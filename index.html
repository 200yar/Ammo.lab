<!DOCTYPE html>
<html lang="en">
<head>
<title>Ammo lab</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
    * {  margin: 0; padding: 0; border: 0; }
    @font-face { font-family: "SourceCode"; src:url("images/SourceCodePro.woff") format("woff");}
    body { background-color: #1d1f20; overflow: hidden; color: #eeeeee; font-family: "SourceCode"; font-size: 12px; }
    h3 { margin-left:0px; font-size:20px; font-weight:800; word-spacing:-6px;}
    input{ margin:0px; padding:4px; }
    #container{ position: absolute; width:100%; height:100%;}
    #interface{ position: absolute; left:10px; top:10px; width:456px; height:20px; }
    #stats{ position: absolute; left:10px; bottom:0px; height:20px; width:220px;  pointer-events:none; font-size: 12px;word-spacing:-4px; color:#424344;}
    #info{ pointer-events:none; position: absolute; left:48px; top:18px; width: 400px; height: 400px; line-height:12px;}
</style>

<script src="js/AAA.View.js"></script>
<script src="js/Transcode.js"></script>
<script src="js/Editor.js"></script>
<script src="js/Terrain.js"></script>

</head>

<body>
<div id='container'></div>
<div id="info"></div>
<div id="stats"></div>
<script>

var engineOption = { broadphase:"BVT", timer:false, timestep:1/60, iteration:2, G:-10 };
var themes = ['1d1f20', '2f3031', '424344', '68696b'];
var info = document.getElementById("info");
var stats = document.getElementById("stats");
var demoName = "yoch";

var Sources, Editor, View, Pool;

//-----------------------------------
// ALL SOURCE LOADED FROM PNG 
//-----------------------------------

window.onload = prevInit;

function prevInit() {
    Sources = new Transcode.Loader([ "images/ammo.png", "images/three.png", "images/sea3d.png"], init, [1, 0, 0]);

    // init editor
    Editor = new Editor(themes, 8);
    document.body.appendChild( Editor.domElement );
}

//-----------------------------------
// AMMO WORKER SIDE 
//-----------------------------------

var ammoInfo = [0];
var AmmoWorker = new Worker('js/AMMO.Worker.js');
AmmoWorker.postMessage = AmmoWorker.webkitPostMessage || AmmoWorker.postMessage;

var mtxCar;
var mtx;

AmmoWorker.onmessage = function(e) {

	var phase = e.data.tell;
    
	if( phase === "INIT"){
        introDemo();
	}
	if( phase === "RUN"){
		ammoInfo = e.data.infos;
		mtx = e.data.mtx;
        mtxCar = e.data.mtxCar;
		var mesh, m, n;
    	var i = ammoInfo[1];
        while (i--) {
            View.objs[i].update(i);
    	}
        i = ammoInfo[2];
        while (i--) {
            View.cars[i].update(i);
        }
	}
    if( phase === "CLEAR"){
        View.clearAll();
        if(Editor.getScript()){
            AmmoWorker.postMessage({tell:"START", option:engineOption });
            initDemo();
        }
    }
}

function introDemo() {
    AmmoWorker.postMessage({tell:"START", option:engineOption});

    NAME("Vehicule Garage");

    ADD({type:"plane"});
    ADD({type:"ground", size:[30,1,20], pos:[0,1,0], rot:[9,0,0], mass:0});
    ADD({ type:"boxbasic", size:[30,2,1], pos:[0,1,16] });

    ADD({type:"box", size:[1,1,1], pos:[10, 10, 0], mass:1, noSleep:true});
    ADD({type:"box", size:[1,1,1], pos:[-10, 10, 0], mass:1, noSleep:true});


    var max = 10;
    var px;

    for (var i=0; i!==10; ++i ){
        px=-10+(i*2.5);
        CAR({ size:[1,0.5,2], pos:[px, 10, -8], wPos:[0.5,0,1], wRadius:0.3, wDeepth:0.2, nWheels:4, mass:100 });
    }
}

function introDemoTerrain() {
    AmmoWorker.postMessage({tell:"START", option:engineOption});
    //ADD({type:"ground", size:[300,30,300], pos:[0, -15, 0], rot:[0,0,0], mass:0} );
    ADD({type:"terrain", size:[300,30,300], pos:[0, -5, 0], div:[64,64] });

    var mx,my,mz,py;
    for(var i=1; i< 20; i++){
        mx = 1 + Math.random()*5;
        my = 1 + Math.random()*5;
        mz = 1 + Math.random()*5;
        py=100+i*10;

        ADD({type:"box", size:[mx,my,mz], pos:[0, py, 0], mass:1});
        ADD({type:"sphere", size:[mx,my,mz], pos:[0, py, 0], mass:1});
        ADD({type:"cylinder", size:[mx,my,mx], pos:[0, py, 0], mass:1});
    }
}


//-----------------------------------
// THREE SIDE 
//-----------------------------------

function init() {
    Editor.hideIntro();
    displayInfo();

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    View = new AAA.View(themes);

    // load basic model
    Pool = new SEA3D.Pool('models/geo.sea', initGeometry);

    loop();
}

function loop() {
    requestAnimationFrame( loop );
    View.render();
    stats.innerHTML = "three: " + View.fps +" fps | ammo: " + ammoInfo[0]+" fps";
}

function displayInfo(){
    info.innerHTML = "<h3>Ammo.lab</h3><br>"+demoName;
}

//-----------------------------------------------------
// MESH FUNCTION
//-----------------------------------------------------

function initGeometry() {

    View.geos[0] = THREE.BufferGeometryUtils.fromGeometry(new THREE.CubeGeometry( 1, 1, 1 ));
    View.geos[1] = THREE.BufferGeometryUtils.fromGeometry(Pool.getGeometry("box", true));
    View.geos[2] = THREE.BufferGeometryUtils.fromGeometry(new THREE.SphereGeometry( 1, 20, 16  ));
    View.geos[3] = THREE.BufferGeometryUtils.fromGeometry(Pool.getGeometry("cyl", true));
    View.geos[4] = THREE.BufferGeometryUtils.fromGeometry(Pool.getGeometry("dice", true));
    View.geos[5] = THREE.BufferGeometryUtils.fromGeometry(new THREE.CylinderGeometry( 0, 1, 1, 20, 1 ));

    View.geos[6] = Pool.getGeometry("L", true);
    View.geos[6].name = "L";
    View.geos[7] = Pool.getGeometry("T", true);
    View.geos[7].name = "T";
    View.geos[8] = Pool.getGeometry("H", true);
    View.geos[8].name = "H";

    // send AMMO script to worker
    AmmoWorker.postMessage({tell:"INIT", AmmoUrl:Sources.ref["AMMOX"] });
}

//-----------------------------------------------------
// TRANSE SCRIPT
//-----------------------------------------------------

var NAME = function(name){
    demoName = name;
    displayInfo()
}

var SET = function(id, obj){
    AmmoWorker.postMessage({tell:"SET", id:id, obj:obj });
}

var ADD = function(obj){
    View.addObj(obj);
    if(obj.type == "convex"){// get geometry vertices 
        obj.v = View.getVertex(obj.name, obj.size);
    }
    if(obj.type == "mesh"){// get geometry faces vertices 
        obj.v = View.getFaces(obj.name, obj.size);
    }
    AmmoWorker.postMessage({ tell:"ADD", obj:obj });
}

var CAR = function(obj){ 
    View.addCar(obj);
    AmmoWorker.postMessage({ tell:"CAR", obj:obj });
}

var CLEAR = function(option){
    engineOption = option || {};
    AmmoWorker.postMessage({tell:"CLEAR"});
}


//var GET = function(names){ AmmoWorker.postMessage({tell:"GET", names:names}); }
//var CAM = function(h, v, d){ TE.changeView(h, v, d); }

</script>
</body>
</html>