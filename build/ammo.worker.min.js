'use strict';var Module={TOTAL_MEMORY:268435456},Ammo,start,world=null,worldInfo=null,solver,solverSoft,collision,dispatcher,broadphase,ghostPairCallback,isSoft=!0,trans,pos,quat,posW,quatW,transW,gravity,tmpTrans,tmpPos,tmpQuat,origineTrans,tmpPos1,tmpPos2,tmpPos3,tmpPos4,tmpZero,tmpTrans1,tmpTrans2,tmpForce=[],tmpMatrix=[],bodys,solids,softs,joints,cars,heros,terrains,carsInfo,contacts,contactGroups,byName,timeStep=1/60,numStep=2,ddt=1,key=[0,0,0,0,0,0,0,0],tmpKey=[0,0,0,0,0,0,0,0],isBuffer=!1,
currentCar=0,Ar,aAr,ArLng,ArPos,ArMax,fixedTime=0.01667,last_step=Date.now(),timePassed=0,STATE={ACTIVE:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5},FLAGS={STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32,DISABLE_SPU_COLLISION_PROCESSING:64},GROUP={DEFAULT:1,STATIC:2,KINEMATIC:4,DEBRIS:8,SENSORTRIGGER:16,NOCOLLISION:32,GROUP0:64,GROUP1:128,GROUP2:256,GROUP3:512,GROUP4:1024,GROUP5:2048,
GROUP6:4096,GROUP7:8192,ALL:-1};
self.onmessage=function(a){a=a.data;var b=a.m,c=a.o;a.Ar&&(Ar=a.Ar);switch(b){case "init":init(a);break;case "step":step(a);break;case "start":start(a);break;case "reset":reset(a);break;case "set":set(c);break;case "key":tmpKey=c.key;break;case "setDriveCar":currentCar=c.n;break;case "moveSoftBody":moveSoftBody(c);break;case "heroRotation":setHeroRotation(c.id,c.angle);break;case "add":add(c);break;case "vehicle":addVehicle(c);break;case "character":addCharacter(c);break;case "terrain":terrainPostStep(c);
break;case "gravity":setGravity(c);break;case "anchor":anchor(c);break;case "force":tmpForce.push(c);break;case "forceArray":tmpForce=c;break;case "matrix":tmpMatrix.push(c);break;case "matrixArray":tmpMatrix=c;break;case "setVehicle":setVehicle(c);break;case "contact":addContact(c)}};function preStep(){}
function step(a){key=a.key;updateMatrix();updateForce();terrainUpdate();world.stepSimulation(timeStep,numStep);drive(currentCar);move(0);stepCharacter(ArPos[0]);stepVehicle(ArPos[1]);stepRigidBody(Ar,ArPos[2]);stepSoftBody(Ar,ArPos[3]);stepConstraint(Ar,ArPos[4]);stepContact();isBuffer?self.postMessage({m:"step",Ar:Ar,contacts:contacts},[Ar.buffer]):self.postMessage({m:"step",Ar:Ar,contacts:contacts})}
function init(a){isBuffer=a.isBuffer||!1;ArLng=a.settings[0];ArPos=a.settings[1];ArMax=a.settings[2];importScripts(a.blob);Ammo().then(function(a){initMath();trans=new a.btTransform;quat=new a.btQuaternion;pos=new a.btVector3;posW=new a.btVector3;quatW=new a.btQuaternion;transW=new a.btTransform;origineTrans=new a.btTransform;tmpTrans=new a.btTransform;tmpPos=new a.btVector3;tmpQuat=new a.btQuaternion;tmpPos1=new a.btVector3;tmpPos2=new a.btVector3;tmpPos3=new a.btVector3;tmpPos4=new a.btVector3;
tmpZero=new a.btVector3(0,0,0);tmpTrans1=new a.btTransform;tmpTrans2=new a.btTransform;gravity=new a.btVector3;addWorld();bodys=[];softs=[];joints=[];cars=[];carsInfo=[];heros=[];terrains=[];solids=[];contacts=[];contactGroups=[];byName={};self.postMessage({m:"initEngine"})})}function set(a){a=a||{};timeStep=void 0!==a.timeStep?a.timeStep:0.016;numStep=void 0!==a.numStep?a.numStep:2;gravity.fromArray(void 0!==a.gravity?a.gravity:[0,-9.81,0]);world.setGravity(gravity)}
function reset(a){tmpForce=[];tmpMatrix=[];clearContact();clearJoint();clearRigidBody();clearVehicle();clearTerrain();clearCharacter();clearSoftBody();byName={};a.full&&(clearWorld(),addWorld());setGravity();isBuffer||(Ar=new Float32Array(ArMax));self.postMessage({m:"start"})}function wipe(a){for(var b in a)a.hasOwnProperty(b)&&delete a[b]}
function add(a,b){a.type=void 0===a.type?"box":a.type;var c=a.type,d=a.type.substring(0,4);"join"===d?addJoint(a):"soft"===d||"ellipsoid"===c||"rope"===c||"cloth"===c?addSoftBody(a):"terrain"===c?addTerrain(a):addRigidBody(a,b)}function anchor(a){getByName(a.soft).appendAnchor(a.pos,getByName(a.body),!1,a.influence||0.5)}
function addRay(a){void 0!==a.p1&&tmpPos1.fromArray(a.p1);void 0!==a.p2&&tmpPos2.fromArray(a.p2);a=new Ammo.ClosestRayResultCallback(tmpPos1,tmpPos2);world.rayTest(tmpPos1,tmpPos2,a)}function getByName(a){return byName[a]||null}function getByIdx(a){a=a.toFixed(1);var b=parseInt(a);switch(Number(a.substring(a.lastIndexOf(".")+1))){case 1:return heros[b];case 2:return cars[b];case 3:return bodys[b];case 4:return solids[b];case 5:return terrains[b];case 6:return softs[b];case 7:return joints[b]}}
function updateForce(){for(;0<tmpForce.length;)applyForce(tmpForce.pop())}
function applyForce(a){var b=getByName(a[0]);if(null!==b){var c=a[1]||"force";void 0!==a[2]&&tmpPos1.fromArray(a[2]);void 0!==a[3]?tmpPos2.fromArray(a[3]):tmpPos2.zero();switch(c){case "force":case 0:b.applyForce(tmpPos1,tmpPos2);break;case "torque":case 1:b.applyTorque(tmpPos1);break;case "localTorque":case 2:b.applyLocalTorque(tmpPos1);break;case "forceCentral":case 3:b.applyCentralForce(tmpPos1);break;case "forceLocal":case 4:b.applyCentralLocalForce(tmpPos1);break;case "impulse":case 5:b.applyImpulse(tmpPos1,
tmpPos2);break;case "impulseCentral":case 6:b.applyCentralImpulse(tmpPos1);break;case "motor":case 7:b.enableAngularMotor(!0,a[2][0],a[2][1])}}}function updateMatrix(){for(;0<tmpMatrix.length;)applyMatrix(tmpMatrix.pop())}
function applyMatrix(a){var b=!1,c=getByName(a[0]);if(void 0!==c&&null!==c){var d=c.isKinematic||!1;if(a[3]){c.getMotionState().getWorldTransform(origineTrans);var e=[];origineTrans.toArray(e);for(var f=a[3].length,g,b=!0;f--;)g=a[3][f],"x"===g&&(a[1][0]=e[0]-a[1][0]),"y"===g&&(a[1][1]=e[1]-a[1][1]),"z"===g&&(a[1][2]=e[2]-a[1][2]),"rot"===g&&(a[2]=[e[3],e[4],e[5],e[6]])}tmpTrans.setIdentity();void 0!==a[1]&&(tmpPos.fromArray(a[1]),tmpTrans.setOrigin(tmpPos));void 0!==a[2]&&(tmpQuat.fromArray(a[2]),
tmpTrans.setRotation(tmpQuat));d||b||(c.setAngularVelocity(tmpZero),c.setLinearVelocity(tmpZero));d?c.getMotionState().setWorldTransform(tmpTrans):(c.setWorldTransform(tmpTrans),c.activate())}}function clearWorld(){Ammo.destroy(world);Ammo.destroy(solver);Ammo.destroy(solverSoft);Ammo.destroy(collision);Ammo.destroy(dispatcher);Ammo.destroy(broadphase);world=null}
function addWorld(a){a=a||{};if(null===world){isSoft=void 0===a.soft?!0:a.soft;solver=new Ammo.btSequentialImpulseConstraintSolver;solverSoft=isSoft?new Ammo.btDefaultSoftBodySolver:null;collision=isSoft?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;dispatcher=new Ammo.btCollisionDispatcher(collision);switch(void 0===a.broadphase?2:a.broadphase){case 1:broadphase=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,1E3,1E3),
4096);break;case 2:broadphase=new Ammo.btDbvtBroadphase}world=isSoft?new Ammo.btSoftRigidDynamicsWorld(dispatcher,broadphase,solver,collision,solverSoft):new Ammo.btDiscreteDynamicsWorld(dispatcher,broadphase,solver,collision);var b=world.getDispatchInfo();void 0!==a.penetration&&b.set_m_allowedCcdPenetration(a.penetration);setGravity(a)}}
function setGravity(a){a=a||{};null!==world&&(gravity.fromArray(a.g||[0,-10,0]),world.setGravity(gravity),isSoft&&(worldInfo=world.getWorldInfo(),worldInfo.set_m_gravity(gravity)))}function setWater(a){isSoft&&(worldInfo=world.getWorldInfo(),worldInfo.set_water_density(a.density||0),worldInfo.set_water_offset(a.offset||0),worldInfo.set_water_normal((new Ammo.btVector3).fromArray(a.normal||[0,0,0])))};var torad=0.017453292519943295,todeg=57.29577951308232;
function initMath(){Ammo.btTransform.prototype.toArray=function(a,b){b=b||0;this.getOrigin().toArray(a,b);this.getRotation().toArray(a,b+3)};Ammo.btVector3.prototype.zero=function(a){this.setValue(0,0,0);return this};Ammo.btVector3.prototype.negate=function(a){this.setValue(-this.x(),-this.y(),-this.z());return this};Ammo.btVector3.prototype.add=function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this};Ammo.btVector3.prototype.fromArray=function(a,b){b=b||0;this.setValue(a[b],
a[b+1],a[b+2]);return this};Ammo.btVector3.prototype.toArray=function(a,b){b=b||0;a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z()};Ammo.btVector3.prototype.direction=function(a){var b=a.x(),c=a.y(),d=a.z();a=a.w();var e=this.x(),f=this.y(),g=this.z(),h=a*e+c*g-d*f,k=a*f+d*e-b*g,l=a*g+b*f-c*e,e=-b*e-c*f-d*g;this.setValue(h*a+e*-b+k*-d-l*-c,k*a+e*-c+l*-b-h*-d,l*a+e*-d+h*-c-k*-b)};Ammo.btQuaternion.prototype.fromArray=function(a,b){b=b||0;this.setValue(a[b],a[b+1],a[b+2],a[b+3])};Ammo.btQuaternion.prototype.toArray=
function(a,b){b=b||0;a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z();a[b+3]=this.w()};Ammo.btQuaternion.prototype.setFromAxisAngle=function(a,b){var c=0.5*b,d=Math.sin(c);this.setValue(a[0]*d,a[1]*d,a[2]*d,Math.cos(c))}};function addCharacter(a){a=new Character(a);heros.push(a)}function move(a){a=a||0;heros[a]&&heros[a].move()}function stepCharacter(a){heros.forEach(function(b,c){b.step(a+8*c)})}function clearCharacter(){for(;0<heros.length;)heros.pop().clear();heros=[]}function setHeroRotation(a,b){a=a||0;heros[a]&&heros[a].setRotation(b)}function Character(a){this.hero=this.body=null;this.speed=this.angle=0;this.wasJumping=!1;this.verticalVelocity=0;this.angleInc=this.init(a)}
Character.prototype={step:function(a){Ar[a]=this.speed;var b=this.body.getWorldTransform();pos=b.getOrigin();quat=b.getRotation();Ar[a+1]=pos.x();Ar[a+2]=pos.y();Ar[a+3]=pos.z();Ar[a+4]=quat.x();Ar[a+5]=quat.y();Ar[a+6]=quat.z();Ar[a+7]=quat.w()},move:function(){var a=this.hero,b=0,c=0;1==key[4]&&a.onGround()&&(this.wasJumping=!0,this.verticalVelocity=0);this.wasJumping&&(this.verticalVelocity+=0.04,1.3<this.verticalVelocity&&(this.verticalVelocity=0,this.wasJumping=!1));c=0.3*-key[1];b=0.3*-key[0];
this.speed=c+b;this.angle-=0.1*key[2];this.setRotation(this.angle);posW.setValue(b,0+this.verticalVelocity,c);posW.direction(quatW);a.setWalkDirection(posW)},clear:function(){world.removeCollisionObject(this.body);world.removeAction(this.hero);Ammo.destroy(this.body);Ammo.destroy(this.hero);this.hero=this.body=null},init:function(a){a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var b=new Ammo.btCapsuleShape(a.size[0],0.5*a.size[1]),c=
new Ammo.btPairCachingGhostObject;c.setCollisionShape(b);c.setCollisionFlags(FLAGS.CHARACTER_OBJECT);tmpPos.fromArray(a.pos);tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);c.setWorldTransform(tmpTrans);c.setFriction(a.friction||0.1);c.setRestitution(a.restitution||0);c.setActivationState(4);c.activate();var d=new Ammo.btKinematicCharacterController(c,b,a.stepH||0.35,a.upAxis||1);d.setUseGhostSweepTest(b);d.setGravity(gravity);d.setFallSpeed(30);
d.setMaxJumpHeight(200);d.setJumpSpeed(1E3);a.slopeRadians&&d.setMaxSlope(a.slopeRadians);tmpPos2.setValue(0,0,0);d.setVelocityForTimeInterval(tmpPos2,1);world.addCollisionObject(c,a.group||1,a.mask||-1);world.addAction(d);this.body=c;this.hero=d},setRotation:function(a){var b=this.body.getWorldTransform();quatW.setFromAxisAngle([0,1,0],a);b.setRotation(quatW);this.angle=a}};function stepConstraint(a,b){joints.forEach(function(c,d){var e=b+4*d;c.type&&(a[e]=c.type)})}function clearJoint(){for(var a;0<joints.length;)a=joints.pop(),world.removeConstraint(a),Ammo.destroy(a);joints=[]}
function addJoint(a){var b=!0;a.collision&&(b=!1);a.body1&&(a.b1=a.body1);a.body2&&(a.b2=a.body2);var c=getByName(a.b1),d=getByName(a.b2);tmpPos1.fromArray(a.pos1||[0,0,0]);tmpPos2.fromArray(a.pos2||[0,0,0]);tmpPos3.fromArray(a.axe1||[1,0,0]);tmpPos4.fromArray(a.axe2||[1,0,0]);"joint_p2p"!==a.type&&"joint_hinge"!==a.type&&"joint"!==a.type&&(tmpTrans1.setIdentity(),tmpTrans1.setOrigin(tmpPos1),a.quatA&&(tmpQuat.fromArray(a.quatA),tmpTrans1.setRotation(tmpQuat)),tmpTrans2.setIdentity(),tmpTrans2.setOrigin(tmpPos2),
a.quatB&&(tmpQuat.fromArray(a.quatB),tmpTrans2.setRotation(tmpQuat)));var e=void 0!==a.useA?a.useA:!0,f=null,g=0;switch(a.type){case "joint_p2p":g=1;f=new Ammo.btPoint2PointConstraint(c,d,tmpPos1,tmpPos2);a.strength&&f.get_m_setting().set_m_tau(a.strength);a.damping&&f.get_m_setting().set_m_damping(a.damping);a.impulse&&f.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":g=2;f=new Ammo.btHingeConstraint(c,d,tmpPos1,tmpPos2,tmpPos3,tmpPos4,e);break;case "joint_slider":g=
3;f=new Ammo.btSliderConstraint(c,d,tmpTrans1,tmpTrans2,e);break;case "joint_conetwist":g=4;f=new Ammo.btConeTwistConstraint(c,d,tmpTrans1,tmpTrans2);break;case "joint_dof":g=5;f=new Ammo.btGeneric6DofConstraint(c,d,tmpTrans1,tmpTrans2,e);break;case "joint_spring_dof":g=6,f=new Ammo.btGeneric6DofSpringConstraint(c,d,tmpTrans1,tmpTrans2,e)}a.breaking&&f.setBreakingImpulseThreshold(a.breaking);a.limit&&("joint_hinge"===a.type||"joint"===a.type?f.setLimit(a.limit[0]*torad,a.limit[1]*torad,a.limit[2]||
0.9,a.limit[3]||0.3,a.limit[4]||1):"joint_conetwist"===a.type&&f.setLimit(a.limit[0]*torad,a.limit[1]*torad,a.limit[2]*torad,a.limit[3]||0.9,a.limit[4]||0.3,a.limit[5]||1));a.motor&&f.enableAngularMotor(a.motor[0],a.motor[1],a.motor[2]);a.linLower&&(tmpPos.fromArray(a.linLower),f.setLinearLowerLimit(tmpPos));a.linUpper&&(tmpPos.fromArray(a.linUpper),f.setLinearUpperLimit(tmpPos));a.angLower&&(tmpPos.fromArray(a.angLower),f.setAngularLowerLimit(tmpPos));a.angUpper&&(tmpPos.fromArray(a.angUpper),f.setAngularUpperLimit(tmpPos));
a.feedback&&f.enableFeedback(a.feedback);a.enableSpring&&f.enableSpring(a.enableSpring[0],a.enableSpring[1]);a.damping&&f.setDamping(a.damping[0],a.damping[1]);a.stiffness&&f.setStiffness(a.stiffness[0],a.stiffness[1]);a.angularOnly&&f.setAngularOnly(a.angularOnly);a.enableMotor&&f.enableMotor(a.enableMotor);a.maxMotorImpulse&&f.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&f.setMotorTarget(tmpQuat.fromArray(a.motorTarget));f.type=0;a.debug&&(f.type=g,f.bodyA=c,f.bodyB=d);world.addConstraint(f,
b);a.name&&(byName[a.name]=f);joints.push(f)};function stepContact(){for(var a=contactGroups.length;a--;)contactGroups[a].step()}function clearContact(){for(;0<contactGroups.length;)contactGroups.pop().clear();contactGroups=[];contacts=[]}function addContact(a){a=new Contact(a,contactGroups.length);a.valide&&(contactGroups.push(a),contacts.push(0))}
function Contact(a,b){this.a=getByName(a.b1);this.b=void 0!==a.b2?getByName(a.b2):null;null!==this.a?(this.id=b,this.f=new Ammo.ConcreteContactResultCallback,this.f.addSingleResult=function(){contacts[b]=1},this.valide=!0):this.valide=!1}Contact.prototype={step:function(){contacts[this.id]=0;null!==this.b?world.contactPairTest(this.a,this.b,this.f):world.contactTest(this.a,this.f)},clear:function(){this.b=this.a=null;Ammo.destroy(this.f)}};function stepRigidBody(a,b){bodys.forEach(function(c,d){var e=b+8*d;a[e]=9.8*c.getLinearVelocity().length();0<a[e]&&(c.getMotionState().getWorldTransform(trans),trans.toArray(a,e+1))})}function clearRigidBody(){for(var a;0<bodys.length;)a=bodys.pop(),world.removeRigidBody(a),Ammo.destroy(a);for(;0<solids.length;)a=solids.pop(),world.removeCollisionObject(a),Ammo.destroy(a);bodys=[];solids=[]}
function addRigidBody(a,b){var c=!1;void 0!==a.density&&(a.mass=a.density);a.kinematic&&(a.flag=2,a.state=4,c=!0);a.mass=void 0==a.mass?0:a.mass;a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var d=null;switch(a.type){case "plane":tmpPos4.fromArray(a.dir||[0,1,0]);d=new Ammo.btStaticPlaneShape(tmpPos4,0);break;case "box":tmpPos4.setValue(0.5*a.size[0],0.5*a.size[1],0.5*a.size[2]);d=new Ammo.btBoxShape(tmpPos4);break;case "sphere":d=new Ammo.btSphereShape(a.size[0]);
break;case "cylinder":tmpPos4.setValue(a.size[0],0.5*a.size[1],0.5*a.size[2]);d=new Ammo.btCylinderShape(tmpPos4);break;case "cone":d=new Ammo.btConeShape(a.size[0],0.5*a.size[1]);break;case "capsule":d=new Ammo.btCapsuleShape(a.size[0],0.5*a.size[1]);break;case "compound":d=new Ammo.btCompoundShape;break;case "mesh":for(var d=new Ammo.btTriangleMesh,e=a.v,f=0,g=e.length;f<g;f+=9)tmpPos1.setValue(e[f+0]*a.size[0],e[f+1]*a.size[1],e[f+2]*a.size[2]),tmpPos2.setValue(e[f+3]*a.size[0],e[f+4]*a.size[1],
e[f+5]*a.size[2]),tmpPos3.setValue(e[f+6]*a.size[0],e[f+7]*a.size[1],e[f+8]*a.size[2]),d.addTriangle(tmpPos1,tmpPos2,tmpPos3,!0);d=0==a.mass?new Ammo.btBvhTriangleMeshShape(d,!0,!0):new Ammo.btConvexTriangleMeshShape(d,!0);break;case "convex":for(d=new Ammo.btConvexHullShape,e=a.v,f=0,g=e.length;f<g;f+=3)e[f]*=a.size[0],e[f+1]*=a.size[1],e[f+2]*=a.size[2],tmpPos1.fromArray(e,f),d.addPoint(tmpPos1)}void 0!==a.margin&&void 0!==d.setMargin&&d.setMargin(a.margin);if("isShape"==b)return d;if("isGhost"==
b)return c=new Ammo.btGhostObject,c.setCollisionShape(d),c.setCollisionFlags(a.flag||1),c;tmpPos.fromArray(a.pos);tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);tmpPos1.setValue(0,0,0);d.calculateLocalInertia(a.mass,tmpPos1);e=new Ammo.btDefaultMotionState(tmpTrans);d=new Ammo.btRigidBodyConstructionInfo(a.mass,e,d,tmpPos1);void 0!==a.friction&&d.set_m_friction(a.friction);void 0!==a.restitution&&d.set_m_restitution(a.restitution);void 0!==
a.linear&&d.set_m_linearDamping(a.linear);void 0!==a.angular&&d.set_m_angularDamping(a.angular);void 0!==a.rolling&&d.set_m_rollingFriction(a.rolling);e=new Ammo.btRigidBody(d);e.isKinematic=c;a.name?byName[a.name]=e:0!==a.mass&&(byName[bodys.length]=e);0!==a.mass||c?(e.setCollisionFlags(a.flag||0),world.addRigidBody(e,a.group||1,a.mask||-1),e.setActivationState(a.state||1),bodys.push(e)):(e.setCollisionFlags(a.flag||1),world.addCollisionObject(e,a.group||1,a.mask||-1),solids.push(e));Ammo.destroy(d)}
;function stepSoftBody(a,b){var c=b;softs.forEach(function(b){b=b.get_m_nodes();for(var e=b.size(),f;e--;)f=c+3*e,b.at(e).get_m_x().toArray(a,f);c+=3*b.size()})}function moveSoftBody(a){a=softs[a.id];for(var b=a.get_m_nodes(),c=b.size();c--;);a.set_m_nodes(b)}function clearSoftBody(){for(var a;0<softs.length;)a=softs.pop(),world.removeSoftBody(a),Ammo.destroy(a);softs=[]}
function addSoftBody(a){var b=world.getWorldInfo(),c=a.gendiags||!0;a.size=void 0==a.size?[1,1,1]:a.size;a.div=void 0==a.div?[64,64]:a.div;var d=new Ammo.btSoftBodyHelpers,e;switch(a.type){case "cloth":e=0.5*a.size[0];var f=0.5*a.size[2];tmpPos1.fromArray([-e,0,-f]);tmpPos2.fromArray([e,0,-f]);tmpPos3.fromArray([-e,0,f]);tmpPos4.fromArray([e,0,f]);e=d.CreatePatch(b,tmpPos1,tmpPos2,tmpPos3,tmpPos4,a.div[0],a.div[1],a.fixed||0,c);e.softType=1;break;case "rope":tmpPos1.fromArray(a.start||[-10,0,0]);
tmpPos2.fromArray(a.end||[10,0,0]);e=a.numSegment||10;a.margin=a.radius||0.2;e=d.CreateRope(b,tmpPos1,tmpPos2,e-2,a.fixed||0);e.softType=2;break;case "ellipsoid":tmpPos1.fromArray(a.center||[0,0,0]);tmpPos2.fromArray(a.radius||[3,3,3]);e=d.CreateEllipsoid(b,tmpPos1,tmpPos2,a.vertices||128);e.softType=3;for(var d=[],c=e.get_m_nodes(),f=c.size(),g;f--;)b=3*f,g=c.at(f),g=g.get_m_x(),d[b]=g.x(),d[b+1]=g.y(),d[b+2]=g.z();a.lng=c.size();a.a=d;self.postMessage({m:"ellipsoid",o:a});break;case "softConvex":c=
a.v.length/3;e=d.CreateFromConvexHull(b,a.v,c,a.randomize||!0);e.softType=4;for(d=c;d--;)b=3*d,tmpPos.fromArray(a.v,b),e.get_m_nodes().at(d).set_m_x(tmpPos);break;case "softTriMesh":e=d.CreateFromTriMesh(b,a.v,a.i,a.ntri,a.randomize||!0),e.softType=5}b=e.get_m_cfg();void 0!==a.viterations&&b.set_viterations(a.viterations);void 0!==a.piterations&&b.set_piterations(a.piterations);void 0!==a.diterations&&b.set_diterations(a.diterations);void 0!==a.citerations&&b.set_citerations(a.citerations);b.set_collisions(17);
void 0!==a.friction&&b.set_kDF(a.friction);void 0!==a.damping&&b.set_kDP(a.damping);void 0!==a.pressure&&b.set_kPR(a.pressure);void 0!==a.drag&&b.set_kDG(a.drag);void 0!==a.lift&&b.set_kLF(a.lift);void 0!==a.vc&&b.set_kVC(a.vc);void 0!==a.matching&&b.set_kMT(a.matching);a.hardness&&(b.set_kCHR(a.hardness),b.set_kKHR(a.hardness),b.set_kSHR(a.hardness),b.set_kAHR(a.hardness));void 0!==a.stiffness&&(b=e.get_m_materials().at(0),b.set_m_kLST(a.stiffness),b.set_m_kAST(a.stiffness),b.set_m_kVST(a.stiffness));
e.setTotalMass(a.mass,a.fromfaces||!1);void 0!==a.margin&&Ammo.castObject(e,Ammo.btCollisionObject).getCollisionShape().setMargin(a.margin);world.addSoftBody(e,a.group||1,a.mask||-1);e.setActivationState(a.state||1);e.points=e.get_m_nodes().size();a.name&&(byName[a.name]=e);softs.push(e)};function terrainPostStep(a){var b=a.name;byName[b]&&byName[b].setData(a.heightData)}function terrainUpdate(a){for(a=terrains.length;a--;)terrains[a].update()}function addTerrain(a){a=new Terrain(a);byName[a.name]=a;terrains.push(a)}function clearTerrain(){for(;0<terrains.length;)terrains.pop().clear();terrains=[]}
function Terrain(a){this.needsUpdate=!1;this.dataHeap=this.tmpData=this.data=null;var b=void 0===a.name?"terrain":a.name,c=void 0===a.size?[1,1,1]:a.size,d=void 0===a.sample?[64,64]:a.sample,e=void 0===a.pos?[0,0,0]:a.pos,f=void 0===a.quat?[0,0,0,1]:a.quat,g=void 0===a.mass?0:a.mass,h=void 0===a.margin?0.02:a.margin,k=void 0===a.friction?0.5:a.friction,l=void 0===a.restitution?0:a.restitution,m=void 0===a.flag?1:a.flag,n=void 0===a.group?1:a.group,p=void 0===a.mask?-1:a.mask,q=void 0===a.heightScale?
1:a.heightScale,r=void 0===a.upAxis?1:a.upAxis,s=a.hdt||"PHY_FLOAT",t=void 0!==a.flipEdge?a.flipEdge:!1;this.setData(a.heightData);this.update();a=new Ammo.btHeightfieldTerrainShape(d[0],d[1],this.data,q,-c[1],c[1],r,s,t);tmpPos2.setValue(c[0]/d[0],1,c[2]/d[1]);a.setLocalScaling(tmpPos2);a.setMargin(h);tmpPos.fromArray(e);tmpQuat.fromArray(f);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);tmpPos1.setValue(0,0,0);c=new Ammo.btDefaultMotionState(tmpTrans);g=new Ammo.btRigidBodyConstructionInfo(g,
c,a,tmpPos1);g.set_m_friction(k);g.set_m_restitution(l);k=new Ammo.btRigidBody(g);k.setCollisionFlags(m);world.addCollisionObject(k,n,p);this.name=b;this.body=k;Ammo.destroy(g)}
Terrain.prototype={setData:function(a){this.tmpData=a;this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT;this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),self.postMessage({m:"terrain",o:{name:this.name}}),this.needsUpdate=!1,this.tmpData=null)},clear:function(){world.removeCollisionObject(this.body);Ammo.destroy(this.body);Ammo._free(this.dataHeap.byteOffset);this.dataHeap=this.tmpData=this.data=this.body=null},malloc:function(){null===this.data&&(this.data=
Ammo._malloc(this.nDataBytes));this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes);this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}};function Malloc_Float(a,b){var c=a.length*a.BYTES_PER_ELEMENT;void 0===b&&(b=Ammo._malloc(c));(new Uint8Array(Ammo.HEAPU8.buffer,b,c)).set(new Uint8Array(a.buffer));return b};function stepVehicle(a){cars.forEach(function(b,c){b.step(a+56*c)})}function clearVehicle(){for(;0<cars.length;)cars.pop().clear();cars=[]}function setVehicle(a){var b=a.id||0;cars[b]&&cars[b].set(a)}function addVehicle(a){a=new Vehicle(a);cars.push(a)}function drive(a){a=a||0;cars[a]&&cars[a].drive()}
function Vehicle(a){this.body=this.car=null;this.engine=this.breaking=this.steering=0;this.gearRatio=[-1,0,2.3,1.8,1.3,0.9,0.5];this.data={mass:100,radius:0.5,nWheel:4,wPos:[1,0,1.6],engine:1E3,acceleration:10,steering:0.3,breaking:100,incSteering:0.04,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-0.6,0],friction:0.6,restitution:0.1,linear:0,angular:0,auto:!1,compValue:0.2,dampValue:0.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6E3,s_length:0.2,w_friction:10.5,w_roll:0.1};this.init(a)}
Vehicle.prototype={step:function(a){Ar[a]=this.car.getCurrentSpeedKmHour();this.body.getMotionState().getWorldTransform(trans);trans.toArray(Ar,a+1);var b=this.data.nWheel,c,d;4===b&&(c=40,Ar[a+c+0]=this.car.getWheelInfo(0).get_m_raycastInfo().get_m_suspensionLength(),Ar[a+c+1]=this.car.getWheelInfo(1).get_m_raycastInfo().get_m_suspensionLength(),Ar[a+c+2]=this.car.getWheelInfo(2).get_m_raycastInfo().get_m_suspensionLength(),Ar[a+c+3]=this.car.getWheelInfo(3).get_m_raycastInfo().get_m_suspensionLength());
for(;b--;)this.car.updateWheelTransform(b,!0),d=this.car.getWheelTransformWS(b),c=8*(b+1),d.toArray(Ar,a+c+1),0===b&&(Ar[a+c]=this.car.getWheelInfo(0).get_m_steering())},drive:function(){var a=this.data;this.steering-=a.incSteering*key[0];this.steering<-a.steering&&(this.steering=-a.steering);this.steering>a.steering&&(this.steering=a.steering);this.steering*=0.9;this.engine-=a.acceleration*key[1];this.engine>a.engine&&(this.engine=a.engine);this.engine<-a.engine&&(this.engine=-a.engine);0==key[1]&&
(1<this.engine?this.engine*=0.9:-1>this.engine?this.engine*=0.9:(this.engine=0,this.breaking=a.breaking));for(var b=a.nWheel;b--;)0==b&&this.car.setSteeringValue(this.steering,b),2!==a.nWheel&&1==b&&this.car.setSteeringValue(this.steering,b),this.car.applyEngineForce(this.engine,b),this.car.setBrake(this.breaking,b)},clear:function(){world.removeRigidBody(this.body);world.removeAction(this.car);Ammo.destroy(this.body);Ammo.destroy(this.car);this.car=this.body=null},init:function(a){var b=this.data,
c=a.type||"box";b.mass=void 0===a.mass?800:a.mass;a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;a.size=void 0===a.size?[2,0.5,4]:a.size;b.pos=void 0===a.pos?[0,0,0]:a.pos;b.quat=void 0===a.quat?[0,0,0,1]:a.quat;var d;d="mesh"==c?addRigidBody({type:"mesh",v:a.v,mass:1},"isShape"):"convex"==c?addRigidBody({type:"convex",v:a.v},"isShape"):addRigidBody({type:"box",size:a.size},"isShape");void 0!==a.v&&delete a.v;tmpPos4.fromArray(a.masscenter).negate();tmpTrans1.setIdentity();tmpTrans1.setOrigin(tmpPos4);
c=new Ammo.btCompoundShape;c.addChildShape(tmpTrans1,d);tmpPos.fromArray(b.pos);tmpQuat.fromArray(b.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);c.calculateLocalInertia(b.mass,tmpPos1);d=new Ammo.btDefaultMotionState(tmpTrans);b=new Ammo.btRigidBodyConstructionInfo(b.mass,d,c,tmpPos1);this.body=new Ammo.btRigidBody(b);this.body.setActivationState(4);Ammo.destroy(b);b=new Ammo.btVehicleTuning;c=new Ammo.btDefaultVehicleRaycaster(world);this.car=new Ammo.btRaycastVehicle(b,
this.body,c);this.car.setCoordinateSystem(0,1,2);c=a.radius||0.4;d=a.wPos||[1,0,1.6];d[1]-=a.masscenter[1];for(var e=a.nWheel||4,f,g,h=0;h<e;h++)2===h&&d[4]&&(d[0]+=d[4]),0===h&&(f=[d[0],d[1],d[2]],g=!0),1===h&&(f=[-d[0],d[1],d[2]],g=!0),2===h&&(f=[-d[0],d[1],-d[2]],g=!1),3===h&&(f=[d[0],d[1],-d[2]],g=!1),4===h&&(f=[-d[0],d[1],-d[3]],g=!1),5===h&&(f=[d[0],d[1],-d[3]],g=!1),2===e&&1==h&&(f=[-d[0],d[1],-d[2]],g=!1),tmpPos1.fromArray(f),tmpPos2.setValue(0,-1,0),tmpPos3.setValue(-1,0,0),this.car.addWheel(tmpPos1,
tmpPos2,tmpPos3,1,c,b,g),this.car.setBrake(a.breaking||100,h);a.name&&(byName[a.name+"_body"]=this.body,byName[a.name]=this.car);this.set(a);world.addAction(this.car);world.addRigidBody(this.body)},setMass:function(a){this.data.mass=a;this.body.getCollisionShape().calculateLocalInertia(this.data.mass,tmpPos1);this.body.setMassProps(a,tmpPos1);this.body.updateInertiaTensor()},setPosition:function(){this.engine=this.breaking=this.steering=0;tmpPos.fromArray(this.data.pos);tmpQuat.fromArray(this.data.quat);
tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);this.body.setAngularVelocity(tmpZero);this.body.setLinearVelocity(tmpZero);this.body.setWorldTransform(tmpTrans);this.car.resetSuspension();for(var a=this.data.nWheel;a--;)this.car.updateWheelTransform(a,!0)},set:function(a){var b=this.data;void 0!==a.mass&&a.mass!==b.mass&&this.setMass(a.mass);for(var c in a)b[c]&&(b[c]=a[c]);this.body.setFriction(b.friction);this.body.setRestitution(b.restitution);this.body.setDamping(b.linear,
b.angular);b.auto&&(c=Math.sqrt(b.s_stiffness),b.s_compression=2*b.compValue*c,b.s_damping=2*b.dampValue*c);c=b.nWheel;for(var d;c--;)d=this.car.getWheelInfo(c),d.set_m_suspensionStiffness(b.s_stiffness),d.set_m_wheelsDampingCompression(b.s_compression),d.set_m_wheelsDampingRelaxation(b.s_damping),d.set_m_maxSuspensionTravelCm(100*b.s_travel),d.set_m_maxSuspensionForce(b.s_force),d.set_m_suspensionRestLength1(b.s_length),d.set_m_rollInfluence(b.w_roll),d.set_m_frictionSlip(b.w_friction),d.set_m_wheelsRadius(b.radius);
a.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}};
