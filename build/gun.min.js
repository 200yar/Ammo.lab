(function(y,F){"object"===typeof exports&&"undefined"!==typeof module?F(exports):"function"===typeof define&&define.amd?define(["exports"],F):(y=y||self,F(y.GUN={}))})(this,function(y){function F(){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){this.setIdentity();return this},positionFromArray:function(a,b,c){b=b||0;a=f.vector3().fromArray(a,b,c);this.setOrigin(a);a.free();return this},eulerFromArray:function(a,b){b=b||0;a=f.quaternion().setFromEuler(a,
b);this.setRotation(a);a.free();return this},eulerFromArrayZYX:function(a,b){b=b||0;this.getBasis().setEulerZYX(a[b],a[b+1],a[b+2]);return this},getRow:function(a){return this.getBasis().getRow(a)},makeRotationDir:function(a){a=f.vector3().fromArray(a);var b=f.vector3(0,1,0),c=f.vector3().cross(b,a).normalize(),d=f.vector3().cross(a,c).normalize(),k=f.matrix3(),e=k.setV3(c,d,a).toQuaternion().normalize();this.setRotation(e);k.free();e.free();a.free();b.free();c.free();d.free()},setFromDirection:function(a){a=
f.vector3().fromArray(a);var b=f.vector3(),c=f.quaternion();if(.99999<a.y())c.set(0,0,0,1);else if(-.99999>a.y())c.set(1,0,0,0);else{b.set(a.z(),0,-a.x());var d=Math.acos(a.y());c.setFromAxisAngle(b.toArray(),d)}this.setRotation(c);a.free();b.free();c.free();return this},quartenionFromAxis:function(a){a=f.quaternion().setFromAxis(a);this.setRotation(a);a.free();return this},quartenionFromAxisAngle:function(a,b){a=f.quaternion().setFromAxisAngle(a,b);this.setRotation(a);a.free();return this},quaternionFromArray:function(a,
b){b=b||0;a=f.quaternion().fromArray(a,b);this.setRotation(a);a.free();return this},fromArray:function(a,b,c){b=b||0;this.positionFromArray(a,b,c);3<a.length&&this.quaternionFromArray(a,b+3);return this},toArray:function(a,b,c){b=b||0;this.getOrigin().toArray(a,b,c);this.getRotation().toArray(a,b+3)},getInverse:function(){var a=f.transform();a.setIdentity();var b=this.getRotation().toMatrix3().transpose(),c=this.getOrigin().clone().negate(),d=b.multiplyByVector3(c),k=b.toQuaternion();a.setOrigin(d);
a.setRotation(k);c.free();d.free();k.free();b.free();return a},multiply:function(a){var b=this.getRotation().toMatrix3(),c=a.getRotation().toMatrix3(),d=this.getOrigin().clone();a=a.getOrigin().clone();var k=b.multiplyByVector3(a).add(d);this.setOrigin(k);b.multiply(c);var e=b.toQuaternion();this.setRotation(e);b.free();c.free();d.free();a.free();e.free();k.free();return this},clone:function(){var a=f.transform();a.setIdentity();a.setOrigin(this.getOrigin());a.setRotation(this.getRotation());return a},
copy:function(a){this.setOrigin(a.getOrigin());this.setRotation(a.getRotation());return this},free:function(){f.freeTransform(this)}});Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(a,b,c){this.setValue(a,b,c);return this},zero:function(){this.setValue(0,0,0);return this},negate:function(){this.setValue(-this.x(),-this.y(),-this.z());return this},add:function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this},sub:function(a){this.setValue(this.x()-
a.x(),this.y()-a.y(),this.z()-a.z());return this},dot:function(a){return this.x()*a.x()+this.y()*a.y()+this.z()*a.z()},cross:function(a,b){var c=a.x(),d=a.y();a=a.z();var k=b.x(),e=b.y();b=b.z();this.set(d*b-a*e,a*k-c*b,c*e-d*k);return this},multiplyScalar:function(a){this.setValue(this.x()*a,this.y()*a,this.z()*a);return this},multiplyArray:function(a){this.setValue(this.x()*a[0],this.y()*a[1],this.z()*a[2]);return this},fromArray:function(a,b,c){b=b||0;c=c||1;this.setValue(a[b]*c,a[b+1]*c,a[b+2]*
c);return this},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z())},normalize:function(){return this.divideScalar(this.length()||1)},toArray:function(a,b,c){void 0===a&&(a=[]);void 0===b&&(b=0);c=c||1;a[b]=this.x()*c;a[b+1]=this.y()*c;a[b+2]=this.z()*c;return a},direction:function(a){var b=a.x(),c=a.y(),d=a.z();a=a.w();var k=this.x(),e=this.y(),f=this.z(),g=a*k+c*f-d*e,r=a*e+d*k-b*f,t=a*f+b*e-c*k;k=-b*
k-c*e-d*f;this.setValue(g*a+k*-b+r*-d-t*-c,r*a+k*-c+t*-b-g*-d,t*a+k*-d+g*-c-r*-b);return this},clone:function(){return f.vector3().set(this.x(),this.y(),this.z())},free:function(){f.freeVector3(this)}});Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(a,b,c,d){this.setValue(a,b,c,d);return this},fromArray:function(a,b){void 0===b&&(b=0);this.setValue(a[b],a[b+1],a[b+2],a[b+3]);return this},toArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);
a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z();a[b+3]=this.w();return a},setFromAxis:function(a){.99999<a[2]?this.setValue(0,0,0,1):-.99999>a[2]?this.setValue(1,0,0,0):this.setFromAxisAngle([a[1],a[0],0],Math.acos(a[2]));return this},setFromAxisAngle:function(a,b){b*=.5;var c=Math.sin(b);this.setValue(a[0]*c,a[1]*c,a[2]*c,Math.cos(b));return this},setFromEuler:function(a){var b=a[0],c=a[1],d=a[2];a=a[3]||"XYZ";var k=Math.cos,e=Math.sin,f=k(.5*b),g=k(.5*c);k=k(.5*d);b=e(.5*b);c=e(.5*c);d=e(.5*d);if("XYZ"===
a){var r=b*g*k+f*c*d;var t=f*c*k-b*g*d;var l=f*g*d+b*c*k;var m=f*g*k-b*c*d}else"YXZ"===a?(r=b*g*k+f*c*d,t=f*c*k-b*g*d,l=f*g*d-b*c*k,m=f*g*k+b*c*d):"ZXY"===a?(r=b*g*k-f*c*d,t=f*c*k+b*g*d,l=f*g*d+b*c*k,m=f*g*k-b*c*d):"ZYX"===a?(r=b*g*k-f*c*d,t=f*c*k+b*g*d,l=f*g*d-b*c*k,m=f*g*k+b*c*d):"YZX"===a?(r=b*g*k+f*c*d,t=f*c*k+b*g*d,l=f*g*d-b*c*k,m=f*g*k-b*c*d):"XZY"===a&&(r=b*g*k-f*c*d,t=f*c*k-b*g*d,l=f*g*d+b*c*k,m=f*g*k+b*c*d);this.setValue(r,t,l,m);return this},toMatrix3:function(){var a=[],b=this.x(),c=this.y(),
d=this.z(),e=this.w(),g=b*b,v=c*c,x=d*d,r=b*c,t=c*d,l=d*b;b*=e;c*=e;d*=e;a[0]=1-2*(v+x);a[1]=2*(r-d);a[2]=2*(l+c);a[3]=2*(r+d);a[4]=1-2*(x+g);a[5]=2*(t-b);a[6]=2*(l-c);a[7]=2*(t+b);a[8]=1-2*(g+v);return f.matrix3().fromArray(a)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z()+this.w()*this.w())},normalize:function(){var a=this.length();if(0===a)return this.set(0,0,0,1);a=1/a;return this.set(this.x()*a,this.y()*a,this.z()*a,this.w()*a)},multiply:function(a){return this.multiplyQuaternions(this,
a)},multiplyQuaternions:function(a,b){var c=a.x(),d=a.y(),f=a.z();a=a.w();var e=b.x(),g=b.y(),x=b.z();b=b.w();this.set(c*b+a*e+d*x-f*g,d*b+a*g+f*e-c*x,f*b+a*x+c*g-d*e,a*b-c*e-d*g-f*x);return this},clone:function(){return f.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){f.freeQuaternion(this)}})}function G(){this.elements=[1,0,0,0,1,0,0,0,1]}function Y(){this.ID=0;this.solids=[];this.bodys=[];this.trans=new Ammo.btTransform;this.zero=new Ammo.btVector3;this.zero.set(0,0,0)}
function Z(){this.ID=0;this.joints=[];this.t1=new Ammo.btTransform;this.t2=new Ammo.btTransform}function aa(){this.ID=0;this.softs=[]}function ba(){this.ID=0;this.terrains=[]}function H(a,b){var c=f.transform(),d=f.vector3();this.needsUpdate=!1;this.dataHeap=this.tmpData=this.data=null;this.type="terrain";1!==e.scale&&(b.pos=f.vectomult(b.pos,e.invScale),b.size=f.vectomult(b.size,e.invScale));var k=void 0===b.size?[1,1,1]:b.size,g=void 0===b.sample?[64,64]:b.sample,v=void 0===b.pos?[0,0,0]:b.pos,
x=void 0===b.quat?[0,0,0,1]:b.quat,r=void 0===b.mass?0:b.mass,t=void 0===b.margin?.02:b.margin,l=void 0===b.friction?.5:b.friction,m=void 0===b.restitution?0:b.restitution,n=void 0===b.flag?1:b.flag,h=void 0===b.heightScale?1:b.heightScale,q=void 0===b.upAxis?1:b.upAxis,E=b.hdt||"PHY_FLOAT",y=void 0!==b.flipEdge?b.flipEdge:!1;this.setData(b.heightData);this.update();b=new Ammo.btHeightfieldTerrainShape(g[0],g[1],this.data,h,-k[1],k[1],q,E,y);d.set(k[0]/g[0],1,k[2]/g[1]);b.setLocalScaling(d);b.setMargin(t);
c.identity().fromArray(v.concat(x));d.set(0,0,0);k=new Ammo.btDefaultMotionState(c);r=new Ammo.btRigidBodyConstructionInfo(r,k,b,d);r.set_m_friction(l);r.set_m_restitution(m);l=new Ammo.btRigidBody(r);l.setCollisionFlags(n);this.name=l.name=a;this.body=l;Ammo.destroy(r);c.free();d.free()}function ca(){this.ID=0;this.cars=[];this.trans=new Ammo.btTransform}function I(a,b,c){this.name=a;this.body=this.chassis=null;this.motor=this.breaking=this.steering=0;this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5];this.limitAngular=
[1,1,1];this.transforms=[];this.wheelBody=[];this.wheelJoint=[];this.wheelRadius=[];this.isRay=!0;this.data={mass:100,wMass:1,wWidth:.25,nWheel:b.nWheel||4,wPos:[1,0,1.6],engine:1E3,acceleration:10,maxSteering:24*f.torad,breaking:100,incSteering:.04,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6E3,s_length:.2,w_friction:10.5,w_roll:.001};
this.init(b,c)}function da(){this.ID=0;this.heroes=[]}function J(a,b){this.name=a;this.controller=this.body=null;this.speed=this.angle=0;this.wasJumping=!1;this.verticalVelocity=0;this.angleInc=.1;this.q=new Ammo.btQuaternion;this.position=new Ammo.btVector3;this.init(b)}function ea(){this.ID=0;this.pairs=[]}function fa(a,b,c){this.name=c;this.result=0;this.type="collision";this.pa=[0,0,0];this.pb=[0,0,0];this.nb=[0,0,0];this.maxImpulse=this.impulse=this.distance=0;this.a=a;this.b=b;this.f=new Ammo.ConcreteContactResultCallback;
this.f.addSingleResult=function(){this.result=1}.bind(this)}function ha(){this.ID=0;this.rays=[];this.ray=null;this.results=[]}function ia(a,b){this.name=a;this.type="ray";this.precision=1;this.update(b);this.result={hit:!1,name:"",point:[0,0,0],normal:[0,0,0]}}var f={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},eulerToQuadArray:function(a,b){b&&(a=f.vectomult(a,f.torad));a=f.quaternion().setFromEuler(a);b=a.toArray();a.free();return b},
getLength:function(){return"T:"+f.T.length+" Q:"+f.Q.length+" V:"+f.V3.length},destroy:function(){for(;0<f.T.length;)Ammo.destroy(f.T.pop());for(;0<f.Q.length;)Ammo.destroy(f.Q.pop());for(;0<f.V3.length;)Ammo.destroy(f.V3.pop());f.M3=[]},transform:function(){return 0<f.T.length?f.T.pop():new Ammo.btTransform},freeTransform:function(a){f.T.push(a)},quaternion:function(){return 0<f.Q.length?f.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(a){f.Q.push(a)},vector3:function(){return 0<f.V3.length?
f.V3.pop():new Ammo.btVector3},freeVector3:function(a){f.V3.push(a)},matrix3:function(){return 0<f.M3.length?f.M3.pop():new G},freeMatrix3:function(a){f.M3.push(a)},vectomult:function(a,b){return a=a.map(function(a){return a*b})},distanceArray:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];a=b[2]-a[2];return Math.sqrt(c*c+d*d+a*a)}};Object.assign(G.prototype,{set:function(a,b,c,d,f,e,g,x,r){var k=this.elements;k[0]=a;k[1]=d;k[2]=g;k[3]=b;k[4]=f;k[5]=x;k[6]=c;k[7]=e;k[8]=r;return this},setV3:function(a,
b,c){var d=this.elements;d[0]=a.x();d[3]=a.y();d[6]=a.z();d[1]=b.x();d[4]=b.y();d[7]=b.z();d[2]=c.x();d[5]=c.y();d[8]=c.z();return this},transpose:function(){var a=this.elements;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this},fromArray:function(a,b){void 0===b&&(b=0);for(var c=0;9>c;c++)this.elements[c]=a[c+b];return this},multiply:function(a){var b=this.row(0),c=this.row(1),d=this.row(2),f=a.column(0),e=a.column(1);a=a.column(2);var g=this.elements;g[0]=b.dot(f);
g[1]=b.dot(e);g[2]=b.dot(a);g[3]=c.dot(f);g[4]=c.dot(e);g[5]=c.dot(a);g[6]=d.dot(f);g[7]=d.dot(e);g[8]=d.dot(a);b.free();c.free();d.free();f.free();e.free();a.free();return this},multiplyByVector3:function(a){var b=this.row(0),c=this.row(1),d=this.row(2);a=f.vector3().set(b.dot(a),c.dot(a),d.dot(a));b.free();c.free();d.free();return a},toQuaternion:function(){var a=this.elements,b=a[0]+a[4]+a[8];if(0<b){var c=2*Math.sqrt(b+1);var d=.25*c;b=(a[7]-a[5])/c;var e=(a[2]-a[6])/c;a=(a[3]-a[1])/c}else a[0]>
a[4]&&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),d=(a[7]-a[5])/c,b=.25*c,e=(a[1]+a[3])/c,a=(a[2]+a[6])/c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),d=(a[2]-a[6])/c,b=(a[1]+a[3])/c,e=.25*c,a=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),d=(a[3]-a[1])/c,b=(a[2]+a[6])/c,e=(a[5]+a[7])/c,a=.25*c);return f.quaternion().set(b,e,a,d)},row:function(a){var b=this.elements;a*=3;return f.vector3().set(b[a],b[a+1],b[a+2])},column:function(a){var b=this.elements;return f.vector3().set(b[a],b[a+3],b[a+6])},free:function(){f.freeMatrix3(this)}});
var e={Ar:null,ArPos:null,constraintDebug:!1,matrix:[],force:[],option:[],flow:{ray:[],terrain:[],vehicle:[]},world:null,gravity:null,scale:1,invscale:1,angle:0,key:[0,0,0,0,0,0,0,0],post:null},g=new Map;Object.assign(Y.prototype,{step:function(a,b){var c,d=this.trans,f=e.scale;this.bodys.forEach(function(e,k){c=b+8*k;a[c]=9.8*e.getLinearVelocity().length();e.getMotionState().getWorldTransform(d);d.toArray(a,c+1,f)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<
this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){"solid"===a.type?e.world.removeCollisionObject(a):e.world.removeRigidBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==c&&(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a,b){var c=void 0!==a.name?a.name:"body"+this.ID++;this.remove(c);void 0!==a.density&&(a.mass=a.density);
void 0!==a.bounce&&(a.restitution=a.bounce);var d=void 0===a.mass?0:a.mass,k=a.kinematic||!1,p=a.ghost||!1;p&&(d=0);var v=f.vector3(),x=f.vector3(),r=f.vector3(),t=f.vector3(),l=f.vector3(),m=f.transform(),n=void 0!==a.noMesh?a.noMesh:!1;k&&(a.flag=2,a.state=4,void 0===a.group&&(a.group=4));a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;1!==e.scale&&(a.pos=f.vectomult(a.pos,e.invScale),a.size=f.vectomult(a.size,e.invScale),void 0!==
a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,e.invScale)));var h=null;if("hardbox"===a.type||"hardbox"===a.type||"realhardbox"===a.type||"ChamferBox"===a.type)a.type="box";if("realcylinder"===a.type||"ChamferCyl"===a.type)a.type="cylinder";"realcone"===a.type&&(a.type="cone");"realsphere"===a.type&&(a.type="sphere");switch(a.type){case "plane":l.fromArray(a.dir||[0,1,0]);h=new Ammo.btStaticPlaneShape(l,0);break;case "box":l.setValue(.5*a.size[0],.5*a.size[1],.5*a.size[2]);h=new Ammo.btBoxShape(l);
break;case "sphere":h=new Ammo.btSphereShape(a.size[0]);break;case "cylinder":l.setValue(a.size[0],.5*a.size[1],.5*a.size[2]);h=new Ammo.btCylinderShape(l);break;case "cone":h=new Ammo.btConeShape(a.size[0],.5*a.size[1]);break;case "capsule":h=new Ammo.btCapsuleShape(a.size[0],a.size[1]);break;case "compound":h=new Ammo.btCompoundShape;for(var q,y,A=f.transform(),u=0;u<a.shapes.length;u++){q=a.shapes[u];q.quat=void 0===q.quat?[0,0,0,1]:q.quat;1!==e.scale&&(q.pos=f.vectomult(q.pos,e.invScale),q.size=
f.vectomult(q.size,e.invScale));A.identity().fromArray(q.pos.concat(q.quat));switch(q.type){case "box":l.setValue(.5*q.size[0],.5*q.size[1],.5*q.size[2]);y=new Ammo.btBoxShape(l);break;case "sphere":y=new Ammo.btSphereShape(q.size[0]);break;case "cylinder":l.setValue(q.size[0],.5*q.size[1],.5*q.size[2]);y=new Ammo.btCylinderShape(l);break;case "cone":y=new Ammo.btConeShape(q.size[0],.5*q.size[1]);break;case "capsule":y=new Ammo.btCapsuleShape(q.size[0],q.size[1]);break;case "convex":y=new Ammo.btConvexHullShape;
var w=q.v;u=0;for(var z=w.length;u<z;u+=3)w[u]*=q.size[0],w[u+1]*=q.size[1],w[u+2]*=q.size[2],l.fromArray(w,u),y.addPoint(l)}h.addChildShape(A,y)}A.free();break;case "mesh":h=new Ammo.btTriangleMesh;w=a.v;u=0;for(z=w.length;u<z;u+=9)x.set(w[u+0]*a.size[0],w[u+1]*a.size[1],w[u+2]*a.size[2]),r.set(w[u+3]*a.size[0],w[u+4]*a.size[1],w[u+5]*a.size[2]),t.set(w[u+6]*a.size[0],w[u+7]*a.size[1],w[u+8]*a.size[2]),h.addTriangle(x,r,t,!0);h=0===d?new Ammo.btBvhTriangleMeshShape(h,!0,!0):new Ammo.btConvexTriangleMeshShape(h,
!0);break;case "convex":h=new Ammo.btConvexHullShape;w=a.v;u=0;for(z=w.length;u<z;u+=3)w[u]*=a.size[0],w[u+1]*=a.size[1],w[u+2]*=a.size[2],l.fromArray(w,u),h.addPoint(l);a.optimized&&(h.recalcLocalAabb(),h.initializePolyhedralFeatures())}void 0!==h.setMargin&&"sphere"!==a.type&&"capsule"!==a.type&&"compound"!==a.type&&(void 0!==a.margin?h.setMargin(a.margin*e.invScale):void 0!==h.getMargin&&1!==e.scale&&h.setMargin(h.getMargin()*e.invScale));if("isShape"==b)return h;m.identity().fromArray(a.pos.concat(a.quat));
if("isGhost"==b)return c=new Ammo.btGhostObject,c.setCollisionShape(h),c.setCollisionFlags(a.flag||4),c.setWorldTransform(m),c;x.setValue(0,0,0);0!==d&&h.calculateLocalInertia(d,x);b=new Ammo.btDefaultMotionState(m);b=new Ammo.btRigidBodyConstructionInfo(d,b,h,x);void 0!==a.friction&&b.set_m_friction(a.friction);void 0!==a.restitution&&b.set_m_restitution(a.restitution);void 0!==a.linear&&b.set_m_linearDamping(a.linear);void 0!==a.angular&&b.set_m_angularDamping(a.angular);void 0!==a.rolling&&b.set_m_rollingFriction(a.rolling);
a.masscenter?(v.fromArray(a.masscenter).negate(),m.setIdentity(),m.setOrigin(v),p=new Ammo.btCompoundShape,p.addChildShape(m,h),m.identity().fromArray(a.pos.concat(a.quat)),v.setValue(0,0,0),p.calculateLocalInertia(d,v),b=new Ammo.btDefaultMotionState(m),b=new Ammo.btRigidBodyConstructionInfo(d,b,p,v)):p?(p=new Ammo.btGhostObject,p.setCollisionShape(h),p.setWorldTransform(m),a.flag=a.flag||4,p.setCollisionFlags(a.flag),p.isGhost=!0):(p=new Ammo.btRigidBody(b),k&&(p.isKinematic=!0));p.name=c;0!==d||
k?(p.setCollisionFlags(a.flag||0),p.setActivationState(a.state||1),a.neverSleep&&p.setSleepingThresholds(0,0),e.world.addRigidBody(p,a.group||1,a.mask||-1),n?(p.type="body",this.solids.push(p)):(p.type="body",this.bodys.push(p))):(p.setCollisionFlags(a.flag||1),e.world.addCollisionObject(p,a.group||2,a.mask||-1),p.type="solid",this.solids.push(p));p.breakable=void 0!==a.breakable?a.breakable:!1;p.breakable&&(p.breakOption=void 0!==a.breakOption?a.breakOption:[250,1,2,1]);g.set(c,p);Ammo.destroy(b);
this.applyOption(p,a);m.free();v.free();x.free();r.free();t.free();l.free()},applyOption:function(a,b){var c=f.vector3();void 0!==b.flag&&(a.setCollisionFlags(b.flag),a.isKinematic=2===b.flag?!0:!1);void 0!==b.state&&a.setActivationState(b.state);void 0!==b.activate&&a.activate();a.isGhost||(void 0!==b.group&&a.getBroadphaseProxy().set_m_collisionFilterGroup(b.group),void 0!==b.mask&&a.getBroadphaseProxy().set_m_collisionFilterMask(b.mask),void 0!==b.damping&&a.setDamping(b.damping[0],b.damping[1]),
void 0!==b.sleeping&&a.setSleepingThresholds(b.sleeping[0],b.sleeping[1]));void 0!==b.friction&&a.setFriction(b.friction);void 0!==b.restitution&&a.setRestitution(b.restitution);void 0!==b.rollingFriction&&a.setRollingFriction(b.rollingFriction);void 0!==b.linearVelocity&&a.setLinearVelocity(c.fromArray(b.linearVelocity,0,e.invScale));void 0!==b.angularVelocity&&a.setAngularVelocity(c.fromArray(b.angularVelocity));void 0!==b.linearFactor&&a.setLinearFactor(c.fromArray(b.linearFactor));void 0!==b.angularFactor&&
a.setAngularFactor(c.fromArray(b.angularFactor));void 0!==b.anisotropic&&a.setAnisotropicFriction(b.anisotropic[0],b.anisotropic[1]);void 0!==b.massProps&&a.setMassProps(b.massProps[0],b.massProps[1]);void 0!==b.gravity&&(b.gravity?a.setGravity(e.gravity):a.setGravity(this.zero));void 0!==b.ccdThreshold&&a.setCcdMotionThreshold(b.ccdThreshold);void 0!==b.ccdRadius&&a.setCcdSweptSphereRadius(b.ccdRadius);c.free()}});Object.assign(Z.prototype,{step:function(a,b){var c,d=this.t1,f=this.t2,p=e.scale;
this.joints.forEach(function(e,k){c=b+14*k;d.copy(g.get(e.b1).getWorldTransform()).multiply(e.formA).toArray(a,c,p);f.copy(g.get(e.b2).getWorldTransform()).multiply(e.formB).toArray(a,c+7,p)})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(a){e.world.removeConstraint(a);a.formA.free();a.formB.free();Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.joints.indexOf(a);-1!==b&&(this.joints.splice(b,1),this.destroy(a))}},
add:function(a){a.name=void 0!==a.name?a.name:"joint"+this.ID++;var b=a.name;this.remove(b);a.body1&&(a.b1=a.body1);a.body2&&(a.b2=a.body2);if(g.has(a.b1)&&g.has(a.b2)){var c=g.get(a.b1),d=g.get(a.b2);c.activate();d.activate();var k=f.vector3(),p=f.vector3().fromArray(a.pos1||[0,0,0]).multiplyScalar(e.invScale),v=f.vector3().fromArray(a.pos2||[0,0,0]).multiplyScalar(e.invScale),x=f.vector3().fromArray(a.axe1||[1,0,0]),r=f.vector3().fromArray(a.axe2||[1,0,0]),t=f.transform().identity(),l=f.transform().identity();
if(void 0!==a.local?a.local:1)t.setOrigin(p),void 0!==a.quatA?t.quaternionFromArray(a.quatA):a.axe1&&t.quartenionFromAxis(a.axe1),l.setOrigin(v),void 0!==a.quatB?l.quaternionFromArray(a.quatB):a.axe2&&l.quartenionFromAxis(a.axe2);else{var m=f.transform();m.identity();m.setOrigin(p);t.getInverse().multiply(m);m.identity();m.setOrigin(v);d.getMotionState().getWorldTransform(l);l.getInverse().multiply(m);m.free()}m=void 0!==a.useA?a.useA:!0;switch(a.type){case "joint_p2p":var n=1;var h=new Ammo.btPoint2PointConstraint(c,
d,p,v);a.strength&&h.get_m_setting().set_m_tau(a.strength);a.damping&&h.get_m_setting().set_m_damping(a.damping);a.impulse&&h.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":n=2;h=new Ammo.btHingeConstraint(c,d,p,v,x,r,m);break;case "joint_hinge_ref":n=2;h=new Ammo.btHingeConstraint(c,d,t,l,m);break;case "joint_slider":n=3;h=new Ammo.btSliderConstraint(c,d,t,l,m);break;case "joint_conetwist":n=4;h=new Ammo.btConeTwistConstraint(c,d,t,l);break;case "joint_dof":n=
5;h=new Ammo.btGeneric6DofConstraint(c,d,t,l,m);break;case "joint_spring_dof":n=6;h=new Ammo.btGeneric6DofSpringConstraint(c,d,t,l,m);break;case "joint_fixe":n=7,h=new Ammo.btFixedConstraint(c,d,t,l)}h.b1=a.b1;h.b2=a.b2;h.formA=t.clone();h.formB=l.clone();a.breaking&&h.setBreakingImpulseThreshold&&h.setBreakingImpulseThreshold(a.breaking);a.limit&&h.setLimit&&("joint_hinge"!==a.type&&"joint"!==a.type&&"joint_hinge_ref"!==a.type||h.setLimit(a.limit[0]*f.torad,a.limit[1]*f.torad,void 0!==a.limit[2]?
a.limit[2]:.9,void 0!==a.limit[3]?a.limit[3]:.3,void 0!==a.limit[4]?a.limit[4]:1),"joint_conetwist"===a.type&&(h.setLimit(3,a.limit[2]*f.torad),h.setLimit(4,a.limit[1]*f.torad),h.setLimit(5,a.limit[0]*f.torad)));a.limit&&"joint_slider"===a.type&&(a.limit[0]&&h.setLowerLinLimit(a.limit[0]*e.invScale),a.limit[1]&&h.setUpperLinLimit(a.limit[1]*e.invScale),a.limit[2]&&h.setLowerAngLimit(a.limit[2]*f.torad),a.limit[3]&&h.setUpperAngLimit(a.limit[3]*f.torad));h.setLinearLowerLimit&&(a.linLower&&h.setLinearLowerLimit(k.fromArray(a.linLower).multiplyScalar(e.invScale)),
a.linUpper&&h.setLinearUpperLimit(k.fromArray(a.linUpper).multiplyScalar(e.invScale)));h.setAngularLowerLimit&&(a.angLower&&h.setAngularLowerLimit(k.fromArray(a.angLower).multiplyScalar(f.torad)),a.angUpper&&h.setAngularUpperLimit(k.fromArray(a.angUpper).multiplyScalar(f.torad)));a.motor&&h.enableAngularMotor&&h.enableAngularMotor(a.motor[0],a.motor[1],a.motor[2]);a.feedback&&h.enableFeedback(a.feedback);a.angularOnly&&h.setAngularOnly&&h.setAngularOnly(a.angularOnly?1:0);a.enableMotor&&h.enableMotor&&
h.enableMotor(a.enableMotor);a.maxMotorImpulse&&h.setMaxMotorImpulse&&h.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&h.setMotorTarget&&(c=f.quaternion().fromArray(a.motorTarget),h.setMotorTarget(c),c.free());if(a.damping&&h.setDamping)for(c=0;6>c;c++)h.setDamping(c,a.damping[c]);if(a.spring&&h.enableSpring&&h.setStiffness)for(c=0;6>c;c++)h.enableSpring(c,0===a.spring[c]?!1:!0),h.setStiffness(c,a.spring[c]);if(a.param&&h.setParam)for(c=0,d=a.param.length;c<d;c++)h.setParam(a.param[c][0],a.param[c][1],
c);a=void 0!==a.collision?a.collision:!1;h.isJoint=!0;h.name=b;h.nType=n;h.type="joint";e.world.addConstraint(h,a?!1:!0);this.joints.push(h);g.set(b,h);k.free();p.free();v.free();x.free();r.free();t.free();l.free()}else console.log("! not find body")},applyOption:function(a,b){}});Object.assign(function(a){this.type="constraint";this.name=a.name}.prototype,{step:function(a,b){},init:function(a){},clear:function(){}});Object.assign(aa.prototype,{step:function(a,b){var c=b,d,f,g,v=e.scale;this.softs.forEach(function(b){f=
b.get_m_nodes();for(g=f.size();g--;)d=c+3*g,f.at(g).get_m_x().toArray(a,d,v);c+=3*f.size()})},getNodes:function(a){var b=[];a=a.get_m_nodes();for(var c,d=a.size(),e=0;e<d;e++)c=a.at(e).get_m_x().toArray(),300<c[1]&&b.push(e);return b},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){e.world.removeSoftBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),
this.destroy(a))}},addAreo:function(a){if(g.has(a.soft)){for(var b=g.get(a.soft),c=f.vector3().fromeArray(a.wind),d=a.nodes.length;d--;)b.addAeroForceToNode(c,a.nodes[d]);c.free()}},addAnchor:function(a){if(g.has(a.soft)&&g.has(a.body))for(var b=a.collision||!1,c=g.get(a.soft),d=g.get(a.body),e=a.nodes.length;e--;)c.appendAnchor(a.nodes[e],d,b?!1:!0,a.influence||1)},add:function(a){var b=void 0!==a.name?a.name:"soft"+this.ID++;this.remove(b);var c=e.world.getWorldInfo(),d=a.gendiags||!0;a.size=void 0==
a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;a.div=void 0==a.div?[64,64]:a.div;1!==e.scale&&(a.pos=f.vectomult(a.pos,e.invScale),a.size=f.vectomult(a.size,e.invScale));var k=f.vector3(),p=f.vector3(),v=f.vector3(),x=f.vector3(),r=f.vector3(),t=f.transform(),l=new Ammo.btSoftBodyHelpers;switch(a.type){case "softMesh":if(1!==e.scale)for(var m=a.v.length;m--;)a.v[m]*=e.invScale;var n=l.CreateFromTriMesh(c,a.v,a.i,a.ntri,a.randomize||!0);n.softType=
5;break;case "softCloth":n=.5*a.size[0];m=.5*a.size[2];p.fromArray([-n,0,-m]);v.fromArray([n,0,-m]);x.fromArray([-n,0,m]);r.fromArray([n,0,m]);n=l.CreatePatch(c,p,v,x,r,a.div[0],a.div[1],a.fixed||0,d);n.softType=1;break;case "softRope":p.fromArray(a.start||[-10,0,0],0,e.invScale);v.fromArray(a.end||[10,0,0],0,e.invScale);n=l.CreateRope(c,p,v,(a.numSegment||10)-2,a.fixed||0);n.softType=2;break;case "softEllips":p.fromArray(a.center||[0,0,0],0,e.invScale);v.fromArray(a.radius||[3,3,3],0,e.invScale);
n=l.CreateEllipsoid(c,p,v,a.vertices||128);n.softType=3;c=[];l=n.get_m_nodes();m=l.size();for(var h;m--;)d=3*m,h=l.at(m),h=h.get_m_x(),c[d]=h.x(),c[d+1]=h.y(),c[d+2]=h.z();a.lng=l.size();a.a=c;self.postMessage({m:"ellipsoid",o:a});break;case "softConvex":n=a.v.length/3;for(m=0;m<n;m++);h=new Ammo.btConvexHullShape;for(m=0;m<n;m++)d=3*m,p.fromArray(a.v,d,e.invScale),h.addPoint(p);h.initializePolyhedralFeatures();n=l.CreateFromConvexHull(c,h.getConvexPolyhedron(),h.getConvexPolyhedron().m_vertices.size(),
a.randomize||!1);n.softType=4;console.log(n,n.get_m_nodes().size())}this.applyOption(n,a);t.identity().fromArray(a.pos.concat(a.quat));n.transform(t);e.world.addSoftBody(n,a.group||1,a.mask||-1);n.setActivationState(a.state||4);n.points=n.get_m_nodes().size();n.name=b;n.type="soft";this.softs.push(n);g.set(b,n);k.free();p.free();v.free();x.free();r.free();t.free()},applyOption:function(a,b){var c=a.get_m_cfg();void 0!==b.viterations&&c.set_viterations(b.viterations);void 0!==b.piterations&&c.set_piterations(b.piterations);
void 0!==b.diterations&&c.set_diterations(b.diterations);void 0!==b.citerations&&c.set_citerations(b.citerations);c.set_collisions(17);void 0!==b.friction&&c.set_kDF(b.friction);void 0!==b.damping&&c.set_kDP(b.damping);void 0!==b.pressure&&c.set_kPR(b.pressure);void 0!==b.drag&&c.set_kDG(b.drag);void 0!==b.lift&&c.set_kLF(b.lift);void 0!==b.volume&&c.set_kVC(b.volume);void 0!==b.matching&&c.set_kMT(b.matching);void 0!==b.hardness&&(c.set_kCHR(b.hardness),c.set_kKHR(b.hardness),c.set_kSHR(b.hardness),
c.set_kAHR(b.hardness));void 0!==b.timescale&&c.set_timescale(b.timescale);void 0!==b.maxvolume&&c.set_maxvolume(b.maxvolume);c=a.get_m_materials().at(0);void 0!==b.stiffness&&(c.set_m_kLST(b.stiffness),c.set_m_kAST(b.stiffness),c.set_m_kVST(b.stiffness));void 0!==b.bendingConstraint&&a.generateBendingConstraints(b.bendingConstraint,c);a.setTotalMass(b.mass||0,b.fromfaces||!1);void 0!==b.cluster&&a.generateClusters(b.cluster,b.maxClusterIterations||8192);void 0!==b.restitution&&a.setRestitution(b.restitution);
void 0!==b.rolling&&a.setRollingFriction(b.rolling);void 0!==b.flag&&a.setCollisionFlags(b.flag);void 0!==b.margin&&Ammo.castObject(a,Ammo.btCollisionObject).getCollisionShape().setMargin(b.margin*e.invScale)}});Object.assign(ba.prototype,{step:function(){for(var a=e.flow.terrain.length;a--;)this.setData(e.flow.terrain[a]);e.flow.terrain=[];this.terrains.forEach(function(a){a.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){e.world.removeCollisionObject(a.body);
a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},setData:function(a){g.has(a.name)&&g.get(a.name).setData(a.heightData)},add:function(a){var b=void 0!==a.name?a.name:"terrain"+this.ID++;this.remove(b);var c=void 0===a.group?2:a.group,d=void 0===a.mask?-1:a.mask;a=new H(b,a);e.world.addCollisionObject(a.body,c,d);this.terrains.push(a);g.set(b,a)}});Object.assign(H.prototype,{setData:function(a){this.tmpData=
a;this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT;this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body);Ammo._free(this.dataHeap.byteOffset);this.dataHeap=this.tmpData=this.data=this.body=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes);this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}});
Object.assign(ca.prototype,{step:function(a,b){for(var c=e.flow.vehicle.length;c--;)this.setData(e.flow.vehicle[c]);e.flow.vehicle=[];var d,f=this.trans;this.cars.forEach(function(c,e){d=b+64*e;c.step(a,d,f)})},control:function(a){g.has(a)&&g.get(a+"_constuctor").drive(e.key)},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){e.world.removeRigidBody(a.body);e.world.removeAction(a.chassis);Ammo.destroy(a.body);Ammo.destroy(a.chassis);g.delete(a.name+
"_constuctor");g.delete(a.name);g.delete(a.name+"_chassis")},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},addExtra:function(){},setData:function(a){g.has(a.name+"_constuctor")&&g.get(a.name+"_constuctor").setData(a)},add:function(a){var b=void 0!==a.name?a.name:"car"+this.ID++;this.remove(b);a.size=void 0===a.size?[2,.5,4]:a.size;void 0!==a.pos&&(a.pos=f.vectomult(a.pos,e.invScale));void 0!==a.size&&(a.size=f.vectomult(a.size,
e.invScale));void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,e.invScale));var c=a.shapeType||"box";c=this.addExtra("mesh"==c?{type:"mesh",v:a.v,mass:1}:"convex"==c?{type:"convex",v:a.v}:{type:"box",size:a.size},"isShape");void 0!==a.v&&delete a.v;a=new I(b,a,c);e.world.addAction(a.chassis);e.world.addRigidBody(a.body);this.cars.push(a);g.set(b+"_constuctor",a);g.set(b,a.body);g.set(b+"_chassis",a.chassis)},applyOption:function(a,b){}});Object.assign(I.prototype,{step:function(a,b,c){var d=
e.scale;a[b]=this.chassis.getCurrentSpeedKmHour();this.body.getMotionState().getWorldTransform(c);c.toArray(a,b+1,d);c=this.data.nWheel;for(var f,g;c--;)this.chassis.updateWheelTransform(c,!0),g=this.chassis.getWheelTransformWS(c),a[b+56+c]=this.chassis.getWheelInfo(c).get_m_raycastInfo().get_m_suspensionLength()*d,f=8*(c+1),g.toArray(a,b+f+1,d),0===c&&(a[b+f]=this.chassis.getWheelInfo(0).get_m_steering()),1===c&&(a[b+f]=this.chassis.getWheelInfo(1).get_m_steering()),2===c&&(a[b+f]=this.steering);
a[b+62]=this.chassis.getWheelInfo(0).m_rotation;a[b+63]=this.chassis.getWheelInfo(1).m_rotation},drive:function(a){var b=this.data;this.steering=0===a[0]?.9*this.steering:this.steering-b.incSteering*a[0];this.steering=f.clamp(this.steering,-b.maxSteering,b.maxSteering);0===a[1]?(this.motor=0,this.breaking=b.breaking):(this.motor-=b.acceleration*a[1],this.breaking=0);this.motor=f.clamp(this.motor,-b.engine,b.engine);if(3<b.nWheel){var c=2*this.wpos[2],d=this.wpos[0];a=c/Math.tan(this.steering);var e=
Math.atan2(c,d+a);c=Math.atan2(c,-d+a);0>a&&(e-=Math.PI,c-=Math.PI)}for(a=b.nWheel;a--;)4>b.nWheel?0===a&&this.chassis.setSteeringValue(this.steering,a):(0===a&&this.chassis.setSteeringValue(c,a),1===a&&this.chassis.setSteeringValue(e,a)),this.chassis.applyEngineForce(this.motor,a),this.chassis.setBrake(this.breaking,a);1>this.motor&&(b=this.body.getAngularVelocity(),b.multiplyArray(this.limitAngular),this.body.setAngularVelocity(b))},clear:function(){this.chassis=this.body=null},init:function(a,
b){var c=this.data,d=f.transform(),g=f.vector3(),p=f.vector3(),v=f.vector3(),x=f.vector3();this.isRay=void 0===a.isRay?!0:a.isRay;c.mass=void 0===a.mass?800:a.mass;a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;c.pos=void 0===a.pos?[0,0,0]:a.pos;c.quat=void 0===a.quat?[0,0,0,1]:a.quat;c.nWheel=a.nWheel||4;g.fromArray(a.masscenter).negate();d.setIdentity();d.setOrigin(g);var r=new Ammo.btCompoundShape;r.addChildShape(d,b);d.identity().fromArray(c.pos.concat(c.quat));g.setValue(0,0,0);r.calculateLocalInertia(c.mass,
g);b=new Ammo.btDefaultMotionState(d);r=new Ammo.btRigidBodyConstructionInfo(c.mass,b,r,g);this.body=new Ammo.btRigidBody(r);this.body.name=this.name;this.body.isRigidBody=!0;this.body.isBody=!0;this.body.setActivationState(4);Ammo.destroy(r);if(this.isRay){var t=new Ammo.btVehicleTuning;r=new Ammo.btDefaultVehicleRaycaster(e.world);this.chassis=new Ammo.btRaycastVehicle(t,this.body,r);this.chassis.setCoordinateSystem(0,1,2)}r=a.radius||.4;b=a.radiusBack||r;var l=a.wPos||[1,0,1.6];l=f.vectomult(l,
e.invScale);r*=e.invScale;b*=e.invScale;l[1]-=a.masscenter[1];c=c.nWheel;for(var m,n,h=a.decalYBack||0,q=0;q<c;q++)0===q&&(m=[l[0],l[1],l[2]],n=!0),1===q&&(m=[-l[0],l[1],l[2]],n=!0),2===q&&(m=[-l[0],l[1]+h,-l[2]],n=!1),3===q&&(m=[l[0],l[1]+h,-l[2]],n=!1),4===q&&(m=[-l[0],l[1]+h,-l[3]],n=!1),5===q&&(m=[l[0],l[1]+h,-l[3]],n=!1),2===c&&(0===q&&(m=[0,l[1],l[2]],n=!0),1===q&&(m=[0,l[1]+h,-l[2]],n=!1)),3===c&&(0===q&&(m=[0,l[1],l[2]],n=!0),1===q&&(m=[l[0],l[1]+h,-l[2]],n=!1),2===q&&(m=[-l[0],l[1]+h,-l[2]],
n=!1)),p.fromArray(m),v.setValue(0,-1,0),x.setValue(-1,0,0),this.chassis.addWheel(p,v,x,1,n?r:b,t,n),this.chassis.setBrake(a.breaking||100,q),this.wheelRadius.push(n?r:b),this.transforms.push(this.chassis.getWheelTransformWS(q));this.wpos=l;this.setData(a);d.free();g.free();p.free();v.free();x.free()},setMass:function(a){var b=f.vector3();this.data.mass=a;b.setValue(0,0,0);this.body.getCollisionShape().calculateLocalInertia(this.data.mass,b);this.body.setMassProps(a,b);this.body.updateInertiaTensor();
b.free()},setPosition:function(){this.motor=this.breaking=this.steering=0;var a=f.transform();a.identity().fromArray(this.data.pos.concat(this.data.quat));var b=f.vector3().set(0,0,0);this.body.setAngularVelocity(b);this.body.setLinearVelocity(b);this.body.setWorldTransform(a);this.chassis.resetSuspension();for(var c=this.data.nWheel;c--;)this.chassis.updateWheelTransform(c,!0);a.free();b.free()},setData:function(a){var b=this.data;void 0!==a.mass&&a.mass!==b.mass&&this.setMass(a.mass);for(var c in a)void 0!==
b[c]&&(b[c]=a[c]);this.body.setFriction(b.friction);this.body.setRestitution(b.restitution);this.body.setDamping(b.linear,b.angular);this.body.setRollingFriction(b.rolling);void 0!==a.limitAngular&&(this.limitAngular=a.limitAngular);c=f.vector3();void 0!==a.linearFactor&&this.body.setLinearFactor(c.fromArray(a.linearFactor));void 0!==a.angularFactor&&this.body.setAngularFactor(c.fromArray(a.angularFactor));c.free();b.autoSuspension&&(c=Math.sqrt(b.s_stiffness),b.s_compression=2*b.compValue*c,b.s_damping=
2*b.dampValue*c);c=b.nWheel;for(var d;c--;)d=this.chassis.getWheelInfo(c),d.set_m_suspensionStiffness(b.s_stiffness),d.set_m_wheelsDampingCompression(b.s_compression),d.set_m_wheelsDampingRelaxation(b.s_damping),d.set_m_maxSuspensionTravelCm(100*b.s_travel*e.invScale),d.set_m_suspensionRestLength1(b.s_length*e.invScale),d.set_m_maxSuspensionForce(b.s_force),d.set_m_rollInfluence(b.w_roll),d.set_m_frictionSlip(b.w_friction),d.set_m_wheelsRadius(this.wheelRadius[c]);a.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",
o:this.data})}});Object.assign(da.prototype,{step:function(a,b){var c;this.heroes.forEach(function(d,e){c=b+8*e;d.step(a,c)})},control:function(a){g.has(a)&&(a=g.get(a),a.move(e.key),a.setAngle(e.angle))},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){e.world.removeCollisionObject(a.body);e.world.removeAction(a.controller);a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,
1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"hero"+this.ID++;this.remove(b);var c=new J(b,a);e.world.addCollisionObject(c.body,a.group||1,a.mask||-1);e.world.addAction(c.controller);this.heroes.push(c);g.set(b,c)}});Object.assign(J.prototype,{step:function(a,b){a[b]=this.speed;this.body.getWorldTransform().toArray(a,b+1,e.scale)},move:function(a){1==a[4]&&this.controller.canJump();var b=.3*-a[1];var c=.3*-a[0];this.speed=b+c;this.angle-=.1*a[2];this.setAngle(this.angle);this.position.setValue(c,
0+this.verticalVelocity,b);this.position.direction(this.q);this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body);Ammo.destroy(this.controller);this.controller=this.body=null},init:function(a){var b=f.vector3(),c=f.transform();a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;1!==e.scale&&(a.pos=f.vectomult(a.pos,e.invScale),a.size=f.vectomult(a.size,e.invScale),void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,
e.invScale)));var d=new Ammo.btCapsuleShape(a.size[0],a.size[1]),g=new Ammo.btPairCachingGhostObject;c.identity().fromArray(a.pos.concat(a.quat));g.setWorldTransform(c);g.setCollisionShape(d);g.setCollisionFlags(16);g.setFriction(a.friction||.1);g.setRestitution(a.restitution||0);g.setActivationState(4);g.activate();c=new Ammo.btKinematicCharacterController(g,d,a.stepH||.35,a.upAxis||1);c.setUseGhostSweepTest(d);c.setGravity(9.8*3);c.setFallSpeed(55);c.setMaxJumpHeight(.01);c.setJumpSpeed(.1);console.log(c);
a.slopeRadians&&c.setMaxSlope(a.slopeRadians);b.setValue(0,0,0);c.setVelocityForTimeInterval(b,1);this.body=g;this.controller=c},setAngle:function(a){var b=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],a);b.setRotation(this.q);this.angle=a}});Object.assign(ea.prototype,{step:function(a,b){var c;this.pairs.forEach(function(d,f){c=b+f;d.result=0;void 0!==d.b?e.world.contactPairTest(d.a,d.b,d.f):e.world.contactTest(d.a,d.f);a[c]=d.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());
this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;if(g.has(a.b1)){var c=g.get(a.b1);a=void 0!==a.b2?g.has(a.b2)?g.get(a.b2):void 0:void 0;c=new fa(c,a,b);this.pairs.push(c);g.set(b,c)}}});Object.assign(fa.prototype,{clear:function(){this.b=this.a=null;Ammo.destroy(this.f)}});Object.assign(ha.prototype,{step:function(){if(null!==
this.ray){var a=this.rays.length,b=e.flow.ray.length;if(a){if(a===b)for(;b--;)this.rays[b].update(e.flow.ray[b]);e.flow.ray=[];var c=this.ray;this.rays.forEach(function(a,b){c.set_m_closestHitFraction(a.precision);c.set_m_collisionObject(null);c.get_m_rayFromWorld().fromArray(a.origin,0,e.invScale);c.get_m_rayToWorld().fromArray(a.dest,0,e.invScale);c.set_m_collisionFilterGroup(a.group);c.set_m_collisionFilterMask(a.mask);e.world.rayTest(c.get_m_rayFromWorld(),c.get_m_rayToWorld(),c);if(c.hasHit()){b=
Ammo.castObject(c.get_m_collisionObject(),Ammo.btRigidBody).name;void 0===b&&(b=Ammo.castObject(c.get_m_collisionObject(),Ammo.btSoftBody).name);var d=c.get_m_hitNormalWorld();d.normalize();a.result.hit=!0;a.result.name=b;a.result.point=c.get_m_hitPointWorld().toArray(void 0,0,e.scale);a.result.normal=d.toArray()}else a.result.hit=!1,a.result.name="";e.flow.ray.push(a.result)})}}},update:function(a){var b=this.rays.length;if(b&&b===a.length)for(;b--;)this.rays[b].update(a[b])},clear:function(){for(;0<
this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.rays.indexOf(a);-1!==b&&(this.rays.splice(b,1),this.destroy(a))}},add:function(a){null===this.ray&&(this.ray=new Ammo.ClosestRayResultCallback);var b=void 0!==a.name?a.name:"ray"+this.ID++;this.remove(a.name);a=new ia(b,a);this.rays.push(a);g.set(b,a)}});Object.assign(ia.prototype,{update:function(a){this.precision=a.precision||1;this.origin=
a.origin||[0,0,0];this.dest=a.dest||[0,1,0];this.group=void 0!==a.group?a.group:1;this.mask=void 0!==a.mask?a.mask:-1},clear:function(){}});self.onmessage=function(a){a=a.data;a.Ar&&y.engine.setAr(a.Ar);a.flow&&(e.flow=a.flow);y.engine[a.m](a.o)};y.engine=function(){var a=null,b=!1,c="undefined"===typeof performance?Date:performance,d,k,p,v=1/60,x=3*v,r=!1,t=2,l=0,m=!1,n=!1,h=!1,q,E,A,u,w,z=[],S="",T="",K=null,U=0,G,H,L=0,M=0,I=0,V=0,J=0,W=0,X,B,C,N,O,D,P,Q,R;y.engine={test:function(){},setAr:function(a){d=
a},getAr:function(){return d},setDrive:function(a){S=a},setMove:function(a){T=a},setAngle:function(a){e.angle=a.angle},loop:function(a){L=c.now();M=L-I;M>V&&(I=L-M%V,y.engine.step({key:a.key,delta:.001*M}))},internStep:function(b){a&&clearTimeout(a);a=setTimeout(function(){y.engine.loop({key:b.key})},0)},step:function(a){b&&(L-1E3>J&&(J=L,X=W,W=0),W++);l=a.delta;e.key=a.key;this.stepRemove();D.control(S);P.control(T);this.stepMatrix();this.stepOptions();this.stepForces();O.step();0!==U&&this.stepBreak();
r?e.world.stepSimulation(v,0):e.world.stepSimulation(l,t,v);B.step(d,k[0]);Q.step(d,k[1]);P.step(d,k[2]);D.step(d,k[3]);C.step(d,k[4]);h&&N.step(d,k[5]);R.step();m?self.postMessage({m:"step",fps:X,delta:M,flow:e.flow,Ar:d},[d.buffer]):self.postMessage({m:"step",fps:X,delta:l,flow:e.flow,Ar:d})},clearFlow:function(){e.flow={ray:[],terrain:[],vehicle:[]}},reset:function(a){U=0;T=S="";this.clearFlow();z=[];e.matrix=[];e.option=[];e.force=[];B.clear();N.clear();C.clear();O.clear();D.clear();P.clear();
Q.clear();R.clear();g.clear();f.destroy();a.full&&(this.clearWorld(),this.createWorld());this.setGravity();m||(d=new Float32Array(p));self.postMessage({m:"start"})},addMulty:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},post:function(a,b){self.postMessage({m:a,o:b})},init:function(a){m=a.isBuffer||!1;k=a.ArPos;p=a.ArMax;m||(d=new Float32Array(p));importScripts(a.blob);Ammo().then(function(b){F();y.engine.createWorld(a.option);y.engine.set(a.option);B=new Y;N=new Z;C=new aa;O=new ba;D=
new ca;P=new da;Q=new ea;R=new ha;new b.ClosestRayResultCallback;G=f.transform();H=f.vector3();D.addExtra=B.add;self.postMessage({m:"initEngine"})})},remove:function(a){if(g.has(a))switch(g.get(a).type){case "solid":case "body":B.remove(a);break;case "soft":C.remove(a);break;case "terrain":O.remove(a);break;case "joint":case "constraint":N.remove(a);break;case "collision":Q.remove(a);break;case "ray":R.remove(a)}},setRemove:function(a){z=z.concat(a)},stepRemove:function(){for(;0<z.length;)this.remove(z.pop())},
directRemoves:function(a){this.setRemove(a);this.stepRemove()},add:function(a){a.type=void 0===a.type?"box":a.type;void 0!==a.breakable&&a.breakable&&U++;var b=a.type,c=a.type.substring(0,4);"join"===c?N.add(a):"soft"===c||"ellipsoid"===b?C.add(a):"terrain"===b?O.add(a):"character"===b?P.add(a):"collision"===b?Q.add(a):"ray"===b?R.add(a):"car"===b?D.add(a):B.add(a)},addAnchor:function(a){C.addAnchor(a)},setVehicle:function(a){D.setData(a)},createWorld:function(a){if(null!==e.world)console.error("World already existe !!");
else{a=a||{};K=new Ammo.btVector3;K.set(0,0,0);n=void 0===a.soft?!0:a.soft;q=new Ammo.btSequentialImpulseConstraintSolver;E=n?new Ammo.btDefaultSoftBodySolver:null;A=n?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;u=new Ammo.btCollisionDispatcher(A);switch(void 0===a.broadphase?2:a.broadphase){case 1:w=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,1E3,1E3),4096);break;case 2:w=new Ammo.btDbvtBroadphase}e.world=n?new Ammo.btSoftRigidDynamicsWorld(u,
w,q,A,E):new Ammo.btDiscreteDynamicsWorld(u,w,q,A);e.post=this.post}},clearWorld:function(){Ammo.destroy(e.world);Ammo.destroy(q);null!==E&&Ammo.destroy(E);Ammo.destroy(A);Ammo.destroy(u);Ammo.destroy(w);e.world=null},setWorldscale:function(a){e.scale=a;e.invScale=1/a},setGravity:function(a){a=a||{};e.gravity=new Ammo.btVector3;e.gravity.fromArray(void 0!==a.gravity?a.gravity:[0,-9.81,0]);e.world.setGravity(e.gravity);n&&e.world.getWorldInfo().set_m_gravity(e.gravity)},set:function(a){a=a||{};this.setWorldscale(void 0!==
a.worldscale?a.worldscale:1);v=void 0!==a.fps?1/a.fps:1/60;t=void 0!==a.substep?a.substep:2;r=void 0!==a.fixed?a.fixed:!1;V=void 0!==a.fps?1E3/a.fps:1E3/60;b=a.isInternUpdate||!1;h=void 0!==a.jointDebug?a.jointDebug:!1;e.constraintDebug=h;x=3*v;void 0!==a.penetration&&e.world.getDispatchInfo().set_m_allowedCcdPenetration(a.penetration);this.setGravity(a)},setForces:function(a){e.force=e.force.concat(a)},directForces:function(a){this.setForces(a);this.stepForces()},stepForces:function(){for(var a=
e.force.length;a--;)this.applyForces(e.force[a]);e.force=[]},applyForces:function(a){var b=a.name;if(g.has(b)){b=g.get(b);var c=f.vector3(),d=f.vector3(),h=f.quaternion();void 0!==a.direction&&c.fromArray(f.vectomult(a.direction,e.invScale));void 0!==a.distance?d.fromArray(f.vectomult(a.distance,e.invScale)):d.zero();switch(a.type){case "force":case 0:b.applyForce(c,d);break;case "torque":case 1:b.applyTorque(c);break;case "localTorque":case 2:b.applyLocalTorque(c);break;case "forceCentral":case 3:b.applyCentralForce(c);
break;case "forceLocal":case 4:b.applyCentralLocalForce(c);break;case "impulse":case 5:b.applyImpulse(c,d);break;case "impulseCentral":case 6:b.applyCentralImpulse(c);break;case "motor":case 7:b.enableAngularMotor(a.enable||!0,a.targetVelocity,a.maxMotor);break;case "motorTarget":case 8:b.setMotorTarget(a.target,a.axis||-1);case "setLimit":case 9:b.setLimit(a.limit[0]*f.torad,a.limit[1]*f.torad,a.limit[2]||.9,a.limit[3]||.3,a.limit[4]||1)}c.free();d.free();h.free()}},setMatrix:function(a){e.matrix=
e.matrix.concat(a)},directMatrix:function(a){this.setMatrix(a);this.stepMatrix()},stepMatrix:function(){for(var a=e.matrix.length;a--;)this.applyMatrix(e.matrix[a]);e.matrix=[]},applyMatrix:function(a){var b=a.name;if(g.has(b)){var c=g.get(b),d=G.identity(),h=H;void 0===a.rot&&void 0===a.quat&&(a.quat=[0,0,0,1]);if(a.keepX||a.keepY||a.keepZ||a.keepRot){c.getMotionState().getWorldTransform(d);var k=[];d.toArray(k);void 0!==a.keepX&&(a.pos[0]=k[0]-a.pos[0]);void 0!==a.keepY&&(a.pos[1]=k[1]-a.pos[1]);
void 0!==a.keepZ&&(a.pos[2]=k[2]-a.pos[2]);void 0!==a.keepRot&&(a.quat=[k[3],k[4],k[5],k[6]])}void 0!==a.pos&&(void 0!==a.rot&&(a.quat=f.eulerToQuadArray(a.rot,!0)),a.pos=a.pos.concat(a.quat),d.fromArray(a.pos,0,e.invScale),c.isKinematic?c.getMotionState().setWorldTransform(d):c.setWorldTransform(d));void 0!==a.clamped&&(d=l>x?1:l/x,h.fromArray(a.pos,0,e.invScale).sub(c.getWorldTransform().getOrigin()).multiplyScalar(d),c.setLinearVelocity(h));a.velocity&&!c.isGhost&&(a.velocity[0]&&c.setLinearVelocity(h.fromArray(a.velocity[0],
0,e.invScale)),a.velocity[1]&&c.setAngularVelocity(h.fromArray(a.velocity[1])));a.noVelocity&&!c.isGhost&&(c.setLinearVelocity(K),c.setAngularVelocity(K));a.noGravity&&c.setGravity(K);a.activate&&c.activate();"body"!==c.type||c.isKinematic||c.activate();"solid"===c.type&&self.postMessage({m:"moveSolid",o:{name:b,pos:a.pos,quat:a.quat}})}},setOptions:function(a){e.option=e.option.concat(a)},directOptions:function(a){this.setOptions(a);this.stepOptions()},stepOptions:function(){for(var a=e.option.length;a--;)this.applyOption(e.option[a]);
e.option=[]},applyOption:function(a){var b=a.name;if(g.has(b))switch(b=g.get(b),b.type){case "solid":case "body":B.applyOption(b,a);break;case "soft":C.applyOption(b,a)}},stepBreak:function(){for(var a,b,c,d,g,h,k,l,m,n,p=0,r=u.getNumManifolds();p<r;p++)if(a=u.getManifoldByIndexInternal(p),m=Ammo.castObject(a.getBody0(),Ammo.btRigidBody),n=Ammo.castObject(a.getBody1(),Ammo.btRigidBody),k=m.name,l=n.name,m.breakable||n.breakable){c=!1;for(var q=d=0,t=a.getNumContacts();q<t;q++)if(b=a.getContactPoint(q),
0>b.getDistance()){c=!0;a=b.getAppliedImpulse();a>d&&(d=a,g=b.get_m_positionWorldOnB().toArray(),h=b.get_m_normalWorldOnB().toArray());break}c&&(m.breakable&&d>m.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:k,pos:f.vectomult(g,e.scale),normal:h,breakOption:m.breakOption}}),n.breakable&&d>n.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:l,pos:f.vectomult(g,e.scale),normal:h,breakOption:n.breakOption}}))}}};return y.engine}();Object.defineProperty(y,"__esModule",{value:!0})});
