(function(y,D){"object"===typeof exports&&"undefined"!==typeof module?D(exports):"function"===typeof define&&define.amd?define(["exports"],D):(y=y||self,D(y.GUN={}))})(this,function(y){function D(){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){this.setIdentity();return this},positionFromArray:function(a,b,c){b=b||0;a=f.vector3().fromArray(a,b,c);this.setOrigin(a);a.free();return this},eulerFromArray:function(a,b){b=b||0;a=f.quaternion().setFromEuler(a,
b);this.setRotation(a);a.free();return this},quaternionFromArray:function(a,b){b=b||0;a=f.quaternion().fromArray(a,b);this.setRotation(a);a.free();return this},fromArray:function(a,b,c){b=b||0;this.positionFromArray(a,b,c);3<a.length&&this.quaternionFromArray(a,b+3);return this},toArray:function(a,b,c){b=b||0;this.getOrigin().toArray(a,b,c);this.getRotation().toArray(a,b+3)},getInverse:function(){var a=f.transform();a.setIdentity();var b=this.getRotation().toMatrix3().transpose(),c=this.getOrigin().clone().negate(),
d=b.multiplyByVector3(c),e=b.toQuaternion();a.setOrigin(d);a.setRotation(e);c.free();d.free();e.free();b.free();return a},multiply:function(a){var b=this.getRotation().toMatrix3(),c=a.getRotation().toMatrix3(),d=this.getOrigin().clone();a=a.getOrigin().clone();var e=b.multiplyByVector3(a).add(d);this.setOrigin(e);b.multiply(c);var f=b.toQuaternion();this.setRotation(f);b.free();c.free();d.free();a.free();f.free();e.free();return this},clone:function(){var a=f.transform();a.setIdentity();a.setOrigin(this.getOrigin());
a.setRotation(this.getRotation());return a},free:function(){f.freeTransform(this)}});Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(a,b,c){this.setValue(a,b,c);return this},zero:function(){this.setValue(0,0,0);return this},negate:function(){this.setValue(-this.x(),-this.y(),-this.z());return this},add:function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this},dot:function(a){return this.x()*a.x()+this.y()*a.y()+this.z()*a.z()},
multiplyScalar:function(a){this.setValue(this.x()*a,this.y()*a,this.z()*a);return this},fromArray:function(a,b,c){b=b||0;c=c||1;this.setValue(a[b]*c,a[b+1]*c,a[b+2]*c);return this},toArray:function(a,b,c){void 0===a&&(a=[]);void 0===b&&(b=0);c=c||1;a[b]=this.x()*c;a[b+1]=this.y()*c;a[b+2]=this.z()*c;return a},direction:function(a){var b=a.x(),c=a.y(),d=a.z();a=a.w();var e=this.x(),f=this.y(),g=this.z(),k=a*e+c*g-d*f,n=a*f+d*e-b*g,p=a*g+b*f-c*e;e=-b*e-c*f-d*g;this.setValue(k*a+e*-b+n*-d-p*-c,n*a+e*
-c+p*-b-k*-d,p*a+e*-d+k*-c-n*-b);return this},clone:function(){return f.vector3().set(this.x(),this.y(),this.z())},free:function(){f.freeVector3(this)}});Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(a,b,c,d){this.setValue(a,b,c,d);return this},fromArray:function(a,b){void 0===b&&(b=0);this.setValue(a[b],a[b+1],a[b+2],a[b+3]);return this},toArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z();a[b+
3]=this.w();return a},setFromAxisAngle:function(a,b){b*=.5;var c=Math.sin(b);this.setValue(a[0]*c,a[1]*c,a[2]*c,Math.cos(b));return this},setFromEuler:function(a){var b=a[0],c=a[1],d=a[2];a=a[3]||"XYZ";var e=Math.cos,f=Math.sin,g=e(.5*b),k=e(.5*c);e=e(.5*d);b=f(.5*b);c=f(.5*c);d=f(.5*d);if("XYZ"===a){var n=b*k*e+g*c*d;var p=g*c*e-b*k*d;var m=g*k*d+b*c*e;var h=g*k*e-b*c*d}else"YXZ"===a?(n=b*k*e+g*c*d,p=g*c*e-b*k*d,m=g*k*d-b*c*e,h=g*k*e+b*c*d):"ZXY"===a?(n=b*k*e-g*c*d,p=g*c*e+b*k*d,m=g*k*d+b*c*e,h=
g*k*e-b*c*d):"ZYX"===a?(n=b*k*e-g*c*d,p=g*c*e+b*k*d,m=g*k*d-b*c*e,h=g*k*e+b*c*d):"YZX"===a?(n=b*k*e+g*c*d,p=g*c*e+b*k*d,m=g*k*d-b*c*e,h=g*k*e-b*c*d):"XZY"===a&&(n=b*k*e-g*c*d,p=g*c*e-b*k*d,m=g*k*d+b*c*e,h=g*k*e+b*c*d);this.setValue(n,p,m,h);return this},toMatrix3:function(){var a=[],b=this.x(),c=this.y(),d=this.z(),e=this.w(),g=b*b,k=c*c,t=d*d,n=b*c,p=c*d,m=d*b;b*=e;c*=e;d*=e;a[0]=1-2*(k+t);a[1]=2*(n-d);a[2]=2*(m+c);a[3]=2*(n+d);a[4]=1-2*(t+g);a[5]=2*(p-b);a[6]=2*(m-c);a[7]=2*(p+b);a[8]=1-2*(g+k);
return f.matrix3().fromArray(a)},clone:function(){return f.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){f.freeQuaternion(this)}});Ammo.btMatrix3x3.prototype=Object.assign(Object.create(Ammo.btMatrix3x3.prototype),{set:function(a,b,c,d,e,g,f,k,n){var p=this.elements;p[0]=a;p[1]=d;p[2]=f;p[3]=b;p[4]=e;p[5]=k;p[6]=c;p[7]=g;p[8]=n;return this},transpose:function(){var a=this.elements;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this},fromArray:function(a,
b){void 0===b&&(b=0);for(var c=0;9>c;c++)this.elements[c]=a[c+b];return this},multiply:function(a){var b=this.row(0),c=this.row(1),d=this.row(2),e=a.column(0),g=a.column(1);a=a.column(2);var f=this.elements;f[0]=b.dot(e);f[1]=b.dot(g);f[2]=b.dot(a);f[3]=c.dot(e);f[4]=c.dot(g);f[5]=c.dot(a);f[6]=d.dot(e);f[7]=d.dot(g);f[8]=d.dot(a);b.free();c.free();d.free();e.free();g.free();a.free();return this},multiplyByVector3:function(a){var b=this.row(0),c=this.row(1),d=this.row(2);a=f.vector3().set(b.dot(a),
c.dot(a),d.dot(a));b.free();c.free();d.free();return a},toQuaternion:function(){var a=this.elements,b=a[0]+a[4]+a[8];if(0<b){var c=2*Math.sqrt(b+1);var d=.25*c;b=(a[7]-a[5])/c;var e=(a[2]-a[6])/c;a=(a[3]-a[1])/c}else a[0]>a[4]&&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),d=(a[7]-a[5])/c,b=.25*c,e=(a[1]+a[3])/c,a=(a[2]+a[6])/c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),d=(a[2]-a[6])/c,b=(a[1]+a[3])/c,e=.25*c,a=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),d=(a[3]-a[1])/c,b=(a[2]+a[6])/c,e=(a[5]+
a[7])/c,a=.25*c);return f.quaternion().set(b,e,a,d)},row:function(a){var b=this.elements;a*=3;return f.vector3().set(b[a],b[a+1],b[a+2])},column:function(a){var b=this.elements;return f.vector3().set(b[a],b[a+3],b[a+6])},free:function(){f.freeMatrix3(this)}})}function M(){this.ID=0;this.solids=[];this.bodys=[];this.trans=new Ammo.btTransform;this.zero=new Ammo.btVector3;this.zero.set(0,0,0)}function N(){this.ID=0;this.joints=[]}function O(){this.ID=0;this.softs=[]}function P(){this.ID=0;this.terrains=
[]}function Q(a,b){var c=f.transform(),d=f.vector3();this.needsUpdate=!1;this.dataHeap=this.tmpData=this.data=null;this.type="terrain";1!==g.scale&&(b.pos=f.vectomult(b.pos,g.invScale),b.size=f.vectomult(b.size,g.invScale));var e=void 0===b.size?[1,1,1]:b.size,k=void 0===b.sample?[64,64]:b.sample,r=void 0===b.pos?[0,0,0]:b.pos,t=void 0===b.quat?[0,0,0,1]:b.quat,n=void 0===b.mass?0:b.mass,p=void 0===b.margin?.02:b.margin,m=void 0===b.friction?.5:b.friction,h=void 0===b.restitution?0:b.restitution,
l=void 0===b.flag?1:b.flag,u=void 0===b.heightScale?1:b.heightScale,q=void 0===b.upAxis?1:b.upAxis,w=b.hdt||"PHY_FLOAT",y=void 0!==b.flipEdge?b.flipEdge:!1;this.setData(b.heightData);this.update();b=new Ammo.btHeightfieldTerrainShape(k[0],k[1],this.data,u,-e[1],e[1],q,w,y);d.set(e[0]/k[0],1,e[2]/k[1]);b.setLocalScaling(d);b.setMargin(p);c.identity().fromArray(r.concat(t));d.set(0,0,0);e=new Ammo.btDefaultMotionState(c);n=new Ammo.btRigidBodyConstructionInfo(n,e,b,d);n.set_m_friction(m);n.set_m_restitution(h);
m=new Ammo.btRigidBody(n);m.setCollisionFlags(l);this.name=m.name=a;this.body=m;Ammo.destroy(n);c.free();d.free()}function R(){this.ID=0;this.cars=[];this.trans=new Ammo.btTransform}function S(a,b,c){this.name=a;this.body=this.chassis=null;this.motor=this.breaking=this.steering=0;this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5];this.wheelBody=[];this.wheelJoint=[];this.isRay=!0;this.data={mass:100,wMass:1,radius:.5,wWidth:.25,nWheel:4,wPos:[1,0,1.6],engine:1E3,acceleration:10,steering:.3,breaking:100,incSteering:.04,
pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,auto:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6E3,s_length:.2,w_friction:10.5,w_roll:.1};this.init(b,c)}function T(){this.ID=0;this.heroes=[]}function U(a,b){this.name=a;this.controller=this.body=null;this.speed=this.angle=0;this.wasJumping=!1;this.verticalVelocity=0;this.angleInc=.1;this.q=new Ammo.btQuaternion;this.position=new Ammo.btVector3;this.init(b)}
function V(){this.ID=0;this.pairs=[]}function W(a,b,c){this.name=c;this.result=0;this.pa=[0,0,0];this.pb=[0,0,0];this.nb=[0,0,0];this.maxImpulse=this.impulse=this.distance=0;this.a=a;this.b=b;this.f=new Ammo.ConcreteContactResultCallback;this.f.addSingleResult=function(){this.result=1}.bind(this)}var f={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,eulerToQuadArray:function(a,b){b&&(a=f.vectomult(a,f.torad));a=f.quaternion().setFromEuler(a);b=a.toArray();a.free();return b},destroy:function(){for(;0<
f.T.length;)Ammo.destroy(f.T.pop());for(;0<f.Q.length;)Ammo.destroy(f.Q.pop());for(;0<f.V3.length;)Ammo.destroy(f.V3.pop());for(;0<f.M3.length;)Ammo.destroy(f.M3.pop())},transform:function(){return 0<f.T.length?f.T.pop():new Ammo.btTransform},freeTransform:function(a){f.T.push(a)},quaternion:function(){return 0<f.Q.length?f.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(a){f.Q.push(a)},vector3:function(){return 0<f.V3.length?f.V3.pop():new Ammo.btVector3},freeVector3:function(a){f.V3.push(a)},
matrix3:function(){return 0<f.M3.length?f.M3.pop():new Ammo.btMatrix3x3},freeMatrix3:function(a){f.M3.push(a)},vectomult:function(a,b){return a=a.map(function(a){return a*b})},distanceArray:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];a=b[2]-a[2];return Math.sqrt(c*c+d*d+a*a)}},g={Ar:null,ArPos:null,world:null,gravity:null,scale:1,invscale:1,key:[0,0,0,0,0,0,0,0],angle:0},k=new Map;Object.assign(M.prototype,{step:function(a,b){var c,d=this.trans,e=g.scale;this.bodys.forEach(function(g,f){c=b+8*f;a[c]=
9.8*g.getLinearVelocity().length();g.getMotionState().getWorldTransform(d);d.toArray(a,c+1,e)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){"solid"===a.type?g.world.removeCollisionObject(a):g.world.removeRigidBody(a);Ammo.destroy(a);k.delete(a.name)},remove:function(a){if(k.has(a)){a=k.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==c&&
(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a,b){var c=void 0!==a.name?a.name:"body"+this.ID++;this.remove(c);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);var d=void 0===a.mass?0:a.mass,e=a.kinematic||!1,v=f.vector3(),r=f.vector3(),t=f.vector3(),n=f.vector3(),p=f.transform();e&&(a.flag=2,a.state=4,void 0===a.group&&(a.group=4));a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?
[0,0,0,1]:a.quat;1!==g.scale&&(a.pos=f.vectomult(a.pos,g.invScale),a.size=f.vectomult(a.size,g.invScale));var m=null;switch(a.type){case "plane":n.fromArray(a.dir||[0,1,0]);m=new Ammo.btStaticPlaneShape(n,0);break;case "box":case "hardbox":case "realbox":case "realhardbox":n.setValue(.5*a.size[0],.5*a.size[1],.5*a.size[2]);m=new Ammo.btBoxShape(n);break;case "sphere":case "realsphere":m=new Ammo.btSphereShape(a.size[0]);break;case "cylinder":case "realcylinder":n.setValue(a.size[0],.5*a.size[1],.5*
a.size[2]);m=new Ammo.btCylinderShape(n);break;case "cone":case "realcone":m=new Ammo.btConeShape(a.size[0],.5*a.size[1]);break;case "capsule":m=new Ammo.btCapsuleShape(a.size[0],.5*a.size[1]);break;case "compound":m=new Ammo.btCompoundShape;for(var h,l,u=f.transform(),q=0;q<a.shapes.length;q++){h=a.shapes[q];1!==g.scale&&(h.pos=f.vectomult(h.pos,g.invScale),h.size=f.vectomult(h.size,g.invScale));u.identity().fromArray(h.pos.concat(h.quat));switch(h.type){case "box":case "hardbox":n.setValue(.5*h.size[0],
.5*h.size[1],.5*h.size[2]);l=new Ammo.btBoxShape(n);break;case "sphere":l=new Ammo.btSphereShape(h.size[0]);break;case "cylinder":case "hardcylinder":n.setValue(h.size[0],.5*h.size[1],.5*h.size[2]);l=new Ammo.btCylinderShape(n);break;case "cone":l=new Ammo.btConeShape(h.size[0],.5*h.size[1]);break;case "capsule":l=new Ammo.btCapsuleShape(h.size[0],.5*h.size[1])}m.addChildShape(u,l)}u.free();break;case "mesh":m=new Ammo.btTriangleMesh;h=a.v;q=0;for(l=h.length;q<l;q+=9)v.set(h[q+0]*a.size[0],h[q+1]*
a.size[1],h[q+2]*a.size[2]),r.set(h[q+3]*a.size[0],h[q+4]*a.size[1],h[q+5]*a.size[2]),t.set(h[q+6]*a.size[0],h[q+7]*a.size[1],h[q+8]*a.size[2]),m.addTriangle(v,r,t,!0);m=0===d?new Ammo.btBvhTriangleMeshShape(m,!0,!0):new Ammo.btConvexTriangleMeshShape(m,!0);break;case "convex":for(m=new Ammo.btConvexHullShape,h=a.v,q=0,l=h.length;q<l;q+=3)h[q]*=a.size[0],h[q+1]*=a.size[1],h[q+2]*=a.size[2],n.fromArray(h,q),m.addPoint(n)}void 0!==a.margin&&void 0!==m.setMargin&&m.setMargin(a.margin*g.invScale);if("isShape"==
b)return m;if("isGhost"==b)return c=new Ammo.btGhostObject,c.setCollisionShape(m),c.setCollisionFlags(a.flag||1),c;p.identity().fromArray(a.pos.concat(a.quat));v.setValue(0,0,0);0!==d&&m.calculateLocalInertia(d,v);b=new Ammo.btDefaultMotionState(p);m=new Ammo.btRigidBodyConstructionInfo(d,b,m,v);void 0!==a.friction&&m.set_m_friction(a.friction);void 0!==a.restitution&&m.set_m_restitution(a.restitution);void 0!==a.linear&&m.set_m_linearDamping(a.linear);void 0!==a.angular&&m.set_m_angularDamping(a.angular);
void 0!==a.rolling&&m.set_m_rollingFriction(a.rolling);b=new Ammo.btRigidBody(m);b.name=c;0!==d||e?(b.setCollisionFlags(a.flag||0),b.setActivationState(a.state||1),a.neverSleep&&b.setSleepingThresholds(0,0),g.world.addRigidBody(b,a.group||1,a.mask||-1),e&&(b.isKinematic=!0),b.type="body",this.bodys.push(b)):(b.setCollisionFlags(a.flag||1),g.world.addCollisionObject(b,a.group||2,a.mask||-1),b.type="solid",this.solids.push(b));b.breakable=void 0!==a.breakable?a.breakable:!1;b.breakable&&(b.breakOption=
void 0!==a.breakOption?a.breakOption:[250,1,2,1]);k.set(c,b);Ammo.destroy(m);this.applyOption(b,a);p.free();v.free();r.free();t.free();n.free()},applyOption:function(a,b){var c=f.vector3();void 0!==b.flag&&a.setCollisionFlags(b.flag);void 0!==b.state&&a.setActivationState(b.state);void 0!==b.group&&a.getBroadphaseProxy().set_m_collisionFilterGroup(b.group);void 0!==b.mask&&a.getBroadphaseProxy().set_m_collisionFilterMask(b.mask);void 0!==b.friction&&a.setFriction(b.friction);void 0!==b.restitution&&
a.setRestitution(b.restitution);void 0!==b.damping&&a.setDamping(b.damping[0],b.damping[1]);void 0!==b.rollingFriction&&a.setRollingFriction(b.rollingFriction);void 0!==b.sleeping&&a.setSleepingThresholds(b.sleeping[0],b.sleeping[1]);void 0!==b.linearVelocity&&a.setLinearVelocity(c.fromArray(b.linearVelocity));void 0!==b.angularVelocity&&a.setAngularVelocity(c.fromArray(b.angularVelocity));void 0!==b.linearFactor&&a.setLinearFactor(c.fromArray(b.linearFactor));void 0!==b.angularFactor&&a.setAngularFactor(c.fromArray(b.angularFactor));
void 0!==b.anisotropic&&a.setAnisotropicFriction(b.anisotropic[0],b.anisotropic[1]);void 0!==b.massProps&&a.setMassProps(b.massProps[0],b.massProps[1]);void 0!==b.gravity&&(b.gravity?a.setGravity(g.gravity):a.setGravity(this.zero));c.free()}});Object.assign(N.prototype,{step:function(a,b){this.joints.forEach(function(c,d){a[b+4*d]=c.ntype})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(a){g.world.removeConstraint(a);Ammo.destroy(a);k.delete(a.name)},
remove:function(a){if(k.has(a)){a=k.get(a);var b=this.joints.indexOf(a);-1!==b&&(this.joints.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"joint"+this.ID++;this.remove(b);a.body1&&(a.b1=a.body1);a.body2&&(a.b2=a.body2);if(k.has(a.b1)&&k.has(a.b2)){var c=k.get(a.b1),d=k.get(a.b2);c.activate();d.activate();var e=f.vector3().fromArray(a.pos1||[0,0,0]).multiplyScalar(g.invScale),v=f.vector3().fromArray(a.pos2||[0,0,0]).multiplyScalar(g.invScale),r=f.vector3().fromArray(a.axe1||
[1,0,0]),t=f.vector3().fromArray(a.axe2||[1,0,0]),n=f.transform().identity(),p=f.transform().identity();if("joint_p2p"!==a.type&&"joint_hinge"!==a.type&&"joint"!==a.type)if(void 0!==a.local?a.local:1)n.setOrigin(e),a.quatA?n.quaternionFromArray(a.quatA):a.axe1&&n.eulerFromArray(a.axe1),p.setOrigin(v),a.quatB?p.quaternionFromArray(a.quatB):a.axe2&&n.eulerFromArray(a.axe2);else{var m=f.transform();m.identity();m.setOrigin(e);m.eulerFromArray(a.axe1||[1,0,0]);c.getMotionState().getWorldTransform(n);
n.getInverse().multiply(m);m.identity();m.setOrigin(v);m.eulerFromArray(a.axe2||[1,0,0]);d.getMotionState().getWorldTransform(p);p.getInverse().multiply(m);m.free()}m=void 0!==a.useA?a.useA:!0;switch(a.type){case "joint_p2p":var h=1;var l=new Ammo.btPoint2PointConstraint(c,d,e,v);a.strength&&l.get_m_setting().set_m_tau(a.strength);a.damping&&l.get_m_setting().set_m_damping(a.damping);a.impulse&&l.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":h=2;l=new Ammo.btHingeConstraint(c,
d,e,v,r,t,m);break;case "joint_hinge_ref":h=2;l=new Ammo.btHingeConstraint(c,d,n,p,m);break;case "joint_slider":h=3;l=new Ammo.btSliderConstraint(c,d,n,p,m);break;case "joint_conetwist":h=4;l=new Ammo.btConeTwistConstraint(c,d,n,p);break;case "joint_dof":h=5;l=new Ammo.btGeneric6DofConstraint(c,d,n,p,m);break;case "joint_spring_dof":h=6;l=new Ammo.btGeneric6DofSpringConstraint(c,d,n,p,m);break;case "joint_fixe":h=7,l=new Ammo.btFixedConstraint(c,d,n,p)}a.breaking&&l.setBreakingImpulseThreshold&&l.setBreakingImpulseThreshold(a.breaking);
a.limit&&l.setLimit&&("joint_hinge"!==a.type&&"joint"!==a.type||l.setLimit(a.limit[0]*f.torad,a.limit[1]*f.torad,a.limit[2]||.9,a.limit[3]||.3,a.limit[4]||1),"joint_conetwist"===a.type&&(l.setLimit(3,a.limit[0]*f.torad),l.setLimit(4,a.limit[2]*f.torad),l.setLimit(5,a.limit[1]*f.torad)));a.motor&&l.enableAngularMotor&&l.enableAngularMotor(a.motor[0],a.motor[1],a.motor[2]);l.setLowerLinLimit&&(a.linLower&&l.setLowerLinLimit(a.linLower*g.invScale),a.linUpper&&l.setUpperLinLimit(a.linUpper*g.invScale));
l.setLowerAngLimit&&(a.angLower&&l.setLowerAngLimit(a.angLower*f.torad),a.angUpper&&l.setUpperAngLimit(a.angUpper*f.torad));l.setLinearLowerLimit&&(a.linLower&&l.setLinearLowerLimit(e.fromArray(a.linLower).multiplyScalar(g.invScale)),a.linUpper&&l.setLinearUpperLimit(v.fromArray(a.linUpper).multiplyScalar(g.invScale)));l.setAngularLowerLimit&&(a.angLower&&l.setAngularLowerLimit(r.set(a.angLower[0]*f.torad,a.angLower[1]*f.torad,a.angLower[2]*f.torad)),a.angUpper&&l.setAngularUpperLimit(t.set(a.angUpper[0]*
f.torad,a.angUpper[1]*f.torad,a.angUpper[2]*f.torad)));a.feedback&&l.enableFeedback(a.feedback);a.angularOnly&&l.setAngularOnly&&l.setAngularOnly(a.angularOnly);a.enableMotor&&l.enableMotor&&l.enableMotor(a.enableMotor);a.maxMotorImpulse&&l.setMaxMotorImpulse&&l.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&l.setMotorTarget&&(c=f.quaternion().fromArray(a.motorTarget),l.setMotorTarget(c),c.free());if(a.damping&&l.setDamping)for(c=0;6>c;c++)l.setDamping(c,a.damping[c]);if(a.spring&&l.enableSpring&&
l.setStiffness)for(c=0;6>c;c++)l.enableSpring(c,0===a.spring[c]?!1:!0),l.setStiffness(c,a.spring[c]);if(a.param&&l.setParam)for(c=0,d=a.param.length;c<d;c++)l.setParam(a.param[c][0],a.param[c][1],c);a=void 0!==a.collision?a.collision:!1;l.isJoint=!0;l.name=b;l.nType=h;l.type="joint";g.world.addConstraint(l,a?!1:!0);this.joints.push(l);k.set(b,l);e.free();v.free();r.free();t.free();n.free();p.free()}}});Object.assign(O.prototype,{step:function(a,b){var c=b,d,e,f;this.softs.forEach(function(b){e=b.get_m_nodes();
for(f=e.size();f--;)d=c+3*f,e.at(f).get_m_x().toArray(a,d,g.scale);c+=3*e.size()})},getNodes:function(a){var b=[];a=a.get_m_nodes();for(var c,d=a.size(),e=0;e<d;e++)c=a.at(e).get_m_x().toArray(),300<c[1]&&b.push(e);return b},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){g.world.removeSoftBody(a);Ammo.destroy(a);k.delete(a.name)},remove:function(a){if(k.has(a)){a=k.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},
addAreo:function(a){if(k.has(a.soft)){for(var b=k.get(a.soft),c=f.vector3().fromeArray(a.wind),d=a.nodes.length;d--;)b.addAeroForceToNode(c,a.nodes[d]);c.free()}},addAnchor:function(a){if(k.has(a.soft)&&k.has(a.body))for(var b=a.collision||!1,c=k.get(a.soft),d=k.get(a.body),e=a.nodes.length;e--;)c.appendAnchor(a.nodes[e],d,b?!1:!0,a.influence||1)},add:function(a){var b=void 0!==a.name?a.name:"soft"+this.ID++;this.remove(b);var c=g.world.getWorldInfo(),d=a.gendiags||!0;a.size=void 0==a.size?[1,1,1]:
a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;a.div=void 0==a.div?[64,64]:a.div;1!==g.scale&&(a.pos=f.vectomult(a.pos,g.invScale),a.size=f.vectomult(a.size,g.invScale));var e=f.vector3(),v=f.vector3(),r=f.vector3(),t=f.vector3(),n=f.vector3(),p=f.transform(),m=new Ammo.btSoftBodyHelpers;switch(a.type){case "softCloth":var h=.5*a.size[0];var l=.5*a.size[2];v.fromArray([-h,0,-l],0,g.invScale);r.fromArray([h,0,-l],0,g.invScale);t.fromArray([-h,0,l],0,g.invScale);n.fromArray([h,
0,l],0,g.invScale);h=m.CreatePatch(c,v,r,t,n,a.div[0],a.div[1],a.fixed||0,d);h.softType=1;break;case "softRope":v.fromArray(a.start||[-10,0,0],0,g.invScale);r.fromArray(a.end||[10,0,0],0,g.invScale);h=m.CreateRope(c,v,r,(a.numSegment||10)-2,a.fixed||0);h.softType=2;break;case "softEllips":v.fromArray(a.center||[0,0,0],0,g.invScale);r.fromArray(a.radius||[3,3,3],0,g.invScale);h=m.CreateEllipsoid(c,v,r,a.vertices||128);h.softType=3;c=[];m=h.get_m_nodes();d=m.size();for(var u;d--;)l=3*d,u=m.at(d),u=
u.get_m_x(),c[l]=u.x(),c[l+1]=u.y(),c[l+2]=u.z();a.lng=m.size();a.a=c;self.postMessage({m:"ellipsoid",o:a});break;case "softMesh":case "softConvex":for(d=a.v.length;d--;)a.v[d]*=g.invScale;h=m.CreateFromTriMesh(c,a.v,a.i,a.ntri,a.randomize||!0);h.softType=5}d=h.get_m_cfg();void 0!==a.viterations&&d.set_viterations(a.viterations);void 0!==a.piterations&&d.set_piterations(a.piterations);void 0!==a.diterations&&d.set_diterations(a.diterations);void 0!==a.citerations&&d.set_citerations(a.citerations);
d.set_collisions(17);void 0!==a.friction&&d.set_kDF(a.friction);void 0!==a.damping&&d.set_kDP(a.damping);void 0!==a.pressure&&d.set_kPR(a.pressure);void 0!==a.drag&&d.set_kDG(a.drag);void 0!==a.lift&&d.set_kLF(a.lift);void 0!==a.volume&&d.set_kVC(a.volume);void 0!==a.matching&&d.set_kMT(a.matching);void 0!==a.hardness&&(d.set_kCHR(a.hardness),d.set_kKHR(a.hardness),d.set_kSHR(a.hardness),d.set_kAHR(a.hardness));void 0!==a.timescale&&d.set_timescale(a.timescale);void 0!==a.maxvolume&&d.set_maxvolume(a.maxvolume);
d=h.get_m_materials().at(0);void 0!==a.stiffness&&(d.set_m_kLST(a.stiffness),d.set_m_kAST(a.stiffness),d.set_m_kVST(a.stiffness));void 0!==a.bendingConstraint&&h.generateBendingConstraints(a.bendingConstraint,d);h.setTotalMass(a.mass||0,a.fromfaces||!1);void 0!==a.cluster&&h.generateClusters(a.cluster,a.maxClusterIterations||8192);void 0!==a.restitution&&h.setRestitution(a.restitution);void 0!==a.rolling&&h.setRollingFriction(a.rolling);void 0!==a.flag&&h.setCollisionFlags(a.flag);void 0!==a.margin&&
Ammo.castObject(h,Ammo.btCollisionObject).getCollisionShape().setMargin(a.margin*g.invScale);p.identity().fromArray(a.pos.concat(a.quat));h.transform(p);g.world.addSoftBody(h,a.group||1,a.mask||-1);h.setActivationState(a.state||4);h.points=h.get_m_nodes().size();h.name=b;h.type="soft";this.softs.push(h);k.set(b,h);e.free();v.free();r.free();t.free();n.free();p.free()}});Object.assign(P.prototype,{step:function(){this.terrains.forEach(function(a){a.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());
this.ID=0},destroy:function(a){g.world.removeCollisionObject(a.body);a.clear();k.delete(a.name)},remove:function(a){if(k.has(a)){a=k.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},setData:function(a){k.has(a.name)&&k.get(a.name).setData(a.heightData)},add:function(a){var b=void 0!==a.name?a.name:"terrain"+this.ID++;this.remove(b);var c=void 0===a.group?2:a.group,d=void 0===a.mask?-1:a.mask;a=new Q(b,a);g.world.addCollisionObject(a.body,c,d);this.terrains.push(a);
k.set(b,a)}});Object.assign(Q.prototype,{setData:function(a){this.tmpData=a;this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT;this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body);Ammo._free(this.dataHeap.byteOffset);this.dataHeap=this.tmpData=this.data=this.body=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,
this.data,this.nDataBytes);this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}});Object.assign(R.prototype,{step:function(a,b){var c,d=this.trans;this.cars.forEach(function(e,g){c=b+56*g;e.step(a,c,d)})},control:function(a){k.has(a)&&k.get(a).drive(g.key)},setData:function(a){k.has(a.name)&&k.get(a.name).setData(a)},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){g.world.removeRigidBody(a.body);g.world.removeAction(a.chassis);Ammo.destroy(a.body);
Ammo.destroy(a.chassis);k.delete(a.name);k.delete(a.name+"_body");k.delete(a.name+"_chassis")},remove:function(a){if(k.has(a)){a=k.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},addExtra:function(){},add:function(a){var b=void 0!==a.name?a.name:"car"+this.ID++;this.remove(b);a.size=void 0===a.size?[2,.5,4]:a.size;void 0!==a.pos&&(a.pos=f.vectomult(a.pos,g.invScale));void 0!==a.size&&(a.size=f.vectomult(a.size,g.invScale));void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,
g.invScale));var c=a.shapeType||"box";c=this.addExtra("mesh"==c?{type:"mesh",v:a.v,mass:1}:"convex"==c?{type:"convex",v:a.v}:{type:"box",size:a.size},"isShape");void 0!==a.v&&delete a.v;a=new S(b,a,c);g.world.addAction(a.chassis);g.world.addRigidBody(a.body);this.cars.push(a);k.set(b,a);k.set(b+"_body",a.body);k.set(b+"_chassis",a.chassis)}});Object.assign(S.prototype,{step:function(a,b,c){var d=g.scale;a[b]=this.chassis.getCurrentSpeedKmHour();this.body.getMotionState().getWorldTransform(c);c.toArray(a,
b+1,d);c=this.data.nWheel;if(4===c){var e=40;a[b+e+0]=this.chassis.getWheelInfo(0).get_m_raycastInfo().get_m_suspensionLength()*d;a[b+e+1]=this.chassis.getWheelInfo(1).get_m_raycastInfo().get_m_suspensionLength()*d;a[b+e+2]=this.chassis.getWheelInfo(2).get_m_raycastInfo().get_m_suspensionLength()*d;a[b+e+3]=this.chassis.getWheelInfo(3).get_m_raycastInfo().get_m_suspensionLength()*d}for(;c--;){this.chassis.updateWheelTransform(c,!0);var f=this.chassis.getWheelTransformWS(c);e=8*(c+1);f.toArray(a,b+
e+1,d);0===c&&(a[b+e]=this.chassis.getWheelInfo(0).get_m_steering())}},drive:function(a){var b=this.data;this.steering-=b.incSteering*a[0];this.steering<-b.steering&&(this.steering=-b.steering);this.steering>b.steering&&(this.steering=b.steering);this.steering*=.9;this.motor-=b.acceleration*a[1];this.motor>b.engine&&(this.motor=b.engine);this.motor<-b.engine&&(this.motor=-b.engine);0==a[1]&&(1<this.motor?this.motor*=.9:-1>this.motor?this.motor*=.9:(this.motor=0,this.breaking=b.breaking));var c=2*
this.wpos[2],d=this.wpos[0],e=c/Math.tan(this.steering);a=Math.atan2(c,d+e);c=Math.atan2(c,-d+e);0>e&&(a-=Math.PI,c-=Math.PI);for(e=b.nWheel;e--;)0==e&&this.chassis.setSteeringValue(c,e),2!==b.nWheel&&1==e&&this.chassis.setSteeringValue(a,e),this.chassis.applyEngineForce(this.motor,e),this.chassis.setBrake(this.breaking,e)},clear:function(){this.chassis=this.body=null},init:function(a,b){var c=this.data,d=f.transform(),e=f.vector3(),k=f.vector3(),r=f.vector3(),t=f.vector3();this.isRay=void 0===a.isRay?
!0:a.isRay;c.mass=void 0===a.mass?800:a.mass;a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;c.pos=void 0===a.pos?[0,0,0]:a.pos;c.quat=void 0===a.quat?[0,0,0,1]:a.quat;e.fromArray(a.masscenter).negate();d.setIdentity();d.setOrigin(e);var n=new Ammo.btCompoundShape;n.addChildShape(d,b);d.identity().fromArray(c.pos.concat(c.quat));e.setValue(0,0,0);n.calculateLocalInertia(c.mass,e);var p=new Ammo.btDefaultMotionState(d);b=new Ammo.btRigidBodyConstructionInfo(c.mass,p,n,e);this.body=new Ammo.btRigidBody(b);
this.body.name=this.name+"_body";this.body.isRigidBody=!0;this.body.isBody=!0;this.body.setActivationState(4);Ammo.destroy(b);if(this.isRay){var m=new Ammo.btVehicleTuning;n=new Ammo.btDefaultVehicleRaycaster(g.world);this.chassis=new Ammo.btRaycastVehicle(m,this.body,n);this.chassis.setCoordinateSystem(0,1,2)}n=a.radius||.4;var h=a.wPos||[1,0,1.6];h=f.vectomult(h,g.invScale);n*=g.invScale;h[1]-=a.masscenter[1];for(var l=a.nWheel||4,u,q,w=0;w<l;w++)2===w&&h[4]&&(h[0]+=h[4]),0===w&&(u=[h[0],h[1],h[2]],
q=!0),1===w&&(u=[-h[0],h[1],h[2]],q=!0),2===w&&(u=[-h[0],h[1],-h[2]],q=!1),3===w&&(u=[h[0],h[1],-h[2]],q=!1),4===w&&(u=[-h[0],h[1],-h[3]],q=!1),5===w&&(u=[h[0],h[1],-h[3]],q=!1),2===l&&1==w&&(u=[-h[0],h[1],-h[2]],q=!1),k.fromArray(u),r.setValue(0,-1,0),t.setValue(-1,0,0),this.isRay?(this.chassis.addWheel(k,r,t,1,n,m,q),this.chassis.setBrake(a.breaking||100,w)):(d.identity(),d.setOrigin(k),r.setValue(c.wWidth*g.invScale,n,n),b=new Ammo.btCylinderShape(r),e.setValue(0,0,0),b.calculateLocalInertia(c.wMass,
e),p=new Ammo.btDefaultMotionState(d),b=new Ammo.btRigidBodyConstructionInfo(c.wMass,p,b,e),b=new Ammo.btRigidBody(b),b.setFriction(1110),b.setActivationState(4),g.world.addRigidBody(b,1,-1),this.wheelBody[w]=b,b=new Ammo.btHingeConstraint(this.body,b,k,e,r,t,!1),g.world.addConstraint(b,!1),this.wheelJoint[w]=b);this.wpos=h;this.setData(a);d.free();e.free();k.free();r.free();t.free()},setMass:function(a){var b=f.vector3();this.data.mass=a;b.setValue(0,0,0);this.body.getCollisionShape().calculateLocalInertia(this.data.mass,
b);this.body.setMassProps(a,b);this.body.updateInertiaTensor();b.free()},setPosition:function(){this.motor=this.breaking=this.steering=0;var a=f.transform();a.identity().fromArray(this.data.pos.concat(this.data.quat));var b=f.vector3().set(0,0,0);this.body.setAngularVelocity(b);this.body.setLinearVelocity(b);this.body.setWorldTransform(a);this.chassis.resetSuspension();for(var c=this.data.nWheel;c--;)this.chassis.updateWheelTransform(c,!0);a.free();b.free()},setData:function(a){var b=this.data;void 0!==
a.mass&&a.mass!==b.mass&&this.setMass(a.mass);for(var c in a)b[c]&&(b[c]=a[c]);this.body.setFriction(b.friction);this.body.setRestitution(b.restitution);this.body.setDamping(b.linear,b.angular);b.auto&&(c=Math.sqrt(b.s_stiffness),b.s_compression=2*b.compValue*c,b.s_damping=2*b.dampValue*c);c=b.nWheel;for(var d;c--;)d=this.chassis.getWheelInfo(c),d.set_m_suspensionStiffness(b.s_stiffness),d.set_m_wheelsDampingCompression(b.s_compression),d.set_m_wheelsDampingRelaxation(b.s_damping),d.set_m_maxSuspensionTravelCm(100*
b.s_travel*g.invScale),d.set_m_maxSuspensionForce(b.s_force),d.set_m_suspensionRestLength1(b.s_length*g.invScale),d.set_m_rollInfluence(b.w_roll),d.set_m_frictionSlip(b.w_friction),d.set_m_wheelsRadius(b.radius*g.invScale);a.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}});Object.assign(T.prototype,{step:function(a,b){var c;this.heroes.forEach(function(d,e){c=b+8*e;d.step(a,c)})},control:function(a){k.has(a)&&(a=k.get(a),a.move(g.key),a.setAngle(g.angle))},
clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){g.world.removeCollisionObject(a.body);g.world.removeAction(a.controller);a.clear();k.delete(a.name)},remove:function(a){if(k.has(a)){a=k.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"hero"+this.ID++;this.remove(b);var c=new U(b,a);c.controller.setGravity(g.gravity);g.world.addCollisionObject(c.body,a.group||
1,a.mask||-1);g.world.addAction(c.controller);this.heroes.push(c);k.set(b,c)}});Object.assign(U.prototype,{step:function(a,b){a[b]=this.speed;var c=this.body.getWorldTransform(),d=c.getOrigin();c=c.getRotation();a[b+1]=d.x();a[b+2]=d.y();a[b+3]=d.z();a[b+4]=c.x();a[b+5]=c.y();a[b+6]=c.z();a[b+7]=c.w()},move:function(a){1==a[4]&&this.controller.onGround()&&(this.wasJumping=!0,this.verticalVelocity=0);this.wasJumping&&(this.verticalVelocity+=.04,1.3<this.verticalVelocity&&(this.verticalVelocity=0,this.wasJumping=
!1));var b=.3*-a[1];var c=.3*-a[0];this.speed=b+c;this.angle-=.1*a[2];this.setAngle(this.angle);this.position.setValue(c,0+this.verticalVelocity,b);this.position.direction(this.q);this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body);Ammo.destroy(this.controller);this.controller=this.body=null},init:function(a){var b=f.vector3(),c=f.transform();a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var d=new Ammo.btCapsuleShape(a.size[0],
.5*a.size[1]),e=new Ammo.btPairCachingGhostObject;e.setCollisionShape(d);e.setCollisionFlags(16);c.identity().fromArray(a.pos.concat(a.quat));e.setWorldTransform(c);e.setFriction(a.friction||.1);e.setRestitution(a.restitution||0);e.setActivationState(4);e.activate();c=new Ammo.btKinematicCharacterController(e,d,a.stepH||.35,a.upAxis||1);c.setUseGhostSweepTest(d);c.setFallSpeed(30);c.setMaxJumpHeight(200);c.setJumpSpeed(1E3);a.slopeRadians&&c.setMaxSlope(a.slopeRadians);b.setValue(0,0,0);c.setVelocityForTimeInterval(b,
1);this.body=e;this.controller=c},setAngle:function(a){var b=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],a);b.setRotation(this.q);this.angle=a}});Object.assign(V.prototype,{step:function(a,b){var c;this.pairs.forEach(function(d,e){c=b+e;d.result=0;void 0!==d.b?g.world.contactPairTest(d.a,d.b,d.f):g.world.contactTest(d.a,d.f);a[c]=d.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(a){a.clear();k.delete(a.name)},remove:function(a){if(k.has(a)){a=
k.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;if(k.has(a.b1)){var c=k.get(a.b1);a=void 0!==a.b2?k.has(a.b2)?k.get(a.b2):void 0:void 0;c=new W(c,a,b);this.pairs.push(c);k.set(b,c)}}});Object.assign(W.prototype,{clear:function(){this.b=this.a=null;Ammo.destroy(this.f)}});self.Module={TOTAL_MEMORY:268435456};self.onmessage=function(a){a.data.Ar&&y.engine.setAr(a.data.Ar);y.engine[a.data.m](a.data.o)};
y.engine=function(){var a,b,c,d=1/60,e=!1,v=2,r=!1,t=!1,n,p,m,h,l,u=[],q=[],w=[],E=[],J="",K="",G=null,L=0,x=null,z,B,H,C,A,F,I;y.engine={test:function(){},setAr:function(b){a=b},getAr:function(){return a},setKey:function(a){g.key=a},setDrive:function(a){J=a},setMove:function(a){K=a},setAngle:function(a){g.angle=a.angle},step:function(c){g.key=c.key;this.stepRemove();A.control(J);F.control(K);this.stepMatrix();this.stepOption();this.stepForces();C.step();0!==L&&this.stepBreak();e?g.world.stepSimulation(c.delta,
v,d):g.world.stepSimulation(c.delta,v);z.step(a,b[0]);I.step(a,b[1]);F.step(a,b[2]);A.step(a,b[3]);B.step(a,b[4]);r?self.postMessage({m:"step",Ar:a},[a.buffer]):self.postMessage({m:"step",Ar:a})},reset:function(b){L=0;K=J="";u=[];q=[];w=[];E=[];z.clear();H.clear();B.clear();C.clear();A.clear();F.clear();I.clear();k.clear();f.destroy();b.full&&(this.clearWorld(),this.createWorld());this.setGravity();r||(a=new Float32Array(c));self.postMessage({m:"start"})},addMulty:function(a){for(var b=0,c=a.length;b<
c;b++)this.add(a[b])},init:function(d){r=d.isBuffer||!1;b=d.ArPos;c=d.ArMax;r||(a=new Float32Array(c));importScripts(d.blob);Ammo().then(function(a){D();y.engine.createWorld(d.option);y.engine.set(d.option);z=new M;H=new N;B=new O;C=new P;A=new R;F=new T;I=new V;x=new a.ClosestRayResultCallback;A.addExtra=z.add;self.postMessage({m:"initEngine"})})},remove:function(a){if(k.has(a))switch(k.get(a).type){case "solid":case "body":z.remove(a);break;case "soft":B.remove(a);break;case "terrain":C.remove(a);
break;case "joint":H.remove(a)}},add:function(a){a.type=void 0===a.type?"box":a.type;void 0!==a.breakable&&a.breakable&&L++;var b=a.type,c=a.type.substring(0,4);"join"===c?H.add(a):"soft"===c||"ellipsoid"===b?B.add(a):"terrain"===b?C.add(a):"character"===b?F.add(a):"collision"===b?I.add(a):"car"===b?A.add(a):z.add(a)},addAnchor:function(a){B.addAnchor(a)},setTerrain:function(a){C.setData(a)},setVehicle:function(a){A.setData(a)},createWorld:function(a){if(null!==g.world)console.error("World already existe !!");
else{a=a||{};G=new Ammo.btVector3;G.set(0,0,0);t=void 0===a.soft?!0:a.soft;n=new Ammo.btSequentialImpulseConstraintSolver;p=t?new Ammo.btDefaultSoftBodySolver:null;m=t?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;h=new Ammo.btCollisionDispatcher(m);switch(void 0===a.broadphase?2:a.broadphase){case 1:l=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,1E3,1E3),4096);break;case 2:l=new Ammo.btDbvtBroadphase}g.world=t?new Ammo.btSoftRigidDynamicsWorld(h,
l,n,m,p):new Ammo.btDiscreteDynamicsWorld(h,l,n,m)}},clearWorld:function(){Ammo.destroy(g.world);Ammo.destroy(n);null!==p&&Ammo.destroy(p);Ammo.destroy(m);Ammo.destroy(h);Ammo.destroy(l);g.world=null},setWorldscale:function(a){g.scale=a;g.invScale=1/a},setGravity:function(a){a=a||{};g.gravity=new Ammo.btVector3;g.gravity.fromArray(void 0!==a.gravity?a.gravity:[0,-9.81,0]);g.world.setGravity(g.gravity);t&&g.world.getWorldInfo().set_m_gravity(g.gravity)},set:function(a){a=a||{};this.setWorldscale(void 0!==
a.worldscale?a.worldscale:1);d=void 0!==a.fps?1/a.fps:1/60;v=void 0!==a.substep?a.substep:2;e=void 0!==a.fixed?a.fixed:!1;void 0!==a.penetration&&g.world.getDispatchInfo().set_m_allowedCcdPenetration(a.penetration);this.setGravity(a)},setForces:function(a){u=u.concat(a)},stepForces:function(){for(;0<u.length;)this.applyForces(u.pop())},applyForces:function(a){if(k.has(a.name)){var b=k.get(a.name),c=f.vector3(),d=f.vector3();void 0!==a.direction&&c.fromArray(f.vectomult(a.direction,g.invScale));void 0!==
a.distance?d.fromArray(f.vectomult(a.distance,g.invScale)):d.zero();switch(a.type){case "force":case 0:b.applyForce(c,d);break;case "torque":case 1:b.applyTorque(c);break;case "localTorque":case 2:b.applyLocalTorque(c);break;case "forceCentral":case 3:b.applyCentralForce(c);break;case "forceLocal":case 4:b.applyCentralLocalForce(c);break;case "impulse":case 5:b.applyImpulse(c,d);break;case "impulseCentral":case 6:b.applyCentralImpulse(c);break;case "motor":case 7:b.enableAngularMotor(a.enable||!0,
a.targetVelocity,a.maxMotor)}c.free();d.free()}},setMatrix:function(a){q=q.concat(a)},stepMatrix:function(){for(;0<q.length;)this.applyMatrix(q.pop())},applyMatrix:function(a){if(k.has(a.name)){var b=k.get(a.name),c=f.transform();if(a.keepX||a.keepY||a.keepZ||a.keepRot){b.getMotionState().getWorldTransform(c);var d=[];c.toArray(d);void 0!==a.keepX&&(a.pos[0]=d[0]-a.pos[0]);void 0!==a.keepY&&(a.pos[1]=d[1]-a.pos[1]);void 0!==a.keepZ&&(a.pos[2]=d[2]-a.pos[2]);void 0!==a.keepRot&&(a.quat=[d[3],d[4],
d[5],d[6]])}c.identity();void 0!==a.pos&&(void 0!==a.rot&&(a.quat=f.eulerToQuadArray(a.rot,!0)),void 0!==a.quat&&(a.pos=a.pos.concat(a.quat)),c.fromArray(a.pos,0,g.invScale));a.noVelocity&&(b.setAngularVelocity(G),b.setLinearVelocity(G));b.isKinematic?b.getMotionState().setWorldTransform(c):b.setWorldTransform(c);"body"===b.type&&b.activate();"solid"===b.type&&self.postMessage({m:"moveSolid",o:{name:a.name,pos:f.vectomult(a.pos,g.scale),quat:a.quat}});c.free()}},setOption:function(a){w=w.concat(a)},
stepOption:function(){for(;0<w.length;)this.applyOption(w.pop())},applyOption:function(a){if(k.has(a.name)){var b=k.get(a.name);switch(b.type){case "solid":case "body":z.applyOption(b,a)}}},setRemove:function(a){E=E.concat(a)},stepRemove:function(){for(;0<E.length;)this.remove(E.pop())},stepBreak:function(){for(var a,b,c,d,e,k,l,m,n,p,q=0,r=h.getNumManifolds();q<r;q++)if(a=h.getManifoldByIndexInternal(q),n=Ammo.castObject(a.getBody0(),Ammo.btRigidBody),p=Ammo.castObject(a.getBody1(),Ammo.btRigidBody),
l=n.name,m=p.name,n.breakable||p.breakable){c=!1;for(var t=d=0,u=a.getNumContacts();t<u;t++)if(b=a.getContactPoint(t),0>b.getDistance()){c=!0;a=b.getAppliedImpulse();a>d&&(d=a,e=b.get_m_positionWorldOnB().toArray(),k=b.get_m_normalWorldOnB().toArray());break}c&&(n.breakable&&d>n.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:l,pos:f.vectomult(e,g.scale),normal:k,breakOption:n.breakOption}}),p.breakable&&d>p.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:m,pos:f.vectomult(e,g.scale),
normal:k,breakOption:p.breakOption}}))}},rayCast:function(a){for(var b=[],c,d=0,e=a.length;d<e;d++){c=a[d];x.set_m_closestHitFraction(1);x.set_m_collisionObject(null);void 0!==c.origin&&x.get_m_rayFromWorld().fromArray(c.origin,0,g.invScale);void 0!==c.dest&&x.get_m_rayToWorld().fromArray(c.dest,0,g.invScale);void 0!==c.group&&x.set_m_collisionFilterGroup(c.group);void 0!==c.mask&&x.set_m_collisionFilterMask(c.mask);g.world.rayTest(x.get_m_rayFromWorld(),x.get_m_rayToWorld(),x);if(x.hasHit()){c=Ammo.castObject(x.get_m_collisionObject(),
Ammo.btRigidBody).name;void 0===c&&(c=Ammo.castObject(x.get_m_collisionObject(),Ammo.btSoftBody).name);var f=x.get_m_hitNormalWorld();f.normalize();c={hit:!0,name:c,point:x.get_m_hitPointWorld().toArray(void 0,0,g.scale),normal:f.toArray()}}else c={hit:!1};b.push(c)}self.postMessage({m:"rayCast",o:b})}};return y.engine}();Object.defineProperty(y,"__esModule",{value:!0})});
