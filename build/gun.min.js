(function(x,C){"object"===typeof exports&&"undefined"!==typeof module?C(exports):"function"===typeof define&&define.amd?define(["exports"],C):(x=x||self,C(x.GUN={}))})(this,function(x){function C(){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){this.setIdentity();return this},positionFromArray:function(a,b,c){b=b||0;a=e.vector3().fromArray(a,b,c);this.setOrigin(a);a.free();return this},eulerFromArray:function(a,b){b=b||0;a=e.quaternion().setFromEuler(a,
b);this.setRotation(a);a.free();return this},quaternionFromArray:function(a,b){b=b||0;a=e.quaternion().fromArray(a,b);this.setRotation(a);a.free();return this},fromArray:function(a,b,c){b=b||0;this.positionFromArray(a,b,c);3<a.length&&this.quaternionFromArray(a,b+3);return this},toArray:function(a,b,c){b=b||0;this.getOrigin().toArray(a,b,c);this.getRotation().toArray(a,b+3)},getInverse:function(){var a=e.transform();a.setIdentity();var b=this.getRotation().toMatrix3().transpose(),c=this.getOrigin().clone().negate(),
d=b.multiplyByVector3(c),m=b.toQuaternion();a.setOrigin(d);a.setRotation(m);c.free();d.free();m.free();b.free();return a},multiply:function(a){var b=this.getRotation().toMatrix3(),c=a.getRotation().toMatrix3(),d=this.getOrigin().clone();a=a.getOrigin().clone();var m=b.multiplyByVector3(a).add(d);this.setOrigin(m);b.multiply(c);var f=b.toQuaternion();this.setRotation(f);b.free();c.free();d.free();a.free();f.free();m.free();return this},clone:function(){var a=e.transform();a.setIdentity();a.setOrigin(this.getOrigin());
a.setRotation(this.getRotation());return a},free:function(){e.freeTransform(this)}});Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(a,b,c){this.setValue(a,b,c);return this},zero:function(){this.setValue(0,0,0);return this},negate:function(){this.setValue(-this.x(),-this.y(),-this.z());return this},add:function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this},sub:function(a){this.setValue(this.x()-a.x(),this.y()-a.y(),this.z()-
a.z());return this},dot:function(a){return this.x()*a.x()+this.y()*a.y()+this.z()*a.z()},multiplyScalar:function(a){this.setValue(this.x()*a,this.y()*a,this.z()*a);return this},multiplyArray:function(a){this.setValue(this.x()*a[0],this.y()*a[1],this.z()*a[2]);return this},fromArray:function(a,b,c){b=b||0;c=c||1;this.setValue(a[b]*c,a[b+1]*c,a[b+2]*c);return this},toArray:function(a,b,c){void 0===a&&(a=[]);void 0===b&&(b=0);c=c||1;a[b]=this.x()*c;a[b+1]=this.y()*c;a[b+2]=this.z()*c;return a},direction:function(a){var b=
a.x(),c=a.y(),d=a.z();a=a.w();var m=this.x(),f=this.y(),e=this.z(),g=a*m+c*e-d*f,n=a*f+d*m-b*e,r=a*e+b*f-c*m;m=-b*m-c*f-d*e;this.setValue(g*a+m*-b+n*-d-r*-c,n*a+m*-c+r*-b-g*-d,r*a+m*-d+g*-c-n*-b);return this},clone:function(){return e.vector3().set(this.x(),this.y(),this.z())},free:function(){e.freeVector3(this)}});Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(a,b,c,d){this.setValue(a,b,c,d);return this},fromArray:function(a,b){void 0===b&&(b=0);
this.setValue(a[b],a[b+1],a[b+2],a[b+3]);return this},toArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z();a[b+3]=this.w();return a},setFromAxisAngle:function(a,b){b*=.5;var c=Math.sin(b);this.setValue(a[0]*c,a[1]*c,a[2]*c,Math.cos(b));return this},setFromEuler:function(a){var b=a[0],c=a[1],d=a[2];a=a[3]||"XYZ";var m=Math.cos,f=Math.sin,e=m(.5*b),g=m(.5*c);m=m(.5*d);b=f(.5*b);c=f(.5*c);d=f(.5*d);if("XYZ"===a){var n=b*g*m+e*c*d;var r=e*c*m-b*g*d;
var h=e*g*d+b*c*m;var l=e*g*m-b*c*d}else"YXZ"===a?(n=b*g*m+e*c*d,r=e*c*m-b*g*d,h=e*g*d-b*c*m,l=e*g*m+b*c*d):"ZXY"===a?(n=b*g*m-e*c*d,r=e*c*m+b*g*d,h=e*g*d+b*c*m,l=e*g*m-b*c*d):"ZYX"===a?(n=b*g*m-e*c*d,r=e*c*m+b*g*d,h=e*g*d-b*c*m,l=e*g*m+b*c*d):"YZX"===a?(n=b*g*m+e*c*d,r=e*c*m+b*g*d,h=e*g*d-b*c*m,l=e*g*m-b*c*d):"XZY"===a&&(n=b*g*m-e*c*d,r=e*c*m-b*g*d,h=e*g*d+b*c*m,l=e*g*m+b*c*d);this.setValue(n,r,h,l);return this},toMatrix3:function(){var a=[],b=this.x(),c=this.y(),d=this.z(),m=this.w(),f=b*b,g=c*
c,u=d*d,n=b*c,r=c*d,h=d*b;b*=m;c*=m;d*=m;a[0]=1-2*(g+u);a[1]=2*(n-d);a[2]=2*(h+c);a[3]=2*(n+d);a[4]=1-2*(u+f);a[5]=2*(r-b);a[6]=2*(h-c);a[7]=2*(r+b);a[8]=1-2*(f+g);return e.matrix3().fromArray(a)},clone:function(){return e.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){e.freeQuaternion(this)}});Ammo.btMatrix3x3.prototype=Object.assign(Object.create(Ammo.btMatrix3x3.prototype),{set:function(a,b,c,d,e,f,g,u,n){var m=this.elements;m[0]=a;m[1]=d;m[2]=g;m[3]=b;m[4]=e;m[5]=u;m[6]=
c;m[7]=f;m[8]=n;return this},transpose:function(){var a=this.elements;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this},fromArray:function(a,b){void 0===b&&(b=0);for(var c=0;9>c;c++)this.elements[c]=a[c+b];return this},multiply:function(a){var b=this.row(0),c=this.row(1),d=this.row(2),e=a.column(0),f=a.column(1);a=a.column(2);var g=this.elements;g[0]=b.dot(e);g[1]=b.dot(f);g[2]=b.dot(a);g[3]=c.dot(e);g[4]=c.dot(f);g[5]=c.dot(a);g[6]=d.dot(e);g[7]=d.dot(f);g[8]=
d.dot(a);b.free();c.free();d.free();e.free();f.free();a.free();return this},multiplyByVector3:function(a){var b=this.row(0),c=this.row(1),d=this.row(2);a=e.vector3().set(b.dot(a),c.dot(a),d.dot(a));b.free();c.free();d.free();return a},toQuaternion:function(){var a=this.elements,b=a[0]+a[4]+a[8];if(0<b){var c=2*Math.sqrt(b+1);var d=.25*c;b=(a[7]-a[5])/c;var f=(a[2]-a[6])/c;a=(a[3]-a[1])/c}else a[0]>a[4]&&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),d=(a[7]-a[5])/c,b=.25*c,f=(a[1]+a[3])/c,a=(a[2]+a[6])/
c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),d=(a[2]-a[6])/c,b=(a[1]+a[3])/c,f=.25*c,a=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),d=(a[3]-a[1])/c,b=(a[2]+a[6])/c,f=(a[5]+a[7])/c,a=.25*c);return e.quaternion().set(b,f,a,d)},row:function(a){var b=this.elements;a*=3;return e.vector3().set(b[a],b[a+1],b[a+2])},column:function(a){var b=this.elements;return e.vector3().set(b[a],b[a+3],b[a+6])},free:function(){e.freeMatrix3(this)}})}function L(){this.ID=0;this.solids=[];this.bodys=[];this.trans=new Ammo.btTransform;
this.zero=new Ammo.btVector3;this.zero.set(0,0,0)}function M(){this.ID=0;this.joints=[]}function N(){this.ID=0;this.softs=[]}function O(){this.ID=0;this.terrains=[]}function P(a,b){var c=e.transform(),d=e.vector3();this.needsUpdate=!1;this.dataHeap=this.tmpData=this.data=null;this.type="terrain";1!==f.scale&&(b.pos=e.vectomult(b.pos,f.invScale),b.size=e.vectomult(b.size,f.invScale));var m=void 0===b.size?[1,1,1]:b.size,g=void 0===b.sample?[64,64]:b.sample,w=void 0===b.pos?[0,0,0]:b.pos,u=void 0===
b.quat?[0,0,0,1]:b.quat,n=void 0===b.mass?0:b.mass,r=void 0===b.margin?.02:b.margin,h=void 0===b.friction?.5:b.friction,l=void 0===b.restitution?0:b.restitution,k=void 0===b.flag?1:b.flag,t=void 0===b.heightScale?1:b.heightScale,p=void 0===b.upAxis?1:b.upAxis,y=b.hdt||"PHY_FLOAT",x=void 0!==b.flipEdge?b.flipEdge:!1;this.setData(b.heightData);this.update();b=new Ammo.btHeightfieldTerrainShape(g[0],g[1],this.data,t,-m[1],m[1],p,y,x);d.set(m[0]/g[0],1,m[2]/g[1]);b.setLocalScaling(d);b.setMargin(r);c.identity().fromArray(w.concat(u));
d.set(0,0,0);m=new Ammo.btDefaultMotionState(c);n=new Ammo.btRigidBodyConstructionInfo(n,m,b,d);n.set_m_friction(h);n.set_m_restitution(l);h=new Ammo.btRigidBody(n);h.setCollisionFlags(k);this.name=h.name=a;this.body=h;Ammo.destroy(n);c.free();d.free()}function Q(){this.ID=0;this.cars=[];this.trans=new Ammo.btTransform}function R(a,b,c){this.name=a;this.body=this.chassis=null;this.motor=this.breaking=this.steering=0;this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5];this.limitAngular=[1,1,1];this.wheelBody=
[];this.wheelJoint=[];this.wheelRadius=[];this.isRay=!0;this.data={mass:100,wMass:1,wWidth:.25,nWheel:b.nWheel||4,wPos:[1,0,1.6],engine:1E3,acceleration:10,maxSteering:24*e.torad,breaking:100,incSteering:.04,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6E3,s_length:.2,w_friction:10.5,w_roll:.001};this.init(b,c)}function S(){this.ID=
0;this.heroes=[]}function T(a,b){this.name=a;this.controller=this.body=null;this.speed=this.angle=0;this.wasJumping=!1;this.verticalVelocity=0;this.angleInc=.1;this.q=new Ammo.btQuaternion;this.position=new Ammo.btVector3;this.init(b)}function U(){this.ID=0;this.pairs=[]}function V(a,b,c){this.name=c;this.result=0;this.type="collision";this.pa=[0,0,0];this.pb=[0,0,0];this.nb=[0,0,0];this.maxImpulse=this.impulse=this.distance=0;this.a=a;this.b=b;this.f=new Ammo.ConcreteContactResultCallback;this.f.addSingleResult=
function(){this.result=1}.bind(this)}function W(){this.ID=0;this.rays=[];this.ray=null;this.results=[]}function X(a,b){this.name=a;this.type="ray";this.precision=1;this.update(b);this.result={hit:!1,name:"",point:[0,0,0],normal:[0,0,0]}}var e={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},eulerToQuadArray:function(a,b){b&&(a=e.vectomult(a,e.torad));a=e.quaternion().setFromEuler(a);b=a.toArray();a.free();return b},destroy:function(){for(;0<
e.T.length;)Ammo.destroy(e.T.pop());for(;0<e.Q.length;)Ammo.destroy(e.Q.pop());for(;0<e.V3.length;)Ammo.destroy(e.V3.pop());for(;0<e.M3.length;)Ammo.destroy(e.M3.pop())},transform:function(){return 0<e.T.length?e.T.pop():new Ammo.btTransform},freeTransform:function(a){e.T.push(a)},quaternion:function(){return 0<e.Q.length?e.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(a){e.Q.push(a)},vector3:function(){return 0<e.V3.length?e.V3.pop():new Ammo.btVector3},freeVector3:function(a){e.V3.push(a)},
matrix3:function(){return 0<e.M3.length?e.M3.pop():new Ammo.btMatrix3x3},freeMatrix3:function(a){e.M3.push(a)},vectomult:function(a,b){return a=a.map(function(a){return a*b})},distanceArray:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];a=b[2]-a[2];return Math.sqrt(c*c+d*d+a*a)}},f={Ar:null,ArPos:null,flow:{matrix:{},force:{},option:{},ray:[],terrain:[],vehicle:[],key:[0,0,0,0,0,0,0,0]},world:null,gravity:null,scale:1,invscale:1,angle:0,post:null},g=new Map;Object.assign(L.prototype,{step:function(a,b){var c,
d=f.scale;this.bodys.forEach(function(e,f){c=b+8*f;a[c]=9.8*e.getLinearVelocity().length();e.getWorldTransform().toArray(a,c+1,d)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){"solid"===a.type?f.world.removeCollisionObject(a):f.world.removeRigidBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):
this.bodys.indexOf(a);-1!==c&&(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a,b){var c=void 0!==a.name?a.name:"body"+this.ID++;this.remove(c);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);var d=void 0===a.mass?0:a.mass,m=a.kinematic||!1,q=a.ghost||!1;q&&(d=0);var w=e.vector3(),u=e.vector3(),n=e.vector3(),r=e.vector3(),h=e.vector3(),l=e.transform(),k=void 0!==a.noMesh?a.noMesh:!1;m&&(a.flag=2,a.state=4,void 0===a.group&&(a.group=
4));a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;1!==f.scale&&(a.pos=e.vectomult(a.pos,f.invScale),a.size=e.vectomult(a.size,f.invScale),void 0!==a.masscenter&&(a.masscenter=e.vectomult(a.masscenter,f.invScale)));var t=null;switch(a.type){case "plane":h.fromArray(a.dir||[0,1,0]);t=new Ammo.btStaticPlaneShape(h,0);break;case "box":case "hardbox":case "realbox":case "realhardbox":h.setValue(.5*a.size[0],.5*a.size[1],.5*a.size[2]);t=
new Ammo.btBoxShape(h);break;case "sphere":case "realsphere":t=new Ammo.btSphereShape(a.size[0]);break;case "cylinder":case "realcylinder":h.setValue(a.size[0],.5*a.size[1],.5*a.size[2]);t=new Ammo.btCylinderShape(h);break;case "cone":case "realcone":t=new Ammo.btConeShape(a.size[0],.5*a.size[1]);break;case "capsule":t=new Ammo.btCapsuleShape(a.size[0],.5*a.size[1]);break;case "compound":t=new Ammo.btCompoundShape;for(var p,y,x=e.transform(),v=0;v<a.shapes.length;v++){p=a.shapes[v];1!==f.scale&&(p.pos=
e.vectomult(p.pos,f.invScale),p.size=e.vectomult(p.size,f.invScale));x.identity().fromArray(p.pos.concat(p.quat));switch(p.type){case "box":case "hardbox":h.setValue(.5*p.size[0],.5*p.size[1],.5*p.size[2]);y=new Ammo.btBoxShape(h);break;case "sphere":y=new Ammo.btSphereShape(p.size[0]);break;case "cylinder":case "hardcylinder":h.setValue(p.size[0],.5*p.size[1],.5*p.size[2]);y=new Ammo.btCylinderShape(h);break;case "cone":y=new Ammo.btConeShape(p.size[0],.5*p.size[1]);break;case "capsule":y=new Ammo.btCapsuleShape(p.size[0],
.5*p.size[1])}t.addChildShape(x,y)}x.free();break;case "mesh":t=new Ammo.btTriangleMesh;p=a.v;v=0;for(y=p.length;v<y;v+=9)u.set(p[v+0]*a.size[0],p[v+1]*a.size[1],p[v+2]*a.size[2]),n.set(p[v+3]*a.size[0],p[v+4]*a.size[1],p[v+5]*a.size[2]),r.set(p[v+6]*a.size[0],p[v+7]*a.size[1],p[v+8]*a.size[2]),t.addTriangle(u,n,r,!0);t=0===d?new Ammo.btBvhTriangleMeshShape(t,!0,!0):new Ammo.btConvexTriangleMeshShape(t,!0);break;case "convex":for(t=new Ammo.btConvexHullShape,p=a.v,v=0,y=p.length;v<y;v+=3)p[v]*=a.size[0],
p[v+1]*=a.size[1],p[v+2]*=a.size[2],h.fromArray(p,v),t.addPoint(h)}void 0!==a.margin&&void 0!==t.setMargin&&t.setMargin(a.margin*f.invScale);if("isShape"==b)return t;l.identity().fromArray(a.pos.concat(a.quat));if("isGhost"==b)return c=new Ammo.btGhostObject,c.setCollisionShape(t),c.setCollisionFlags(a.flag||4),c.setWorldTransform(l),c;u.setValue(0,0,0);0!==d&&t.calculateLocalInertia(d,u);b=new Ammo.btDefaultMotionState(l);b=new Ammo.btRigidBodyConstructionInfo(d,b,t,u);void 0!==a.friction&&b.set_m_friction(a.friction);
void 0!==a.restitution&&b.set_m_restitution(a.restitution);void 0!==a.linear&&b.set_m_linearDamping(a.linear);void 0!==a.angular&&b.set_m_angularDamping(a.angular);void 0!==a.rolling&&b.set_m_rollingFriction(a.rolling);a.masscenter?(w.fromArray(a.masscenter).negate(),l.setIdentity(),l.setOrigin(w),q=new Ammo.btCompoundShape,q.addChildShape(l,t),l.identity().fromArray(a.pos.concat(a.quat)),w.setValue(0,0,0),q.calculateLocalInertia(d,w),b=new Ammo.btDefaultMotionState(l),b=new Ammo.btRigidBodyConstructionInfo(d,
b,q,w)):q?(q=new Ammo.btGhostObject,q.setCollisionShape(t),q.setWorldTransform(l),a.flag=a.flag||4,q.setCollisionFlags(a.flag),q.isGhost=!0):(q=new Ammo.btRigidBody(b),m&&(q.isKinematic=!0));q.name=c;0!==d||m?(q.setCollisionFlags(a.flag||0),q.setActivationState(a.state||1),a.neverSleep&&q.setSleepingThresholds(0,0),f.world.addRigidBody(q,a.group||1,a.mask||-1),k?(q.type="body",this.solids.push(q)):(q.type="body",this.bodys.push(q))):(q.setCollisionFlags(a.flag||1),f.world.addCollisionObject(q,a.group||
2,a.mask||-1),q.type="solid",this.solids.push(q));q.breakable=void 0!==a.breakable?a.breakable:!1;q.breakable&&(q.breakOption=void 0!==a.breakOption?a.breakOption:[250,1,2,1]);g.set(c,q);Ammo.destroy(b);this.applyOption(q,a);l.free();w.free();u.free();n.free();r.free();h.free()},applyOption:function(a,b){var c=e.vector3();void 0!==b.flag&&(a.setCollisionFlags(b.flag),a.isKinematic=2===b.flag?!0:!1);void 0!==b.state&&a.setActivationState(b.state);void 0!==b.activate&&a.activate();a.isGhost||(void 0!==
b.group&&a.getBroadphaseProxy().set_m_collisionFilterGroup(b.group),void 0!==b.mask&&a.getBroadphaseProxy().set_m_collisionFilterMask(b.mask),void 0!==b.damping&&a.setDamping(b.damping[0],b.damping[1]),void 0!==b.sleeping&&a.setSleepingThresholds(b.sleeping[0],b.sleeping[1]));void 0!==b.friction&&a.setFriction(b.friction);void 0!==b.restitution&&a.setRestitution(b.restitution);void 0!==b.rollingFriction&&a.setRollingFriction(b.rollingFriction);void 0!==b.linearVelocity&&a.setLinearVelocity(c.fromArray(b.linearVelocity,
0,f.invScale));void 0!==b.angularVelocity&&a.setAngularVelocity(c.fromArray(b.angularVelocity));void 0!==b.linearFactor&&a.setLinearFactor(c.fromArray(b.linearFactor));void 0!==b.angularFactor&&a.setAngularFactor(c.fromArray(b.angularFactor));void 0!==b.threshold&&a.setCcdMotionThreshold(b.threshold);void 0!==b.anisotropic&&a.setAnisotropicFriction(b.anisotropic[0],b.anisotropic[1]);void 0!==b.massProps&&a.setMassProps(b.massProps[0],b.massProps[1]);void 0!==b.gravity&&(b.gravity?a.setGravity(f.gravity):
a.setGravity(this.zero));c.free()}});Object.assign(M.prototype,{step:function(a,b){this.joints.forEach(function(c,d){a[b+4*d]=c.ntype})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(a){f.world.removeConstraint(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.joints.indexOf(a);-1!==b&&(this.joints.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"joint"+this.ID++;this.remove(b);
a.body1&&(a.b1=a.body1);a.body2&&(a.b2=a.body2);if(g.has(a.b1)&&g.has(a.b2)){var c=g.get(a.b1),d=g.get(a.b2);c.activate();d.activate();var m=e.vector3().fromArray(a.pos1||[0,0,0]).multiplyScalar(f.invScale),q=e.vector3().fromArray(a.pos2||[0,0,0]).multiplyScalar(f.invScale),w=e.vector3().fromArray(a.axe1||[1,0,0]),u=e.vector3().fromArray(a.axe2||[1,0,0]),n=e.transform().identity(),r=e.transform().identity();if("joint_p2p"!==a.type&&"joint_hinge"!==a.type&&"joint"!==a.type)if(void 0!==a.local?a.local:
1)n.setOrigin(m),a.quatA?n.quaternionFromArray(a.quatA):a.axe1&&n.eulerFromArray(a.axe1),r.setOrigin(q),a.quatB?r.quaternionFromArray(a.quatB):a.axe2&&n.eulerFromArray(a.axe2);else{var h=e.transform();h.identity();h.setOrigin(m);h.eulerFromArray(a.axe1||[1,0,0]);c.getMotionState().getWorldTransform(n);n.getInverse().multiply(h);h.identity();h.setOrigin(q);h.eulerFromArray(a.axe2||[1,0,0]);d.getMotionState().getWorldTransform(r);r.getInverse().multiply(h);h.free()}h=void 0!==a.useA?a.useA:!0;switch(a.type){case "joint_p2p":var l=
1;var k=new Ammo.btPoint2PointConstraint(c,d,m,q);a.strength&&k.get_m_setting().set_m_tau(a.strength);a.damping&&k.get_m_setting().set_m_damping(a.damping);a.impulse&&k.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":l=2;k=new Ammo.btHingeConstraint(c,d,m,q,w,u,h);break;case "joint_hinge_ref":l=2;k=new Ammo.btHingeConstraint(c,d,n,r,h);break;case "joint_slider":l=3;k=new Ammo.btSliderConstraint(c,d,n,r,h);break;case "joint_conetwist":l=4;k=new Ammo.btConeTwistConstraint(c,
d,n,r);break;case "joint_dof":l=5;k=new Ammo.btGeneric6DofConstraint(c,d,n,r,h);break;case "joint_spring_dof":l=6;k=new Ammo.btGeneric6DofSpringConstraint(c,d,n,r,h);break;case "joint_fixe":l=7,k=new Ammo.btFixedConstraint(c,d,n,r)}a.breaking&&k.setBreakingImpulseThreshold&&k.setBreakingImpulseThreshold(a.breaking);a.limit&&k.setLimit&&("joint_hinge"!==a.type&&"joint"!==a.type||k.setLimit(a.limit[0]*e.torad,a.limit[1]*e.torad,void 0!==a.limit[2]?a.limit[2]:.9,void 0!==a.limit[3]?a.limit[3]:.3,void 0!==
a.limit[4]?a.limit[4]:1),"joint_conetwist"===a.type&&(k.setLimit(3,a.limit[0]*e.torad),k.setLimit(4,a.limit[2]*e.torad),k.setLimit(5,a.limit[1]*e.torad)));a.motor&&k.enableAngularMotor&&k.enableAngularMotor(a.motor[0],a.motor[1],a.motor[2]);k.setLowerLinLimit&&(a.linLower&&k.setLowerLinLimit(a.linLower*f.invScale),a.linUpper&&k.setUpperLinLimit(a.linUpper*f.invScale));k.setLowerAngLimit&&(a.angLower&&k.setLowerAngLimit(a.angLower*e.torad),a.angUpper&&k.setUpperAngLimit(a.angUpper*e.torad));k.setLinearLowerLimit&&
(a.linLower&&k.setLinearLowerLimit(m.fromArray(a.linLower).multiplyScalar(f.invScale)),a.linUpper&&k.setLinearUpperLimit(q.fromArray(a.linUpper).multiplyScalar(f.invScale)));k.setAngularLowerLimit&&(a.angLower&&k.setAngularLowerLimit(w.set(a.angLower[0]*e.torad,a.angLower[1]*e.torad,a.angLower[2]*e.torad)),a.angUpper&&k.setAngularUpperLimit(u.set(a.angUpper[0]*e.torad,a.angUpper[1]*e.torad,a.angUpper[2]*e.torad)));a.feedback&&k.enableFeedback(a.feedback);a.angularOnly&&k.setAngularOnly&&k.setAngularOnly(a.angularOnly);
a.enableMotor&&k.enableMotor&&k.enableMotor(a.enableMotor);a.maxMotorImpulse&&k.setMaxMotorImpulse&&k.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&k.setMotorTarget&&(c=e.quaternion().fromArray(a.motorTarget),k.setMotorTarget(c),c.free());if(a.damping&&k.setDamping)for(c=0;6>c;c++)k.setDamping(c,a.damping[c]);if(a.spring&&k.enableSpring&&k.setStiffness)for(c=0;6>c;c++)k.enableSpring(c,0===a.spring[c]?!1:!0),k.setStiffness(c,a.spring[c]);if(a.param&&k.setParam)for(c=0,d=a.param.length;c<d;c++)k.setParam(a.param[c][0],
a.param[c][1],c);a=void 0!==a.collision?a.collision:!1;k.isJoint=!0;k.name=b;k.nType=l;k.type="joint";f.world.addConstraint(k,a?!1:!0);this.joints.push(k);g.set(b,k);m.free();q.free();w.free();u.free();n.free();r.free()}else console.log("! not find body")}});Object.assign(N.prototype,{step:function(a,b){var c=b,d,e,g;this.softs.forEach(function(b){e=b.get_m_nodes();for(g=e.size();g--;)d=c+3*g,e.at(g).get_m_x().toArray(a,d,f.scale);c+=3*e.size()})},getNodes:function(a){var b=[];a=a.get_m_nodes();for(var c,
d=a.size(),e=0;e<d;e++)c=a.at(e).get_m_x().toArray(),300<c[1]&&b.push(e);return b},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){f.world.removeSoftBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},addAreo:function(a){if(g.has(a.soft)){for(var b=g.get(a.soft),c=e.vector3().fromeArray(a.wind),d=a.nodes.length;d--;)b.addAeroForceToNode(c,
a.nodes[d]);c.free()}},addAnchor:function(a){if(g.has(a.soft)&&g.has(a.body))for(var b=a.collision||!1,c=g.get(a.soft),d=g.get(a.body),e=a.nodes.length;e--;)c.appendAnchor(a.nodes[e],d,b?!1:!0,a.influence||1)},add:function(a){var b=void 0!==a.name?a.name:"soft"+this.ID++;this.remove(b);var c=f.world.getWorldInfo(),d=a.gendiags||!0;a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;a.div=void 0==a.div?[64,64]:a.div;1!==f.scale&&(a.pos=e.vectomult(a.pos,
f.invScale),a.size=e.vectomult(a.size,f.invScale));var m=e.vector3(),q=e.vector3(),w=e.vector3(),u=e.vector3(),n=e.vector3(),r=e.transform(),h=new Ammo.btSoftBodyHelpers;switch(a.type){case "softCloth":var l=.5*a.size[0];var k=.5*a.size[2];q.fromArray([-l,0,-k],0,f.invScale);w.fromArray([l,0,-k],0,f.invScale);u.fromArray([-l,0,k],0,f.invScale);n.fromArray([l,0,k],0,f.invScale);l=h.CreatePatch(c,q,w,u,n,a.div[0],a.div[1],a.fixed||0,d);l.softType=1;break;case "softRope":q.fromArray(a.start||[-10,0,
0],0,f.invScale);w.fromArray(a.end||[10,0,0],0,f.invScale);l=h.CreateRope(c,q,w,(a.numSegment||10)-2,a.fixed||0);l.softType=2;break;case "softEllips":q.fromArray(a.center||[0,0,0],0,f.invScale);w.fromArray(a.radius||[3,3,3],0,f.invScale);l=h.CreateEllipsoid(c,q,w,a.vertices||128);l.softType=3;c=[];h=l.get_m_nodes();d=h.size();for(var t;d--;)k=3*d,t=h.at(d),t=t.get_m_x(),c[k]=t.x(),c[k+1]=t.y(),c[k+2]=t.z();a.lng=h.size();a.a=c;self.postMessage({m:"ellipsoid",o:a});break;case "softMesh":case "softConvex":for(d=
a.v.length;d--;)a.v[d]*=f.invScale;l=h.CreateFromTriMesh(c,a.v,a.i,a.ntri,a.randomize||!0);l.softType=5}d=l.get_m_cfg();void 0!==a.viterations&&d.set_viterations(a.viterations);void 0!==a.piterations&&d.set_piterations(a.piterations);void 0!==a.diterations&&d.set_diterations(a.diterations);void 0!==a.citerations&&d.set_citerations(a.citerations);d.set_collisions(17);void 0!==a.friction&&d.set_kDF(a.friction);void 0!==a.damping&&d.set_kDP(a.damping);void 0!==a.pressure&&d.set_kPR(a.pressure);void 0!==
a.drag&&d.set_kDG(a.drag);void 0!==a.lift&&d.set_kLF(a.lift);void 0!==a.volume&&d.set_kVC(a.volume);void 0!==a.matching&&d.set_kMT(a.matching);void 0!==a.hardness&&(d.set_kCHR(a.hardness),d.set_kKHR(a.hardness),d.set_kSHR(a.hardness),d.set_kAHR(a.hardness));void 0!==a.timescale&&d.set_timescale(a.timescale);void 0!==a.maxvolume&&d.set_maxvolume(a.maxvolume);d=l.get_m_materials().at(0);void 0!==a.stiffness&&(d.set_m_kLST(a.stiffness),d.set_m_kAST(a.stiffness),d.set_m_kVST(a.stiffness));void 0!==a.bendingConstraint&&
l.generateBendingConstraints(a.bendingConstraint,d);l.setTotalMass(a.mass||0,a.fromfaces||!1);void 0!==a.cluster&&l.generateClusters(a.cluster,a.maxClusterIterations||8192);void 0!==a.restitution&&l.setRestitution(a.restitution);void 0!==a.rolling&&l.setRollingFriction(a.rolling);void 0!==a.flag&&l.setCollisionFlags(a.flag);void 0!==a.margin&&Ammo.castObject(l,Ammo.btCollisionObject).getCollisionShape().setMargin(a.margin*f.invScale);r.identity().fromArray(a.pos.concat(a.quat));l.transform(r);f.world.addSoftBody(l,
a.group||1,a.mask||-1);l.setActivationState(a.state||4);l.points=l.get_m_nodes().size();l.name=b;l.type="soft";this.softs.push(l);g.set(b,l);m.free();q.free();w.free();u.free();n.free();r.free()}});Object.assign(O.prototype,{step:function(){for(var a=f.flow.terrain.length;a--;)this.setData(f.flow.terrain[a]);f.flow.terrain=[];this.terrains.forEach(function(a){a.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){f.world.removeCollisionObject(a.body);
a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},setData:function(a){g.has(a.name)&&g.get(a.name).setData(a.heightData)},add:function(a){var b=void 0!==a.name?a.name:"terrain"+this.ID++;this.remove(b);var c=void 0===a.group?2:a.group,d=void 0===a.mask?-1:a.mask;a=new P(b,a);f.world.addCollisionObject(a.body,c,d);this.terrains.push(a);g.set(b,a)}});Object.assign(P.prototype,{setData:function(a){this.tmpData=
a;this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT;this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body);Ammo._free(this.dataHeap.byteOffset);this.dataHeap=this.tmpData=this.data=this.body=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes);this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}});
Object.assign(Q.prototype,{step:function(a,b){for(var c=f.flow.vehicle.length;c--;)this.setData(f.flow.vehicle[c]);f.flow.vehicle=[];var d,e=this.trans;this.cars.forEach(function(c,f){d=b+64*f;c.step(a,d,e)})},control:function(a){g.has(a)&&g.get(a+"_constuctor").drive(f.flow.key)},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){f.world.removeRigidBody(a.body);f.world.removeAction(a.chassis);Ammo.destroy(a.body);Ammo.destroy(a.chassis);g.delete(a.name+
"_constuctor");g.delete(a.name);g.delete(a.name+"_chassis")},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},addExtra:function(){},setData:function(a){g.has(a.name+"_constuctor")&&g.get(a.name+"_constuctor").setData(a)},add:function(a){var b=void 0!==a.name?a.name:"car"+this.ID++;this.remove(b);a.size=void 0===a.size?[2,.5,4]:a.size;void 0!==a.pos&&(a.pos=e.vectomult(a.pos,f.invScale));void 0!==a.size&&(a.size=e.vectomult(a.size,
f.invScale));void 0!==a.masscenter&&(a.masscenter=e.vectomult(a.masscenter,f.invScale));var c=a.shapeType||"box";c=this.addExtra("mesh"==c?{type:"mesh",v:a.v,mass:1}:"convex"==c?{type:"convex",v:a.v}:{type:"box",size:a.size},"isShape");void 0!==a.v&&delete a.v;a=new R(b,a,c);f.world.addAction(a.chassis);f.world.addRigidBody(a.body);this.cars.push(a);g.set(b+"_constuctor",a);g.set(b,a.body);g.set(b+"_chassis",a.chassis)}});Object.assign(R.prototype,{step:function(a,b,c){var d=f.scale;a[b]=this.chassis.getCurrentSpeedKmHour();
this.body.getMotionState().getWorldTransform(c);c.toArray(a,b+1,d);c=this.data.nWheel;for(var e,g;c--;)this.chassis.updateWheelTransform(c,!0),g=this.chassis.getWheelTransformWS(c),a[b+56+c]=this.chassis.getWheelInfo(c).get_m_raycastInfo().get_m_suspensionLength()*d,e=8*(c+1),g.toArray(a,b+e+1,d),0===c&&(a[b+e]=this.chassis.getWheelInfo(0).get_m_steering()),1===c&&(a[b+e]=this.chassis.getWheelInfo(1).get_m_steering()),2===c&&(a[b+e]=this.steering);a[b+62]=this.chassis.getWheelInfo(0).m_rotation;a[b+
63]=this.chassis.getWheelInfo(1).m_rotation},drive:function(a){var b=this.data;this.steering=0===a[0]?.9*this.steering:this.steering-b.incSteering*a[0];this.steering=e.clamp(this.steering,-b.maxSteering,b.maxSteering);0===a[1]?(this.motor=0,this.breaking=b.breaking):(this.motor-=b.acceleration*a[1],this.breaking=0);this.motor=e.clamp(this.motor,-b.engine,b.engine);if(3<b.nWheel){var c=2*this.wpos[2],d=this.wpos[0];a=c/Math.tan(this.steering);var f=Math.atan2(c,d+a);c=Math.atan2(c,-d+a);0>a&&(f-=Math.PI,
c-=Math.PI)}for(a=b.nWheel;a--;)4>b.nWheel?0===a&&this.chassis.setSteeringValue(this.steering,a):(0===a&&this.chassis.setSteeringValue(c,a),1===a&&this.chassis.setSteeringValue(f,a)),this.chassis.applyEngineForce(this.motor,a),this.chassis.setBrake(this.breaking,a);1>this.motor&&(b=this.body.getAngularVelocity(),b.multiplyArray(this.limitAngular),this.body.setAngularVelocity(b))},clear:function(){this.chassis=this.body=null},init:function(a,b){var c=this.data,d=e.transform(),g=e.vector3(),q=e.vector3(),
w=e.vector3(),u=e.vector3();this.isRay=void 0===a.isRay?!0:a.isRay;c.mass=void 0===a.mass?800:a.mass;a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;c.pos=void 0===a.pos?[0,0,0]:a.pos;c.quat=void 0===a.quat?[0,0,0,1]:a.quat;c.nWheel=a.nWheel||4;g.fromArray(a.masscenter).negate();d.setIdentity();d.setOrigin(g);var n=new Ammo.btCompoundShape;n.addChildShape(d,b);d.identity().fromArray(c.pos.concat(c.quat));g.setValue(0,0,0);n.calculateLocalInertia(c.mass,g);b=new Ammo.btDefaultMotionState(d);
n=new Ammo.btRigidBodyConstructionInfo(c.mass,b,n,g);this.body=new Ammo.btRigidBody(n);this.body.name=this.name;this.body.isRigidBody=!0;this.body.isBody=!0;this.body.setActivationState(4);Ammo.destroy(n);if(this.isRay){var r=new Ammo.btVehicleTuning;n=new Ammo.btDefaultVehicleRaycaster(f.world);this.chassis=new Ammo.btRaycastVehicle(r,this.body,n);this.chassis.setCoordinateSystem(0,1,2)}n=a.radius||.4;b=a.radiusBack||n;var h=a.wPos||[1,0,1.6];h=e.vectomult(h,f.invScale);n*=f.invScale;b*=f.invScale;
h[1]-=a.masscenter[1];c=c.nWheel;for(var l,k,t=a.decalYBack||0,p=0;p<c;p++)0===p&&(l=[h[0],h[1],h[2]],k=!0),1===p&&(l=[-h[0],h[1],h[2]],k=!0),2===p&&(l=[-h[0],h[1]+t,-h[2]],k=!1),3===p&&(l=[h[0],h[1]+t,-h[2]],k=!1),4===p&&(l=[-h[0],h[1]+t,-h[3]],k=!1),5===p&&(l=[h[0],h[1]+t,-h[3]],k=!1),2===c&&(0===p&&(l=[0,h[1],h[2]],k=!0),1===p&&(l=[0,h[1]+t,-h[2]],k=!1)),3===c&&(0===p&&(l=[0,h[1],h[2]],k=!0),1===p&&(l=[h[0],h[1]+t,-h[2]],k=!1),2===p&&(l=[-h[0],h[1]+t,-h[2]],k=!1)),q.fromArray(l),w.setValue(0,-1,
0),u.setValue(-1,0,0),this.chassis.addWheel(q,w,u,1,k?n:b,r,k),this.chassis.setBrake(a.breaking||100,p),this.wheelRadius.push(k?n:b);this.wpos=h;this.setData(a);d.free();g.free();q.free();w.free();u.free()},setMass:function(a){var b=e.vector3();this.data.mass=a;b.setValue(0,0,0);this.body.getCollisionShape().calculateLocalInertia(this.data.mass,b);this.body.setMassProps(a,b);this.body.updateInertiaTensor();b.free()},setPosition:function(){this.motor=this.breaking=this.steering=0;var a=e.transform();
a.identity().fromArray(this.data.pos.concat(this.data.quat));var b=e.vector3().set(0,0,0);this.body.setAngularVelocity(b);this.body.setLinearVelocity(b);this.body.setWorldTransform(a);this.chassis.resetSuspension();for(var c=this.data.nWheel;c--;)this.chassis.updateWheelTransform(c,!0);a.free();b.free()},setData:function(a){var b=this.data;void 0!==a.mass&&a.mass!==b.mass&&this.setMass(a.mass);for(var c in a)void 0!==b[c]&&(b[c]=a[c]);this.body.setFriction(b.friction);this.body.setRestitution(b.restitution);
this.body.setDamping(b.linear,b.angular);this.body.setRollingFriction(b.rolling);void 0!==a.limitAngular&&(this.limitAngular=a.limitAngular);c=e.vector3();void 0!==a.linearFactor&&this.body.setLinearFactor(c.fromArray(a.linearFactor));void 0!==a.angularFactor&&this.body.setAngularFactor(c.fromArray(a.angularFactor));c.free();b.autoSuspension&&(c=Math.sqrt(b.s_stiffness),b.s_compression=2*b.compValue*c,b.s_damping=2*b.dampValue*c);c=b.nWheel;for(var d;c--;)d=this.chassis.getWheelInfo(c),d.set_m_suspensionStiffness(b.s_stiffness),
d.set_m_wheelsDampingCompression(b.s_compression),d.set_m_wheelsDampingRelaxation(b.s_damping),d.set_m_maxSuspensionTravelCm(100*b.s_travel*f.invScale),d.set_m_suspensionRestLength1(b.s_length*f.invScale),d.set_m_maxSuspensionForce(b.s_force),d.set_m_rollInfluence(b.w_roll),d.set_m_frictionSlip(b.w_friction),d.set_m_wheelsRadius(this.wheelRadius[c]);a.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}});Object.assign(S.prototype,{step:function(a,b){var c;this.heroes.forEach(function(d,
e){c=b+8*e;d.step(a,c)})},control:function(a){g.has(a)&&(a=g.get(a),a.move(f.flow.key),a.setAngle(f.angle))},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){f.world.removeCollisionObject(a.body);f.world.removeAction(a.controller);a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"hero"+this.ID++;
this.remove(b);var c=new T(b,a);c.controller.setGravity(f.gravity);f.world.addCollisionObject(c.body,a.group||1,a.mask||-1);f.world.addAction(c.controller);this.heroes.push(c);g.set(b,c)}});Object.assign(T.prototype,{step:function(a,b){a[b]=this.speed;var c=this.body.getWorldTransform(),d=c.getOrigin();c=c.getRotation();a[b+1]=d.x();a[b+2]=d.y();a[b+3]=d.z();a[b+4]=c.x();a[b+5]=c.y();a[b+6]=c.z();a[b+7]=c.w()},move:function(a){1==a[4]&&this.controller.onGround()&&(this.wasJumping=!0,this.verticalVelocity=
0);this.wasJumping&&(this.verticalVelocity+=.04,1.3<this.verticalVelocity&&(this.verticalVelocity=0,this.wasJumping=!1));var b=.3*-a[1];var c=.3*-a[0];this.speed=b+c;this.angle-=.1*a[2];this.setAngle(this.angle);this.position.setValue(c,0+this.verticalVelocity,b);this.position.direction(this.q);this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body);Ammo.destroy(this.controller);this.controller=this.body=null},init:function(a){var b=e.vector3(),c=e.transform();a.size=
void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var d=new Ammo.btCapsuleShape(a.size[0],.5*a.size[1]),f=new Ammo.btPairCachingGhostObject;f.setCollisionShape(d);f.setCollisionFlags(16);c.identity().fromArray(a.pos.concat(a.quat));f.setWorldTransform(c);f.setFriction(a.friction||.1);f.setRestitution(a.restitution||0);f.setActivationState(4);f.activate();c=new Ammo.btKinematicCharacterController(f,d,a.stepH||.35,a.upAxis||1);c.setUseGhostSweepTest(d);
c.setFallSpeed(30);c.setMaxJumpHeight(200);c.setJumpSpeed(1E3);a.slopeRadians&&c.setMaxSlope(a.slopeRadians);b.setValue(0,0,0);c.setVelocityForTimeInterval(b,1);this.body=f;this.controller=c},setAngle:function(a){var b=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],a);b.setRotation(this.q);this.angle=a}});Object.assign(U.prototype,{step:function(a,b){var c;this.pairs.forEach(function(d,e){c=b+e;d.result=0;void 0!==d.b?f.world.contactPairTest(d.a,d.b,d.f):f.world.contactTest(d.a,d.f);
a[c]=d.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;if(g.has(a.b1)){var c=g.get(a.b1);a=void 0!==a.b2?g.has(a.b2)?g.get(a.b2):void 0:void 0;c=new V(c,a,b);this.pairs.push(c);g.set(b,c)}}});Object.assign(V.prototype,{clear:function(){this.b=
this.a=null;Ammo.destroy(this.f)}});Object.assign(W.prototype,{step:function(){if(null!==this.ray){var a=this.rays.length,b=f.flow.ray.length;if(a){if(a===b)for(;b--;)this.rays[b].update(f.flow.ray[b]);f.flow.ray=[];var c=this.ray;this.rays.forEach(function(a,b){c.set_m_closestHitFraction(a.precision);c.set_m_collisionObject(null);c.get_m_rayFromWorld().fromArray(a.origin,0,f.invScale);c.get_m_rayToWorld().fromArray(a.dest,0,f.invScale);c.set_m_collisionFilterGroup(a.group);c.set_m_collisionFilterMask(a.mask);
f.world.rayTest(c.get_m_rayFromWorld(),c.get_m_rayToWorld(),c);if(c.hasHit()){b=Ammo.castObject(c.get_m_collisionObject(),Ammo.btRigidBody).name;void 0===b&&(b=Ammo.castObject(c.get_m_collisionObject(),Ammo.btSoftBody).name);var d=c.get_m_hitNormalWorld();d.normalize();a.result.hit=!0;a.result.name=b;a.result.point=c.get_m_hitPointWorld().toArray(void 0,0,f.scale);a.result.normal=d.toArray()}else a.result.hit=!1,a.result.name="";f.flow.ray.push(a.result)})}}},update:function(a){var b=this.rays.length;
if(b&&b===a.length)for(;b--;)this.rays[b].update(a[b])},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.rays.indexOf(a);-1!==b&&(this.rays.splice(b,1),this.destroy(a))}},add:function(a){null===this.ray&&(this.ray=new Ammo.ClosestRayResultCallback);var b=void 0!==a.name?a.name:"ray"+this.ID++;this.remove(a.name);a=new X(b,a);this.rays.push(a);g.set(b,a)}});Object.assign(X.prototype,
{update:function(a){this.precision=a.precision||1;this.origin=a.origin||[0,0,0];this.dest=a.dest||[0,1,0];this.group=void 0!==a.group?a.group:1;this.mask=void 0!==a.mask?a.mask:-1},clear:function(){}});self.onmessage=function(a){a=a.data;a.Ar&&x.engine.setAr(a.Ar);a.flow&&(f.flow=a.flow);x.engine[a.m](a.o)};x.engine=function(){var a,b,c,d=1/60,m=3*d,q=!1,w=2,u=0,n=!1,r=!1,h,l,k,t,p,y=[],J="",v="",D=null,K=0,z,B,I,E,A,F,G,H;x.engine={test:function(){},setAr:function(b){a=b},getAr:function(){return a},
setDrive:function(a){J=a},setMove:function(a){v=a},setAngle:function(a){f.angle=a.angle},step:function(c){this.stepRemove();A.control(J);F.control(v);this.stepOption();this.stepForces();this.stepMatrix();E.step();0!==K&&this.stepBreak();u=c.delta;q?f.world.stepSimulation(u,w,d):f.world.stepSimulation(u,w);z.step(a,b[0]);G.step(a,b[1]);F.step(a,b[2]);A.step(a,b[3]);B.step(a,b[4]);H.step();n?self.postMessage({m:"step",flow:f.flow,Ar:a},[a.buffer]):self.postMessage({m:"step",flow:f.flow,Ar:a})},clearFlow:function(){f.flow=
{matrix:{},force:{},option:{},ray:[],terrain:[],vehicle:[]}},reset:function(b){K=0;v=J="";this.clearFlow();y=[];z.clear();I.clear();B.clear();E.clear();A.clear();F.clear();G.clear();H.clear();g.clear();e.destroy();b.full&&(this.clearWorld(),this.createWorld());this.setGravity();n||(a=new Float32Array(c));self.postMessage({m:"start"})},addMulty:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},post:function(a,b){self.postMessage({m:a,o:b})},init:function(d){n=d.isBuffer||!1;b=d.ArPos;c=d.ArMax;
n||(a=new Float32Array(c));importScripts(d.blob);Ammo().then(function(a){C();x.engine.createWorld(d.option);x.engine.set(d.option);z=new L;I=new M;B=new N;E=new O;A=new Q;F=new S;G=new U;H=new W;new a.ClosestRayResultCallback;A.addExtra=z.add;self.postMessage({m:"initEngine"})})},remove:function(a){if(g.has(a))switch(g.get(a).type){case "solid":case "body":z.remove(a);break;case "soft":B.remove(a);break;case "terrain":E.remove(a);break;case "joint":I.remove(a);break;case "collision":G.remove(a);break;
case "ray":H.remove(a)}},setRemove:function(a){y=y.concat(a)},stepRemove:function(){for(;0<y.length;)this.remove(y.pop())},add:function(a){a.type=void 0===a.type?"box":a.type;void 0!==a.breakable&&a.breakable&&K++;var b=a.type,c=a.type.substring(0,4);"join"===c?I.add(a):"soft"===c||"ellipsoid"===b?B.add(a):"terrain"===b?E.add(a):"character"===b?F.add(a):"collision"===b?G.add(a):"ray"===b?H.add(a):"car"===b?A.add(a):z.add(a)},addAnchor:function(a){B.addAnchor(a)},setVehicle:function(a){A.setData(a)},
createWorld:function(a){if(null!==f.world)console.error("World already existe !!");else{a=a||{};D=new Ammo.btVector3;D.set(0,0,0);r=void 0===a.soft?!0:a.soft;h=new Ammo.btSequentialImpulseConstraintSolver;l=r?new Ammo.btDefaultSoftBodySolver:null;k=r?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;t=new Ammo.btCollisionDispatcher(k);switch(void 0===a.broadphase?2:a.broadphase){case 1:p=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,
1E3,1E3),4096);break;case 2:p=new Ammo.btDbvtBroadphase}f.world=r?new Ammo.btSoftRigidDynamicsWorld(t,p,h,k,l):new Ammo.btDiscreteDynamicsWorld(t,p,h,k);f.post=this.post}},clearWorld:function(){Ammo.destroy(f.world);Ammo.destroy(h);null!==l&&Ammo.destroy(l);Ammo.destroy(k);Ammo.destroy(t);Ammo.destroy(p);f.world=null},setWorldscale:function(a){f.scale=a;f.invScale=1/a},setGravity:function(a){a=a||{};f.gravity=new Ammo.btVector3;f.gravity.fromArray(void 0!==a.gravity?a.gravity:[0,-9.81,0]);f.world.setGravity(f.gravity);
r&&f.world.getWorldInfo().set_m_gravity(f.gravity)},set:function(a){a=a||{};this.setWorldscale(void 0!==a.worldscale?a.worldscale:1);d=void 0!==a.fps?1/a.fps:1/60;w=void 0!==a.substep?a.substep:2;q=void 0!==a.fixed?a.fixed:!1;m=3*d;void 0!==a.penetration&&f.world.getDispatchInfo().set_m_allowedCcdPenetration(a.penetration);this.setGravity(a)},stepForces:function(){for(var a in f.flow.force)this.applyForces(a,f.flow.force[a]);f.flow.force={}},applyForces:function(a,b){if(g.has(a)){a=g.get(a);var c=
e.vector3(),d=e.vector3(),h=e.quaternion();void 0!==b.direction&&c.fromArray(e.vectomult(b.direction,f.invScale));void 0!==b.distance?d.fromArray(e.vectomult(b.distance,f.invScale)):d.zero();switch(b.type){case "force":case 0:a.applyForce(c,d);break;case "torque":case 1:a.applyTorque(c);break;case "localTorque":case 2:a.applyLocalTorque(c);break;case "forceCentral":case 3:a.applyCentralForce(c);break;case "forceLocal":case 4:a.applyCentralLocalForce(c);break;case "impulse":case 5:a.applyImpulse(c,
d);break;case "impulseCentral":case 6:a.applyCentralImpulse(c);break;case "motor":case 7:a.enableAngularMotor(b.enable||!0,b.targetVelocity,b.maxMotor);break;case "motorTarget":case 8:a.setMotorTarget(b.target,b.axis||-1);case "setLimit":case 9:a.setLimit(b.limit[0]*e.torad,b.limit[1]*e.torad,b.limit[2]||.9,b.limit[3]||.3,b.limit[4]||1)}c.free();d.free();h.free()}},stepMatrix:function(){for(var a in f.flow.matrix)this.applyMatrix(a,f.flow.matrix[a]);f.flow.matrix={}},applyMatrix:function(a,b){if(g.has(a)){var c=
g.get(a),d=e.transform(),h=e.vector3();if(b.keepX||b.keepY||b.keepZ||b.keepRot){c.getMotionState().getWorldTransform(d);var k=[];d.toArray(k);void 0!==b.keepX&&(b.pos[0]=k[0]-b.pos[0]);void 0!==b.keepY&&(b.pos[1]=k[1]-b.pos[1]);void 0!==b.keepZ&&(b.pos[2]=k[2]-b.pos[2]);void 0!==b.keepRot&&(b.quat=[k[3],k[4],k[5],k[6]])}void 0!==b.pos&&(void 0!==b.rot&&(b.quat=e.eulerToQuadArray(b.rot,!0)),void 0!==b.quat&&(b.pos=b.pos.concat(b.quat)),d.fromArray(b.pos,0,f.invScale),c.isKinematic?c.getMotionState().setWorldTransform(d):
c.setWorldTransform(d));void 0!==b.clamped&&(k=u>m?1:u/m,h.fromArray(b.pos,0,f.invScale).sub(c.getWorldTransform().getOrigin()).multiplyScalar(k),c.setLinearVelocity(h));b.velocity&&!c.isGhost&&(b.velocity[0]&&c.setLinearVelocity(h.fromArray(b.velocity[0],0,f.invScale)),b.velocity[1]&&c.setAngularVelocity(h.fromArray(b.velocity[1])));b.noVelocity&&!c.isGhost&&(c.setLinearVelocity(D),c.setAngularVelocity(D));b.noGravity&&c.setGravity(D);b.activate&&c.activate();"body"===c.type&&c.activate();"solid"===
c.type&&self.postMessage({m:"moveSolid",o:{name:a,pos:b.pos,quat:b.quat}});d.free();h.free()}},stepOption:function(){for(var a in f.flow.option)this.applyOption(a,f.flow.option[a]);f.flow.option={}},applyOption:function(a,b){if(g.has(a))switch(a=g.get(a),a.type){case "solid":case "body":z.applyOption(a,b)}},stepBreak:function(){for(var a,b,c,d,g,h,k,m,l,n,p=0,q=t.getNumManifolds();p<q;p++)if(a=t.getManifoldByIndexInternal(p),l=Ammo.castObject(a.getBody0(),Ammo.btRigidBody),n=Ammo.castObject(a.getBody1(),
Ammo.btRigidBody),k=l.name,m=n.name,l.breakable||n.breakable){c=!1;for(var r=d=0,u=a.getNumContacts();r<u;r++)if(b=a.getContactPoint(r),0>b.getDistance()){c=!0;a=b.getAppliedImpulse();a>d&&(d=a,g=b.get_m_positionWorldOnB().toArray(),h=b.get_m_normalWorldOnB().toArray());break}c&&(l.breakable&&d>l.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:k,pos:e.vectomult(g,f.scale),normal:h,breakOption:l.breakOption}}),n.breakable&&d>n.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:m,pos:e.vectomult(g,
f.scale),normal:h,breakOption:n.breakOption}}))}}};return x.engine}();Object.defineProperty(x,"__esModule",{value:!0})});
