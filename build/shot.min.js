(function(h,D){"object"===typeof exports&&"undefined"!==typeof module?D(exports):"function"===typeof define&&define.amd?define(["exports"],D):(h=h||self,D(h.SHOT={}))})(this,function(h){function D(){this.tolerance=-1;this.faces=[];this.newFaces=[];this.assigned=new P;this.unassigned=new P;this.vertices=[]}function A(){this.normal=new THREE.Vector3;this.midpoint=new THREE.Vector3;this.constant=this.area=0;this.outside=null;this.mark=0;this.edge=null}function G(a,b){this.vertex=a;this.twin=this.next=
this.prev=null;this.face=b}function ca(a){this.point=a;this.face=this.next=this.prev=null}function P(){this.tail=this.head=null}function Q(a,b){var c=!1;if("mesh"==b||"convex"==b)c=!0;var e=a.isBufferGeometry?(new THREE.Geometry).fromBufferGeometry(a):a;e.mergeVertices();var d=a.attributes.position.array.length/3,k=e.vertices.length,g=e.faces.length;a.realVertices=new Float32Array(3*k);a.realIndices=new (65535<3*g?Uint32Array:Uint16Array)(3*g);a.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
d),3));var p=a.attributes.color.array;for(b=d;b--;){var f=3*b;p[f]=1;p[f+1]=1;p[f+2]=1}for(b=k;b--;)p=e.vertices[b],f=3*b,a.realVertices[f]=p.x,a.realVertices[f+1]=p.y,a.realVertices[f+2]=p.z;for(b=g;b--;)p=e.faces[b],f=3*b,a.realIndices[f]=p.a,a.realIndices[f+1]=p.b,a.realIndices[f+2]=p.c;e.dispose();if(c){d=[];for(b=a.realIndices.length;b--;)f=3*b,p=3*a.realIndices[b],d[f]=a.realVertices[p],d[f+1]=a.realVertices[p+1],d[f+2]=a.realVertices[p+2];return d}e=[];var h=a.attributes.position.array;for(b=
k;b--;)for(f=3*b,e[b]=[],c=d;c--;)p=3*c,h[p]==a.realVertices[f]&&h[p+1]==a.realVertices[f+1]&&h[p+2]==a.realVertices[f+2]&&e[b].push(c);h=new (65535<k?Uint32Array:Uint16Array)(k);var m=new (65535<d?Uint32Array:Uint16Array)(d);for(b=p=0;b<k;b++){f=e[b].length;h[b]=p;for(c=f;c--;)m[p+c]=e[b][c];p+=f}a.numFaces=g;a.numVertices=k;a.maxi=d;a.pPoint=h;a.lPoint=m}function R(a,b,c,e){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var d=a||1;b=b||1;var k=c||12,g=Math.floor(.5*k);a=e||1;
var f=2*Math.PI,z=.5*Math.PI;e=new THREE.Geometry;a=new THREE.CylinderGeometry(d,d,b,k,a,!0);var h=new THREE.SphereGeometry(d,k,g,0,f,0,z);d=new THREE.SphereGeometry(d,k,g,0,f,z,z);k=(new THREE.Matrix4).makeTranslation(0,0,0);6===c&&k.makeRotationY(.5235987755982988);c=(new THREE.Matrix4).makeTranslation(0,.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,.5*-b,0);e.merge(a,k);e.merge(h,c);e.merge(d,b);e.mergeVertices();this.fromGeometry(e)}function K(a){THREE.Geometry.call(this);this.fromBufferGeometry(new E(a));
this.mergeVertices()}function E(a){THREE.BufferGeometry.call(this);var b=[],c=[];a=(new D).setFromPoints(a).faces;for(var e=0;e<a.length;e++){var d=a[e],k=d.edge;do{var g=k.head().point;b.push(g.x,g.y,g.z);c.push(d.normal.x,d.normal.y,d.normal.z);k=k.next}while(k!==d.edge)}this.addAttribute("position",new THREE.Float32BufferAttribute(b,3));this.addAttribute("normal",new THREE.Float32BufferAttribute(c,3))}function C(a){for(var b=a.length;b--;)a[b]*=f.torad;return a}function S(){this.ID=0;this.solids=
[];this.bodys=[]}function T(){this.ID=0;this.softs=[]}function U(a,b){var c=a.shape.clone(),e=a.size||[1,1,1];c.scale(e[0],e[1],e[2]);Q(c);f.extraGeo.push(c);a.v=c.realVertices;a.i=c.realIndices;a.ntri=c.numFaces;b=new THREE.Mesh(c,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=5;b.points=a.v.length/3;a.shape&&delete a.shape;a.material&&delete a.material;return{mesh:b,o:a}}function V(){this.ID=0;this.terrains=[]}function W(){this.ID=0;this.cars=[]}function X(){this.ID=0;this.heroes=[]}function Y(){this.ID=
0;this.pairs=[]}function Z(a,b){this.name=a;this.callback=b}function aa(){this.ID=0;this.rays=[]}function ba(a){THREE.Line.call(this);this.name=a.name;this.visible=void 0!==a.visible?a.visible:!0;this.callback=a.callback||function(){};this.position.fromArray(a.pos||[0,0,0]);this.group=void 0!==a.group?a.group:1;this.mask=void 0!==a.mask?a.mask:-1;this.origin=[0,0,0];this.dest=[0,0,0];this.start=(new THREE.Vector3).fromArray(a.start||[0,0,0]);this.end=(new THREE.Vector3).fromArray(a.end||[0,10,0]);
this.tmp=new THREE.Vector3;this.normal=new THREE.Vector3;this.inv=new THREE.Matrix4;this.c1=[.1,.1,.1];this.c2=[.1,1,.1];this.vertices=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.local=[0,0,0,0,0,0];this.geometry.addAttribute("position",new THREE.Float32BufferAttribute(this.vertices,3));this.geometry.addAttribute("color",new THREE.Float32BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.colors=this.geometry.attributes.color.array;
this.material.color.setHex(16777215);this.material.vertexColors=THREE.VertexColors;this.base=!1;this.upGeo()}function F(a,b){this.minSizeForBreak=a||1.4;this.smallDelta=b||1E-4;this.tempLine1=new THREE.Line3;this.tempPlane1=new THREE.Plane;this.tempPlane2=new THREE.Plane;this.tempPlane_Cut=new THREE.Plane;this.tempCM1=new THREE.Vector3;this.tempCM2=new THREE.Vector3;this.tempVector3=new THREE.Vector3;this.tempVector3_2=new THREE.Vector3;this.tempVector3_3=new THREE.Vector3;this.tempVector3_P0=new THREE.Vector3;
this.tempVector3_P1=new THREE.Vector3;this.tempVector3_P2=new THREE.Vector3;this.tempVector3_N0=new THREE.Vector3;this.tempVector3_N1=new THREE.Vector3;this.tempVector3_AB=new THREE.Vector3;this.tempVector3_CB=new THREE.Vector3;this.tempResultObjects={object1:null,object2:null};this.segments=[];for(a=0;900>a;a++)this.segments[a]=!1}function da(a){a=new Uint8Array(a);var b={data:[],position:0,writeByte:function(a){this.data[this.position++]=a}};ea.decompressFile({data:a,position:0,readByte:function(){return this.data[this.position++]}},
b);return(new Uint8Array(b.data)).buffer}Object.assign(D.prototype,{setFromPoints:function(a){!0!==Array.isArray(a)&&console.error("THREE.QuickHull: Points parameter is not an array.");4>a.length&&console.error("THREE.QuickHull: The algorithm needs at least four points.");this.makeEmpty();for(var b=0,c=a.length;b<c;b++)this.vertices.push(new ca(a[b]));this.compute();return this},setFromObject:function(a){var b=[];a.updateMatrixWorld(!0);a.traverse(function(a){var c;var d=a.geometry;if(void 0!==d)if(d.isGeometry){var k=
d.vertices;d=0;for(c=k.length;d<c;d++){var g=k[d].clone();g.applyMatrix4(a.matrixWorld);b.push(g)}}else if(d.isBufferGeometry&&(k=d.attributes.position,void 0!==k))for(d=0,c=k.count;d<c;d++)g=new THREE.Vector3,g.fromBufferAttribute(k,d).applyMatrix4(a.matrixWorld),b.push(g)});return this.setFromPoints(b)},makeEmpty:function(){this.faces=[];this.vertices=[];return this},addVertexToFace:function(a,b){a.face=b;null===b.outside?this.assigned.append(a):this.assigned.insertBefore(b.outside,a);b.outside=
a;return this},removeVertexFromFace:function(a,b){a===b.outside&&(b.outside=null!==a.next&&a.next.face===b?a.next:null);this.assigned.remove(a);return this},removeAllVerticesFromFace:function(a){if(null!==a.outside){for(var b=a.outside,c=a.outside;null!==c.next&&c.next.face===a;)c=c.next;this.assigned.removeSubList(b,c);b.prev=c.next=null;a.outside=null;return b}},deleteFaceVertices:function(a,b){a=this.removeAllVerticesFromFace(a);if(void 0!==a)if(void 0===b)this.unassigned.appendChain(a);else{do{var c=
a.next;b.distanceToPoint(a.point)>this.tolerance?this.addVertexToFace(a,b):this.unassigned.append(a);a=c}while(null!==a)}return this},resolveUnassignedPoints:function(a){if(!1===this.unassigned.isEmpty()){var b=this.unassigned.first();do{for(var c=b.next,e=this.tolerance,d=null,k=0;k<a.length;k++){var g=a[k];if(0===g.mark){var f=g.distanceToPoint(b.point);f>e&&(e=f,d=g);if(e>1E3*this.tolerance)break}}null!==d&&this.addVertexToFace(b,d);b=c}while(null!==b)}return this},computeExtremes:function(){var a=
new THREE.Vector3,b=new THREE.Vector3,c=[],e=[],d,k,g;for(d=0;3>d;d++)c[d]=e[d]=this.vertices[0];a.copy(this.vertices[0].point);b.copy(this.vertices[0].point);d=0;for(k=this.vertices.length;d<k;d++){var f=this.vertices[d],z=f.point;for(g=0;3>g;g++)z.getComponent(g)<a.getComponent(g)&&(a.setComponent(g,z.getComponent(g)),c[g]=f);for(g=0;3>g;g++)z.getComponent(g)>b.getComponent(g)&&(b.setComponent(g,z.getComponent(g)),e[g]=f)}this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(a.x),Math.abs(b.x))+Math.max(Math.abs(a.y),
Math.abs(b.y))+Math.max(Math.abs(a.z),Math.abs(b.z)));return{min:c,max:e}},computeInitialHull:function(){var a,b,c;return function(){void 0===a&&(a=new THREE.Line3,b=new THREE.Plane,c=new THREE.Vector3);var e=this.vertices,d=this.computeExtremes(),k=d.min,g=d.max,f,z,h=0;for(d=z=0;3>d;d++){var m=g[d].point.getComponent(d)-k[d].point.getComponent(d);m>h&&(h=m,z=d)}k=k[z];g=g[z];h=0;a.set(k.point,g.point);d=0;for(f=this.vertices.length;d<f;d++){var n=e[d];if(n!==k&&n!==g&&(a.closestPointToPoint(n.point,
!0,c),m=c.distanceToSquared(n.point),m>h)){h=m;var r=n}}if(r){h=-1;b.setFromCoplanarPoints(k.point,g.point,r.point);d=0;for(f=this.vertices.length;d<f;d++)if(n=e[d],n!==k&&n!==g&&n!==r&&(m=Math.abs(b.distanceToPoint(n.point)),m>h)){h=m;var l=n}m=[];if(0>b.distanceToPoint(l.point))for(m.push(A.create(k,g,r),A.create(l,g,k),A.create(l,r,g),A.create(l,k,r)),d=0;3>d;d++)z=(d+1)%3,m[d+1].getEdge(2).setTwin(m[0].getEdge(z)),m[d+1].getEdge(1).setTwin(m[z+1].getEdge(0));else for(m.push(A.create(k,r,g),A.create(l,
k,g),A.create(l,g,r),A.create(l,r,k)),d=0;3>d;d++)z=(d+1)%3,m[d+1].getEdge(2).setTwin(m[0].getEdge((3-d)%3)),m[d+1].getEdge(0).setTwin(m[z+1].getEdge(1));for(d=0;4>d;d++)this.faces.push(m[d]);d=0;for(f=e.length;d<f;d++)if(n=e[d],n!==k&&n!==g&&n!==r&&n!==l){h=this.tolerance;var t=null;for(z=0;4>z;z++)m=this.faces[z].distanceToPoint(n.point),m>h&&(h=m,t=this.faces[z]);null!==t&&this.addVertexToFace(n,t)}return this}console.log("bug v2")}}(),reindexFaces:function(){for(var a=[],b=0;b<this.faces.length;b++){var c=
this.faces[b];0===c.mark&&a.push(c)}this.faces=a;return this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var a=0,b=this.assigned.first().face,c=b.outside;do{var e=b.distanceToPoint(c.point);if(e>a){a=e;var d=c}c=c.next}while(null!==c&&c.face===b);return d}},computeHorizon:function(a,b,c,e){this.deleteFaceVertices(c);c.mark=1;c=null===b?b=c.getEdge(0):b.next;do{var d=c.twin,k=d.face;0===k.mark&&(k.distanceToPoint(a)>this.tolerance?this.computeHorizon(a,d,k,e):e.push(c));c=c.next}while(c!==
b);return this},addAdjoiningFace:function(a,b){a=A.create(a,b.tail(),b.head());this.faces.push(a);a.getEdge(-1).setTwin(b.twin);return a.getEdge(0)},addNewFaces:function(a,b){this.newFaces=[];for(var c=null,e=null,d=0;d<b.length;d++){var k=this.addAdjoiningFace(a,b[d]);null===c?c=k:k.next.setTwin(e);this.newFaces.push(k.face);e=k}c.next.setTwin(e);return this},addVertexToHull:function(a){var b=[];this.unassigned.clear();this.removeVertexFromFace(a,a.face);this.computeHorizon(a.point,null,a.face,b);
this.addNewFaces(a,b);this.resolveUnassignedPoints(this.newFaces);return this},cleanup:function(){this.assigned.clear();this.unassigned.clear();this.newFaces=[];return this},compute:function(){var a;for(this.computeInitialHull();void 0!==(a=this.nextVertexToAdd());)this.addVertexToHull(a);this.reindexFaces();this.cleanup();return this}});Object.assign(A,{create:function(a,b,c){var e=new A;a=new G(a,e);b=new G(b,e);c=new G(c,e);a.next=c.prev=b;b.next=a.prev=c;c.next=b.prev=a;e.edge=a;return e.compute()}});
Object.assign(A.prototype,{getEdge:function(a){for(var b=this.edge;0<a;)b=b.next,a--;for(;0>a;)b=b.prev,a++;return b},compute:function(){var a;return function(){void 0===a&&(a=new THREE.Triangle);var b=this.edge.tail(),c=this.edge.head(),e=this.edge.next.head();a.set(b.point,c.point,e.point);a.getNormal(this.normal);a.getMidpoint(this.midpoint);this.area=a.getArea();this.constant=this.normal.dot(this.midpoint);return this}}(),distanceToPoint:function(a){return this.normal.dot(a)-this.constant}});
Object.assign(G.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceTo(a.point):-1},lengthSquared:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceToSquared(a.point):-1},setTwin:function(a){this.twin=a;a.twin=this;return this}});Object.assign(P.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){this.head=
this.tail=null;return this},insertBefore:function(a,b){b.prev=a.prev;b.next=a;null===b.prev?this.head=b:b.prev.next=b;a.prev=b;return this},insertAfter:function(a,b){b.prev=a;b.next=a.next;null===b.next?this.tail=b:b.next.prev=b;a.next=b;return this},append:function(a){null===this.head?this.head=a:this.tail.next=a;a.prev=this.tail;a.next=null;this.tail=a;return this},appendChain:function(a){null===this.head?this.head=a:this.tail.next=a;for(a.prev=this.tail;null!==a.next;)a=a.next;this.tail=a;return this},
remove:function(a){null===a.prev?this.head=a.next:a.prev.next=a.next;null===a.next?this.tail=a.prev:a.next.prev=a.prev;return this},removeSubList:function(a,b){null===a.prev?this.head=b.next:a.prev.next=b.next;null===b.next?this.tail=a.prev:b.next.prev=a.prev;return this},isEmpty:function(){return null===this.head}});R.prototype=Object.create(THREE.BufferGeometry.prototype);K.prototype=Object.create(THREE.Geometry.prototype);K.prototype.constructor=K;E.prototype=Object.create(THREE.BufferGeometry.prototype);
E.prototype.constructor=E;var f={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},torad:.017453292519943295},q=new Map;Object.assign(S.prototype,{step:function(a,b){var c;this.bodys.forEach(function(e,d){c=b+8*d;d=a[c];if(0<d)"sleep"==e.material.name&&(e.material=f.mat.move),50<d&&"move"==e.material.name?e.material=f.mat.speed:50>d&&"speed"==e.material.name&&(e.material=f.mat.move);else if("move"==e.material.name||"speed"==e.material.name)e.material=
f.mat.sleep;e.position.fromArray(a,c+1);e.quaternion.fromArray(a,c+4)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==c&&(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a){void 0!==
a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);a.mass=void 0===a.mass?0:a.mass;a.kinematic=a.kinematic||!1;var b="body";0!==a.mass||a.kinematic||(b="static");a.name=void 0!==a.name?a.name:b+this.ID++;this.remove(a.name);!a.breakable||"hardbox"!==a.type&&"box"!==a.type&&"sphere"!==a.type&&"cylinder"!==a.type&&"cone"!==a.type||(a.type="real"+a.type);a.type=void 0===a.type?"box":a.type;a.pos=void 0===a.pos?[0,0,0]:a.pos;b=!1;a.size=void 0==a.size?[1,1,1]:a.size;1===a.size.length&&
(a.size[1]=a.size[0]);2===a.size.length&&(a.size[2]=a.size[0]);a.geoSize&&(1===a.geoSize.length&&(a.geoSize[1]=a.geoSize[0]),2===a.geoSize.length&&(a.geoSize[2]=a.geoSize[0]));a.rot=void 0===a.rot?[0,0,0]:C(a.rot);a.quat=void 0===a.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray():a.quat;a.rotA&&(a.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(C(a.rotA))).toArray());a.rotB&&(a.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(C(a.rotB))).toArray());
a.angUpper&&(a.angUpper=C(a.angUpper));a.angLower&&(a.angLower=C(a.angLower));if("plane"===a.type)f.post("add",a);else{if(void 0!==a.material)var c=a.material.constructor===String?f.mat[a.material]:a.material;else c=0!==a.mass||a.kinematic?f.mat.move:f.mat.static,a.kinematic&&(c=f.mat.kinematic);if("compound"===a.type){for(var e,d,k=0;k<a.shapes.length;k++)d=a.shapes[k],d.size=void 0===d.size?[1,1,1]:d.size,1===d.size.length&&(d.size[1]=d.size[0]),2===d.size.length&&(d.size[2]=d.size[0]),d.pos=void 0===
d.pos?[0,0,0]:d.pos,d.rot=void 0===d.rot?[0,0,0]:C(d.rot),d.quat=void 0===d.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(d.rot)).toArray():d.quat;var g=a.geometry?new THREE.Mesh(a.geometry,c):new THREE.Group;a.geometry&&f.extraGeo.push(a.geometry);if(!a.geometry||a.debug)for(g.material=c,k=0;k<a.shapes.length;k++)d=a.shapes[k],"box"===d.type&&(d.type="hardbox"),"cylinder"===d.type&&(d.type="hardcylinder"),e=new THREE.Mesh("capsule"===d.type?new R(a.size[0],.5*a.size[1]):f.geo[d.type],
a.debug?f.mat.debug:c),e.scale.fromArray(d.size),e.position.fromArray(d.pos),e.quaternion.fromArray(d.quat),g.add(e)}else if("mesh"===a.type||"convex"===a.type)a.shape&&(a.v=Q(a.shape,a.type),f.extraGeo.push(a.shape)),a.geometry?(g=new THREE.Mesh(a.geometry,c),f.extraGeo.push(a.geometry)):g=new THREE.Mesh(a.shape,c);else{"box"!==a.type||0!==a.mass||a.kinematic||(a.type="hardbox");"capsule"===a.type&&(a.geometry=new R(a.size[0],.5*a.size[1]));if("realbox"===a.type||"realhardbox"===a.type)a.geometry=
new THREE.BoxBufferGeometry(a.size[0],a.size[1],a.size[2]);"realsphere"===a.type&&(a.geometry=new THREE.SphereBufferGeometry(a.size[0],16,12));"realcylinder"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(a.size[0],a.size[0],.5*a.size[1],12,1));"realcone"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(0,.5*a.size[0],.55*a.size[1],12,1));if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(C(a.geoRot))));
a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[1],a.geoScale[2]))}g=new THREE.Mesh(a.geometry||f.geo[a.type],c);a.geometry&&(f.extraGeo.push(a.geometry),a.geoSize&&g.scale.fromArray(a.geoSize),b=!0)}"highsphere"===a.type&&(a.type="sphere");g&&(b||g.scale.fromArray(a.size),g.position.fromArray(a.pos),g.quaternion.fromArray(a.quat),g.receiveShadow=!0,g.castShadow=0!==a.mass||a.kinematic?!0:!1,g.updateMatrix(),g.name=a.name,void 0!==a.parent?a.parent.add(g):
f.container.add(g));a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;void 0===a.noPhy&&(g&&(0!==a.mass||a.kinematic?this.bodys.push(g):this.solids.push(g)),f.post("add",a));if(g)return g.type=0!==a.mass||a.kinematic?"body":"solid",g.userData.mass=a.mass,q.set(a.name,g),g}}});Object.assign(T.prototype,{step:function(a,b){var c=b;this.softs.forEach(function(b){var d,e,g=b.geometry,f=b.softType,h=null,q=g.attributes.color?!0:!1,m=g.attributes.normal?!0:!1;if(2===f){for(e=
g.positions.length;e--;){var n=c+3*e;g.positions[e].set(a[n],a[n+1],a[n+2])}g.updatePath()}else{if(!g.attributes.position)return;var r=g.attributes.position.array;if(q)var l=g.attributes.color.array;if(5===f||4===f){var t=g.numVertices,v=g.maxi,w=g.pPoint,y=g.lPoint;for(e=t;e--;){n=3*e+c;var u=e==t-1?v-w[e]:w[e+1]-w[e];for(d=w[e];u--;)l=3*y[d+u],r[l]=a[n],r[l+1]=a[n+1],r[l+2]=a[n+2]}}else if(g.attributes.order&&(h=g.attributes.order.array),e=r.length,n=2,null!==h)for(e=h.length;e--;)u=3*h[e],n=3*
e+c,r[u]=a[n],r[u+1]=a[n+1],r[u+2]=a[n+2],d=Math.abs(a[n+1]/10),l[u]=d,l[u+1]=d,l[u+2]=d;else for(;e--;)r[e]=a[e+c],1==n&&(d=Math.abs(r[e]/10),l[e-1]=d,l[e]=d,l[e+1]=d),n--,n=0>n?2:n;2!==f&&g.computeVertexNormals();if(m){n=g.attributes.normal.array;for(e=t;e--;)for(u=e==t-1?v-w[e]:w[e+1]-w[e],d=w[e],r=3*y[d];u--;)l=3*y[d+u],n[l]=n[r],n[l+1]=n[r+1],n[l+2]=n[r+2];g.attributes.normal.needsUpdate=!0}q&&(g.attributes.color.needsUpdate=!0);g.attributes.position.needsUpdate=!0;g.computeBoundingSphere()}c+=
3*b.points})},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.size=void 0==a.size?[1,1,1]:a.size;1===a.size.length&&(a.size[1]=a.size[0]);2===a.size.length&&(a.size[2]=
a.size[0]);a.rot=void 0===a.rot?[0,0,0]:C(a.rot);a.quat=void 0===a.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray():a.quat;var c=void 0!==a.material?a.material.constructor===String?f.mat[a.material]:a.material:f.mat.soft;switch(a.type){case "softMesh":case "softTriMesh":var e=U(a,c);break;case "softConvex":e=U(a,c);break;case "softCloth":e=a.div||[16,16];var d=a.size||[100,0,100],k=a.pos||[0,0,0],g=e[0]*e[1],p=new THREE.PlaneBufferGeometry(d[0],d[2],e[0]-1,e[1]-
1);p.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*g),3));p.rotateX(-Math.PI90);c=new THREE.Mesh(p,c);c.position.set(k[0],k[1],k[2]);c.castShadow=!0;c.receiveShadow=!0;c.softType=1;c.points=p.attributes.position.array.length/3;a.size=d;a.div=e;a.pos=k;e={mesh:c,o:a};break;case "softRope":void 0===a.numSeg&&(a.numSeg=a.numSegment);e=new THREE.Tubular(a,a.numSeg||10,a.radius||.2,a.numRad||6,!1);c=new THREE.Mesh(e,c);c.castShadow=!0;c.receiveShadow=!0;c.softType=2;c.points=e.positions.length;
e={mesh:c,o:a};break;case "softEllips":f.post("add",a);return}c=e.mesh;a=e.o;c.name=b;c.type="soft";f.container.add(c);this.softs.push(c);q.set(b,c);f.post("add",a)},createEllipsoid:function(a){var b=a.lng,c=[],e=a.a,d,k;for(d=0;d<b;d++){var g=3*d;c.push(new THREE.Vector3(e[g],e[g+1],e[g+2]))}c=new K(c);var p=new Uint32Array(3*c.faces.length),h=new Float32Array(3*b),B=new Float32Array(b);var m=c.vertices;for(d=b;d--;)for(k=b;k--;)g=3*k,e[g]==m[d].x&&e[g+1]==m[d].y&&e[g+2]==m[d].z&&(B[k]=d);for(d=
b;d--;)g=3*d,k=3*B[d],h[k]=e[g],h[k+1]=e[g+1],h[k+2]=e[g+2];for(d=c.faces.length;d--;)g=3*d,e=c.faces[d],p[g]=e.a,p[g+1]=e.b,p[g+2]=e.c;d=new THREE.BufferGeometry;d.setIndex(new THREE.BufferAttribute(p,1));d.addAttribute("position",new THREE.BufferAttribute(h,3));d.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*b),3));d.addAttribute("order",new THREE.BufferAttribute(B,1));c.uvs&&(b=new Float32Array(2*c.uvs.length),d.addAttribute("uv",(new THREE.BufferAttribute(b,2)).copyVector2sArray(c.uvs),
2));d.computeVertexNormals();f.extraGeo.push(d);c.dispose();b=new THREE.Mesh(d,f.mat.soft);b.softType=3;b.type="soft";b.points=d.attributes.position.array.length/3;b.castShadow=!0;b.receiveShadow=!0;b.name=a.name;f.container.add(b);this.softs.push(b);q.set(a.name,b)}});Object.assign(V.prototype,{step:function(){this.terrains.forEach(function(a){a.needsUpdate&&(a.updateGeometry(),f.post("setTerrain",{name:a.name,heightData:a.heightData}),a.needsUpdate=!1)})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());
this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.sample=void 0===a.sample?[64,64]:a.sample;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.complexity=void 0===a.complexity?30:a.complexity;a.name=b;var c=new THREE.Terrain(a);c.needsUpdate=!1;c.type="terrain";a.heightData=c.heightData;
a.offset=0;f.container.add(c);this.terrains.push(c);q.set(b,c);f.post("add",a)},move:function(a,b,c){q.has(a)&&(a=q.get(a),a.local.x+=b||0,a.local.z+=c||0,a.update(!0),a.needsUpdate=!0)}});Object.assign(W.prototype,{step:function(a,b){var c;this.cars.forEach(function(e,d){c=b+56*d;e.userData.speed=a[c];e.position.fromArray(a,c+1);e.quaternion.fromArray(a,c+4);d=e.userData.NumWheels;var f=40;var g=e.userData.radius;var p=a[c+24];e.userData.steeringWheel&&(e.userData.steeringWheel.rotation.y=15*-p);
if(e.userData.isWithBrake){var h=a[c+8],q=a[c+16];for(p=d;p--;)0===p&&(e.userData.b[p].rotation.y=q),1===p&&(e.userData.b[p].rotation.y=Math.Pi-h),e.userData.b[p].position.y=g-a[c+f+p]}if(e.userData.isWithSusp)for(p=d;p--;)g=5*a[c+f+p],g=1<g?1:g,g=-1>g?-1:g,0<g?(e.userData.s[p].setWeight("low",g),e.userData.s[p].setWeight("top",0)):(e.userData.s[p].setWeight("low",0),e.userData.s[p].setWeight("top",-g));for(e.userData.helper&&4==d&&e.userData.helper.updateSuspension(a[c+f+0],a[c+f+1],a[c+f+2],a[c+
f+3]);d--;)f=8*(d+1),e.userData.w[d].position.fromArray(a,c+f+1),e.userData.w[d].quaternion.fromArray(a,c+f+4)})},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){for(var b,c=0,e=a.userData.w.length;c<e;c++)b=a.userData.w[c],b.parent&&b.parent.remove(b);a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==
a.name?a.name:a.type+this.ID++;this.remove(b);var c=a.size||[2,.5,4],e=a.pos||[0,0,0],d=a.rot||[0,0,0];a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;Math.vectorad(d);a.mesh?(c=new THREE.Group,c.add(a.mesh)):a.geometry?(c=new THREE.Mesh(a.geometry,a.material),f.extraGeo.push(a.geometry)):(c=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(c[0],c[1],c[2])),c.translate(-a.masscenter[0],-a.masscenter[1],-a.masscenter[2]),f.extraGeo.push(c),c=new THREE.Mesh(c,f.mat.move));a.debug&&
a.shape&&(c=new THREE.Mesh(a.shape,f.mat.debug));c.position.set(e[0],e[1],e[2]);c.rotation.set(d[0],d[1],d[2]);a.quat=c.quaternion.toArray();f.container.add(c);c.userData.speed=0;c.userData.steering=0;c.userData.NumWheels=a.nw||4;c.userData.type="car";c.userData.steeringWheel=a.meshSteeringWheel||null;d=a.radius||.4;var k=a.deep||.3;e=a.wPos||[1,-.25,1.6];var g=[],p=[],h=[],B=void 0===a.meshSusp?!1:!0,m=void 0===a.meshBrake?!1:!0,n=void 0==a.wheel?!0:!1,r=a.wheel||f.geo.wheel,l=r.clone();l.rotateY(Math.Pi);
f.extraGeo.push(l);var t=f.mat.move;void 0!==a.wheelMaterial&&(t=a.wheelMaterial.constructor===String?f.mat[a.wheelMaterial]:a.wheelMaterial);for(var v=a.nw||4;v--;){if(a.meshBrake){var w=a.meshBrake.clone();c.add(w);w.position.y=d;1==v||2==v?(w.rotation.y=Math.Pi,w.position.x=e[0],w.rotation.x=Math.Pi):w.position.x=-e[0];w.position.z=0==v||1==v?e[2]:-e[2];h[v]=w}if(a.meshSusp){w=a.meshSusp.clone();c.add(w);w.position.y=d;if(1==v||2==v)w.rotation.y=Math.Pi;w.position.z=0==v||1==v?e[2]:-e[2];p[v]=
w.children[0]}if(a.meshWheel)if(g[v]=a.meshWheel.clone(),n=!1,1==v||2==v)g[v]=new THREE.Group,w=a.meshWheel.clone(),w.rotation.y=Math.Pi,g[v].add(w);else for(g[v]=a.meshWheel.clone(),w=g[v].children.length;w--;)"h_pneu"===g[v].children[w].name&&(g[v].children[w].rotation.y=Math.Pi);else g[v]=1==v||2==v?new THREE.Mesh(r,f.mat.move):new THREE.Mesh(l,f.mat.move);n&&g[v].scale.set(k,d,d);g[v].material=t;g[v].castShadow=!0;g[v].receiveShadow=!0;f.container.add(g[v])}a.extraWeels&&(n=a.meshWheel.clone(),
n.children[0].visible=!1,n.rotation.z=.5*-Math.Pi,n.position.set(0,1.25,-1.11),c.add(n));c.userData.radius=d;c.userData.w=g;c.userData.s=p;c.userData.b=h;c.userData.isWithSusp=B;c.userData.isWithBrake=m;a.helper&&(c.userData.helper=new THREE.CarHelper(e,a.masscenter,k),c.add(c.userData.helper));a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.shapeType||"convex"==a.shapeType)a.v=Q(a.shape,a.shapeType);a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;a.mesh&&
delete a.mesh;a.meshWheel&&delete a.meshWheel;a.meshSusp&&delete a.meshSusp;a.meshBrake&&delete a.meshBrake;a.meshSteeringWheel&&delete a.meshSteeringWheel;a.wheelMaterial&&delete a.wheelMaterial;this.cars.push(c);q.set(b,c);f.post("add",a)}});Object.assign(X.prototype,{step:function(a,b){var c;this.heroes.forEach(function(e,d){c=b+8*d;d=3.33*a[c];e.userData.speed=100*d;e.position.fromArray(a,c+1);e.quaternion.fromArray(a,c+4);e.skin&&(0===d?e.skin.play(0,.3):(e.skin.play(1,.3),e.skin.setTimeScale(d)))})},
clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.size=void 0==a.size?[.25,2,2]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:
a.pos;a.rot=void 0==a.rot?[0,0,0]:Math.vectorad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var c=void 0!==a.material?a.material.constructor===String?f.mat[a.material]:a.material:f.mat.hero;var e=new THREE.CapsuleBufferGeometry(a.size[0],.5*a.size[1],6),d=new THREE.Group;if(a.debug){var k=new THREE.Mesh(e,f.mat.debug);f.extraGeo.push(e);d.add(k)}a.mesh?(e=a.mesh,e.material=c,e.scale.multiplyScalar(a.scale||1),e.position.set(0,0,0),e.setTimeScale(.5),
e.play(0),d.add(e),d.skin=e):(c=new THREE.Mesh(e,c),f.extraGeo.push(e),d.add(c));d.userData.speed=0;d.userData.type="hero";d.position.fromArray(a.pos);d.quaternion.fromArray(a.quat);d.castShadow=!0;d.receiveShadow=!0;d.name=b;a.material&&delete a.material;a.mesh&&delete a.mesh;f.container.add(d);this.heroes.push(d);q.set(b,d);f.post("add",a)}});Object.assign(Y.prototype,{step:function(a,b){this.pairs.forEach(function(c,e){c.callback(a[b+e]||0)})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());
this.ID=0},destroy:function(a){a.clear();q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;this.remove(b);var c=new Z(b,a.callback);this.pairs.push(c);delete a.callback;q.set(b,c);f.post("add",a)}});Object.assign(Z.prototype,{clear:function(){this.callback=this.name=null}});Object.assign(aa.prototype,{step:function(){if(this.rays.length){var a=[];
this.rays.forEach(function(b){b.updateMatrixWorld();a.push({origin:b.origin,dest:b.dest,group:b.group,mask:b.mask})});f.post("rayCast",a)}},receive:function(a){var b=this.rays.length;if(b&&b===a.length)for(;b--;)this.rays[b].update(a[b])},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.rays.indexOf(a);-1!==b&&(this.rays.splice(b,1),this.destroy(a))}},
add:function(a){a.name=void 0!==a.name?a.name:"ray"+this.ID++;this.remove(a.name);var b=new ba(a);void 0!==a.parent?a.parent.add(b):f.container.add(b);this.rays.push(b);q.set(a.name,b);return b}});ba.prototype=Object.assign(Object.create(THREE.Line.prototype),{setFromCamera:function(a,b){b&&b.isPerspectiveCamera?(this.start.setFromMatrixPosition(b.matrixWorld),this.tmp.set(a.x,a.y,.5).unproject(b).sub(this.start).normalize(),this.end.copy(this.tmp).multiplyScalar(b.far).add(this.start)):b&&b.isOrthographicCamera?
(this.start.set(a.x,a.y,(b.near+b.far)/(b.near-b.far)).unproject(b),this.normal.set(0,0,-1).transformDirection(b.matrixWorld),this.end.addScaledVector(this.normal,b.far)):console.error("THREE.Raycaster: Unsupported camera type.")},updateMatrixWorld:function(a){THREE.Line.prototype.updateMatrixWorld.call(this,a);this.tmp.copy(this.start).applyMatrix4(this.matrixWorld);this.tmp.toArray(this.origin,0);this.tmp.copy(this.end).applyMatrix4(this.matrixWorld);this.tmp.toArray(this.dest,0);this.inv.getInverse(this.matrixWorld)},
upGeo:function(a){if(this.visible){var b=this.vertices,c=this.colors,e=this.local;if(a)this.isBase=!1,c[0]=c[3]=c[15]=c[18]=this.c2[0],c[1]=c[4]=c[16]=c[19]=this.c2[1],c[2]=c[5]=c[17]=c[20]=this.c2[2],b[3]=b[6]=b[12]=b[15]=e[0],b[4]=b[7]=b[13]=b[16]=e[1],b[5]=b[8]=b[14]=b[17]=e[2],b[18]=e[3],b[19]=e[4],b[20]=e[5],this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0;else if(!this.isBase){for(var d=7;d--;)a=3*d,e=3>d?!0:!1,c[a]=this.c1[0],c[a+1]=this.c1[1],
c[a+2]=this.c1[2],b[a]=e?this.start.x:this.end.x,b[a+1]=e?this.start.y:this.end.y,b[a+2]=e?this.start.z:this.end.z;this.geometry.attributes.position.needsUpdate=!0;this.isBase=this.geometry.attributes.color.needsUpdate=!0}}},update:function(a){if(a.hit){if(this.visible){this.tmp.fromArray(a.point).applyMatrix4(this.inv);var b=this.tmp.distanceTo(this.end);this.tmp.toArray(this.local,0);this.normal.fromArray(a.normal);this.tmp.addScaledVector(this.normal,b);this.tmp.toArray(this.local,3);this.upGeo(!0)}}else this.upGeo();
this.callback(a)}});F.prototype={constructor:F,prepareBreakableObject:function(a,b,c,e,d){a.geometry.isBufferGeometry||console.error("ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");a=a.userData;a.mass=b;a.velocity=void 0!==c?c.clone():new THREE.Vector3;a.angularVelocity=void 0!==e?e.clone():new THREE.Vector3;a.breakable=d},subdivideByImpact:function(a,b,c,e,d){function f(b,c,d,k){if(Math.random()<.05*k||k>n)g.push(b);else{var l=Math.PI;0===k?(m.normal.copy(q.normal),
m.constant=q.constant):k<=e?(l=(d-c)*(.2+.6*Math.random())+c,r.tempVector3_2.copy(a.position).sub(p).applyAxisAngle(h,l).add(p),m.setFromCoplanarPoints(p,r.tempVector3,r.tempVector3_2)):(l=(.5*(k&1)+.2*(2-Math.random()))*Math.PI,r.tempVector3_2.copy(p).sub(b.position).applyAxisAngle(h,l).add(b.position),r.tempVector3_3.copy(h).add(b.position),m.setFromCoplanarPoints(b.position,r.tempVector3_3,r.tempVector3_2));r.cutByPlane(b,m,r.tempResultObjects);b=r.tempResultObjects.object1;var t=r.tempResultObjects.object2;
b&&f(b,c,l,k+1);t&&f(t,l,d,k+1)}}var g=[],p=(new THREE.Vector3).fromArray(b),h=(new THREE.Vector3).fromArray(c),q=this.tempPlane1,m=this.tempPlane2;this.tempVector3.addVectors(p,h);q.setFromCoplanarPoints(p,a.position,this.tempVector3);var n=d+e,r=this;f(a,0,2*Math.PI,0);return g},cutByPlane:function(a,b,c){function e(a,b){a=3*a+b;return B?B[a]:a}var d=a.geometry,f=d.attributes.position.array,g=d.attributes.normal.array,h=f.length/3,q=h/3,B=d.getIndex();B&&(B=B.array,q=B.length/3);d=[];for(var m=
[],n=this.smallDelta,r=h*h,l=0;l<r;l++)this.segments[l]=!1;r=this.tempVector3_P0;var t=this.tempVector3_P1,v=this.tempVector3_N0,w=this.tempVector3_N1;for(l=0;l<q-1;l++){var y=e(l,0),u=e(l,1),x=e(l,2);v.set(g[y],g[y]+1,g[y]+2);for(var A=l+1;A<q;A++){var N=e(A,0),C=e(A,1),H=e(A,2);w.set(g[N],g[N]+1,g[N]+2);if(1-v.dot(w)<n)if(y===N||y===C||y===H)u===N||u===C||u===H?(this.segments[y*h+u]=!0,this.segments[u*h+y]=!0):(this.segments[x*h+y]=!0,this.segments[y*h+x]=!0);else if(u===N||u===C||u===H)this.segments[x*
h+u]=!0,this.segments[u*h+x]=!0}}g=this.tempPlane_Cut;a.updateMatrix();F.transformPlaneToLocalSpace(b,a.matrix,g);for(l=0;l<q;l++)for(b=e(l,0),v=e(l,1),w=e(l,2),y=0;3>y;y++)if(u=0===y?b:1===y?v:w,x=0===y?v:1===y?w:b,!this.segments[u*h+x]&&(this.segments[u*h+x]=!0,this.segments[x*h+u]=!0,r.set(f[3*u],f[3*u+1],f[3*u+2]),t.set(f[3*x],f[3*x+1],f[3*x+2]),u=0,x=g.distanceToPoint(r),x>n?(u=2,m.push(r.clone())):x<-n?(u=1,d.push(r.clone())):(u=3,d.push(r.clone()),m.push(r.clone())),x=0,x=g.distanceToPoint(t),
x>n?(x=2,m.push(t.clone())):x<-n?(x=1,d.push(t.clone())):(x=3,d.push(t.clone()),m.push(t.clone())),1===u&&2===x||2===u&&1===x)){this.tempLine1.start.copy(r);this.tempLine1.end.copy(t);u=new THREE.Vector3;u=g.intersectLine(this.tempLine1,u);if(void 0===u)return console.error("Internal error: segment does not intersect plane."),c.segmentedObject1=null,c.segmentedObject2=null,0;d.push(u);m.push(u.clone())}f=.5*a.userData.mass;this.tempCM1.set(0,0,0);h=0;q=d.length;if(0<q){for(l=0;l<q;l++)this.tempCM1.add(d[l]);
this.tempCM1.divideScalar(q);for(l=0;l<q;l++)t=d[l],t.sub(this.tempCM1),h=Math.max(h,t.x,t.y,t.z);this.tempCM1.add(a.position)}this.tempCM2.set(0,0,0);n=0;r=m.length;if(0<r){for(l=0;l<r;l++)this.tempCM2.add(m[l]);this.tempCM2.divideScalar(r);for(l=0;l<r;l++)t=m[l],t.sub(this.tempCM2),n=Math.max(n,t.x,t.y,t.z);this.tempCM2.add(a.position)}t=l=null;b=0;4<q&&(l=new THREE.Mesh(new E(d),a.material),l.position.copy(this.tempCM1),l.quaternion.copy(a.quaternion),this.prepareBreakableObject(l,f,a.userData.velocity,
a.userData.angularVelocity,2*h>this.minSizeForBreak),b++);4<r&&(t=new THREE.Mesh(new E(m),a.material),t.position.copy(this.tempCM2),t.quaternion.copy(a.quaternion),this.prepareBreakableObject(t,f,a.userData.velocity,a.userData.angularVelocity,2*n>this.minSizeForBreak),b++);c.object1=l;c.object2=t;return b}};F.transformFreeVector=function(a,b){var c=a.x,e=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[4]*e+b[8]*d;a.y=b[1]*c+b[5]*e+b[9]*d;a.z=b[2]*c+b[6]*e+b[10]*d;return a};F.transformFreeVectorInverse=function(a,
b){var c=a.x,e=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[1]*e+b[2]*d;a.y=b[4]*c+b[5]*e+b[6]*d;a.z=b[8]*c+b[9]*e+b[10]*d;return a};F.transformTiedVectorInverse=function(a,b){var c=a.x,e=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[1]*e+b[2]*d-b[12];a.y=b[4]*c+b[5]*e+b[6]*d-b[13];a.z=b[8]*c+b[9]*e+b[10]*d-b[14];return a};F.transformPlaneToLocalSpace=function(){var a=new THREE.Vector3;return function(b,c,e){e.normal.copy(b.normal);e.constant=b.constant;b=F.transformTiedVectorInverse(b.coplanarPoint(a),c);F.transformFreeVectorInverse(e.normal,
c);e.constant=-b.dot(e.normal)}}();var ea=function(){var a=a||{};a.OutWindow=function(){this._windowSize=0};a.OutWindow.prototype.create=function(a){this._buffer&&this._windowSize===a||(this._buffer=[]);this._windowSize=a;this._streamPos=this._pos=0};a.OutWindow.prototype.flush=function(){var a=this._pos-this._streamPos;if(0!==a){for(;a--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0);this._streamPos=this._pos}};a.OutWindow.prototype.releaseStream=
function(){this.flush();this._stream=null};a.OutWindow.prototype.setStream=function(a){this.releaseStream();this._stream=a};a.OutWindow.prototype.init=function(a){a||(this._pos=this._streamPos=0)};a.OutWindow.prototype.copyBlock=function(a,c){a=this._pos-a-1;for(0>a&&(a+=this._windowSize);c--;)a>=this._windowSize&&(a=0),this._buffer[this._pos++]=this._buffer[a++],this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.putByte=function(a){this._buffer[this._pos++]=a;this._pos>=this._windowSize&&
this.flush()};a.OutWindow.prototype.getByte=function(a){a=this._pos-a-1;0>a&&(a+=this._windowSize);return this._buffer[a]};a.RangeDecoder=function(){};a.RangeDecoder.prototype.setStream=function(a){this._stream=a};a.RangeDecoder.prototype.releaseStream=function(){this._stream=null};a.RangeDecoder.prototype.init=function(){var a=5;this._code=0;for(this._range=-1;a--;)this._code=this._code<<8|this._stream.readByte()};a.RangeDecoder.prototype.decodeDirectBits=function(a){for(var b=0,e;a--;)this._range>>>=
1,e=this._code-this._range>>>31,this._code-=this._range&e-1,b=b<<1|1-e,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return b};a.RangeDecoder.prototype.decodeBit=function(a,c){var b=a[c],d=(this._range>>>11)*b;if((this._code^2147483648)<(d^2147483648))return this._range=d,a[c]+=2048-b>>>5,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0;this._range-=d;this._code-=d;a[c]-=b>>>5;0===(this._range&4278190080)&&
(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return 1};a.initBitModels=function(a,c){for(;c--;)a[c]=1024};a.BitTreeDecoder=function(a){this._models=[];this._numBitLevels=a};a.BitTreeDecoder.prototype.init=function(){a.initBitModels(this._models,1<<this._numBitLevels)};a.BitTreeDecoder.prototype.decode=function(a){for(var b=1,e=this._numBitLevels;e--;)b=b<<1|a.decodeBit(this._models,b);return b-(1<<this._numBitLevels)};a.BitTreeDecoder.prototype.reverseDecode=function(a){for(var b=
1,e=0,d=0,f;d<this._numBitLevels;++d)f=a.decodeBit(this._models,b),b=b<<1|f,e|=f<<d;return e};a.reverseDecode2=function(a,c,e,d){for(var b=1,f=0,h=0,q;h<d;++h)q=e.decodeBit(a,c+b),b=b<<1|q,f|=q<<h;return f};a.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new a.BitTreeDecoder(8);this._numPosStates=0};a.LenDecoder.prototype.create=function(b){for(;this._numPosStates<b;++this._numPosStates)this._lowCoder[this._numPosStates]=new a.BitTreeDecoder(3),this._midCoder[this._numPosStates]=
new a.BitTreeDecoder(3)};a.LenDecoder.prototype.init=function(){var b=this._numPosStates;for(a.initBitModels(this._choice,2);b--;)this._lowCoder[b].init(),this._midCoder[b].init();this._highCoder.init()};a.LenDecoder.prototype.decode=function(a,c){return 0===a.decodeBit(this._choice,0)?this._lowCoder[c].decode(a):0===a.decodeBit(this._choice,1)?8+this._midCoder[c].decode(a):16+this._highCoder.decode(a)};a.Decoder2=function(){this._decoders=[]};a.Decoder2.prototype.init=function(){a.initBitModels(this._decoders,
768)};a.Decoder2.prototype.decodeNormal=function(a){var b=1;do b=b<<1|a.decodeBit(this._decoders,b);while(256>b);return b&255};a.Decoder2.prototype.decodeWithMatchByte=function(a,c){var b=1;do{var d=c>>7&1;c<<=1;var f=a.decodeBit(this._decoders,(1+d<<8)+b);b=b<<1|f;if(d!==f){for(;256>b;)b=b<<1|a.decodeBit(this._decoders,b);break}}while(256>b);return b&255};a.LiteralDecoder=function(){};a.LiteralDecoder.prototype.create=function(b,c){if(!this._coders||this._numPrevBits!==c||this._numPosBits!==b)for(this._numPosBits=
b,this._posMask=(1<<b)-1,this._numPrevBits=c,this._coders=[],b=1<<this._numPrevBits+this._numPosBits;b--;)this._coders[b]=new a.Decoder2};a.LiteralDecoder.prototype.init=function(){for(var a=1<<this._numPrevBits+this._numPosBits;a--;)this._coders[a].init()};a.LiteralDecoder.prototype.getDecoder=function(a,c){return this._coders[((a&this._posMask)<<this._numPrevBits)+((c&255)>>>8-this._numPrevBits)]};a.Decoder=function(){this._outWindow=new a.OutWindow;this._rangeDecoder=new a.RangeDecoder;this._isMatchDecoders=
[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new a.BitTreeDecoder(4);this._lenDecoder=new a.LenDecoder;this._repLenDecoder=new a.LenDecoder;this._literalDecoder=new a.LiteralDecoder;this._dictionarySizeCheck=this._dictionarySize=-1;this._posSlotDecoder[0]=new a.BitTreeDecoder(6);this._posSlotDecoder[1]=new a.BitTreeDecoder(6);this._posSlotDecoder[2]=
new a.BitTreeDecoder(6);this._posSlotDecoder[3]=new a.BitTreeDecoder(6)};a.Decoder.prototype.setDictionarySize=function(a){if(0>a)return!1;this._dictionarySize!==a&&(this._dictionarySize=a,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096)));return!0};a.Decoder.prototype.setLcLpPb=function(a,c,e){var b=1<<e;if(8<a||4<c||4<e)return!1;this._literalDecoder.create(c,a);this._lenDecoder.create(b);this._repLenDecoder.create(b);this._posStateMask=
b-1;return!0};a.Decoder.prototype.init=function(){var b=4;this._outWindow.init(!1);a.initBitModels(this._isMatchDecoders,192);a.initBitModels(this._isRep0LongDecoders,192);a.initBitModels(this._isRepDecoders,12);a.initBitModels(this._isRepG0Decoders,12);a.initBitModels(this._isRepG1Decoders,12);a.initBitModels(this._isRepG2Decoders,12);a.initBitModels(this._posDecoders,114);for(this._literalDecoder.init();b--;)this._posSlotDecoder[b].init();this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();
this._rangeDecoder.init()};a.Decoder.prototype.decode=function(b,c,e){var d=0,f=0,g=0,h=0,q=0,B=0,m=0;this._rangeDecoder.setStream(b);this._outWindow.setStream(c);for(this.init();0>e||B<e;)if(b=B&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(d<<4)+b))m=this._literalDecoder.getDecoder(B++,m),m=7<=d?m.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(f)):m.decodeNormal(this._rangeDecoder),this._outWindow.putByte(m),d=4>d?0:d-(10>d?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,
d))m=0,0===this._rangeDecoder.decodeBit(this._isRepG0Decoders,d)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(d<<4)+b)&&(d=7>d?9:11,m=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,d)?c=g:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,d)?c=h:(c=q,q=h),h=g),g=f,f=c),0===m&&(m=2+this._repLenDecoder.decode(this._rangeDecoder,b),d=7>d?8:11);else if(q=h,h=g,g=f,m=2+this._lenDecoder.decode(this._rangeDecoder,b),d=7>d?7:10,b=this._posSlotDecoder[5>=m?m-2:3].decode(this._rangeDecoder),
4<=b)if(c=(b>>1)-1,f=(2|b&1)<<c,14>b)f+=a.reverseDecode2(this._posDecoders,f-b-1,this._rangeDecoder,c);else{if(f+=this._rangeDecoder.decodeDirectBits(c-4)<<4,f+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),0>f){if(-1===f)break;return!1}}else f=b;if(f>=B||f>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(f,m);B+=m;m=this._outWindow.getByte(0)}this._outWindow.flush();this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return!0};a.Decoder.prototype.setDecoderProperties=
function(a){if(5>a.size)return!1;var b=a.readByte();var e=b%9;b=~~(b/9);if(!this.setLcLpPb(e,b%5,~~(b/5)))return!1;b=a.readByte();b|=a.readByte()<<8;b|=a.readByte()<<16;b+=16777216*a.readByte();return this.setDictionarySize(b)};a.decompress=function(b,c,e,d){var f=new a.Decoder;if(!f.setDecoderProperties(b))throw"Incorrect stream properties";if(!f.decode(c,e,d))throw"Error in data stream";return!0};a.decompressFile=function(b,c){var e=new a.Decoder;if(!e.setDecoderProperties(b))throw"Incorrect stream properties";
var d=b.readByte();d|=b.readByte()<<8;d|=b.readByte()<<16;d+=16777216*b.readByte();b.readByte();b.readByte();b.readByte();b.readByte();if(!e.decode(b,c,d))throw"Error in data stream";return!0};return a}();h.engine=function(){var a="LZMA",b,c,e=null,d=window.URL||window.webkitURL,k="undefined"===typeof performance?Date:performance,g=0,p=0,z=0,B=0,m=0,n=0,r,l=null,t=null,v=!1,w=!1,y="",u="",x,A,C,D,H,E,M,G=null,K=null,I="free",J=[],L=[],O={worldscale:1,gravity:[0,-10,0],fps:60,substep:2,broadphase:2,
soft:!0};h.engine={init:function(b,d,f,g){this.initArray(g);this.defaultRoot();f=f||{};c=b;O={fps:f.fps||60,worldscale:f.worldscale||1,gravity:f.gravity||[0,-10,0],substep:f.substep||2,broadphase:f.broadphase||2,soft:void 0!==f.soft?f.soft:!0,fixed:void 0!==f.fixed?f.fixed:!1};n=1/O.fps*1E3;a=d||"LZMA";"LZMA"===a?h.engine.load(O):(e=document.location.href.replace(/\/[^/]*$/,"/")+("WASM"===a?"./build/ammo.wasm.js":"./build/ammo.js"),h.engine.startWorker())},load:function(){var a=new XMLHttpRequest;
a.responseType="arraybuffer";a.open("GET","./build/ammo.hex",!0);a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status?(e=d.createObjectURL(new Blob([da(a.response)],{type:"application/javascript"})),h.engine.startWorker()):console.error("Couldn't load [./build/ammo.hex] ["+a.status+"]"))};a.send(null)},startWorker:function(){b=new Worker("./build/gun.js");b.postMessage=b.webkitPostMessage||b.postMessage;b.onmessage=h.engine.message;var a=new ArrayBuffer(1);b.postMessage({m:"test",
ab:a},[a]);v=a.byteLength?!1:!0;h.engine.post("init",{blob:e,ArPos:f.ArPos,ArMax:f.ArMax,isBuffer:v,option:O});f.post=h.engine.post},initArray:function(a){a=a||{};f.ArLng=[8*(a.maxBody||1400),a.maxContact||200,8*(a.maxCharacter||10),56*(a.maxCar||14),3*(a.maxSoftPoint||8192)];f.ArPos=[0,f.ArLng[0],f.ArLng[0]+f.ArLng[1],f.ArLng[0]+f.ArLng[1]+f.ArLng[2],f.ArLng[0]+f.ArLng[1]+f.ArLng[2]+f.ArLng[3]];f.ArMax=f.ArLng[0]+f.ArLng[1]+f.ArLng[2]+f.ArLng[3]+f.ArLng[4]},message:function(a){a=a.data;a.Ar&&(f.Ar=
a.Ar);switch(a.m){case "initEngine":h.engine.initEngine();break;case "start":h.engine.start();break;case "step":h.engine.step();break;case "moveSolid":h.engine.moveSolid(a.o);break;case "ellipsoid":h.engine.ellipsoidMesh(a.o);break;case "makeBreak":h.engine.makeBreak(a.o);break;case "rayCast":M.receive(a.o)}},initEngine:function(){d.revokeObjectURL(e);e=null;this.initObject();console.log("AMMO.Worker 002"+(v?" with ":" without ")+"Buffer #"+a);c&&c()},start:function(){w=!0;v&&(f.Ar=new Float32Array(f.ArMax));
z=k.now();l&&clearInterval(l);l=setInterval(h.engine.sendData,n);h.engine.setMode(u)},postUpdate:function(){},update:function(){h.engine.postUpdate();C.step();M.step();x.step(f.Ar,f.ArPos[0]);E.step(f.Ar,f.ArPos[1]);H.step(f.Ar,f.ArPos[2]);D.step(f.Ar,f.ArPos[3]);A.step(f.Ar,f.ArPos[4])},step:function(){g-1E3>B&&(B=g,r=m,m=0);m++;h.engine.tell();t&&t.needUpdate(!0);h.engine.update();h.engine.stepRemove();h.engine.stepAdd();w=!0},sendData:function(){t&&t.pause&&h.engine.stop();w&&(g=k.now(),p=.001*
(g-z),z=g,v?b.postMessage({m:"step",o:{delta:p,key:h.engine.getKey()},Ar:f.Ar},[f.Ar.buffer]):b.postMessage({m:"step",o:{delta:p,key:h.engine.getKey()}}),w=!1)},stepRemove:function(){if(0!==J.length)for(this.post("setRemove",J);0<J.length;)this.remove(J.pop(),!0)},stepAdd:function(){if(0!==L.length)for(;0<L.length;)this.add(L.pop())},setView:function(a){t=a;f.mat=a.getMat();f.geo=a.getGeo();f.container=a.getScene()},getFps:function(){return r},getDelta:function(){return p},tell:function(){},log:function(){},
getKey:function(){return[0,0,0,0,0,0,0,0]},set:function(a){a=a||O;n=void 0!==a.fps?1/a.fps*1E3:n;this.post("set",a)},post:function(a,c){b.postMessage({m:a,o:c})},reset:function(a){u=y;h.engine.setMode("");h.engine.stop();for(h.engine.clear();0<f.tmpMat.length;)f.tmpMat.pop().dispose();h.engine.postUpdate=function(){};J=[];L=[];t&&t.reset(a);h.engine.post("reset",{full:a})},stop:function(){l&&(clearInterval(l),l=null)},destroy:function(){b.terminate();b=void 0},addMat:function(a){f.tmpMat.push(a)},
ellipsoidMesh:function(a){A.createEllipsoid(a)},updateTmpMat:function(a,b){for(var c=f.tmpMat.length,d;c--;)d=f.tmpMat[c],void 0!==d.envMap&&(d.envMap="MeshStandardMaterial"===d.type?a:b?null:a,d.needsUpdate=!0)},drive:function(a){this.post("setDrive",a)},move:function(a){this.post("setMove",a)},forces:function(a){this.post("setForces",a)},option:function(a){this.post("setOption",a)},removes:function(a){J=J.concat(a)},matrix:function(a){this.post("setMatrix",a)},anchor:function(a){this.post("addAnchor",
a)},break:function(a){this.post("addBreakable",a)},moveSolid:function(a){if(q.has(a.name)){var b=q.get(a.name);void 0!==a.pos&&b.position.fromArray(a.pos);void 0!==a.quat&&b.quaternion.fromArray(a.quat)}},getBodys:function(){return x.bodys},byName:function(a){return q.get(a)},initObject:function(){x=new S;A=new T;C=new V;D=new W;H=new X;E=new Y;M=new aa},clear:function(){x.clear();E.clear();C.clear();D.clear();H.clear();A.clear();for(M.clear();0<f.extraGeo.length;)f.extraGeo.pop().dispose()},remove:function(a,
b){if(q.has(a)){switch(h.engine.byName(a).type){case "solid":case "body":x.remove(a);break;case "soft":A.remove(a);break;case "terrain":C.remove(a)}b||this.post("remove",a)}},removeConstraint:function(a){this.post("remove",a)},removeRay:function(a){M.remove(a)},addGroup:function(a){L=L.concat(a)},add:function(a){a=a||{};var b=void 0===a.type?"box":a.type,c=b.substring(0,4);if("join"===c)f.post("add",a);else if("soft"===c)A.add(a);else if("terrain"===b)C.add(a);else if("character"===b)H.add(a);else if("collision"===
b)E.add(a);else if("car"===b)D.add(a);else return"ray"===b?M.add(a):x.add(a)},defaultRoot:function(){var a={circle:new THREE.CircleBufferGeometry(1,6),plane:new THREE.PlaneBufferGeometry(1,1,1,1),box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,
1,1,12,1),hardcylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};a.circle.rotateX(-1.570796326794896);a.plane.rotateX(-1.570796326794896);a.wheel.rotateZ(-1.570796326794896);f.geo=a;f.mat={move:new THREE.MeshLambertMaterial({color:16746513,name:"move",wireframe:!1}),speed:new THREE.MeshLambertMaterial({color:16776977,name:"speed",wireframe:!1}),sleep:new THREE.MeshLambertMaterial({color:1149183,name:"sleep",wireframe:!1}),basic:new THREE.MeshLambertMaterial({color:1118481,name:"basic",wireframe:!1}),
static:new THREE.MeshLambertMaterial({color:1118719,name:"static",wireframe:!1}),kinematic:new THREE.MeshLambertMaterial({color:1179409,name:"kinematic",wireframe:!1})};f.container=new THREE.Group},getContainer:function(){return f.container},makeBreak:function(a){var b=a.name;if(q.has(b)){null===G&&(G=new F);var c=q.get(b),d=a.breakOption;a=G.subdivideByImpact(c,a.pos,a.normal,d[1],d[2]);--d[3];J.push(b);for(c=a.length;c--;)L.push(this.addDebris(b,c,a[c],d))}},addDebris:function(a,b,c,d){a={name:a+
"_debris"+b,material:c.material,type:"convex",shape:c.geometry,pos:c.position.toArray(),quat:c.quaternion.toArray(),mass:c.userData.mass,linearVelocity:c.userData.velocity.toArray(),angularVelocity:c.userData.angularVelocity.toArray(),margin:.05};0<d[3]&&(a.breakable=!0,a.breakOption=d);return a},setMode:function(a){a!==y&&("picker"===y&&h.engine.removeRayCamera(),"shoot"===y&&h.engine.removeShootCamera());y=a;"picker"===y&&h.engine.addRayCamera();"shoot"===y&&h.engine.addShootCamera()},addShootCamera:function(){},
removeShootCamera:function(){},removeRayCamera:function(){t&&(h.engine.removeRay("cameraRay"),t.removeRay(),h.engine.log())},addRayCamera:function(){t&&(K=h.engine.add({name:"cameraRay",type:"ray",callback:h.engine.onRay,mask:1,visible:!1}),t.activeRay(h.engine.updateRayCamera,!1))},updateRayCamera:function(a){"drag"===I&&h.engine.matrix([{name:"dragger",pos:a.toArray(),keepRot:!0}])},onRay:function(a){var b=t.getMouse(),c=t.getControls(),d=void 0===a.name?"":a.name;K.setFromCamera(b,c.object);0===
b.z?("drag"===I&&(c.enableRotate=!0,h.engine.removeConnector()),I="free"):"free"===I&&(d?"drag"!==I&&(t.setDragPlane(a.point),c.enableRotate=!1,h.engine.addConnector(a),I="drag"):I="rotate");h.engine.log(I+"   "+d)},addConnector:function(a){var b=h.engine.byName(a.name),c=(new THREE.Vector3).fromArray(a.point),d=b.quaternion.toArray();b=h.engine.getLocalPoint(c,b).toArray();h.engine.add({name:"dragger",type:"sphere",size:[.1],pos:a.point,quat:d,mass:0,kinematic:!0,group:32,mask:32});h.engine.add({name:"connector",
type:"joint_fixe",b1:"dragger",b2:a.name,pos1:[0,0,0],pos2:b,collision:!1})},removeConnector:function(){h.engine.remove("dragger");h.engine.removeConstraint("connector")},getLocalPoint:function(a,b){b.updateMatrix();var c=new THREE.Matrix4,d=new THREE.Vector3(1,1,1);b=(new THREE.Matrix4).compose(b.position,b.quaternion,d);c.getInverse(b);return a.applyMatrix4(c)}};return h.engine}();Object.defineProperty(h,"__esModule",{value:!0})});
