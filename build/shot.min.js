(function(r,B){"object"===typeof exports&&"undefined"!==typeof module?B(exports):"function"===typeof define&&define.amd?define(["exports"],B):(r=r||self,B(r.SHOT={}))})(this,function(r){function B(){this.tolerance=-1;this.faces=[];this.newFaces=[];this.assigned=new I;this.unassigned=new I;this.vertices=[]}function z(){this.normal=new THREE.Vector3;this.midpoint=new THREE.Vector3;this.constant=this.area=0;this.outside=null;this.mark=0;this.edge=null}function G(a,b){this.vertex=a;this.twin=this.next=
this.prev=null;this.face=b}function U(a){this.point=a;this.face=this.next=this.prev=null}function I(){this.tail=this.head=null}function J(a,b){var d=!1;if("mesh"==b||"convex"==b)d=!0;var e=a.isBufferGeometry?(new THREE.Geometry).fromBufferGeometry(a):a;e.mergeVertices();var c=a.attributes.position.array.length/3,h=e.vertices.length,g=e.faces.length;a.realVertices=new Float32Array(3*h);a.realIndices=new (65535<3*g?Uint32Array:Uint16Array)(3*g);a.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
c),3));var l=a.attributes.color.array;for(b=c;b--;){var f=3*b;l[f]=1;l[f+1]=1;l[f+2]=1}for(b=h;b--;)l=e.vertices[b],f=3*b,a.realVertices[f]=l.x,a.realVertices[f+1]=l.y,a.realVertices[f+2]=l.z;for(b=g;b--;)l=e.faces[b],f=3*b,a.realIndices[f]=l.a,a.realIndices[f+1]=l.b,a.realIndices[f+2]=l.c;e.dispose();if(d){c=[];for(b=a.realIndices.length;b--;)f=3*b,l=3*a.realIndices[b],c[f]=a.realVertices[l],c[f+1]=a.realVertices[l+1],c[f+2]=a.realVertices[l+2];return c}e=[];var v=a.attributes.position.array;for(b=
h;b--;)for(f=3*b,e[b]=[],d=c;d--;)l=3*d,v[l]==a.realVertices[f]&&v[l+1]==a.realVertices[f+1]&&v[l+2]==a.realVertices[f+2]&&e[b].push(d);v=new (65535<h?Uint32Array:Uint16Array)(h);var m=new (65535<c?Uint32Array:Uint16Array)(c);for(b=l=0;b<h;b++){f=e[b].length;v[b]=l;for(d=f;d--;)m[l+d]=e[b][d];l+=f}a.numFaces=g;a.numVertices=h;a.maxi=c;a.pPoint=v;a.lPoint=m}function K(a,b,d,e){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var c=a||1;b=b||1;var h=d||12,g=Math.floor(.5*h);a=e||1;
var f=2*Math.PI,n=.5*Math.PI;e=new THREE.Geometry;a=new THREE.CylinderGeometry(c,c,b,h,a,!0);var v=new THREE.SphereGeometry(c,h,g,0,f,0,n);c=new THREE.SphereGeometry(c,h,g,0,f,n,n);h=(new THREE.Matrix4).makeTranslation(0,0,0);6===d&&h.makeRotationY(.5235987755982988);d=(new THREE.Matrix4).makeTranslation(0,.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,.5*-b,0);e.merge(a,h);e.merge(v,d);e.merge(c,b);e.mergeVertices();this.fromGeometry(e)}function H(a){THREE.Geometry.call(this);this.fromBufferGeometry(new D(a));
this.mergeVertices()}function D(a){THREE.BufferGeometry.call(this);var b=[],d=[];a=(new B).setFromPoints(a).faces;for(var e=0;e<a.length;e++){var c=a[e],h=c.edge;do{var g=h.head().point;b.push(g.x,g.y,g.z);d.push(c.normal.x,c.normal.y,c.normal.z);h=h.next}while(h!==c.edge)}this.addAttribute("position",new THREE.Float32BufferAttribute(b,3));this.addAttribute("normal",new THREE.Float32BufferAttribute(d,3))}function A(a){for(var b=a.length;b--;)a[b]*=f.torad;return a}function M(){this.ID=0;this.solids=
[];this.bodys=[]}function N(){this.ID=0;this.softs=[]}function O(a,b){var d=a.shape.clone(),e=a.pos||[0,0,0],c=a.size||[1,1,1],h=a.rot||[0,0,0];d.translate(e[0],e[1],e[2]);d.scale(c[0],c[1],c[2]);d.applyMatrix((new THREE.Matrix4).makeRotationY(h[1]*=Math.torad));J(d);f.extraGeo.push(d);a.v=d.realVertices;a.i=d.realIndices;a.ntri=d.numFaces;b=new THREE.Mesh(d,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=5;b.points=a.v.length/3;a.shape&&delete a.shape;a.material&&delete a.material;return{mesh:b,
o:a}}function P(){this.ID=0;this.terrains=[]}function Q(){this.ID=0;this.cars=[]}function R(){this.ID=0;this.heroes=[]}function S(){this.ID=0;this.pairs=[]}function T(a,b){this.name=a;this.callback=b}function E(a,b){this.minSizeForBreak=a||1.4;this.smallDelta=b||1E-4;this.tempLine1=new THREE.Line3;this.tempPlane1=new THREE.Plane;this.tempPlane2=new THREE.Plane;this.tempPlane_Cut=new THREE.Plane;this.tempCM1=new THREE.Vector3;this.tempCM2=new THREE.Vector3;this.tempVector3=new THREE.Vector3;this.tempVector3_2=
new THREE.Vector3;this.tempVector3_3=new THREE.Vector3;this.tempVector3_P0=new THREE.Vector3;this.tempVector3_P1=new THREE.Vector3;this.tempVector3_P2=new THREE.Vector3;this.tempVector3_N0=new THREE.Vector3;this.tempVector3_N1=new THREE.Vector3;this.tempVector3_AB=new THREE.Vector3;this.tempVector3_CB=new THREE.Vector3;this.tempResultObjects={object1:null,object2:null};this.segments=[];for(a=0;900>a;a++)this.segments[a]=!1}function V(a){a=new Uint8Array(a);var b={data:[],position:0,writeByte:function(a){this.data[this.position++]=
a}};W.decompressFile({data:a,position:0,readByte:function(){return this.data[this.position++]}},b);return(new Uint8Array(b.data)).buffer}Object.assign(B.prototype,{setFromPoints:function(a){!0!==Array.isArray(a)&&console.error("THREE.QuickHull: Points parameter is not an array.");4>a.length&&console.error("THREE.QuickHull: The algorithm needs at least four points.");this.makeEmpty();for(var b=0,d=a.length;b<d;b++)this.vertices.push(new U(a[b]));this.compute();return this},setFromObject:function(a){var b=
[];a.updateMatrixWorld(!0);a.traverse(function(a){var d;var c=a.geometry;if(void 0!==c)if(c.isGeometry){var h=c.vertices;c=0;for(d=h.length;c<d;c++){var g=h[c].clone();g.applyMatrix4(a.matrixWorld);b.push(g)}}else if(c.isBufferGeometry&&(h=c.attributes.position,void 0!==h))for(c=0,d=h.count;c<d;c++)g=new THREE.Vector3,g.fromBufferAttribute(h,c).applyMatrix4(a.matrixWorld),b.push(g)});return this.setFromPoints(b)},makeEmpty:function(){this.faces=[];this.vertices=[];return this},addVertexToFace:function(a,
b){a.face=b;null===b.outside?this.assigned.append(a):this.assigned.insertBefore(b.outside,a);b.outside=a;return this},removeVertexFromFace:function(a,b){a===b.outside&&(b.outside=null!==a.next&&a.next.face===b?a.next:null);this.assigned.remove(a);return this},removeAllVerticesFromFace:function(a){if(null!==a.outside){for(var b=a.outside,d=a.outside;null!==d.next&&d.next.face===a;)d=d.next;this.assigned.removeSubList(b,d);b.prev=d.next=null;a.outside=null;return b}},deleteFaceVertices:function(a,b){a=
this.removeAllVerticesFromFace(a);if(void 0!==a)if(void 0===b)this.unassigned.appendChain(a);else{do{var d=a.next;b.distanceToPoint(a.point)>this.tolerance?this.addVertexToFace(a,b):this.unassigned.append(a);a=d}while(null!==a)}return this},resolveUnassignedPoints:function(a){if(!1===this.unassigned.isEmpty()){var b=this.unassigned.first();do{for(var d=b.next,e=this.tolerance,c=null,h=0;h<a.length;h++){var g=a[h];if(0===g.mark){var f=g.distanceToPoint(b.point);f>e&&(e=f,c=g);if(e>1E3*this.tolerance)break}}null!==
c&&this.addVertexToFace(b,c);b=d}while(null!==b)}return this},computeExtremes:function(){var a=new THREE.Vector3,b=new THREE.Vector3,d=[],e=[],c,h,g;for(c=0;3>c;c++)d[c]=e[c]=this.vertices[0];a.copy(this.vertices[0].point);b.copy(this.vertices[0].point);c=0;for(h=this.vertices.length;c<h;c++){var f=this.vertices[c],n=f.point;for(g=0;3>g;g++)n.getComponent(g)<a.getComponent(g)&&(a.setComponent(g,n.getComponent(g)),d[g]=f);for(g=0;3>g;g++)n.getComponent(g)>b.getComponent(g)&&(b.setComponent(g,n.getComponent(g)),
e[g]=f)}this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(a.x),Math.abs(b.x))+Math.max(Math.abs(a.y),Math.abs(b.y))+Math.max(Math.abs(a.z),Math.abs(b.z)));return{min:d,max:e}},computeInitialHull:function(){var a,b,d;return function(){void 0===a&&(a=new THREE.Line3,b=new THREE.Plane,d=new THREE.Vector3);var e=this.vertices,c=this.computeExtremes(),h=c.min,g=c.max,f,n,v=0;for(c=n=0;3>c;c++){var m=g[c].point.getComponent(c)-h[c].point.getComponent(c);m>v&&(v=m,n=c)}h=h[n];g=g[n];v=0;a.set(h.point,g.point);
c=0;for(f=this.vertices.length;c<f;c++){var p=e[c];if(p!==h&&p!==g&&(a.closestPointToPoint(p.point,!0,d),m=d.distanceToSquared(p.point),m>v)){v=m;var q=p}}if(q){v=-1;b.setFromCoplanarPoints(h.point,g.point,q.point);c=0;for(f=this.vertices.length;c<f;c++)if(p=e[c],p!==h&&p!==g&&p!==q&&(m=Math.abs(b.distanceToPoint(p.point)),m>v)){v=m;var k=p}m=[];if(0>b.distanceToPoint(k.point))for(m.push(z.create(h,g,q),z.create(k,g,h),z.create(k,q,g),z.create(k,h,q)),c=0;3>c;c++)n=(c+1)%3,m[c+1].getEdge(2).setTwin(m[0].getEdge(n)),
m[c+1].getEdge(1).setTwin(m[n+1].getEdge(0));else for(m.push(z.create(h,q,g),z.create(k,h,g),z.create(k,g,q),z.create(k,q,h)),c=0;3>c;c++)n=(c+1)%3,m[c+1].getEdge(2).setTwin(m[0].getEdge((3-c)%3)),m[c+1].getEdge(0).setTwin(m[n+1].getEdge(1));for(c=0;4>c;c++)this.faces.push(m[c]);c=0;for(f=e.length;c<f;c++)if(p=e[c],p!==h&&p!==g&&p!==q&&p!==k){v=this.tolerance;var w=null;for(n=0;4>n;n++)m=this.faces[n].distanceToPoint(p.point),m>v&&(v=m,w=this.faces[n]);null!==w&&this.addVertexToFace(p,w)}return this}console.log("bug v2")}}(),
reindexFaces:function(){for(var a=[],b=0;b<this.faces.length;b++){var d=this.faces[b];0===d.mark&&a.push(d)}this.faces=a;return this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var a=0,b=this.assigned.first().face,d=b.outside;do{var e=b.distanceToPoint(d.point);if(e>a){a=e;var c=d}d=d.next}while(null!==d&&d.face===b);return c}},computeHorizon:function(a,b,d,e){this.deleteFaceVertices(d);d.mark=1;d=null===b?b=d.getEdge(0):b.next;do{var c=d.twin,h=c.face;0===h.mark&&(h.distanceToPoint(a)>
this.tolerance?this.computeHorizon(a,c,h,e):e.push(d));d=d.next}while(d!==b);return this},addAdjoiningFace:function(a,b){a=z.create(a,b.tail(),b.head());this.faces.push(a);a.getEdge(-1).setTwin(b.twin);return a.getEdge(0)},addNewFaces:function(a,b){this.newFaces=[];for(var d=null,e=null,c=0;c<b.length;c++){var h=this.addAdjoiningFace(a,b[c]);null===d?d=h:h.next.setTwin(e);this.newFaces.push(h.face);e=h}d.next.setTwin(e);return this},addVertexToHull:function(a){var b=[];this.unassigned.clear();this.removeVertexFromFace(a,
a.face);this.computeHorizon(a.point,null,a.face,b);this.addNewFaces(a,b);this.resolveUnassignedPoints(this.newFaces);return this},cleanup:function(){this.assigned.clear();this.unassigned.clear();this.newFaces=[];return this},compute:function(){var a;for(this.computeInitialHull();void 0!==(a=this.nextVertexToAdd());)this.addVertexToHull(a);this.reindexFaces();this.cleanup();return this}});Object.assign(z,{create:function(a,b,d){var e=new z;a=new G(a,e);b=new G(b,e);d=new G(d,e);a.next=d.prev=b;b.next=
a.prev=d;d.next=b.prev=a;e.edge=a;return e.compute()}});Object.assign(z.prototype,{getEdge:function(a){for(var b=this.edge;0<a;)b=b.next,a--;for(;0>a;)b=b.prev,a++;return b},compute:function(){var a;return function(){void 0===a&&(a=new THREE.Triangle);var b=this.edge.tail(),d=this.edge.head(),e=this.edge.next.head();a.set(b.point,d.point,e.point);a.getNormal(this.normal);a.getMidpoint(this.midpoint);this.area=a.getArea();this.constant=this.normal.dot(this.midpoint);return this}}(),distanceToPoint:function(a){return this.normal.dot(a)-
this.constant}});Object.assign(G.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceTo(a.point):-1},lengthSquared:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceToSquared(a.point):-1},setTwin:function(a){this.twin=a;a.twin=this;return this}});Object.assign(I.prototype,{first:function(){return this.head},last:function(){return this.tail},
clear:function(){this.head=this.tail=null;return this},insertBefore:function(a,b){b.prev=a.prev;b.next=a;null===b.prev?this.head=b:b.prev.next=b;a.prev=b;return this},insertAfter:function(a,b){b.prev=a;b.next=a.next;null===b.next?this.tail=b:b.next.prev=b;a.next=b;return this},append:function(a){null===this.head?this.head=a:this.tail.next=a;a.prev=this.tail;a.next=null;this.tail=a;return this},appendChain:function(a){null===this.head?this.head=a:this.tail.next=a;for(a.prev=this.tail;null!==a.next;)a=
a.next;this.tail=a;return this},remove:function(a){null===a.prev?this.head=a.next:a.prev.next=a.next;null===a.next?this.tail=a.prev:a.next.prev=a.prev;return this},removeSubList:function(a,b){null===a.prev?this.head=b.next:a.prev.next=b.next;null===b.next?this.tail=a.prev:b.next.prev=a.prev;return this},isEmpty:function(){return null===this.head}});K.prototype=Object.create(THREE.BufferGeometry.prototype);H.prototype=Object.create(THREE.Geometry.prototype);H.prototype.constructor=H;D.prototype=Object.create(THREE.BufferGeometry.prototype);
D.prototype.constructor=D;var f={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},torad:.017453292519943295},t=new Map;Object.assign(M.prototype,{step:function(a,b){var d;this.bodys.forEach(function(e,c){d=b+8*c;if(0!==a[d]+a[d+1]+a[d+2]+a[d+3]||e.isKinemmatic){c=a[d];if(0<c)"sleep"==e.material.name&&(e.material=f.mat.move),50<c&&"move"==e.material.name?e.material=f.mat.speed:50>c&&"speed"==e.material.name&&(e.material=f.mat.move);
else if("move"==e.material.name||"speed"==e.material.name)e.material=f.mat.sleep;e.position.fromArray(a,d+1);e.quaternion.fromArray(a,d+4)}})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);t.delete(a.name)},remove:function(a){if(t.has(a)){a=t.get(a);var b=a.isSolid?!0:!1,d=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==d&&(b?this.solids.splice(d,1):
this.bodys.splice(d,1),this.destroy(a))}},add:function(a,b){a.name=void 0!==a.name?a.name:"body"+this.ID++;this.remove(a.name);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);a.mass=void 0===a.mass?0:a.mass;a.kinematic=a.kinematic||!1;a.type=void 0===a.type?"box":a.type;a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;b=!1;a.size=void 0==a.size?[1,1,1]:a.size;1===a.size.length&&(a.size[1]=a.size[0]);2===a.size.length&&(a.size[2]=a.size[0]);
a.geoSize&&(1===a.geoSize.length&&(a.geoSize[1]=a.geoSize[0]),2===a.geoSize.length&&(a.geoSize[2]=a.geoSize[0]));a.rot=void 0===a.rot?[0,0,0]:A(a.rot);a.quat=void 0===a.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray():a.quat;a.rotA&&(a.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(A(a.rotA))).toArray());a.rotB&&(a.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(A(a.rotB))).toArray());a.angUpper&&(a.angUpper=A(a.angUpper));
a.angLower&&(a.angLower=A(a.angLower));if("plane"===a.type)f.post("add",a);else{if(void 0!==a.material)var d=a.material.constructor===String?f.mat[a.material]:a.material;else d=0!==a.mass||a.kinematic?f.mat.move:f.mat.static,a.kinematic&&(d=f.mat.kinematic);if("compound"===a.type){for(var e,c,h=0;h<a.shapes.length;h++)c=a.shapes[h],c.size=void 0===c.size?[1,1,1]:c.size,1===c.size.length&&(c.size[1]=c.size[0]),2===c.size.length&&(c.size[2]=c.size[0]),c.pos=void 0===c.pos?[0,0,0]:c.pos,c.rot=void 0===
c.rot?[0,0,0]:A(c.rot),c.quat=void 0===c.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(c.rot)).toArray():c.quat;var g=a.geometry?new THREE.Mesh(a.geometry,d):new THREE.Group;a.geometry&&f.extraGeo.push(a.geometry);if(!a.geometry||a.debug)for(g.material=d,h=0;h<a.shapes.length;h++)c=a.shapes[h],"box"===c.type&&(c.type="hardbox"),"cylinder"===c.type&&(c.type="hardcylinder"),e=new THREE.Mesh("capsule"===c.type?new K(a.size[0],.5*a.size[1]):f.geo[c.type],a.debug?f.mat.debug:d),
e.scale.fromArray(c.size),e.position.fromArray(c.pos),e.quaternion.fromArray(c.quat),g.add(e)}else if("mesh"===a.type||"convex"===a.type)a.shape&&(a.v=J(a.shape,a.type),f.extraGeo.push(a.shape)),a.geometry?(g=new THREE.Mesh(a.geometry,d),f.extraGeo.push(a.geometry)):g=new THREE.Mesh(a.shape,d);else{"box"!==a.type||0!==a.mass||a.kinematic||(a.type="hardbox");"capsule"===a.type&&(a.geometry=new K(a.size[0],.5*a.size[1]));if("realbox"===a.type||"realhardbox"===a.type)a.geometry=new THREE.BoxBufferGeometry(a.size[0],
a.size[1],a.size[2]);"realsphere"===a.type&&(a.geometry=new THREE.SphereBufferGeometry(a.size[0],16,12));"realcylinder"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(a.size[0],a.size[0],.5*a.size[1],12,1));"realcone"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(0,.5*a.size[0],.55*a.size[1],12,1));if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(A(a.geoRot))));
a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[1],a.geoScale[2]))}g=new THREE.Mesh(a.geometry||f.geo[a.type],d);a.geometry&&(f.extraGeo.push(a.geometry),a.geoSize&&g.scale.fromArray(a.geoSize),b=!0)}"highsphere"===a.type&&(a.type="sphere");g&&(b||g.scale.fromArray(a.size),g.position.fromArray(a.pos),g.quaternion.fromArray(a.quat),g.receiveShadow=!0,g.castShadow=0!==a.mass||a.kinematic?!0:!1,g.updateMatrix(),g.name=a.name,void 0!==a.parent?a.parent.add(g):
f.container.add(g));a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;void 0===a.noPhy&&(g&&(0!==a.mass||a.kinematic?this.bodys.push(g):this.solids.push(g)),f.post("add",a));if(g)return 0!==a.mass||a.kinematic||(g.isSolid=!0),a.kinematic?g.isKinemmatic=!0:g.isBody=!0,g.userData.mass=a.mass,t.set(a.name,g),g}}});Object.assign(N.prototype,{step:function(a,b){var d=b;this.softs.forEach(function(b,c){var e,g=b.geometry,f=b.softType,n=null,v=g.attributes.color?!0:!1,m=
g.attributes.normal?!0:!1;if(2===f){for(c=g.positions.length;c--;){var p=d+3*c;g.positions[c].set(a[p],a[p+1],a[p+2])}g.updatePath()}else{if(!g.attributes.position)return;var q=g.attributes.position.array;if(v)var k=g.attributes.color.array;if(5===f||4===f){var w=g.numVertices,x=g.maxi,y=g.pPoint,L=g.lPoint;for(c=w;c--;){p=3*c+d;var u=c==w-1?x-y[c]:y[c+1]-y[c];for(e=y[c];u--;)k=3*L[e+u],q[k]=a[p],q[k+1]=a[p+1],q[k+2]=a[p+2]}}else if(g.attributes.order&&(n=g.attributes.order.array),c=q.length,p=2,
null!==n)for(c=n.length;c--;)u=3*n[c],p=3*c+d,q[u]=a[p],q[u+1]=a[p+1],q[u+2]=a[p+2],e=Math.abs(a[p+1]/10),k[u]=e,k[u+1]=e,k[u+2]=e;else for(;c--;)q[c]=a[c+d],1==p&&(e=Math.abs(q[c]/10),k[c-1]=e,k[c]=e,k[c+1]=e),p--,p=0>p?2:p;2!==f&&g.computeVertexNormals();if(m){p=g.attributes.normal.array;for(c=w;c--;)for(u=c==w-1?x-y[c]:y[c+1]-y[c],e=y[c],q=3*L[e];u--;)k=3*L[e+u],p[k]=p[q],p[k+1]=p[q+1],p[k+2]=p[q+2];g.attributes.normal.needsUpdate=!0}v&&(g.attributes.color.needsUpdate=!0);g.attributes.position.needsUpdate=
!0;g.computeBoundingSphere()}d+=3*b.points})},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);t.delete(a.name)},remove:function(a){if(t.has(a)){a=t.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},add:function(a,b){b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);var d=void 0!==a.material?a.material.constructor===String?f.mat[a.material]:a.material:f.mat.soft;switch(a.type){case "softMesh":case "softTriMesh":var e=
O(a,d);break;case "softConvex":e=O(a,d);break;case "softCloth":e=a.div||[16,16];var c=a.size||[100,0,100],h=a.pos||[0,0,0],g=e[0]*e[1],l=new THREE.PlaneBufferGeometry(c[0],c[2],e[0]-1,e[1]-1);l.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*g),3));l.rotateX(-Math.PI90);d=new THREE.Mesh(l,d);d.position.set(h[0],h[1],h[2]);d.castShadow=!0;d.receiveShadow=!0;d.softType=1;d.points=l.attributes.position.array.length/3;a.size=c;a.div=e;a.pos=h;e={mesh:d,o:a};break;case "softRope":void 0===
a.numSeg&&(a.numSeg=a.numSegment);e=new THREE.Tubular(a,a.numSeg||10,a.radius||.2,a.numRad||6,!1);d=new THREE.Mesh(e,d);d.castShadow=!0;d.receiveShadow=!0;d.softType=2;d.points=e.positions.length;e={mesh:d,o:a};break;case "softEllips":f.post("add",a);return}d=e.mesh;a=e.o;d.name=b;d.isSoft=!0;f.container.add(d);this.softs.push(d);t.set(b,d);f.post("add",a)},createEllipsoid:function(a){var b=a.lng,d=[],e=a.a,c,h;for(c=0;c<b;c++){var g=3*c;d.push(new THREE.Vector3(e[g],e[g+1],e[g+2]))}d=new H(d);var l=
new Uint32Array(3*d.faces.length),n=new Float32Array(3*b),v=new Float32Array(b);var m=d.vertices;for(c=b;c--;)for(h=b;h--;)g=3*h,e[g]==m[c].x&&e[g+1]==m[c].y&&e[g+2]==m[c].z&&(v[h]=c);for(c=b;c--;)g=3*c,h=3*v[c],n[h]=e[g],n[h+1]=e[g+1],n[h+2]=e[g+2];for(c=d.faces.length;c--;)g=3*c,e=d.faces[c],l[g]=e.a,l[g+1]=e.b,l[g+2]=e.c;c=new THREE.BufferGeometry;c.setIndex(new THREE.BufferAttribute(l,1));c.addAttribute("position",new THREE.BufferAttribute(n,3));c.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
b),3));c.addAttribute("order",new THREE.BufferAttribute(v,1));d.uvs&&(b=new Float32Array(2*d.uvs.length),c.addAttribute("uv",(new THREE.BufferAttribute(b,2)).copyVector2sArray(d.uvs),2));c.computeVertexNormals();f.extraGeo.push(c);d.dispose();b=new THREE.Mesh(c,f.mat.soft);b.softType=3;b.isSoft=!0;b.points=c.attributes.position.array.length/3;b.castShadow=!0;b.receiveShadow=!0;b.name=a.name;f.container.add(b);this.softs.push(b);t.set(a.name,b)}});Object.assign(P.prototype,{step:function(a,b){this.terrains.forEach(function(a,
b){a.needsUpdate&&(a.updateGeometry(),f.post("setTerrain",{name:a.name,heightData:a.heightData}),a.needsUpdate=!1)})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);t.delete(a.name)},remove:function(a){if(t.has(a)){a=t.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},add:function(a,b){b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.sample=void 0===a.sample?
[64,64]:a.sample;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.complexity=void 0===a.complexity?30:a.complexity;a.name=b;var d=new THREE.Terrain(a);d.needsUpdate=!1;a.heightData=d.heightData;a.offset=0;f.container.add(d);this.terrains.push(d);t.set(b,d);f.post("add",a)},move:function(a,b,d){t.has(a)&&(a=t.get(a),a.local.x+=b||0,a.local.z+=d||0,a.update(!0),a.needsUpdate=!0)}});Object.assign(Q.prototype,{step:function(a,b){var d;this.cars.forEach(function(e,c){d=b+56*c;e.userData.speed=a[d];e.position.fromArray(a,
d+1);e.quaternion.fromArray(a,d+4);c=e.userData.NumWheels;var h;var g=40;var f=e.userData.radius;var n=a[d+8];e.userData.steeringWheel&&(e.userData.steeringWheel.rotation.y=6*-n);if(e.userData.isWithBrake)for(h=c;h--;)0===h&&(e.userData.b[h].rotation.y=n),1===h&&(e.userData.b[h].rotation.y=Math.Pi-n),e.userData.b[h].position.y=f-a[d+g+h];if(e.userData.isWithSusp)for(h=c;h--;)f=5*a[d+g+h],f=1<f?1:f,f=-1>f?-1:f,0<f?(e.userData.s[h].setWeight("low",f),e.userData.s[h].setWeight("top",0)):(e.userData.s[h].setWeight("low",
0),e.userData.s[h].setWeight("top",-f));for(e.userData.helper&&4==c&&e.userData.helper.updateSuspension(a[d+g+0],a[d+g+1],a[d+g+2],a[d+g+3]);c--;)g=8*(c+1),e.userData.w[c].position.fromArray(a,d+g+1),e.userData.w[c].quaternion.fromArray(a,d+g+4)})},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){for(var b,d=0,e=a.userData.w.length;d<e;d++)b=a.userData.w[d],b.parent&&b.parent.remove(b);a.parent&&a.parent.remove(a);t.delete(a.name)},remove:function(a){if(t.has(a)){a=
t.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},add:function(a,b){b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);var d=a.size||[2,.5,4],e=a.pos||[0,0,0],c=a.rot||[0,0,0];a.masscenter=void 0==a.masscenter?[0,0,0]:a.masscenter;Math.vectorad(c);a.mesh?(d=new THREE.Group,d.add(a.mesh)):a.geometry?(d=new THREE.Mesh(a.geometry,a.material),f.extraGeo.push(a.geometry)):(d=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(d[0],d[1],d[2])),d.translate(-a.masscenter[0],
-a.masscenter[1],-a.masscenter[2]),f.extraGeo.push(d),d=new THREE.Mesh(d,f.mat.move));a.debug&&a.shape&&(d=new THREE.Mesh(a.shape,f.mat.debug));d.position.set(e[0],e[1],e[2]);d.rotation.set(c[0],c[1],c[2]);a.quat=d.quaternion.toArray();f.container.add(d);d.userData.speed=0;d.userData.steering=0;d.userData.NumWheels=a.nw||4;d.userData.type="car";d.userData.steeringWheel=a.meshSteeringWheel||null;c=a.radius||.4;var h=a.deep||.3;e=a.wPos||[1,-.25,1.6];var g=[],l=[],n=[],v=void 0===a.meshSusp?!1:!0,m=
void 0===a.meshBrake?!1:!0,p=void 0==a.wheel?!0:!1,q=a.wheel||f.geo.wheel,k=q.clone();k.rotateY(Math.Pi);f.extraGeo.push(k);var w=f.mat.move;void 0!==a.wheelMaterial&&(w=a.wheelMaterial.constructor===String?f.mat[a.wheelMaterial]:a.wheelMaterial);for(var x=a.nw||4;x--;){if(a.meshBrake){var y=a.meshBrake.clone();d.add(y);y.position.y=c;1==x||2==x?(y.rotation.y=Math.Pi,y.position.x=e[0],y.rotation.x=Math.Pi):y.position.x=-e[0];y.position.z=0==x||1==x?e[2]:-e[2];n[x]=y}if(a.meshSusp){y=a.meshSusp.clone();
d.add(y);y.position.y=c;if(1==x||2==x)y.rotation.y=Math.Pi;y.position.z=0==x||1==x?e[2]:-e[2];l[x]=y.children[0]}if(a.meshWheel)if(g[x]=a.meshWheel.clone(),p=!1,1==x||2==x)g[x]=new THREE.Group,y=a.meshWheel.clone(),y.rotation.y=Math.Pi,g[x].add(y);else for(g[x]=a.meshWheel.clone(),y=g[x].children.length;y--;)"h_pneu"===g[x].children[y].name&&(g[x].children[y].rotation.y=Math.Pi);else g[x]=1==x||2==x?new THREE.Mesh(q,f.mat.move):new THREE.Mesh(k,f.mat.move);p&&g[x].scale.set(h,c,c);g[x].material=w;
g[x].castShadow=!0;g[x].receiveShadow=!0;f.container.add(g[x])}a.extraWeels&&(p=a.meshWheel.clone(),p.children[0].visible=!1,p.rotation.z=.5*-Math.Pi,p.position.set(0,1.25,-1.11),d.add(p));d.userData.radius=c;d.userData.w=g;d.userData.s=l;d.userData.b=n;d.userData.isWithSusp=v;d.userData.isWithBrake=m;a.helper&&(d.userData.helper=new THREE.CarHelper(e,a.masscenter,h),d.add(d.userData.helper));a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.shapeType||"convex"==a.shapeType)a.v=J(a.shape,
a.shapeType);a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;a.mesh&&delete a.mesh;a.meshWheel&&delete a.meshWheel;a.meshSusp&&delete a.meshSusp;a.meshBrake&&delete a.meshBrake;a.meshSteeringWheel&&delete a.meshSteeringWheel;a.wheelMaterial&&delete a.wheelMaterial;this.cars.push(d);t.set(b,d);f.post("add",a)}});Object.assign(R.prototype,{step:function(a,b){var d;this.heroes.forEach(function(e,c){d=b+8*c;c=3.33*a[d];e.userData.speed=100*c;e.position.fromArray(a,
d+1);e.quaternion.fromArray(a,d+4);e.skin&&(0===c?e.skin.play(0,.3):(e.skin.play(1,.3),e.skin.setTimeScale(c)))})},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);t.delete(a.name)},remove:function(a){if(t.has(a)){a=t.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},add:function(a,b){b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.size=void 0==a.size?[.25,2,2]:a.size;
1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:Math.vectorad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var d=new THREE.CapsuleBufferGeometry(a.size[0],.5*a.size[1],6),e=new THREE.Group;if(a.debug){var c=new THREE.Mesh(d,f.mat.debug);f.extraGeo.push(d);e.add(c)}a.mesh?(d=a.mesh,d.material=f.mat.hero,d.scale.multiplyScalar(a.scale||1),d.position.set(0,
0,0),d.setTimeScale(.5),d.play(0),e.add(d),e.skin=d):(c=new THREE.Mesh(d,f.mat.hero),f.extraGeo.push(d),e.add(c));e.userData.speed=0;e.userData.type="hero";e.position.fromArray(a.pos);e.quaternion.fromArray(a.quat);e.castShadow=!0;e.receiveShadow=!0;e.name=b;a.mesh&&delete a.mesh;f.container.add(e);this.heroes.push(e);t.set(b,e);f.post("add",a)}});Object.assign(S.prototype,{step:function(a,b){this.pairs.forEach(function(d,e){d.callback(a[b+e]||0)})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());
this.ID=0},destroy:function(a){a.clear();t.delete(a.name)},remove:function(a){if(t.has(a)){a=t.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a,b){b=void 0!==a.name?a.name:"pair"+this.ID++;this.remove(b);var d=new T(b,a.callback);this.pairs.push(d);delete a.callback;t.set(b,d);f.post("add",a)}});Object.assign(T.prototype,{clear:function(){this.callback=this.name=null}});E.prototype={constructor:E,prepareBreakableObject:function(a,b,d,e,c){a.geometry.isBufferGeometry||
console.error("ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");a=a.userData;a.mass=b;a.velocity=void 0!==d?d.clone():new THREE.Vector3;a.angularVelocity=void 0!==e?e.clone():new THREE.Vector3;a.breakable=c},subdivideByImpact:function(a,b,d,e,c){function f(b,d,c,h){if(Math.random()<.05*h||h>p)g.push(b);else{var k=Math.PI;0===h?(m.normal.copy(v.normal),m.constant=v.constant):h<=e?(k=(c-d)*(.2+.6*Math.random())+d,q.tempVector3_2.copy(a.position).sub(l).applyAxisAngle(n,
k).add(l),m.setFromCoplanarPoints(l,q.tempVector3,q.tempVector3_2)):(k=(.5*(h&1)+.2*(2-Math.random()))*Math.PI,q.tempVector3_2.copy(l).sub(b.position).applyAxisAngle(n,k).add(b.position),q.tempVector3_3.copy(n).add(b.position),m.setFromCoplanarPoints(b.position,q.tempVector3_3,q.tempVector3_2));q.cutByPlane(b,m,q.tempResultObjects);b=q.tempResultObjects.object1;var u=q.tempResultObjects.object2;b&&f(b,d,k,h+1);u&&f(u,k,c,h+1)}}var g=[],l=(new THREE.Vector3).fromArray(b),n=(new THREE.Vector3).fromArray(d),
v=this.tempPlane1,m=this.tempPlane2;this.tempVector3.addVectors(l,n);v.setFromCoplanarPoints(l,a.position,this.tempVector3);var p=c+e,q=this;f(a,0,2*Math.PI,0);return g},cutByPlane:function(a,b,d){function e(a,b){a=3*a+b;return v?v[a]:a}var c=a.geometry,f=c.attributes.position.array,g=c.attributes.normal.array,l=f.length/3,n=l/3,v=c.getIndex();v&&(v=v.array,n=v.length/3);c=[];for(var m=[],p=this.smallDelta,q=l*l,k=0;k<q;k++)this.segments[k]=!1;q=this.tempVector3_P0;var w=this.tempVector3_P1,x=this.tempVector3_N0,
y=this.tempVector3_N1;for(k=0;k<n-1;k++){var t=e(k,0),u=e(k,1),r=e(k,2);x.set(g[t],g[t]+1,g[t]+2);for(var z=k+1;z<n;z++){var C=e(z,0),A=e(z,1),F=e(z,2);y.set(g[C],g[C]+1,g[C]+2);if(1-x.dot(y)<p)if(t===C||t===A||t===F)u===C||u===A||u===F?(this.segments[t*l+u]=!0,this.segments[u*l+t]=!0):(this.segments[r*l+t]=!0,this.segments[t*l+r]=!0);else if(u===C||u===A||u===F)this.segments[r*l+u]=!0,this.segments[u*l+r]=!0}}g=this.tempPlane_Cut;a.updateMatrix();E.transformPlaneToLocalSpace(b,a.matrix,g);for(k=
0;k<n;k++)for(b=e(k,0),x=e(k,1),y=e(k,2),t=0;3>t;t++)if(u=0===t?b:1===t?x:y,r=0===t?x:1===t?y:b,!this.segments[u*l+r]&&(this.segments[u*l+r]=!0,this.segments[r*l+u]=!0,q.set(f[3*u],f[3*u+1],f[3*u+2]),w.set(f[3*r],f[3*r+1],f[3*r+2]),u=0,r=g.distanceToPoint(q),r>p?(u=2,m.push(q.clone())):r<-p?(u=1,c.push(q.clone())):(u=3,c.push(q.clone()),m.push(q.clone())),r=0,r=g.distanceToPoint(w),r>p?(r=2,m.push(w.clone())):r<-p?(r=1,c.push(w.clone())):(r=3,c.push(w.clone()),m.push(w.clone())),1===u&&2===r||2===
u&&1===r)){this.tempLine1.start.copy(q);this.tempLine1.end.copy(w);u=new THREE.Vector3;u=g.intersectLine(this.tempLine1,u);if(void 0===u)return console.error("Internal error: segment does not intersect plane."),d.segmentedObject1=null,d.segmentedObject2=null,0;c.push(u);m.push(u.clone())}f=.5*a.userData.mass;this.tempCM1.set(0,0,0);l=0;n=c.length;if(0<n){for(k=0;k<n;k++)this.tempCM1.add(c[k]);this.tempCM1.divideScalar(n);for(k=0;k<n;k++)w=c[k],w.sub(this.tempCM1),l=Math.max(l,w.x,w.y,w.z);this.tempCM1.add(a.position)}this.tempCM2.set(0,
0,0);p=0;q=m.length;if(0<q){for(k=0;k<q;k++)this.tempCM2.add(m[k]);this.tempCM2.divideScalar(q);for(k=0;k<q;k++)w=m[k],w.sub(this.tempCM2),p=Math.max(p,w.x,w.y,w.z);this.tempCM2.add(a.position)}w=k=null;b=0;4<n&&(k=new THREE.Mesh(new D(c),a.material),k.position.copy(this.tempCM1),k.quaternion.copy(a.quaternion),this.prepareBreakableObject(k,f,a.userData.velocity,a.userData.angularVelocity,2*l>this.minSizeForBreak),b++);4<q&&(w=new THREE.Mesh(new D(m),a.material),w.position.copy(this.tempCM2),w.quaternion.copy(a.quaternion),
this.prepareBreakableObject(w,f,a.userData.velocity,a.userData.angularVelocity,2*p>this.minSizeForBreak),b++);d.object1=k;d.object2=w;return b}};E.transformFreeVector=function(a,b){var d=a.x,e=a.y,c=a.z;b=b.elements;a.x=b[0]*d+b[4]*e+b[8]*c;a.y=b[1]*d+b[5]*e+b[9]*c;a.z=b[2]*d+b[6]*e+b[10]*c;return a};E.transformFreeVectorInverse=function(a,b){var d=a.x,e=a.y,c=a.z;b=b.elements;a.x=b[0]*d+b[1]*e+b[2]*c;a.y=b[4]*d+b[5]*e+b[6]*c;a.z=b[8]*d+b[9]*e+b[10]*c;return a};E.transformTiedVectorInverse=function(a,
b){var d=a.x,e=a.y,c=a.z;b=b.elements;a.x=b[0]*d+b[1]*e+b[2]*c-b[12];a.y=b[4]*d+b[5]*e+b[6]*c-b[13];a.z=b[8]*d+b[9]*e+b[10]*c-b[14];return a};E.transformPlaneToLocalSpace=function(){var a=new THREE.Vector3;return function(b,d,e){e.normal.copy(b.normal);e.constant=b.constant;b=E.transformTiedVectorInverse(b.coplanarPoint(a),d);E.transformFreeVectorInverse(e.normal,d);e.constant=-b.dot(e.normal)}}();var W=function(){var a=a||{};a.OutWindow=function(){this._windowSize=0};a.OutWindow.prototype.create=
function(a){this._buffer&&this._windowSize===a||(this._buffer=[]);this._windowSize=a;this._streamPos=this._pos=0};a.OutWindow.prototype.flush=function(){var a=this._pos-this._streamPos;if(0!==a){for(;a--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0);this._streamPos=this._pos}};a.OutWindow.prototype.releaseStream=function(){this.flush();this._stream=null};a.OutWindow.prototype.setStream=function(a){this.releaseStream();this._stream=a};a.OutWindow.prototype.init=
function(a){a||(this._pos=this._streamPos=0)};a.OutWindow.prototype.copyBlock=function(a,d){a=this._pos-a-1;for(0>a&&(a+=this._windowSize);d--;)a>=this._windowSize&&(a=0),this._buffer[this._pos++]=this._buffer[a++],this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.putByte=function(a){this._buffer[this._pos++]=a;this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.getByte=function(a){a=this._pos-a-1;0>a&&(a+=this._windowSize);return this._buffer[a]};a.RangeDecoder=function(){};
a.RangeDecoder.prototype.setStream=function(a){this._stream=a};a.RangeDecoder.prototype.releaseStream=function(){this._stream=null};a.RangeDecoder.prototype.init=function(){var a=5;this._code=0;for(this._range=-1;a--;)this._code=this._code<<8|this._stream.readByte()};a.RangeDecoder.prototype.decodeDirectBits=function(a){for(var b=0,e;a--;)this._range>>>=1,e=this._code-this._range>>>31,this._code-=this._range&e-1,b=b<<1|1-e,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),
this._range<<=8);return b};a.RangeDecoder.prototype.decodeBit=function(a,d){var b=a[d],c=(this._range>>>11)*b;if((this._code^2147483648)<(c^2147483648))return this._range=c,a[d]+=2048-b>>>5,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0;this._range-=c;this._code-=c;a[d]-=b>>>5;0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return 1};a.initBitModels=function(a,d){for(;d--;)a[d]=1024};a.BitTreeDecoder=
function(a){this._models=[];this._numBitLevels=a};a.BitTreeDecoder.prototype.init=function(){a.initBitModels(this._models,1<<this._numBitLevels)};a.BitTreeDecoder.prototype.decode=function(a){for(var b=1,e=this._numBitLevels;e--;)b=b<<1|a.decodeBit(this._models,b);return b-(1<<this._numBitLevels)};a.BitTreeDecoder.prototype.reverseDecode=function(a){for(var b=1,e=0,c=0,f;c<this._numBitLevels;++c)f=a.decodeBit(this._models,b),b=b<<1|f,e|=f<<c;return e};a.reverseDecode2=function(a,d,e,c){for(var b=
1,f=0,l=0,n;l<c;++l)n=e.decodeBit(a,d+b),b=b<<1|n,f|=n<<l;return f};a.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new a.BitTreeDecoder(8);this._numPosStates=0};a.LenDecoder.prototype.create=function(b){for(;this._numPosStates<b;++this._numPosStates)this._lowCoder[this._numPosStates]=new a.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new a.BitTreeDecoder(3)};a.LenDecoder.prototype.init=function(){var b=this._numPosStates;for(a.initBitModels(this._choice,
2);b--;)this._lowCoder[b].init(),this._midCoder[b].init();this._highCoder.init()};a.LenDecoder.prototype.decode=function(a,d){return 0===a.decodeBit(this._choice,0)?this._lowCoder[d].decode(a):0===a.decodeBit(this._choice,1)?8+this._midCoder[d].decode(a):16+this._highCoder.decode(a)};a.Decoder2=function(){this._decoders=[]};a.Decoder2.prototype.init=function(){a.initBitModels(this._decoders,768)};a.Decoder2.prototype.decodeNormal=function(a){var b=1;do b=b<<1|a.decodeBit(this._decoders,b);while(256>
b);return b&255};a.Decoder2.prototype.decodeWithMatchByte=function(a,d){var b=1;do{var c=d>>7&1;d<<=1;var f=a.decodeBit(this._decoders,(1+c<<8)+b);b=b<<1|f;if(c!==f){for(;256>b;)b=b<<1|a.decodeBit(this._decoders,b);break}}while(256>b);return b&255};a.LiteralDecoder=function(){};a.LiteralDecoder.prototype.create=function(b,d){if(!this._coders||this._numPrevBits!==d||this._numPosBits!==b)for(this._numPosBits=b,this._posMask=(1<<b)-1,this._numPrevBits=d,this._coders=[],b=1<<this._numPrevBits+this._numPosBits;b--;)this._coders[b]=
new a.Decoder2};a.LiteralDecoder.prototype.init=function(){for(var a=1<<this._numPrevBits+this._numPosBits;a--;)this._coders[a].init()};a.LiteralDecoder.prototype.getDecoder=function(a,d){return this._coders[((a&this._posMask)<<this._numPrevBits)+((d&255)>>>8-this._numPrevBits)]};a.Decoder=function(){this._outWindow=new a.OutWindow;this._rangeDecoder=new a.RangeDecoder;this._isMatchDecoders=[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=
[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new a.BitTreeDecoder(4);this._lenDecoder=new a.LenDecoder;this._repLenDecoder=new a.LenDecoder;this._literalDecoder=new a.LiteralDecoder;this._dictionarySizeCheck=this._dictionarySize=-1;this._posSlotDecoder[0]=new a.BitTreeDecoder(6);this._posSlotDecoder[1]=new a.BitTreeDecoder(6);this._posSlotDecoder[2]=new a.BitTreeDecoder(6);this._posSlotDecoder[3]=new a.BitTreeDecoder(6)};a.Decoder.prototype.setDictionarySize=function(a){if(0>
a)return!1;this._dictionarySize!==a&&(this._dictionarySize=a,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096)));return!0};a.Decoder.prototype.setLcLpPb=function(a,d,e){var b=1<<e;if(8<a||4<d||4<e)return!1;this._literalDecoder.create(d,a);this._lenDecoder.create(b);this._repLenDecoder.create(b);this._posStateMask=b-1;return!0};a.Decoder.prototype.init=function(){var b=4;this._outWindow.init(!1);a.initBitModels(this._isMatchDecoders,
192);a.initBitModels(this._isRep0LongDecoders,192);a.initBitModels(this._isRepDecoders,12);a.initBitModels(this._isRepG0Decoders,12);a.initBitModels(this._isRepG1Decoders,12);a.initBitModels(this._isRepG2Decoders,12);a.initBitModels(this._posDecoders,114);for(this._literalDecoder.init();b--;)this._posSlotDecoder[b].init();this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();this._rangeDecoder.init()};a.Decoder.prototype.decode=function(b,d,e){var c=0,f=0,g=0,l=0,n=0,r=0,
m=0;this._rangeDecoder.setStream(b);this._outWindow.setStream(d);for(this.init();0>e||r<e;)if(b=r&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(c<<4)+b))m=this._literalDecoder.getDecoder(r++,m),m=7<=c?m.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(f)):m.decodeNormal(this._rangeDecoder),this._outWindow.putByte(m),c=4>c?0:c-(10>c?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,c))m=0,0===this._rangeDecoder.decodeBit(this._isRepG0Decoders,
c)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(c<<4)+b)&&(c=7>c?9:11,m=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,c)?d=g:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,c)?d=l:(d=n,n=l),l=g),g=f,f=d),0===m&&(m=2+this._repLenDecoder.decode(this._rangeDecoder,b),c=7>c?8:11);else if(n=l,l=g,g=f,m=2+this._lenDecoder.decode(this._rangeDecoder,b),c=7>c?7:10,b=this._posSlotDecoder[5>=m?m-2:3].decode(this._rangeDecoder),4<=b)if(d=(b>>1)-1,f=(2|b&1)<<d,14>b)f+=a.reverseDecode2(this._posDecoders,
f-b-1,this._rangeDecoder,d);else{if(f+=this._rangeDecoder.decodeDirectBits(d-4)<<4,f+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),0>f){if(-1===f)break;return!1}}else f=b;if(f>=r||f>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(f,m);r+=m;m=this._outWindow.getByte(0)}this._outWindow.flush();this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return!0};a.Decoder.prototype.setDecoderProperties=function(a){if(5>a.size)return!1;var b=a.readByte();var e=b%9;b=~~(b/
9);if(!this.setLcLpPb(e,b%5,~~(b/5)))return!1;b=a.readByte();b|=a.readByte()<<8;b|=a.readByte()<<16;b+=16777216*a.readByte();return this.setDictionarySize(b)};a.decompress=function(b,d,e,c){var f=new a.Decoder;if(!f.setDecoderProperties(b))throw"Incorrect stream properties";if(!f.decode(d,e,c))throw"Error in data stream";return!0};a.decompressFile=function(b,d){var e=new a.Decoder;if(!e.setDecoderProperties(b))throw"Incorrect stream properties";var c=b.readByte();c|=b.readByte()<<8;c|=b.readByte()<<
16;c+=16777216*b.readByte();b.readByte();b.readByte();b.readByte();b.readByte();if(!e.decode(b,d,c))throw"Error in data stream";return!0};return a}();r.engine=function(){var a="LZMA",b,d,e=null,c=window.URL||window.webkitURL,h=0,g=0,l=0,n=0,v=0,m=0,p,q=void 0,k=!1,w=null,x=!1,y,z,u,A,B,C,D=null,F={worldscale:1,gravity:[0,-10,0],fps:60,substep:2,broadphase:2,soft:!0};r.engine={init:function(b,c,f,g){this.initArray(g);this.defaultRoot();f=f||{};d=b;F={fps:f.fps||60,worldscale:f.worldscale||1,gravity:f.gravity||
[0,-10,0],substep:f.substep||2,broadphase:f.broadphase||2,soft:void 0!==f.soft?f.soft:!0};m=1/F.fps*1E3;a=c||"LZMA";"LZMA"===a?r.engine.load(F):(e=document.location.href.replace(/\/[^/]*$/,"/")+("WASM"===a?"./build/ammo.wasm.js":"./build/ammo.js"),r.engine.startWorker())},load:function(){var a=new XMLHttpRequest;a.responseType="arraybuffer";a.open("GET","./build/ammo.hex",!0);a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status?(e=c.createObjectURL(new Blob([V(a.response)],
{type:"application/javascript"})),r.engine.startWorker()):console.error("Couldn't load [./build/ammo.hex] ["+a.status+"]"))};a.send(null)},startWorker:function(){b=new Worker("./build/gun.js");b.postMessage=b.webkitPostMessage||b.postMessage;b.onmessage=r.engine.message;var a=new ArrayBuffer(1);b.postMessage({m:"test",ab:a},[a]);x=a.byteLength?!1:!0;r.engine.post("init",{blob:e,ArPos:f.ArPos,ArMax:f.ArMax,isBuffer:x,option:F});f.post=r.engine.post},initArray:function(a){a=a||{};f.ArLng=[8*(a.maxBody||
1400),a.maxContact||200,8*(a.maxCharacter||10),56*(a.maxCar||14),3*(a.maxSoftPoint||8192)];f.ArPos=[0,f.ArLng[0],f.ArLng[0]+f.ArLng[1],f.ArLng[0]+f.ArLng[1]+f.ArLng[2],f.ArLng[0]+f.ArLng[1]+f.ArLng[2]+f.ArLng[3]];f.ArMax=f.ArLng[0]+f.ArLng[1]+f.ArLng[2]+f.ArLng[3]+f.ArLng[4]},message:function(a){a=a.data;a.Ar&&(f.Ar=a.Ar);switch(a.m){case "initEngine":r.engine.initEngine();break;case "start":r.engine.start(a);break;case "step":r.engine.step();break;case "moveSolid":r.engine.moveSolid(a.o);break;case "ellipsoid":r.engine.ellipsoidMesh(a.o);
break;case "makeBreak":r.engine.makeBreak(a.o)}},initEngine:function(){c.revokeObjectURL(e);e=null;this.initObject();console.log("AMMO.Worker 002"+(x?" with ":" without ")+"Buffer #"+a);d&&d()},start:function(a){k=!0;x&&(f.Ar=new Float32Array(f.ArMax));r.engine.sendData(0)},postUpdate:function(){},update:function(){r.engine.postUpdate();u.step();y.step(f.Ar,f.ArPos[0]);C.step(f.Ar,f.ArPos[1]);B.step(f.Ar,f.ArPos[2]);A.step(f.Ar,f.ArPos[3]);z.step(f.Ar,f.ArPos[4])},step:function(){h-1E3>n&&(n=h,p=
v,v=0);v++;w&&w.needUpdate(!0);r.engine.update();k=!0},sendData:function(a){w&&w.pause?q=null:(q=requestAnimationFrame(r.engine.sendData),h=a,g=h-l,g>m&&(l=h-g%m,k&&(x?b.postMessage({m:"step",o:{key:r.engine.getKey()},Ar:f.Ar},[f.Ar.buffer]):b.postMessage({m:"step",o:{key:r.engine.getKey()}}),k=!1),r.engine.tell()))},setView:function(a){w=a;f.mat=a.getMat();f.geo=a.getGeo();f.container=a.getScene()},getFps:function(){return p},tell:function(){},getKey:function(){return[0,0,0,0,0,0,0,0]},set:function(a){a=
a||F;m=void 0!==a.fps?1/a.fps*1E3:m;this.post("set",a)},post:function(a,c){b.postMessage({m:a,o:c})},reset:function(a){q&&(window.cancelAnimationFrame(q),q=void 0);for(r.engine.clear();0<f.tmpMat.length;)f.tmpMat.pop().dispose();r.engine.postUpdate=function(){};w&&w.reset(a);r.engine.post("reset",{full:a})},stop:function(){q&&(window.cancelAnimationFrame(q),q=void 0)},destroy:function(){b.terminate();b=void 0},addMat:function(a){f.tmpMat.push(a)},ellipsoidMesh:function(a){z.createEllipsoid(a)},updateTmpMat:function(a,
b){for(var c=f.tmpMat.length,d;c--;)d=f.tmpMat[c],void 0!==d.envMap&&(d.envMap="MeshStandardMaterial"===d.type?a:b?null:a,d.needsUpdate=!0)},drive:function(a){this.post("setDrive",{name:a})},move:function(a){this.post("setMove",{name:a})},forces:function(a){this.post("setForces",a)},option:function(a){this.post("setOption",a)},remove:function(a){this.post("setRemove",a)},matrix:function(a){this.post("setMatrix",a)},anchor:function(a){this.post("addAnchor",a)},break:function(a){this.post("addBreakable",
a)},moveSolid:function(a){if(t.has(a.name)){var b=t.get(a.name);void 0!==a.pos&&b.position.fromArray(a.pos);void 0!==a.quat&&b.quaternion.fromArray(a.quat)}},getBodys:function(){return y.bodys},byName:function(a){return t.get(a)},removeRigidBody:function(a){y.remove(a)},initObject:function(){y=new M;z=new N;u=new P;A=new Q;B=new R;C=new S},clear:function(a){y.clear();C.clear();u.clear();A.clear();B.clear();for(z.clear();0<f.extraGeo.length;)f.extraGeo.pop().dispose()},addGroup:function(a){for(var b=
0,c=a.length;b<c;b++)this.add(a[b])},add:function(a){a=a||{};var b=void 0===a.type?"box":a.type,c=b.substring(0,4);if("join"===c)f.post("add",a);else if("soft"===c)z.add(a);else if("terrain"===b)u.add(a);else if("character"===b)B.add(a);else if("collision"===b)C.add(a);else if("car"===b)A.add(a);else return!a.breakable||"hardbox"!==b&&"box"!==b&&"sphere"!==b&&"cylinder"!==b&&"cone"!==b||(a.type="real"+a.type),y.add(a)},defaultRoot:function(){var a={circle:new THREE.CircleBufferGeometry(1,6),plane:new THREE.PlaneBufferGeometry(1,
1,1,1),box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1),hardcylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};a.circle.rotateX(-1.570796326794896);a.plane.rotateX(-1.570796326794896);a.wheel.rotateZ(-1.570796326794896);
f.geo=a;f.mat={move:new THREE.MeshLambertMaterial({color:16746513,name:"move",wireframe:!1}),speed:new THREE.MeshLambertMaterial({color:16776977,name:"speed",wireframe:!1}),sleep:new THREE.MeshLambertMaterial({color:1149183,name:"sleep",wireframe:!1}),basic:new THREE.MeshLambertMaterial({color:1118481,name:"basic",wireframe:!1}),static:new THREE.MeshLambertMaterial({color:1118719,name:"static",wireframe:!1}),kinematic:new THREE.MeshLambertMaterial({color:1179409,name:"kinematic",wireframe:!1})};f.container=
new THREE.Group},getContainer:function(){return f.container},makeBreak:function(a){var b=a.name;if(t.has(b)){null===D&&(D=new E);var c=t.get(b),d=a.breakOption;a=D.subdivideByImpact(c,a.pos,a.normal,d[1],d[2]);--d[3];this.removeRigidBody(b);for(c=a.length;c--;)this.addDebris(b,c,a[c],d)}},addDebris:function(a,b,c,d){a={name:a+"_debris"+b,material:c.material,type:"convex",shape:c.geometry,pos:c.position.toArray(),quat:c.quaternion.toArray(),mass:c.userData.mass,linearVelocity:c.userData.velocity.toArray(),
angularVelocity:c.userData.angularVelocity.toArray(),margin:.05};0<d[3]&&(a.breakable=!0,a.breakOption=d);this.add(a)}};return r.engine}();Object.defineProperty(r,"__esModule",{value:!0})});
