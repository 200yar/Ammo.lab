(function(g,v){"object"===typeof exports&&"undefined"!==typeof module?v(exports):"function"===typeof define&&define.amd?define(["exports"],v):(g=g||self,v(g.SHOT={}))})(this,function(g){function v(a,c){var b=!1,e=!1;"mesh"==c&&(e=!0);"convex"==c&&(b=!0);var f=(new THREE.Geometry).fromBufferGeometry(a);f.mergeVertices();var d=a.attributes.position.array.length/3,h=f.vertices.length,u=f.faces.length;a.realVertices=new Float32Array(3*h);a.realIndices=new (65535<3*u?Uint32Array:Uint16Array)(3*u);a.addAttribute("color",
new THREE.BufferAttribute(new Float32Array(3*d),3));var k=a.attributes.color.array;for(c=d;c--;){var m=3*c;k[m]=1;k[m+1]=1;k[m+2]=1}for(c=h;c--;)k=f.vertices[c],m=3*c,a.realVertices[m]=k.x,a.realVertices[m+1]=k.y,a.realVertices[m+2]=k.z;if(b)return f.dispose(),a.realVertices;for(c=u;c--;)k=f.faces[c],m=3*c,a.realIndices[m]=k.a,a.realIndices[m+1]=k.b,a.realIndices[m+2]=k.c;f.dispose();if(e){d=[];for(c=a.realIndices.length;c--;)m=3*c,k=3*a.realIndices[c],d[m]=a.realVertices[k],d[m+1]=a.realVertices[k+
1],d[m+2]=a.realVertices[k+2];return d}e=[];f=a.attributes.position.array;for(c=h;c--;)for(m=3*c,e[c]=[],b=d;b--;)k=3*b,f[k]==a.realVertices[m]&&f[k+1]==a.realVertices[m+1]&&f[k+2]==a.realVertices[m+2]&&e[c].push(b);f=new (65535<h?Uint32Array:Uint16Array)(h);var l=new (65535<d?Uint32Array:Uint16Array)(d);for(c=k=0;c<h;c++){m=e[c].length;f[c]=k;for(b=m;b--;)l[k+b]=e[c][b];k+=m}a.numFaces=u;a.numVertices=h;a.maxi=d;a.pPoint=f;a.lPoint=l}function E(a,c,b,e){THREE.BufferGeometry.call(this);this.type=
"CapsuleBufferGeometry";var f=a||1;c=c||1;var d=b||12,h=Math.floor(.5*d);a=e||1;var u=2*Math.PI,k=.5*Math.PI;e=new THREE.Geometry;a=new THREE.CylinderGeometry(f,f,c,d,a,!0);var m=new THREE.SphereGeometry(f,d,h,0,u,0,k);f=new THREE.SphereGeometry(f,d,h,0,u,k,k);d=(new THREE.Matrix4).makeTranslation(0,0,0);6===b&&d.makeRotationY(.5235987755982988);b=(new THREE.Matrix4).makeTranslation(0,.5*c,0);c=(new THREE.Matrix4).makeTranslation(0,.5*-c,0);e.merge(a,d);e.merge(m,b);e.merge(f,c);e.mergeVertices();
this.fromGeometry(e)}function A(a){for(var c=a.length;c--;)a[c]*=d.torad;return a}function F(){this.ID=0;this.solids=[];this.bodys=[]}function G(){this.ID=0;this.softs=[]}function H(){this.ID=0;this.terrains=[]}function I(){this.ID=0;this.cars=[]}function J(){this.ID=0;this.heroes=[]}function K(){this.ID=0;this.pairs=[]}function L(a,c){this.name=a;this.callback=c}function M(a){a=new Uint8Array(a);var c={data:[],position:0,writeByte:function(a){this.data[this.position++]=a}};N.decompressFile({data:a,
position:0,readByte:function(){return this.data[this.position++]}},c);return(new Uint8Array(c.data)).buffer}E.prototype=Object.create(THREE.BufferGeometry.prototype);var d={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},torad:.017453292519943295},l=new Map;Object.assign(F.prototype,{step:function(a,c){var b;this.bodys.forEach(function(e,f){b=c+8*f;f=a[b];if(0<f)"sleep"==e.material.name&&(e.material=d.mat.move),50<f&&"move"==e.material.name?
e.material=d.mat.speed:50>f&&"speed"==e.material.name&&(e.material=d.mat.move);else if("move"==e.material.name||"speed"==e.material.name)e.material=d.mat.sleep;e.position.fromArray(a,b+1);e.quaternion.fromArray(a,b+4)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=a.isSolid?!0:!1,b=c?
this.solids.indexOf(a):this.bodys.indexOf(a);-1!==b&&(c?this.solids.splice(b,1):this.bodys.splice(b,1),this.destroy(a))}},add:function(a,c){a.name=void 0!==a.name?a.name:"body"+this.ID++;this.remove(a.name);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);a.mass=void 0===a.mass?0:a.mass;a.kinematic=a.kinematic||!1;a.type=void 0===a.type?"box":a.type;a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;c=!1;a.size=void 0==a.size?[1,1,1]:a.size;
1===a.size.length&&(a.size[1]=a.size[0]);2===a.size.length&&(a.size[2]=a.size[0]);a.geoSize&&(1===a.geoSize.length&&(a.geoSize[1]=a.geoSize[0]),2===a.geoSize.length&&(a.geoSize[2]=a.geoSize[0]));a.rot=void 0===a.rot?[0,0,0]:A(a.rot);a.quat=void 0===a.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray():a.quat;a.rotA&&(a.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(A(a.rotA))).toArray());a.rotB&&(a.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(A(a.rotB))).toArray());
a.angUpper&&(a.angUpper=A(a.angUpper));a.angLower&&(a.angLower=A(a.angLower));if("plane"===a.type)d.post("add",a);else{if(void 0!==a.material)var b=a.material.constructor===String?d.mat[a.material]:a.material;else b=0!==a.mass||a.kinematic?d.mat.move:d.mat.static,a.kinematic&&(b=d.mat.kinematic);if("mesh"===a.type||"convex"===a.type)a.shape&&(a.v=v(a.shape,a.type),d.extraGeo.push(a.shape)),a.geometry?(b=new THREE.Mesh(a.geometry,b),d.extraGeo.push(a.geometry)):b=new THREE.Mesh(a.shape,b);else{"box"!==
a.type||0!==a.mass||a.kinematic||(a.type="hardbox");"capsule"===a.type&&(a.geometry=new E(a.size[0],.5*a.size[1]));if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(A(a.geoRot))));a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[1],a.geoScale[2]))}b=new THREE.Mesh(a.geometry||d.geo[a.type],b);a.geometry&&(d.extraGeo.push(a.geometry),a.geoSize&&
b.scale.fromArray(a.geoSize),!a.geoSize&&a.size&&"capsule"!==a.type&&b.scale.fromArray(a.size),c=!0)}b&&(c||b.scale.fromArray(a.size),b.position.fromArray(a.pos),b.quaternion.fromArray(a.quat),b.receiveShadow=!0,b.castShadow=0!==a.mass||a.kinematic?!0:!1,b.name=a.name,void 0!==a.parent?a.parent.add(b):d.container.add(b));a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;void 0===a.noPhy&&(b&&(0!==a.mass||a.kinematic?this.bodys.push(b):this.solids.push(b)),d.post("add",
a));if(b)return 0!==a.mass||a.kinematic||(b.isSolid=!0),a.kinematic?b.isKinemmatic=!0:b.isBody=!0,l.set(a.name,b),b}}});Object.assign(G.prototype,{step:function(a,c){var b=c;this.softs.forEach(function(c,f){var e,d=c.geometry,u=c.softType,k=null,m=d.attributes.color?!0:!1,l=d.attributes.normal?!0:!1;if(2===u){for(f=d.positions.length;f--;){var p=b+3*f;d.positions[f].set(a[p],a[p+1],a[p+2])}d.updatePath()}else{if(!d.attributes.position)return;var g=d.attributes.position.array;if(m)var t=d.attributes.color.array;
if(5===u||4===u){var x=d.numVertices,n=d.maxi,q=d.pPoint,v=d.lPoint;for(f=x;f--;){p=3*f+b;var w=f==x-1?n-q[f]:q[f+1]-q[f];for(e=q[f];w--;)t=3*v[e+w],g[t]=a[p],g[t+1]=a[p+1],g[t+2]=a[p+2]}}else if(d.attributes.order&&(k=d.attributes.order.array),f=g.length,p=2,null!==k)for(f=k.length;f--;)w=3*k[f],p=3*f+b,g[w]=a[p],g[w+1]=a[p+1],g[w+2]=a[p+2],e=Math.abs(a[p+1]/10),t[w]=e,t[w+1]=e,t[w+2]=e;else for(;f--;)g[f]=a[f+b],1==p&&(e=Math.abs(g[f]/10),t[f-1]=e,t[f]=e,t[f+1]=e),p--,p=0>p?2:p;2!==u&&d.computeVertexNormals();
if(l){p=d.attributes.normal.array;for(f=x;f--;)for(w=f==x-1?n-q[f]:q[f+1]-q[f],e=q[f],g=3*v[e];w--;)t=3*v[e+w],p[t]=p[g],p[t+1]=p[g+1],p[t+2]=p[g+2];d.attributes.normal.needsUpdate=!0}m&&(d.attributes.color.needsUpdate=!0);d.attributes.position.needsUpdate=!0;d.computeBoundingSphere()}b+=3*c.points})},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=
this.softs.indexOf(a);-1!==c&&(this.softs.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);switch(a.type){case "softMesh":case "softTriMesh":var b=a.shape.clone();var e=a.pos||[0,0,0];var f=a.size||[1,1,1],y=a.rot||[0,0,0];b.translate(e[0],e[1],e[2]);b.scale(f[0],f[1],f[2]);b.applyMatrix((new THREE.Matrix4).makeRotationY(y[1]*=Math.torad));v(b);d.extraGeo.push(b);a.v=b.realVertices;a.i=b.realIndices;a.ntri=b.numFaces;b=new THREE.Mesh(b,void 0===
a.material?d.mat.soft:d.mat[a.material]);b.castShadow=!0;b.receiveShadow=!0;b.softType=5;b.points=a.v.length/3;a.shape&&delete a.shape;a.material&&delete a.material;e=a;break;case "softConvex":b=a.shape.clone();e=a.pos||[0,0,0];b.translate(e[0],e[1],e[2]);v(b);d.extraGeo.push(b);a.v=b.realVertices;b=new THREE.Mesh(b,void 0===a.material?d.mat.soft:d.mat[a.material]);b.castShadow=!0;b.receiveShadow=!0;b.softType=4;b.points=a.v.length/3;a.shape&&delete a.shape;a.material&&delete a.material;e=a;break;
case "softCloth":b=a.div||[16,16];e=a.size||[100,0,100];f=a.pos||[0,0,0];var h=b[0]*b[1];y=new THREE.PlaneBufferGeometry(e[0],e[2],b[0]-1,b[1]-1);y.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*h),3));y.rotateX(-Math.PI90);h=new THREE.Mesh(y,d.mat.soft);h.position.set(f[0],f[1],f[2]);h.castShadow=!0;h.receiveShadow=!0;h.softType=1;h.points=y.attributes.position.array.length/3;a.size=e;a.div=b;a.pos=f;b=h;e=a;break;case "softRope":void 0===a.numSeg&&(a.numSeg=a.numSegment),b=new THREE.Tubular(a,
a.numSeg||10,a.radius||.2,a.numRad||6,!1),e=new THREE.Mesh(b,d.mat.soft),e.castShadow=!0,e.receiveShadow=!0,e.softType=2,e.points=b.positions.length,b=e,e=a}a=e;b.name=c;d.container.add(b);this.softs.push(b);l.set(c,b);d.post("add",a)}});Object.assign(H.prototype,{step:function(a,c){this.terrains.forEach(function(a,c){a.needsUpdate&&(a.updateGeometry(),d.post("setTerrain",{name:a.name,heightData:a.heightData}),a.needsUpdate=!1)})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());
this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.terrains.indexOf(a);-1!==c&&(this.terrains.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);a.sample=void 0===a.sample?[64,64]:a.sample;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.complexity=void 0===a.complexity?30:a.complexity;a.name=c;var b=new THREE.Terrain(a);b.needsUpdate=!1;a.heightData=b.heightData;a.offset=0;
d.container.add(b);this.terrains.push(b);l.set(c,b);d.post("add",a)},move:function(a,c,b){l.has(a)&&(a=l.get(a),a.local.x+=c||0,a.local.z+=b||0,a.update(!0),a.needsUpdate=!0)}});Object.assign(I.prototype,{step:function(a,c){var b;this.cars.forEach(function(e,f){b=c+56*f;e.userData.speed=a[b];e.position.fromArray(a,b+1);e.quaternion.fromArray(a,b+4);f=e.userData.NumWheels;var d;var h=40;var g=e.userData.radius;var k=a[b+8];e.userData.steeringWheel&&(e.userData.steeringWheel.rotation.y=6*-k);if(e.userData.isWithBrake)for(d=
f;d--;)0===d&&(e.userData.b[d].rotation.y=k),1===d&&(e.userData.b[d].rotation.y=Math.Pi-k),e.userData.b[d].position.y=g-a[b+h+d];if(e.userData.isWithSusp)for(d=f;d--;)g=5*a[b+h+d],g=1<g?1:g,g=-1>g?-1:g,0<g?(e.userData.s[d].setWeight("low",g),e.userData.s[d].setWeight("top",0)):(e.userData.s[d].setWeight("low",0),e.userData.s[d].setWeight("top",-g));for(e.userData.helper&&4==f&&e.userData.helper.updateSuspension(a[b+h+0],a[b+h+1],a[b+h+2],a[b+h+3]);f--;)h=8*(f+1),e.userData.w[f].position.fromArray(a,
b+h+1),e.userData.w[f].quaternion.fromArray(a,b+h+4)})},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){for(var c,b=0,e=a.userData.w.length;b<e;b++)c=a.userData.w[b],c.parent&&c.parent.remove(c);a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.cars.indexOf(a);-1!==c&&(this.cars.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);var b=a.size||
[2,.5,4],e=a.pos||[0,0,0],f=a.rot||[0,0,0];a.masscenter=void 0==a.masscenter?[0,0,0]:a.masscenter;Math.vectorad(f);a.mesh?(b=new THREE.Group,b.add(a.mesh)):a.geometry?(b=new THREE.Mesh(a.geometry,a.material),d.extraGeo.push(a.geometry)):(b=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(b[0],b[1],b[2])),b.translate(-a.masscenter[0],-a.masscenter[1],-a.masscenter[2]),d.extraGeo.push(b),b=new THREE.Mesh(b,d.mat.move));a.debug&&a.shape&&(b=new THREE.Mesh(a.shape,d.mat.debug));b.position.set(e[0],
e[1],e[2]);b.rotation.set(f[0],f[1],f[2]);a.quat=b.quaternion.toArray();d.container.add(b);b.userData.speed=0;b.userData.steering=0;b.userData.NumWheels=a.nw||4;b.userData.type="car";b.userData.steeringWheel=a.meshSteeringWheel||null;f=a.radius||.4;var g=a.deep||.3;e=a.wPos||[1,-.25,1.6];var h=[],u=[],k=[],m=void 0===a.meshSusp?!1:!0,r=void 0===a.meshBrake?!1:!0,p=void 0==a.wheel?!0:!1,z=a.wheel||d.geo.wheel,t=z.clone();t.rotateY(Math.Pi);d.extraGeo.push(t);var x=d.mat.move;void 0!==a.wheelMaterial&&
(x=a.wheelMaterial.constructor===String?d.mat[a.wheelMaterial]:a.wheelMaterial);for(var n=a.nw||4;n--;){if(a.meshBrake){var q=a.meshBrake.clone();b.add(q);q.position.y=f;1==n||2==n?(q.rotation.y=Math.Pi,q.position.x=e[0],q.rotation.x=Math.Pi):q.position.x=-e[0];q.position.z=0==n||1==n?e[2]:-e[2];k[n]=q}if(a.meshSusp){q=a.meshSusp.clone();b.add(q);q.position.y=f;if(1==n||2==n)q.rotation.y=Math.Pi;q.position.z=0==n||1==n?e[2]:-e[2];u[n]=q.children[0]}if(a.meshWheel)if(h[n]=a.meshWheel.clone(),p=!1,
1==n||2==n)h[n]=new THREE.Group,q=a.meshWheel.clone(),q.rotation.y=Math.Pi,h[n].add(q);else for(h[n]=a.meshWheel.clone(),q=h[n].children.length;q--;)"h_pneu"===h[n].children[q].name&&(h[n].children[q].rotation.y=Math.Pi);else h[n]=1==n||2==n?new THREE.Mesh(z,d.mat.move):new THREE.Mesh(t,d.mat.move);p&&h[n].scale.set(g,f,f);h[n].material=x;h[n].castShadow=!0;h[n].receiveShadow=!0;d.container.add(h[n])}a.extraWeels&&(p=a.meshWheel.clone(),p.children[0].visible=!1,p.rotation.z=.5*-Math.Pi,p.position.set(0,
1.25,-1.11),b.add(p));b.userData.radius=f;b.userData.w=h;b.userData.s=u;b.userData.b=k;b.userData.isWithSusp=m;b.userData.isWithBrake=r;a.helper&&(b.userData.helper=new THREE.CarHelper(e,a.masscenter,g),b.add(b.userData.helper));a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.shapeType||"convex"==a.shapeType)a.v=v(a.shape,a.shapeType);a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;a.mesh&&delete a.mesh;a.meshWheel&&delete a.meshWheel;a.meshSusp&&delete a.meshSusp;
a.meshBrake&&delete a.meshBrake;a.meshSteeringWheel&&delete a.meshSteeringWheel;a.wheelMaterial&&delete a.wheelMaterial;this.cars.push(b);l.set(c,b);d.post("add",a)}});Object.assign(J.prototype,{step:function(a,c){var b;this.heroes.forEach(function(e,d){b=c+8*d;d=3.33*a[b];e.userData.speed=100*d;e.position.fromArray(a,b+1);e.quaternion.fromArray(a,b+4);e.skin&&(0===d?e.skin.play(0,.3):(e.skin.play(1,.3),e.skin.setTimeScale(d)))})},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());
this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.heroes.indexOf(a);-1!==c&&(this.heroes.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);a.size=void 0==a.size?[.25,2,2]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:Math.vectorad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();
var b=new THREE.CapsuleBufferGeometry(a.size[0],.5*a.size[1],6),e=new THREE.Group;if(a.debug){var f=new THREE.Mesh(b,d.mat.debug);d.extraGeo.push(b);e.add(f)}a.mesh?(b=a.mesh,b.material=d.mat.hero,b.scale.multiplyScalar(a.scale||1),b.position.set(0,0,0),b.setTimeScale(.5),b.play(0),e.add(b),e.skin=b):(f=new THREE.Mesh(b,d.mat.hero),d.extraGeo.push(b),e.add(f));e.userData.speed=0;e.userData.type="hero";e.position.fromArray(a.pos);e.quaternion.fromArray(a.quat);e.castShadow=!0;e.receiveShadow=!0;e.name=
c;a.mesh&&delete a.mesh;d.container.add(e);this.heroes.push(e);l.set(c,e);d.post("add",a)}});Object.assign(K.prototype,{step:function(a,c){this.pairs.forEach(function(b,e){b.callback(a[c+e]||0)})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(a){a.clear();l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.pairs.indexOf(a);-1!==c&&(this.pairs.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:"pair"+
this.ID++;this.remove(c);var b=new L(c,a.callback);this.pairs.push(b);delete a.callback;l.set(c,b);d.post("add",a)}});Object.assign(L.prototype,{clear:function(){this.callback=this.name=null}});var N=function(){var a=a||{};a.OutWindow=function(){this._windowSize=0};a.OutWindow.prototype.create=function(a){this._buffer&&this._windowSize===a||(this._buffer=[]);this._windowSize=a;this._streamPos=this._pos=0};a.OutWindow.prototype.flush=function(){var a=this._pos-this._streamPos;if(0!==a){for(;a--;)this._stream.writeByte(this._buffer[this._streamPos++]);
this._pos>=this._windowSize&&(this._pos=0);this._streamPos=this._pos}};a.OutWindow.prototype.releaseStream=function(){this.flush();this._stream=null};a.OutWindow.prototype.setStream=function(a){this.releaseStream();this._stream=a};a.OutWindow.prototype.init=function(a){a||(this._pos=this._streamPos=0)};a.OutWindow.prototype.copyBlock=function(a,b){a=this._pos-a-1;for(0>a&&(a+=this._windowSize);b--;)a>=this._windowSize&&(a=0),this._buffer[this._pos++]=this._buffer[a++],this._pos>=this._windowSize&&
this.flush()};a.OutWindow.prototype.putByte=function(a){this._buffer[this._pos++]=a;this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.getByte=function(a){a=this._pos-a-1;0>a&&(a+=this._windowSize);return this._buffer[a]};a.RangeDecoder=function(){};a.RangeDecoder.prototype.setStream=function(a){this._stream=a};a.RangeDecoder.prototype.releaseStream=function(){this._stream=null};a.RangeDecoder.prototype.init=function(){var a=5;this._code=0;for(this._range=-1;a--;)this._code=this._code<<
8|this._stream.readByte()};a.RangeDecoder.prototype.decodeDirectBits=function(a){for(var b=0,c;a--;)this._range>>>=1,c=this._code-this._range>>>31,this._code-=this._range&c-1,b=b<<1|1-c,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return b};a.RangeDecoder.prototype.decodeBit=function(a,b){var c=a[b],d=(this._range>>>11)*c;if((this._code^2147483648)<(d^2147483648))return this._range=d,a[b]+=2048-c>>>5,0===(this._range&4278190080)&&(this._code=this._code<<
8|this._stream.readByte(),this._range<<=8),0;this._range-=d;this._code-=d;a[b]-=c>>>5;0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return 1};a.initBitModels=function(a,b){for(;b--;)a[b]=1024};a.BitTreeDecoder=function(a){this._models=[];this._numBitLevels=a};a.BitTreeDecoder.prototype.init=function(){a.initBitModels(this._models,1<<this._numBitLevels)};a.BitTreeDecoder.prototype.decode=function(a){for(var b=1,c=this._numBitLevels;c--;)b=b<<1|a.decodeBit(this._models,
b);return b-(1<<this._numBitLevels)};a.BitTreeDecoder.prototype.reverseDecode=function(a){for(var b=1,c=0,d=0,g;d<this._numBitLevels;++d)g=a.decodeBit(this._models,b),b=b<<1|g,c|=g<<d;return c};a.reverseDecode2=function(a,b,d,f){for(var c=1,e=0,g=0,k;g<f;++g)k=d.decodeBit(a,b+c),c=c<<1|k,e|=k<<g;return e};a.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new a.BitTreeDecoder(8);this._numPosStates=0};a.LenDecoder.prototype.create=function(c){for(;this._numPosStates<
c;++this._numPosStates)this._lowCoder[this._numPosStates]=new a.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new a.BitTreeDecoder(3)};a.LenDecoder.prototype.init=function(){var c=this._numPosStates;for(a.initBitModels(this._choice,2);c--;)this._lowCoder[c].init(),this._midCoder[c].init();this._highCoder.init()};a.LenDecoder.prototype.decode=function(a,b){return 0===a.decodeBit(this._choice,0)?this._lowCoder[b].decode(a):0===a.decodeBit(this._choice,1)?8+this._midCoder[b].decode(a):16+this._highCoder.decode(a)};
a.Decoder2=function(){this._decoders=[]};a.Decoder2.prototype.init=function(){a.initBitModels(this._decoders,768)};a.Decoder2.prototype.decodeNormal=function(a){var b=1;do b=b<<1|a.decodeBit(this._decoders,b);while(256>b);return b&255};a.Decoder2.prototype.decodeWithMatchByte=function(a,b){var c=1;do{var d=b>>7&1;b<<=1;var g=a.decodeBit(this._decoders,(1+d<<8)+c);c=c<<1|g;if(d!==g){for(;256>c;)c=c<<1|a.decodeBit(this._decoders,c);break}}while(256>c);return c&255};a.LiteralDecoder=function(){};a.LiteralDecoder.prototype.create=
function(c,b){if(!this._coders||this._numPrevBits!==b||this._numPosBits!==c)for(this._numPosBits=c,this._posMask=(1<<c)-1,this._numPrevBits=b,this._coders=[],c=1<<this._numPrevBits+this._numPosBits;c--;)this._coders[c]=new a.Decoder2};a.LiteralDecoder.prototype.init=function(){for(var a=1<<this._numPrevBits+this._numPosBits;a--;)this._coders[a].init()};a.LiteralDecoder.prototype.getDecoder=function(a,b){return this._coders[((a&this._posMask)<<this._numPrevBits)+((b&255)>>>8-this._numPrevBits)]};a.Decoder=
function(){this._outWindow=new a.OutWindow;this._rangeDecoder=new a.RangeDecoder;this._isMatchDecoders=[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new a.BitTreeDecoder(4);this._lenDecoder=new a.LenDecoder;this._repLenDecoder=new a.LenDecoder;this._literalDecoder=new a.LiteralDecoder;this._dictionarySizeCheck=this._dictionarySize=-1;this._posSlotDecoder[0]=
new a.BitTreeDecoder(6);this._posSlotDecoder[1]=new a.BitTreeDecoder(6);this._posSlotDecoder[2]=new a.BitTreeDecoder(6);this._posSlotDecoder[3]=new a.BitTreeDecoder(6)};a.Decoder.prototype.setDictionarySize=function(a){if(0>a)return!1;this._dictionarySize!==a&&(this._dictionarySize=a,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096)));return!0};a.Decoder.prototype.setLcLpPb=function(a,b,d){var c=1<<d;if(8<a||4<b||4<d)return!1;
this._literalDecoder.create(b,a);this._lenDecoder.create(c);this._repLenDecoder.create(c);this._posStateMask=c-1;return!0};a.Decoder.prototype.init=function(){var c=4;this._outWindow.init(!1);a.initBitModels(this._isMatchDecoders,192);a.initBitModels(this._isRep0LongDecoders,192);a.initBitModels(this._isRepDecoders,12);a.initBitModels(this._isRepG0Decoders,12);a.initBitModels(this._isRepG1Decoders,12);a.initBitModels(this._isRepG2Decoders,12);a.initBitModels(this._posDecoders,114);for(this._literalDecoder.init();c--;)this._posSlotDecoder[c].init();
this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();this._rangeDecoder.init()};a.Decoder.prototype.decode=function(c,b,d){var e=0,g=0,h=0,l=0,k=0,m=0,r=0;this._rangeDecoder.setStream(c);this._outWindow.setStream(b);for(this.init();0>d||m<d;)if(c=m&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(e<<4)+c))r=this._literalDecoder.getDecoder(m++,r),r=7<=e?r.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(g)):r.decodeNormal(this._rangeDecoder),
this._outWindow.putByte(r),e=4>e?0:e-(10>e?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,e))r=0,0===this._rangeDecoder.decodeBit(this._isRepG0Decoders,e)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(e<<4)+c)&&(e=7>e?9:11,r=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,e)?b=h:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,e)?b=l:(b=k,k=l),l=h),h=g,g=b),0===r&&(r=2+this._repLenDecoder.decode(this._rangeDecoder,c),e=7>e?8:11);else if(k=l,l=h,h=
g,r=2+this._lenDecoder.decode(this._rangeDecoder,c),e=7>e?7:10,c=this._posSlotDecoder[5>=r?r-2:3].decode(this._rangeDecoder),4<=c)if(b=(c>>1)-1,g=(2|c&1)<<b,14>c)g+=a.reverseDecode2(this._posDecoders,g-c-1,this._rangeDecoder,b);else{if(g+=this._rangeDecoder.decodeDirectBits(b-4)<<4,g+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),0>g){if(-1===g)break;return!1}}else g=c;if(g>=m||g>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(g,r);m+=r;r=this._outWindow.getByte(0)}this._outWindow.flush();
this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return!0};a.Decoder.prototype.setDecoderProperties=function(a){if(5>a.size)return!1;var b=a.readByte();var c=b%9;b=~~(b/9);if(!this.setLcLpPb(c,b%5,~~(b/5)))return!1;b=a.readByte();b|=a.readByte()<<8;b|=a.readByte()<<16;b+=16777216*a.readByte();return this.setDictionarySize(b)};a.decompress=function(c,b,d,f){var e=new a.Decoder;if(!e.setDecoderProperties(c))throw"Incorrect stream properties";if(!e.decode(b,d,f))throw"Error in data stream";
return!0};a.decompressFile=function(c,b){var d=new a.Decoder;if(!d.setDecoderProperties(c))throw"Incorrect stream properties";var f=c.readByte();f|=c.readByte()<<8;f|=c.readByte()<<16;f+=16777216*c.readByte();c.readByte();c.readByte();c.readByte();c.readByte();if(!d.decode(c,b,f))throw"Error in data stream";return!0};return a}();g.engine=function(){var a="LZMA",c,b,e=null,f=window.URL||window.webkitURL,y=0,h=0,u=0,k=0,m=0,r=0,p,z=void 0,t=!1,x=null,n=!1,q,v,w,A,C,D,B={worldscale:1,gravity:[0,-10,
0],fps:60,substep:2,broadphase:2,soft:!0};g.engine={init:function(c,d,f,h){this.initArray(h);this.defaultRoot();f=f||{};b=c;B={fps:f.fps||60,worldscale:f.worldscale||1,gravity:f.gravity||[0,-10,0],substep:f.substep||2,broadphase:f.broadphase||2,soft:void 0!==f.soft?f.soft:!0};r=1/B.fps*1E3;a=d||"LZMA";"LZMA"===a?g.engine.load(B):(e=document.location.href.replace(/\/[^/]*$/,"/")+("WASM"===a?"./build/ammo.wasm.js":"./build/ammo.js"),g.engine.startWorker())},load:function(){var a=new XMLHttpRequest;
a.responseType="arraybuffer";a.open("GET","./build/ammo.hex",!0);a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status?(e=f.createObjectURL(new Blob([M(a.response)],{type:"application/javascript"})),g.engine.startWorker()):console.error("Couldn't load [./build/ammo.hex] ["+a.status+"]"))};a.send(null)},startWorker:function(){c=new Worker("./build/gun.js");c.postMessage=c.webkitPostMessage||c.postMessage;c.onmessage=g.engine.message;var a=new ArrayBuffer(1);c.postMessage({m:"test",
ab:a},[a]);n=a.byteLength?!1:!0;g.engine.post("init",{blob:e,ArPos:d.ArPos,ArMax:d.ArMax,isBuffer:n,option:B});d.post=g.engine.post},initArray:function(a){a=a||{};d.ArLng=[8*(a.maxBody||1E3),a.maxContact||200,8*(a.maxCharacter||10),56*(a.maxCar||14),3*(a.maxSoftPoint||8192)];d.ArPos=[0,d.ArLng[0],d.ArLng[0]+d.ArLng[1],d.ArLng[0]+d.ArLng[1]+d.ArLng[2],d.ArLng[0]+d.ArLng[1]+d.ArLng[2]+d.ArLng[3]];d.ArMax=d.ArLng[0]+d.ArLng[1]+d.ArLng[2]+d.ArLng[3]+d.ArLng[4]},message:function(a){a=a.data;a.Ar&&(d.Ar=
a.Ar);switch(a.m){case "initEngine":g.engine.initEngine();break;case "start":g.engine.start(a);break;case "step":g.engine.step();break;case "moveSolid":g.engine.moveSolid(a.o)}},initEngine:function(){f.revokeObjectURL(e);e=null;this.initObject();console.log("AMMO.Worker 001"+(n?" with ":" without ")+"Buffer #"+a);b&&b()},start:function(a){t=!0;n&&(d.Ar=new Float32Array(d.ArMax));z||(z=requestAnimationFrame(g.engine.sendData))},postUpdate:function(){},step:function(){y-1E3>k&&(k=y,p=m,m=0);m++;g.engine.postUpdate();
g.engine.steps();x&&x.needUpdate(!0);t=!0},sendData:function(a){x&&x.pause?z=null:(z=requestAnimationFrame(g.engine.sendData),y=a,h=y-u,h>r&&(u=y-h%r,t&&(n?c.postMessage({m:"step",o:{key:g.engine.getKey()},Ar:d.Ar},[d.Ar.buffer]):c.postMessage({m:"step",o:{key:g.engine.getKey()}}),t=!1),g.engine.tell()))},setView:function(a){x=a;d.mat=a.getMat();d.geo=a.getGeo();d.container=a.getScene()},getFps:function(){return p},tell:function(){},getKey:function(){return[0,0,0,0,0,0,0,0]},set:function(a){a=a||
B;r=void 0!==a.fps?1/a.fps*1E3:r;this.post("set",a)},post:function(a,b){c.postMessage({m:a,o:b})},reset:function(a){z&&(window.cancelAnimationFrame(z),z=void 0);for(g.engine.clear();0<d.tmpMat.length;)d.tmpMat.pop().dispose();g.engine.postUpdate=function(){};x&&x.reset();g.engine.post("reset",{full:a})},stop:function(){z&&(window.cancelAnimationFrame(z),z=void 0)},destroy:function(){c.terminate();c=void 0},addMat:function(a){d.tmpMat.push(a)},updateTmpMat:function(a,b){for(var c=d.tmpMat.length,e;c--;)e=
d.tmpMat[c],void 0!==e.envMap&&(e.envMap="MeshStandardMaterial"===e.type?a:b?null:a,e.needsUpdate=!0)},drive:function(a){this.post("setDrive",{name:a})},move:function(a){this.post("setMove",{name:a})},forces:function(a){this.post("setForces",a)},option:function(a){this.post("setOption",a)},remove:function(a){this.post("setRemove",a)},matrix:function(a){this.post("setMatrix",a)},moveSolid:function(a){if(l.has(a.name)){var b=l.get(a.name);void 0!==a.pos&&b.position.fromArray(a.pos);void 0!==a.quat&&
b.quaternion.fromArray(a.quat)}},getBodys:function(){return q.bodys},byName:function(a){return l.get(a)},initObject:function(){q=new F;v=new G;w=new H;A=new I;C=new J;D=new K},steps:function(){w.step();q.step(d.Ar,d.ArPos[0]);D.step(d.Ar,d.ArPos[1]);C.step(d.Ar,d.ArPos[2]);A.step(d.Ar,d.ArPos[3]);v.step(d.Ar,d.ArPos[4])},clear:function(a){q.clear();D.clear();w.clear();A.clear();C.clear();for(v.clear();0<d.extraGeo.length;)d.extraGeo.pop().dispose()},addGroup:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},
add:function(a){a=a||{};var b=void 0===a.type?"box":a.type,c=b.substring(0,4);if("join"===c)d.post("add",a);else if("soft"===c)v.add(a);else if("terrain"===b)w.add(a);else if("character"===b)C.add(a);else if("collision"===b)D.add(a);else if("car"===b)A.add(a);else return q.add(a)},defaultRoot:function(){var a={circle:new THREE.CircleBufferGeometry(1,6),plane:new THREE.PlaneBufferGeometry(1,1,1,1),box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,
1,.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};a.circle.rotateX(-1.570796326794896);a.plane.rotateX(-1.570796326794896);a.wheel.rotateZ(-1.570796326794896);d.geo=a;d.mat={move:new THREE.MeshLambertMaterial({color:16746513,name:"move",wireframe:!1}),speed:new THREE.MeshLambertMaterial({color:16776977,name:"speed",wireframe:!1}),sleep:new THREE.MeshLambertMaterial({color:1149183,
name:"sleep",wireframe:!1}),basic:new THREE.MeshLambertMaterial({color:1118481,name:"basic",wireframe:!1}),static:new THREE.MeshLambertMaterial({color:1118719,name:"static",wireframe:!1}),kinematic:new THREE.MeshLambertMaterial({color:1179409,name:"kinematic",wireframe:!1})};d.container=new THREE.Group},getContainer:function(){return d.container}};return g.engine}();Object.defineProperty(g,"__esModule",{value:!0})});
