(function(h,y){"object"===typeof exports&&"undefined"!==typeof module?y(exports):"function"===typeof define&&define.amd?define(["exports"],y):(h=h||self,y(h.SHOT={}))})(this,function(h){function y(a,c){var b=!1;if("mesh"==c||"convex"==c)b=!0;var f=a.isBufferGeometry?(new THREE.Geometry).fromBufferGeometry(a):a;f.mergeVertices();var d=a.attributes.position.array.length/3,m=f.vertices.length,g=f.faces.length;a.realVertices=new Float32Array(3*m);a.realIndices=new (65535<3*g?Uint32Array:Uint16Array)(3*
g);a.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*d),3));var e=a.attributes.color.array;for(c=d;c--;){var k=3*c;e[k]=1;e[k+1]=1;e[k+2]=1}for(c=m;c--;)e=f.vertices[c],k=3*c,a.realVertices[k]=e.x,a.realVertices[k+1]=e.y,a.realVertices[k+2]=e.z;for(c=g;c--;)e=f.faces[c],k=3*c,a.realIndices[k]=e.a,a.realIndices[k+1]=e.b,a.realIndices[k+2]=e.c;f.dispose();if(b){d=[];for(c=a.realIndices.length;c--;)k=3*c,e=3*a.realIndices[c],d[k]=a.realVertices[e],d[k+1]=a.realVertices[e+1],d[k+2]=
a.realVertices[e+2];return d}f=[];var l=a.attributes.position.array;for(c=m;c--;)for(k=3*c,f[c]=[],b=d;b--;)e=3*b,l[e]==a.realVertices[k]&&l[e+1]==a.realVertices[k+1]&&l[e+2]==a.realVertices[k+2]&&f[c].push(b);l=new (65535<m?Uint32Array:Uint16Array)(m);var r=new (65535<d?Uint32Array:Uint16Array)(d);for(c=e=0;c<m;c++){k=f[c].length;l[c]=e;for(b=k;b--;)r[e+b]=f[c][b];e+=k}a.numFaces=g;a.numVertices=m;a.maxi=d;a.pPoint=l;a.lPoint=r}function E(a,c,b,f){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";
var d=a||1;c=c||1;var e=b||12,g=Math.floor(.5*e);a=f||1;var u=2*Math.PI,k=.5*Math.PI;f=new THREE.Geometry;a=new THREE.CylinderGeometry(d,d,c,e,a,!0);var l=new THREE.SphereGeometry(d,e,g,0,u,0,k);d=new THREE.SphereGeometry(d,e,g,0,u,k,k);e=(new THREE.Matrix4).makeTranslation(0,0,0);6===b&&e.makeRotationY(.5235987755982988);b=(new THREE.Matrix4).makeTranslation(0,.5*c,0);c=(new THREE.Matrix4).makeTranslation(0,.5*-c,0);f.merge(a,e);f.merge(l,b);f.merge(d,c);f.mergeVertices();this.fromGeometry(f)}function x(a){for(var c=
a.length;c--;)a[c]*=e.torad;return a}function F(){this.ID=0;this.solids=[];this.bodys=[]}function G(){this.ID=0;this.softs=[]}function H(a,c){var b=a.shape.clone(),f=a.pos||[0,0,0],d=a.size||[1,1,1],m=a.rot||[0,0,0];b.translate(f[0],f[1],f[2]);b.scale(d[0],d[1],d[2]);b.applyMatrix((new THREE.Matrix4).makeRotationY(m[1]*=Math.torad));y(b);e.extraGeo.push(b);a.v=b.realVertices;a.i=b.realIndices;a.ntri=b.numFaces;c=new THREE.Mesh(b,c);c.castShadow=!0;c.receiveShadow=!0;c.softType=5;c.points=a.v.length/
3;a.shape&&delete a.shape;a.material&&delete a.material;return{mesh:c,o:a}}function I(){this.ID=0;this.terrains=[]}function J(){this.ID=0;this.cars=[]}function K(){this.ID=0;this.heroes=[]}function L(){this.ID=0;this.pairs=[]}function M(a,c){this.name=a;this.callback=c}function O(a){a=new Uint8Array(a);var c={data:[],position:0,writeByte:function(a){this.data[this.position++]=a}};P.decompressFile({data:a,position:0,readByte:function(){return this.data[this.position++]}},c);return(new Uint8Array(c.data)).buffer}
E.prototype=Object.create(THREE.BufferGeometry.prototype);var e={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},torad:.017453292519943295},l=new Map;Object.assign(F.prototype,{step:function(a,c){var b;this.bodys.forEach(function(f,d){b=c+8*d;d=a[b];if(0<d)"sleep"==f.material.name&&(f.material=e.mat.move),50<d&&"move"==f.material.name?f.material=e.mat.speed:50>d&&"speed"==f.material.name&&(f.material=e.mat.move);else if("move"==
f.material.name||"speed"==f.material.name)f.material=e.mat.sleep;f.position.fromArray(a,b+1);f.quaternion.fromArray(a,b+4)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=a.isSolid?!0:!1,b=c?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==b&&(c?this.solids.splice(b,1):this.bodys.splice(b,
1),this.destroy(a))}},add:function(a,c){a.name=void 0!==a.name?a.name:"body"+this.ID++;this.remove(a.name);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);a.mass=void 0===a.mass?0:a.mass;a.kinematic=a.kinematic||!1;a.type=void 0===a.type?"box":a.type;a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;c=!1;a.size=void 0==a.size?[1,1,1]:a.size;1===a.size.length&&(a.size[1]=a.size[0]);2===a.size.length&&(a.size[2]=a.size[0]);a.geoSize&&(1===a.geoSize.length&&
(a.geoSize[1]=a.geoSize[0]),2===a.geoSize.length&&(a.geoSize[2]=a.geoSize[0]));a.rot=void 0===a.rot?[0,0,0]:x(a.rot);a.quat=void 0===a.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray():a.quat;a.rotA&&(a.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(x(a.rotA))).toArray());a.rotB&&(a.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(x(a.rotB))).toArray());a.angUpper&&(a.angUpper=x(a.angUpper));a.angLower&&(a.angLower=x(a.angLower));
if("plane"===a.type)e.post("add",a);else{if(void 0!==a.material)var b=a.material.constructor===String?e.mat[a.material]:a.material;else b=0!==a.mass||a.kinematic?e.mat.move:e.mat.static,a.kinematic&&(b=e.mat.kinematic);if("compound"===a.type){for(var f,d,m=0;m<a.shapes.length;m++)d=a.shapes[m],d.size=void 0===d.size?[1,1,1]:d.size,1===d.size.length&&(d.size[1]=d.size[0]),2===d.size.length&&(d.size[2]=d.size[0]),d.pos=void 0===d.pos?[0,0,0]:d.pos,d.rot=void 0===d.rot?[0,0,0]:x(d.rot),d.quat=void 0===
d.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(d.rot)).toArray():d.quat;var g=a.geometry?new THREE.Mesh(a.geometry,b):new THREE.Group;a.geometry&&e.extraGeo.push(a.geometry);if(!a.geometry||a.debug)for(g.material=b,m=0;m<a.shapes.length;m++)d=a.shapes[m],"box"===d.type&&(d.type="hardbox"),"cylinder"===d.type&&(d.type="hardcylinder"),f=new THREE.Mesh("capsule"===d.type?new E(a.size[0],.5*a.size[1]):e.geo[d.type],a.debug?e.mat.debug:b),f.scale.fromArray(d.size),f.position.fromArray(d.pos),
f.quaternion.fromArray(d.quat),g.add(f)}else if("mesh"===a.type||"convex"===a.type)a.shape&&(a.v=y(a.shape,a.type),e.extraGeo.push(a.shape)),a.geometry?(g=new THREE.Mesh(a.geometry,b),e.extraGeo.push(a.geometry)):g=new THREE.Mesh(a.shape,b);else{"box"!==a.type||0!==a.mass||a.kinematic||(a.type="hardbox");"capsule"===a.type&&(a.geometry=new E(a.size[0],.5*a.size[1]));if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(x(a.geoRot))));
a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[1],a.geoScale[2]))}g=new THREE.Mesh(a.geometry||e.geo[a.type],b);a.geometry&&(e.extraGeo.push(a.geometry),a.geoSize&&g.scale.fromArray(a.geoSize),!a.geoSize&&a.size&&"capsule"!==a.type&&g.scale.fromArray(a.size),c=!0)}"highsphere"===a.type&&(a.type="sphere");g&&(c||g.scale.fromArray(a.size),g.position.fromArray(a.pos),g.quaternion.fromArray(a.quat),g.receiveShadow=!0,g.castShadow=0!==a.mass||a.kinematic?!0:!1,
g.name=a.name,void 0!==a.parent?a.parent.add(g):e.container.add(g));a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;void 0===a.noPhy&&(g&&(0!==a.mass||a.kinematic?this.bodys.push(g):this.solids.push(g)),e.post("add",a));if(g)return 0!==a.mass||a.kinematic||(g.isSolid=!0),a.kinematic?g.isKinemmatic=!0:g.isBody=!0,l.set(a.name,g),g}}});Object.assign(G.prototype,{step:function(a,c){var b=c;this.softs.forEach(function(c,d){var f,e=c.geometry,u=c.softType,k=null,l=e.attributes.color?
!0:!1,r=e.attributes.normal?!0:!1;if(2===u){for(d=e.positions.length;d--;){var p=b+3*d;e.positions[d].set(a[p],a[p+1],a[p+2])}e.updatePath()}else{if(!e.attributes.position)return;var h=e.attributes.position.array;if(l)var t=e.attributes.color.array;if(5===u||4===u){var w=e.numVertices,n=e.maxi,q=e.pPoint,A=e.lPoint;for(d=w;d--;){p=3*d+b;var v=d==w-1?n-q[d]:q[d+1]-q[d];for(f=q[d];v--;)t=3*A[f+v],h[t]=a[p],h[t+1]=a[p+1],h[t+2]=a[p+2]}}else if(e.attributes.order&&(k=e.attributes.order.array),d=h.length,
p=2,null!==k)for(d=k.length;d--;)v=3*k[d],p=3*d+b,h[v]=a[p],h[v+1]=a[p+1],h[v+2]=a[p+2],f=Math.abs(a[p+1]/10),t[v]=f,t[v+1]=f,t[v+2]=f;else for(;d--;)h[d]=a[d+b],1==p&&(f=Math.abs(h[d]/10),t[d-1]=f,t[d]=f,t[d+1]=f),p--,p=0>p?2:p;2!==u&&e.computeVertexNormals();if(r){p=e.attributes.normal.array;for(d=w;d--;)for(v=d==w-1?n-q[d]:q[d+1]-q[d],f=q[d],h=3*A[f];v--;)t=3*A[f+v],p[t]=p[h],p[t+1]=p[h+1],p[t+2]=p[h+2];e.attributes.normal.needsUpdate=!0}l&&(e.attributes.color.needsUpdate=!0);e.attributes.position.needsUpdate=
!0;e.computeBoundingSphere()}b+=3*c.points})},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.softs.indexOf(a);-1!==c&&(this.softs.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);var b=void 0!==a.material?a.material.constructor===String?e.mat[a.material]:a.material:e.mat.soft;switch(a.type){case "softMesh":case "softTriMesh":var f=
H(a,b);break;case "softConvex":f=H(a,b);break;case "softCloth":f=a.div||[16,16];var d=a.size||[100,0,100],m=a.pos||[0,0,0],g=f[0]*f[1],u=new THREE.PlaneBufferGeometry(d[0],d[2],f[0]-1,f[1]-1);u.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*g),3));u.rotateX(-Math.PI90);b=new THREE.Mesh(u,b);b.position.set(m[0],m[1],m[2]);b.castShadow=!0;b.receiveShadow=!0;b.softType=1;b.points=u.attributes.position.array.length/3;a.size=d;a.div=f;a.pos=m;f={mesh:b,o:a};break;case "softRope":void 0===
a.numSeg&&(a.numSeg=a.numSegment);f=new THREE.Tubular(a,a.numSeg||10,a.radius||.2,a.numRad||6,!1);b=new THREE.Mesh(f,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=2;b.points=f.positions.length;f={mesh:b,o:a};break;case "softEllips":e.post("add",a);return}b=f.mesh;a=f.o;b.name=c;b.isSoft=!0;e.container.add(b);this.softs.push(b);l.set(c,b);e.post("add",a)},createEllipsoid:function(a){var c=a.lng,b=[],f=a.a,d,m;for(d=0;d<c;d++){var g=3*d;b.push(new THREE.Vector3(f[g],f[g+1],f[g+2]))}b=new THREE.ConvexGeometry(b);
var u=new Uint32Array(3*b.faces.length),k=new Float32Array(3*c),h=new Float32Array(c);var r=b.vertices;for(d=c;d--;)for(m=c;m--;)g=3*m,f[g]==r[d].x&&f[g+1]==r[d].y&&f[g+2]==r[d].z&&(h[m]=d);for(d=c;d--;)g=3*d,m=3*h[d],k[m]=f[g],k[m+1]=f[g+1],k[m+2]=f[g+2];for(d=b.faces.length;d--;)g=3*d,f=b.faces[d],u[g]=f.a,u[g+1]=f.b,u[g+2]=f.c;d=new THREE.BufferGeometry;d.setIndex(new THREE.BufferAttribute(u,1));d.addAttribute("position",new THREE.BufferAttribute(k,3));d.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
c),3));d.addAttribute("order",new THREE.BufferAttribute(h,1));b.uvs&&(c=new Float32Array(2*b.uvs.length),d.addAttribute("uv",(new THREE.BufferAttribute(c,2)).copyVector2sArray(b.uvs),2));d.computeVertexNormals();e.extraGeo.push(d);b.dispose();c=new THREE.Mesh(d,e.mat.soft);c.softType=3;c.isSoft=!0;c.points=d.attributes.position.array.length/3;c.castShadow=!0;c.receiveShadow=!0;c.name=a.name;e.container.add(c);this.softs.push(c);l.set(a.name,c)}});Object.assign(I.prototype,{step:function(a,c){this.terrains.forEach(function(a,
c){a.needsUpdate&&(a.updateGeometry(),e.post("setTerrain",{name:a.name,heightData:a.heightData}),a.needsUpdate=!1)})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.terrains.indexOf(a);-1!==c&&(this.terrains.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);a.sample=void 0===a.sample?
[64,64]:a.sample;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.complexity=void 0===a.complexity?30:a.complexity;a.name=c;var b=new THREE.Terrain(a);b.needsUpdate=!1;a.heightData=b.heightData;a.offset=0;e.container.add(b);this.terrains.push(b);l.set(c,b);e.post("add",a)},move:function(a,c,b){l.has(a)&&(a=l.get(a),a.local.x+=c||0,a.local.z+=b||0,a.update(!0),a.needsUpdate=!0)}});Object.assign(J.prototype,{step:function(a,c){var b;this.cars.forEach(function(f,d){b=c+56*d;f.userData.speed=a[b];f.position.fromArray(a,
b+1);f.quaternion.fromArray(a,b+4);d=f.userData.NumWheels;var e;var g=40;var h=f.userData.radius;var k=a[b+8];f.userData.steeringWheel&&(f.userData.steeringWheel.rotation.y=6*-k);if(f.userData.isWithBrake)for(e=d;e--;)0===e&&(f.userData.b[e].rotation.y=k),1===e&&(f.userData.b[e].rotation.y=Math.Pi-k),f.userData.b[e].position.y=h-a[b+g+e];if(f.userData.isWithSusp)for(e=d;e--;)h=5*a[b+g+e],h=1<h?1:h,h=-1>h?-1:h,0<h?(f.userData.s[e].setWeight("low",h),f.userData.s[e].setWeight("top",0)):(f.userData.s[e].setWeight("low",
0),f.userData.s[e].setWeight("top",-h));for(f.userData.helper&&4==d&&f.userData.helper.updateSuspension(a[b+g+0],a[b+g+1],a[b+g+2],a[b+g+3]);d--;)g=8*(d+1),f.userData.w[d].position.fromArray(a,b+g+1),f.userData.w[d].quaternion.fromArray(a,b+g+4)})},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){for(var c,b=0,f=a.userData.w.length;b<f;b++)c=a.userData.w[b],c.parent&&c.parent.remove(c);a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=
l.get(a);var c=this.cars.indexOf(a);-1!==c&&(this.cars.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);var b=a.size||[2,.5,4],f=a.pos||[0,0,0],d=a.rot||[0,0,0];a.masscenter=void 0==a.masscenter?[0,0,0]:a.masscenter;Math.vectorad(d);a.mesh?(b=new THREE.Group,b.add(a.mesh)):a.geometry?(b=new THREE.Mesh(a.geometry,a.material),e.extraGeo.push(a.geometry)):(b=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(b[0],b[1],b[2])),b.translate(-a.masscenter[0],
-a.masscenter[1],-a.masscenter[2]),e.extraGeo.push(b),b=new THREE.Mesh(b,e.mat.move));a.debug&&a.shape&&(b=new THREE.Mesh(a.shape,e.mat.debug));b.position.set(f[0],f[1],f[2]);b.rotation.set(d[0],d[1],d[2]);a.quat=b.quaternion.toArray();e.container.add(b);b.userData.speed=0;b.userData.steering=0;b.userData.NumWheels=a.nw||4;b.userData.type="car";b.userData.steeringWheel=a.meshSteeringWheel||null;d=a.radius||.4;var m=a.deep||.3;f=a.wPos||[1,-.25,1.6];var g=[],h=[],k=[],N=void 0===a.meshSusp?!1:!0,r=
void 0===a.meshBrake?!1:!0,p=void 0==a.wheel?!0:!1,z=a.wheel||e.geo.wheel,t=z.clone();t.rotateY(Math.Pi);e.extraGeo.push(t);var w=e.mat.move;void 0!==a.wheelMaterial&&(w=a.wheelMaterial.constructor===String?e.mat[a.wheelMaterial]:a.wheelMaterial);for(var n=a.nw||4;n--;){if(a.meshBrake){var q=a.meshBrake.clone();b.add(q);q.position.y=d;1==n||2==n?(q.rotation.y=Math.Pi,q.position.x=f[0],q.rotation.x=Math.Pi):q.position.x=-f[0];q.position.z=0==n||1==n?f[2]:-f[2];k[n]=q}if(a.meshSusp){q=a.meshSusp.clone();
b.add(q);q.position.y=d;if(1==n||2==n)q.rotation.y=Math.Pi;q.position.z=0==n||1==n?f[2]:-f[2];h[n]=q.children[0]}if(a.meshWheel)if(g[n]=a.meshWheel.clone(),p=!1,1==n||2==n)g[n]=new THREE.Group,q=a.meshWheel.clone(),q.rotation.y=Math.Pi,g[n].add(q);else for(g[n]=a.meshWheel.clone(),q=g[n].children.length;q--;)"h_pneu"===g[n].children[q].name&&(g[n].children[q].rotation.y=Math.Pi);else g[n]=1==n||2==n?new THREE.Mesh(z,e.mat.move):new THREE.Mesh(t,e.mat.move);p&&g[n].scale.set(m,d,d);g[n].material=w;
g[n].castShadow=!0;g[n].receiveShadow=!0;e.container.add(g[n])}a.extraWeels&&(p=a.meshWheel.clone(),p.children[0].visible=!1,p.rotation.z=.5*-Math.Pi,p.position.set(0,1.25,-1.11),b.add(p));b.userData.radius=d;b.userData.w=g;b.userData.s=h;b.userData.b=k;b.userData.isWithSusp=N;b.userData.isWithBrake=r;a.helper&&(b.userData.helper=new THREE.CarHelper(f,a.masscenter,m),b.add(b.userData.helper));a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.shapeType||"convex"==a.shapeType)a.v=y(a.shape,
a.shapeType);a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;a.mesh&&delete a.mesh;a.meshWheel&&delete a.meshWheel;a.meshSusp&&delete a.meshSusp;a.meshBrake&&delete a.meshBrake;a.meshSteeringWheel&&delete a.meshSteeringWheel;a.wheelMaterial&&delete a.wheelMaterial;this.cars.push(b);l.set(c,b);e.post("add",a)}});Object.assign(K.prototype,{step:function(a,c){var b;this.heroes.forEach(function(f,d){b=c+8*d;d=3.33*a[b];f.userData.speed=100*d;f.position.fromArray(a,
b+1);f.quaternion.fromArray(a,b+4);f.skin&&(0===d?f.skin.play(0,.3):(f.skin.play(1,.3),f.skin.setTimeScale(d)))})},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.heroes.indexOf(a);-1!==c&&(this.heroes.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:a.type+this.ID++;this.remove(c);a.size=void 0==a.size?[.25,2,2]:a.size;
1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:Math.vectorad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var b=new THREE.CapsuleBufferGeometry(a.size[0],.5*a.size[1],6),f=new THREE.Group;if(a.debug){var d=new THREE.Mesh(b,e.mat.debug);e.extraGeo.push(b);f.add(d)}a.mesh?(b=a.mesh,b.material=e.mat.hero,b.scale.multiplyScalar(a.scale||1),b.position.set(0,
0,0),b.setTimeScale(.5),b.play(0),f.add(b),f.skin=b):(d=new THREE.Mesh(b,e.mat.hero),e.extraGeo.push(b),f.add(d));f.userData.speed=0;f.userData.type="hero";f.position.fromArray(a.pos);f.quaternion.fromArray(a.quat);f.castShadow=!0;f.receiveShadow=!0;f.name=c;a.mesh&&delete a.mesh;e.container.add(f);this.heroes.push(f);l.set(c,f);e.post("add",a)}});Object.assign(L.prototype,{step:function(a,c){this.pairs.forEach(function(b,f){b.callback(a[c+f]||0)})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());
this.ID=0},destroy:function(a){a.clear();l.delete(a.name)},remove:function(a){if(l.has(a)){a=l.get(a);var c=this.pairs.indexOf(a);-1!==c&&(this.pairs.splice(c,1),this.destroy(a))}},add:function(a,c){c=void 0!==a.name?a.name:"pair"+this.ID++;this.remove(c);var b=new M(c,a.callback);this.pairs.push(b);delete a.callback;l.set(c,b);e.post("add",a)}});Object.assign(M.prototype,{clear:function(){this.callback=this.name=null}});var P=function(){var a=a||{};a.OutWindow=function(){this._windowSize=0};a.OutWindow.prototype.create=
function(a){this._buffer&&this._windowSize===a||(this._buffer=[]);this._windowSize=a;this._streamPos=this._pos=0};a.OutWindow.prototype.flush=function(){var a=this._pos-this._streamPos;if(0!==a){for(;a--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0);this._streamPos=this._pos}};a.OutWindow.prototype.releaseStream=function(){this.flush();this._stream=null};a.OutWindow.prototype.setStream=function(a){this.releaseStream();this._stream=a};a.OutWindow.prototype.init=
function(a){a||(this._pos=this._streamPos=0)};a.OutWindow.prototype.copyBlock=function(a,b){a=this._pos-a-1;for(0>a&&(a+=this._windowSize);b--;)a>=this._windowSize&&(a=0),this._buffer[this._pos++]=this._buffer[a++],this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.putByte=function(a){this._buffer[this._pos++]=a;this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.getByte=function(a){a=this._pos-a-1;0>a&&(a+=this._windowSize);return this._buffer[a]};a.RangeDecoder=function(){};
a.RangeDecoder.prototype.setStream=function(a){this._stream=a};a.RangeDecoder.prototype.releaseStream=function(){this._stream=null};a.RangeDecoder.prototype.init=function(){var a=5;this._code=0;for(this._range=-1;a--;)this._code=this._code<<8|this._stream.readByte()};a.RangeDecoder.prototype.decodeDirectBits=function(a){for(var b=0,c;a--;)this._range>>>=1,c=this._code-this._range>>>31,this._code-=this._range&c-1,b=b<<1|1-c,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),
this._range<<=8);return b};a.RangeDecoder.prototype.decodeBit=function(a,b){var c=a[b],d=(this._range>>>11)*c;if((this._code^2147483648)<(d^2147483648))return this._range=d,a[b]+=2048-c>>>5,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0;this._range-=d;this._code-=d;a[b]-=c>>>5;0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return 1};a.initBitModels=function(a,b){for(;b--;)a[b]=1024};a.BitTreeDecoder=
function(a){this._models=[];this._numBitLevels=a};a.BitTreeDecoder.prototype.init=function(){a.initBitModels(this._models,1<<this._numBitLevels)};a.BitTreeDecoder.prototype.decode=function(a){for(var b=1,c=this._numBitLevels;c--;)b=b<<1|a.decodeBit(this._models,b);return b-(1<<this._numBitLevels)};a.BitTreeDecoder.prototype.reverseDecode=function(a){for(var b=1,c=0,d=0,e;d<this._numBitLevels;++d)e=a.decodeBit(this._models,b),b=b<<1|e,c|=e<<d;return c};a.reverseDecode2=function(a,b,e,d){for(var c=
1,f=0,h=0,k;h<d;++h)k=e.decodeBit(a,b+c),c=c<<1|k,f|=k<<h;return f};a.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new a.BitTreeDecoder(8);this._numPosStates=0};a.LenDecoder.prototype.create=function(c){for(;this._numPosStates<c;++this._numPosStates)this._lowCoder[this._numPosStates]=new a.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new a.BitTreeDecoder(3)};a.LenDecoder.prototype.init=function(){var c=this._numPosStates;for(a.initBitModels(this._choice,
2);c--;)this._lowCoder[c].init(),this._midCoder[c].init();this._highCoder.init()};a.LenDecoder.prototype.decode=function(a,b){return 0===a.decodeBit(this._choice,0)?this._lowCoder[b].decode(a):0===a.decodeBit(this._choice,1)?8+this._midCoder[b].decode(a):16+this._highCoder.decode(a)};a.Decoder2=function(){this._decoders=[]};a.Decoder2.prototype.init=function(){a.initBitModels(this._decoders,768)};a.Decoder2.prototype.decodeNormal=function(a){var b=1;do b=b<<1|a.decodeBit(this._decoders,b);while(256>
b);return b&255};a.Decoder2.prototype.decodeWithMatchByte=function(a,b){var c=1;do{var d=b>>7&1;b<<=1;var e=a.decodeBit(this._decoders,(1+d<<8)+c);c=c<<1|e;if(d!==e){for(;256>c;)c=c<<1|a.decodeBit(this._decoders,c);break}}while(256>c);return c&255};a.LiteralDecoder=function(){};a.LiteralDecoder.prototype.create=function(c,b){if(!this._coders||this._numPrevBits!==b||this._numPosBits!==c)for(this._numPosBits=c,this._posMask=(1<<c)-1,this._numPrevBits=b,this._coders=[],c=1<<this._numPrevBits+this._numPosBits;c--;)this._coders[c]=
new a.Decoder2};a.LiteralDecoder.prototype.init=function(){for(var a=1<<this._numPrevBits+this._numPosBits;a--;)this._coders[a].init()};a.LiteralDecoder.prototype.getDecoder=function(a,b){return this._coders[((a&this._posMask)<<this._numPrevBits)+((b&255)>>>8-this._numPrevBits)]};a.Decoder=function(){this._outWindow=new a.OutWindow;this._rangeDecoder=new a.RangeDecoder;this._isMatchDecoders=[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=
[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new a.BitTreeDecoder(4);this._lenDecoder=new a.LenDecoder;this._repLenDecoder=new a.LenDecoder;this._literalDecoder=new a.LiteralDecoder;this._dictionarySizeCheck=this._dictionarySize=-1;this._posSlotDecoder[0]=new a.BitTreeDecoder(6);this._posSlotDecoder[1]=new a.BitTreeDecoder(6);this._posSlotDecoder[2]=new a.BitTreeDecoder(6);this._posSlotDecoder[3]=new a.BitTreeDecoder(6)};a.Decoder.prototype.setDictionarySize=function(a){if(0>
a)return!1;this._dictionarySize!==a&&(this._dictionarySize=a,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096)));return!0};a.Decoder.prototype.setLcLpPb=function(a,b,e){var c=1<<e;if(8<a||4<b||4<e)return!1;this._literalDecoder.create(b,a);this._lenDecoder.create(c);this._repLenDecoder.create(c);this._posStateMask=c-1;return!0};a.Decoder.prototype.init=function(){var c=4;this._outWindow.init(!1);a.initBitModels(this._isMatchDecoders,
192);a.initBitModels(this._isRep0LongDecoders,192);a.initBitModels(this._isRepDecoders,12);a.initBitModels(this._isRepG0Decoders,12);a.initBitModels(this._isRepG1Decoders,12);a.initBitModels(this._isRepG2Decoders,12);a.initBitModels(this._posDecoders,114);for(this._literalDecoder.init();c--;)this._posSlotDecoder[c].init();this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();this._rangeDecoder.init()};a.Decoder.prototype.decode=function(c,b,e){var d=0,f=0,g=0,h=0,k=0,l=0,
r=0;this._rangeDecoder.setStream(c);this._outWindow.setStream(b);for(this.init();0>e||l<e;)if(c=l&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(d<<4)+c))r=this._literalDecoder.getDecoder(l++,r),r=7<=d?r.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(f)):r.decodeNormal(this._rangeDecoder),this._outWindow.putByte(r),d=4>d?0:d-(10>d?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,d))r=0,0===this._rangeDecoder.decodeBit(this._isRepG0Decoders,
d)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(d<<4)+c)&&(d=7>d?9:11,r=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,d)?b=g:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,d)?b=h:(b=k,k=h),h=g),g=f,f=b),0===r&&(r=2+this._repLenDecoder.decode(this._rangeDecoder,c),d=7>d?8:11);else if(k=h,h=g,g=f,r=2+this._lenDecoder.decode(this._rangeDecoder,c),d=7>d?7:10,c=this._posSlotDecoder[5>=r?r-2:3].decode(this._rangeDecoder),4<=c)if(b=(c>>1)-1,f=(2|c&1)<<b,14>c)f+=a.reverseDecode2(this._posDecoders,
f-c-1,this._rangeDecoder,b);else{if(f+=this._rangeDecoder.decodeDirectBits(b-4)<<4,f+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),0>f){if(-1===f)break;return!1}}else f=c;if(f>=l||f>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(f,r);l+=r;r=this._outWindow.getByte(0)}this._outWindow.flush();this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return!0};a.Decoder.prototype.setDecoderProperties=function(a){if(5>a.size)return!1;var b=a.readByte();var c=b%9;b=~~(b/
9);if(!this.setLcLpPb(c,b%5,~~(b/5)))return!1;b=a.readByte();b|=a.readByte()<<8;b|=a.readByte()<<16;b+=16777216*a.readByte();return this.setDictionarySize(b)};a.decompress=function(c,b,e,d){var f=new a.Decoder;if(!f.setDecoderProperties(c))throw"Incorrect stream properties";if(!f.decode(b,e,d))throw"Error in data stream";return!0};a.decompressFile=function(c,b){var e=new a.Decoder;if(!e.setDecoderProperties(c))throw"Incorrect stream properties";var d=c.readByte();d|=c.readByte()<<8;d|=c.readByte()<<
16;d+=16777216*c.readByte();c.readByte();c.readByte();c.readByte();c.readByte();if(!e.decode(c,b,d))throw"Error in data stream";return!0};return a}();h.engine=function(){var a="LZMA",c,b,f=null,d=window.URL||window.webkitURL,m=0,g=0,u=0,k=0,y=0,r=0,p,z=void 0,t=!1,w=null,n=!1,q,A,v,x,C,D,B={worldscale:1,gravity:[0,-10,0],fps:60,substep:2,broadphase:2,soft:!0};h.engine={init:function(c,d,e,g){this.initArray(g);this.defaultRoot();e=e||{};b=c;B={fps:e.fps||60,worldscale:e.worldscale||1,gravity:e.gravity||
[0,-10,0],substep:e.substep||2,broadphase:e.broadphase||2,soft:void 0!==e.soft?e.soft:!0};r=1/B.fps*1E3;a=d||"LZMA";"LZMA"===a?h.engine.load(B):(f=document.location.href.replace(/\/[^/]*$/,"/")+("WASM"===a?"./build/ammo.wasm.js":"./build/ammo.js"),h.engine.startWorker())},load:function(){var a=new XMLHttpRequest;a.responseType="arraybuffer";a.open("GET","./build/ammo.hex",!0);a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status?(f=d.createObjectURL(new Blob([O(a.response)],
{type:"application/javascript"})),h.engine.startWorker()):console.error("Couldn't load [./build/ammo.hex] ["+a.status+"]"))};a.send(null)},startWorker:function(){c=new Worker("./build/gun.js");c.postMessage=c.webkitPostMessage||c.postMessage;c.onmessage=h.engine.message;var a=new ArrayBuffer(1);c.postMessage({m:"test",ab:a},[a]);n=a.byteLength?!1:!0;h.engine.post("init",{blob:f,ArPos:e.ArPos,ArMax:e.ArMax,isBuffer:n,option:B});e.post=h.engine.post},initArray:function(a){a=a||{};e.ArLng=[8*(a.maxBody||
1E3),a.maxContact||200,8*(a.maxCharacter||10),56*(a.maxCar||14),3*(a.maxSoftPoint||8192)];e.ArPos=[0,e.ArLng[0],e.ArLng[0]+e.ArLng[1],e.ArLng[0]+e.ArLng[1]+e.ArLng[2],e.ArLng[0]+e.ArLng[1]+e.ArLng[2]+e.ArLng[3]];e.ArMax=e.ArLng[0]+e.ArLng[1]+e.ArLng[2]+e.ArLng[3]+e.ArLng[4]},message:function(a){a=a.data;a.Ar&&(e.Ar=a.Ar);switch(a.m){case "initEngine":h.engine.initEngine();break;case "start":h.engine.start(a);break;case "step":h.engine.step();break;case "moveSolid":h.engine.moveSolid(a.o);break;case "ellipsoid":h.engine.ellipsoidMesh(a.o)}},
initEngine:function(){d.revokeObjectURL(f);f=null;this.initObject();console.log("AMMO.Worker 001"+(n?" with ":" without ")+"Buffer #"+a);b&&b()},start:function(a){t=!0;n&&(e.Ar=new Float32Array(e.ArMax));h.engine.sendData(0)},postUpdate:function(){},step:function(){m-1E3>k&&(k=m,p=y,y=0);y++;h.engine.postUpdate();h.engine.steps();w&&w.needUpdate(!0);t=!0},sendData:function(a){w&&w.pause?z=null:(z=requestAnimationFrame(h.engine.sendData),m=a,g=m-u,g>r&&(u=m-g%r,t&&(n?c.postMessage({m:"step",o:{key:h.engine.getKey()},
Ar:e.Ar},[e.Ar.buffer]):c.postMessage({m:"step",o:{key:h.engine.getKey()}}),t=!1),h.engine.tell()))},setView:function(a){w=a;e.mat=a.getMat();e.geo=a.getGeo();e.container=a.getScene()},getFps:function(){return p},tell:function(){},getKey:function(){return[0,0,0,0,0,0,0,0]},set:function(a){a=a||B;r=void 0!==a.fps?1/a.fps*1E3:r;this.post("set",a)},post:function(a,b){c.postMessage({m:a,o:b})},reset:function(a){console.log("reset",a);z&&(window.cancelAnimationFrame(z),z=void 0);for(h.engine.clear();0<
e.tmpMat.length;)e.tmpMat.pop().dispose();h.engine.postUpdate=function(){};w&&w.reset(a);h.engine.post("reset",{full:a})},stop:function(){z&&(window.cancelAnimationFrame(z),z=void 0)},destroy:function(){c.terminate();c=void 0},addMat:function(a){e.tmpMat.push(a)},ellipsoidMesh:function(a){A.createEllipsoid(a)},updateTmpMat:function(a,b){for(var c=e.tmpMat.length,d;c--;)d=e.tmpMat[c],void 0!==d.envMap&&(d.envMap="MeshStandardMaterial"===d.type?a:b?null:a,d.needsUpdate=!0)},drive:function(a){this.post("setDrive",
{name:a})},move:function(a){this.post("setMove",{name:a})},forces:function(a){this.post("setForces",a)},option:function(a){this.post("setOption",a)},remove:function(a){this.post("setRemove",a)},matrix:function(a){this.post("setMatrix",a)},anchor:function(a){this.post("addAnchor",a)},moveSolid:function(a){if(l.has(a.name)){var b=l.get(a.name);void 0!==a.pos&&b.position.fromArray(a.pos);void 0!==a.quat&&b.quaternion.fromArray(a.quat)}},getBodys:function(){return q.bodys},byName:function(a){return l.get(a)},
initObject:function(){q=new F;A=new G;v=new I;x=new J;C=new K;D=new L},steps:function(){v.step();q.step(e.Ar,e.ArPos[0]);D.step(e.Ar,e.ArPos[1]);C.step(e.Ar,e.ArPos[2]);x.step(e.Ar,e.ArPos[3]);A.step(e.Ar,e.ArPos[4])},clear:function(a){q.clear();D.clear();v.clear();x.clear();C.clear();for(A.clear();0<e.extraGeo.length;)e.extraGeo.pop().dispose()},addGroup:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},add:function(a){a=a||{};var b=void 0===a.type?"box":a.type,c=b.substring(0,4);if("join"===
c)e.post("add",a);else if("soft"===c)A.add(a);else if("terrain"===b)v.add(a);else if("character"===b)C.add(a);else if("collision"===b)D.add(a);else if("car"===b)x.add(a);else return q.add(a)},defaultRoot:function(){var a={circle:new THREE.CircleBufferGeometry(1,6),plane:new THREE.PlaneBufferGeometry(1,1,1,1),box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,
16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1),hardcylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};a.circle.rotateX(-1.570796326794896);a.plane.rotateX(-1.570796326794896);a.wheel.rotateZ(-1.570796326794896);e.geo=a;e.mat={move:new THREE.MeshLambertMaterial({color:16746513,name:"move",wireframe:!1}),speed:new THREE.MeshLambertMaterial({color:16776977,name:"speed",wireframe:!1}),sleep:new THREE.MeshLambertMaterial({color:1149183,
name:"sleep",wireframe:!1}),basic:new THREE.MeshLambertMaterial({color:1118481,name:"basic",wireframe:!1}),static:new THREE.MeshLambertMaterial({color:1118719,name:"static",wireframe:!1}),kinematic:new THREE.MeshLambertMaterial({color:1179409,name:"kinematic",wireframe:!1})};e.container=new THREE.Group},getContainer:function(){return e.container}};return h.engine}();Object.defineProperty(h,"__esModule",{value:!0})});
