'use strict';var THREE,list,extensions,numDiv,data,TextDecoder,ammo,intro,UIL,esprima,CodeMirror,update,postUpdate,Ar,ArLng,ArPos,ArMax,demos,module,exports,process,define;var ARRAY8;ARRAY8||(ARRAY8="undefined"!==typeof Uint8Array?Uint8Array:Array);function Perlin(a){this.F2=0.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;a||(a=Math.random);this.p=new ARRAY8(256);this.perm=new ARRAY8(512);this.permMod12=new ARRAY8(512);for(var c=0;256>c;c++)this.p[c]=256*a();for(c=0;512>c;c++)this.perm[c]=this.p[c&255],this.permMod12[c]=this.perm[c]%12}
Perlin.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),noise:function(a,c){var b=this.permMod12,f=this.perm,e=this.grad3,k=0,h=0,l=0,n=(a+c)*this.F2,p=Math.floor(a+n),x=Math.floor(c+n),n=(p+x)*this.G2,s=a-(p-n),B=c-(x-n),D,d;s>B?(D=1,d=0):(D=0,d=1);var A=s-D+this.G2,C=B-d+this.G2,n=s-1+2*this.G2,q=B-1+2*this.G2,p=p&255,x=x&255,m=0.5-s*s-B*B;0<=m&&(k=3*b[p+f[x]],m*=m,k=m*m*(e[k]*s+e[k+1]*B));s=0.5-A*A-C*C;0<=s&&(h=3*b[p+D+f[x+
d]],s*=s,h=s*s*(e[h]*A+e[h+1]*C));A=0.5-n*n-q*q;0<=A&&(b=3*b[p+1+f[x+1]],A*=A,l=A*A*(e[b]*n+e[b+1]*q));return 70*(k+h+l)}};var TWEEN=TWEEN||function(){var a=[];return{getAll:function(){return a},removeAll:function(){a=[]},add:function(c){a.push(c)},remove:function(c){c=a.indexOf(c);-1!==c&&a.splice(c,1)},update:function(c,b){if(0===a.length)return!1;var f=0;for(c=void 0!==c?c:TWEEN.now();f<a.length;)a[f].update(c)||b?f++:a.splice(f,1);return!0}}}();
TWEEN.now="undefined"===typeof window&&"undefined"!==typeof process?function(){var a=process.hrtime();return 1E3*a[0]+a[1]/1E6}:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now.bind(window.performance):void 0!==Date.now?Date.now:function(){return(new Date).getTime()};
TWEEN.Tween=function(a){var c={},b={},f={},e=1E3,k=0,h,l=!1,n=!1,p=0,x=null,s=TWEEN.Easing.Linear.None,B=TWEEN.Interpolation.Linear,D=[],d=null,A=!1,C=null,q=null,m=null;this.to=function(a,d){b=a;void 0!==d&&(e=d);return this};this.start=function(d){TWEEN.add(this);n=!0;A=!1;x=void 0!==d?d:TWEEN.now();x+=p;for(var e in b){if(b[e]instanceof Array){if(0===b[e].length)continue;b[e]=[a[e]].concat(b[e])}void 0!==a[e]&&(c[e]=a[e],!1===c[e]instanceof Array&&(c[e]*=1),f[e]=c[e]||0)}return this};this.stop=
function(){if(!n)return this;TWEEN.remove(this);n=!1;null!==m&&m.call(a,a);this.stopChainedTweens();return this};this.end=function(){this.update(x+e);return this};this.stopChainedTweens=function(){for(var a=0,b=D.length;a<b;a++)D[a].stop()};this.delay=function(a){p=a;return this};this.repeat=function(a){k=a;return this};this.repeatDelay=function(a){h=a;return this};this.yoyo=function(a){l=a;return this};this.easing=function(a){s=a;return this};this.interpolation=function(a){B=a;return this};this.chain=
function(){D=arguments;return this};this.onStart=function(a){d=a;return this};this.onUpdate=function(a){C=a;return this};this.onComplete=function(a){q=a;return this};this.onStop=function(a){m=a;return this};this.update=function(m){var n,u,v;if(m<x)return!0;!1===A&&(null!==d&&d.call(a,a),A=!0);u=(m-x)/e;u=1<u?1:u;v=s(u);for(n in b)if(void 0!==c[n]){var w=c[n]||0,y=b[n];y instanceof Array?a[n]=B(y,v):("string"===typeof y&&(y="+"===y.charAt(0)||"-"===y.charAt(0)?w+parseFloat(y):parseFloat(y)),"number"===
typeof y&&(a[n]=w+(y-w)*v))}null!==C&&C.call(a,v);if(1===u)if(0<k){isFinite(k)&&k--;for(n in f)"string"===typeof b[n]&&(f[n]+=parseFloat(b[n])),l&&(u=f[n],f[n]=b[n],b[n]=u),c[n]=f[n];x=void 0!==h?m+h:m+p}else{null!==q&&q.call(a,a);m=0;for(n=D.length;m<n;m++)D[m].start(x+e);return!1}return!0}};
TWEEN.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?0.5*a*a:-0.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a:-0.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*
a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return 0.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?0.5*Math.pow(1024,a-1):0.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-
Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){return 0===a?0:1===a?1:-Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI)},Out:function(a){return 0===a?0:1===a?1:Math.pow(2,-10*a)*Math.sin(5*(a-0.1)*Math.PI)+1},InOut:function(a){if(0===a)return 0;if(1===a)return 1;a*=2;return 1>a?-0.5*Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI):0.5*Math.pow(2,-10*(a-1))*Math.sin(5*
(a-1.1)*Math.PI)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*(3.5949095*a-2.5949095):0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-TWEEN.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},InOut:function(a){return 0.5>a?0.5*TWEEN.Easing.Bounce.In(2*
a):0.5*TWEEN.Easing.Bounce.Out(2*a-1)+0.5}}};
TWEEN.Interpolation={Linear:function(a,c){var b=a.length-1,f=b*c,e=Math.floor(f),k=TWEEN.Interpolation.Utils.Linear;return 0>c?k(a[0],a[1],f):1<c?k(a[b],a[b-1],b-f):k(a[e],a[e+1>b?b:e+1],f-e)},Bezier:function(a,c){for(var b=0,f=a.length-1,e=Math.pow,k=TWEEN.Interpolation.Utils.Bernstein,h=0;h<=f;h++)b+=e(1-c,f-h)*e(c,h)*a[h]*k(f,h);return b},CatmullRom:function(a,c){var b=a.length-1,f=b*c,e=Math.floor(f),k=TWEEN.Interpolation.Utils.CatmullRom;return a[0]===a[b]?(0>c&&(e=Math.floor(f=b*(1+c))),k(a[(e-
1+b)%b],a[e],a[(e+1)%b],a[(e+2)%b],f-e)):0>c?a[0]-(k(a[0],a[0],a[1],a[1],-f)-a[0]):1<c?a[b]-(k(a[b],a[b],a[b-1],a[b-1],f-b)-a[b]):k(a[e?e-1:0],a[e],a[b<e+1?b:e+1],a[b<e+2?b:e+2],f-e)},Utils:{Linear:function(a,c,b){return(c-a)*b+a},Bernstein:function(a,c){var b=TWEEN.Interpolation.Utils.Factorial;return b(a)/b(c)/b(a-c)},Factorial:function(){var a=[1];return function(c){var b=1;if(a[c])return a[c];for(var f=c;1<f;f--)b*=f;return a[c]=b}}(),CatmullRom:function(a,c,b,f,e){a=0.5*(b-a);f=0.5*(f-c);var k=
e*e;return(2*c-2*b+a+f)*e*k+(-3*c+3*b-2*a-f)*k+a*e+c}}};(function(a){"function"===typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!==typeof module&&"object"===typeof exports?module.exports=TWEEN:void 0!==a&&(a.TWEEN=TWEEN)})(this);THREE.OrbitControls=function(a,c){function b(){return Math.pow(0.95,d.zoomSpeed)}function f(a){d.object instanceof THREE.PerspectiveCamera?w/=a:d.object instanceof THREE.OrthographicCamera?(d.object.zoom=Math.max(d.minZoom,Math.min(d.maxZoom,d.object.zoom*a)),d.object.updateProjectionMatrix(),F=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),d.enableZoom=!1)}function e(a){d.object instanceof THREE.PerspectiveCamera?w*=a:d.object instanceof THREE.OrthographicCamera?
(d.object.zoom=Math.max(d.minZoom,Math.min(d.maxZoom,d.object.zoom/a)),d.object.updateProjectionMatrix(),F=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),d.enableZoom=!1)}function k(a){if(!1!==d.enabled){a.preventDefault();if(a.button===d.mouseButtons.ORBIT){if(!1===d.enableRotate)return;H.set(a.clientX,a.clientY);r=m.ROTATE}else if(a.button===d.mouseButtons.ZOOM){if(!1===d.enableZoom)return;O.set(a.clientX,a.clientY);r=m.DOLLY}else if(a.button===
d.mouseButtons.PAN){if(!1===d.enablePan)return;E.set(a.clientX,a.clientY);r=m.PAN}r!==m.NONE&&(document.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",l,!1),d.dispatchEvent(C))}}function h(a){!1!==d.enabled&&(a.preventDefault(),r===m.ROTATE?!1!==d.enableRotate&&(z.set(a.clientX,a.clientY),R.subVectors(z,H),a=d.domElement===document?d.domElement.body:d.domElement,v.theta-=2*Math.PI*R.x/a.clientWidth*d.rotateSpeed,v.phi-=2*Math.PI*R.y/a.clientHeight*d.rotateSpeed,H.copy(z),d.update()):
r===m.DOLLY?!1!==d.enableZoom&&(J.set(a.clientX,a.clientY),N.subVectors(J,O),0<N.y?f(b()):0>N.y&&e(b()),O.copy(J),d.update()):r===m.PAN&&!1!==d.enablePan&&(K.set(a.clientX,a.clientY),L.subVectors(K,E),P(L.x,L.y),E.copy(K),d.update()))}function l(a){!1!==d.enabled&&(document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",l,!1),d.dispatchEvent(q),r=m.NONE)}function n(a){!1===d.enabled||!1===d.enableZoom||r!==m.NONE&&r!==m.ROTATE||(a.preventDefault(),a.stopPropagation(),
0>a.deltaY?e(b()):0<a.deltaY&&f(b()),d.update(),d.dispatchEvent(C),d.dispatchEvent(q))}function p(a){if(!1!==d.enabled&&!1!==d.enableKeys&&!1!==d.enablePan)switch(a.keyCode){case d.keys.UP:P(0,d.keyPanSpeed);d.update();break;case d.keys.BOTTOM:P(0,-d.keyPanSpeed);d.update();break;case d.keys.LEFT:P(d.keyPanSpeed,0);d.update();break;case d.keys.RIGHT:P(-d.keyPanSpeed,0),d.update()}}function x(a){if(!1!==d.enabled){switch(a.touches.length){case 1:if(!1===d.enableRotate)return;H.set(a.touches[0].pageX,
a.touches[0].pageY);r=m.TOUCH_ROTATE;break;case 2:if(!1===d.enableZoom)return;var b=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;b=Math.sqrt(b*b+a*a);O.set(0,b);r=m.TOUCH_DOLLY;break;case 3:if(!1===d.enablePan)return;E.set(a.touches[0].pageX,a.touches[0].pageY);r=m.TOUCH_PAN;break;default:r=m.NONE}r!==m.NONE&&d.dispatchEvent(C)}}function s(a){if(!1!==d.enabled)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:if(!1===d.enableRotate)break;if(r!==
m.TOUCH_ROTATE)break;z.set(a.touches[0].pageX,a.touches[0].pageY);R.subVectors(z,H);var c=d.domElement===document?d.domElement.body:d.domElement;v.theta-=2*Math.PI*R.x/c.clientWidth*d.rotateSpeed;v.phi-=2*Math.PI*R.y/c.clientHeight*d.rotateSpeed;H.copy(z);d.update();break;case 2:if(!1===d.enableZoom)break;if(r!==m.TOUCH_DOLLY)break;c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;c=Math.sqrt(c*c+a*a);J.set(0,c);N.subVectors(J,O);0<N.y?e(b()):0>N.y&&f(b());O.copy(J);
d.update();break;case 3:if(!1===d.enablePan)break;if(r!==m.TOUCH_PAN)break;K.set(a.touches[0].pageX,a.touches[0].pageY);L.subVectors(K,E);P(L.x,L.y);E.copy(K);d.update();break;default:r=m.NONE}}function B(a){!1!==d.enabled&&(d.dispatchEvent(q),r=m.NONE)}function D(a){a.preventDefault()}this.object=a;this.domElement=void 0!==c?c:document;this.enabled=!0;this.target=new THREE.Vector3;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.minPolarAngle=0;this.maxPolarAngle=
Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=!1;this.dampingFactor=0.25;this.enableZoom=!0;this.zoomSpeed=1;this.enableRotate=!0;this.rotateSpeed=1;this.enablePan=!0;this.keyPanSpeed=7;this.autoRotate=!1;this.autoRotateSpeed=2;this.enableKeys=!0;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=
this.object.zoom;this.getPolarAngle=function(){return u.phi};this.getAzimuthalAngle=function(){return u.theta};this.reset=function(){d.target.copy(d.target0);d.object.position.copy(d.position0);d.object.zoom=d.zoom0;d.object.updateProjectionMatrix();d.dispatchEvent(A);d.update();r=m.NONE};this.update=function(){var b=new THREE.Vector3,c=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),e=c.clone().inverse(),f=new THREE.Vector3,k=new THREE.Quaternion;return function(){var a=
d.object.position;b.copy(a).sub(d.target);b.applyQuaternion(c);u.setFromVector3(b);d.autoRotate&&r===m.NONE&&(v.theta-=2*Math.PI/60/60*d.autoRotateSpeed);u.theta+=v.theta;u.phi+=v.phi;u.theta=Math.max(d.minAzimuthAngle,Math.min(d.maxAzimuthAngle,u.theta));u.phi=Math.max(d.minPolarAngle,Math.min(d.maxPolarAngle,u.phi));u.makeSafe();u.radius*=w;u.radius=Math.max(d.minDistance,Math.min(d.maxDistance,u.radius));d.target.add(y);b.setFromSpherical(u);b.applyQuaternion(e);a.copy(d.target).add(b);d.object.lookAt(d.target);
!0===d.enableDamping?(v.theta*=1-d.dampingFactor,v.phi*=1-d.dampingFactor):v.set(0,0,0);w=1;y.set(0,0,0);return F||f.distanceToSquared(d.object.position)>G||8*(1-k.dot(d.object.quaternion))>G?(d.dispatchEvent(A),f.copy(d.object.position),k.copy(d.object.quaternion),F=!1,!0):!1}}();this.dispose=function(){d.domElement.removeEventListener("contextmenu",D,!1);d.domElement.removeEventListener("mousedown",k,!1);d.domElement.removeEventListener("wheel",n,!1);d.domElement.removeEventListener("touchstart",
x,!1);d.domElement.removeEventListener("touchend",B,!1);d.domElement.removeEventListener("touchmove",s,!1);document.removeEventListener("mousemove",h,!1);document.removeEventListener("mouseup",l,!1);window.removeEventListener("keydown",p,!1)};var d=this,A={type:"change"},C={type:"start"},q={type:"end"},m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},r=m.NONE,G=1E-6,u=new THREE.Spherical,v=new THREE.Spherical,w=1,y=new THREE.Vector3,F=!1,H=new THREE.Vector2,z=new THREE.Vector2,
R=new THREE.Vector2,E=new THREE.Vector2,K=new THREE.Vector2,L=new THREE.Vector2,O=new THREE.Vector2,J=new THREE.Vector2,N=new THREE.Vector2,U=function(){var a=new THREE.Vector3;return function(b,d){a.setFromMatrixColumn(d,0);a.multiplyScalar(-b);y.add(a)}}(),V=function(){var a=new THREE.Vector3;return function(b,d){a.setFromMatrixColumn(d,1);a.multiplyScalar(b);y.add(a)}}(),P=function(){var a=new THREE.Vector3;return function(b,c){var e=d.domElement===document?d.domElement.body:d.domElement;if(d.object instanceof
THREE.PerspectiveCamera){a.copy(d.object.position).sub(d.target);var f=a.length(),f=f*Math.tan(d.object.fov/2*Math.PI/180);U(2*b*f/e.clientHeight,d.object.matrix);V(2*c*f/e.clientHeight,d.object.matrix)}else d.object instanceof THREE.OrthographicCamera?(U(b*(d.object.right-d.object.left)/d.object.zoom/e.clientWidth,d.object.matrix),V(c*(d.object.top-d.object.bottom)/d.object.zoom/e.clientHeight,d.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),
d.enablePan=!1)}}();d.domElement.addEventListener("contextmenu",D,!1);d.domElement.addEventListener("mousedown",k,!1);d.domElement.addEventListener("wheel",n,!1);d.domElement.addEventListener("touchstart",x,!1);d.domElement.addEventListener("touchend",B,!1);d.domElement.addEventListener("touchmove",s,!1);window.addEventListener("keydown",p,!1);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;
Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){console.warn("THREE.OrbitControls: .center has been renamed to .target");return this.target}},noZoom:{get:function(){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");return!this.enableZoom},set:function(a){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");this.enableZoom=!a}},noRotate:{get:function(){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");
return!this.enableRotate},set:function(a){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");this.enableRotate=!a}},noPan:{get:function(){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");return!this.enablePan},set:function(a){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");this.enablePan=!a}},noKeys:{get:function(){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");
return!this.enableKeys},set:function(a){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");this.enableKeys=!a}},staticMoving:{get:function(){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");return!this.enableDamping},set:function(a){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");this.enableDamping=!a}},dynamicDampingFactor:{get:function(){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");
return this.dampingFactor},set:function(a){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");this.dampingFactor=a}}});THREE.CapsuleBufferGeometry=function(a,c,b,f){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var e=a||1;c=c||1;var k=b||12,h=0.5*~~k;a=f||1;var l=2*Math.PI,n=0.5*Math.PI;f=new THREE.Geometry;a=new THREE.CylinderGeometry(e,e,c,k,a,!0);var p=new THREE.SphereGeometry(e,k,h,0,l,0,n),e=new THREE.SphereGeometry(e,k,h,0,l,n,n),k=(new THREE.Matrix4).makeTranslation(0,0,0);6===b&&k.makeRotationY(0.5235987755982988);b=(new THREE.Matrix4).makeTranslation(0,0.5*c,0);c=(new THREE.Matrix4).makeTranslation(0,
0.5*-c,0);f.merge(a,k);f.merge(p,b);f.merge(e,c);f.mergeVertices();this.fromGeometry(f)};THREE.CapsuleBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CapsuleBufferGeometry.prototype.constructor=THREE.CapsuleBufferGeometry;THREE.ConvexGeometry=function(a){function c(b){var c=a[b].clone(),e=c.length();c.x+=2E-6*e*(Math.random()-0.5);c.y+=2E-6*e*(Math.random()-0.5);c.z+=2E-6*e*(Math.random()-0.5);for(var e=[],k=0;k<f.length;){var h=f[k],d=c,l=a[h[0]],n;n=l;var q=a[h[1]],m=a[h[2]],r=new THREE.Vector3,G=new THREE.Vector3;r.subVectors(m,q);G.subVectors(n,q);r.cross(G);r.normalize();n=r;l=n.dot(l);if(n.dot(d)>=l){for(d=0;3>d;d++){l=[h[d],h[(d+1)%3]];n=!0;for(q=0;q<e.length;q++)if(m=e[q],m[0]===l[1]&&m[1]===l[0]){e[q]=e[e.length-
1];e.pop();n=!1;break}n&&e.push(l)}f[k]=f[f.length-1];f.pop()}else k++}for(q=0;q<e.length;q++)f.push([e[q][0],e[q][1],b])}function b(a){var b=a.length();return new THREE.Vector2(a.x/b,a.y/b)}THREE.Geometry.call(this);for(var f=[[0,1,2],[0,2,1]],e=3;e<a.length;e++)c(e);for(var k=0,h=Array(a.length),e=0;e<f.length;e++)for(var l=f[e],n=0;3>n;n++)void 0===h[l[n]]&&(h[l[n]]=k++,this.vertices.push(a[l[n]])),l[n]=h[l[n]];for(e=0;e<f.length;e++)this.faces.push(new THREE.Face3(f[e][0],f[e][1],f[e][2]));for(e=
0;e<this.faces.length;e++)l=this.faces[e],this.faceVertexUvs[0].push([b(this.vertices[l.a]),b(this.vertices[l.b]),b(this.vertices[l.c])]);this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry.prototype.constructor=THREE.ConvexGeometry;THREE.Tubex=function(a,c,b,f,e,k){THREE.BufferGeometry.call(this);this.type="Tubex";this.tubularSegments=c||64;this.radius=b||1;this.radialSegments=f||8;this.closed=e||!1;if(a instanceof Array)this.positions=a;else{this.positions=[];c=(new THREE.Vector3).fromArray(a.start);b=(new THREE.Vector3).fromArray(a.end);f=b.clone().sub(c);a=a.numSegment-1;this.positions.push(c);for(e=1;e<a;e++)this.positions.push((new THREE.Vector3(f.x/a*e,f.y/a*e,f.z/a*e)).add(c));this.positions.push(b)}this.path=new THREE.CatmullRomCurve3(this.positions);
this.path.type=k||"catmullrom";this.path.closed=this.closed;this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.vertex=new THREE.Vector3;this.normal=new THREE.Vector3;this.uv=new THREE.Vector2;this.vertices=[];this.colors=[];this.normals=[];this.uvs=[];this.indices=[];this.generateBufferData();this.setIndex(new (65535<this.indices.length?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(this.indices,1));this.addAttribute("position",new THREE.Float32BufferAttribute(this.vertices,
3));this.addAttribute("color",new THREE.Float32BufferAttribute(this.colors,3));this.addAttribute("normal",new THREE.Float32BufferAttribute(this.normals,3));this.addAttribute("uv",new THREE.Float32BufferAttribute(this.uvs,2))};THREE.Tubex.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.Tubex.prototype.constructor=THREE.Tubex;
THREE.Tubex.prototype.generateBufferData=function(){for(var a=0;a<this.tubularSegments;a++)this.generateSegment(a);this.generateSegment(!1===this.closed?this.tubularSegments:0);this.generateIndicesAndUv()};
THREE.Tubex.prototype.generateSegment=function(a){var c=this.path.getPointAt(a/this.tubularSegments),b=this.frames.normals[a];a=this.frames.binormals[a];for(var f=0;f<=this.radialSegments;f++){var e=f/this.radialSegments*Math.PI*2,k=Math.sin(e),e=-Math.cos(e);this.normal.x=e*b.x+k*a.x;this.normal.y=e*b.y+k*a.y;this.normal.z=e*b.z+k*a.z;this.normal.normalize();this.normals.push(this.normal.x,this.normal.y,this.normal.z);this.vertex.x=c.x+this.radius*this.normal.x;this.vertex.y=c.y+this.radius*this.normal.y;
this.vertex.z=c.z+this.radius*this.normal.z;this.vertices.push(this.vertex.x,this.vertex.y,this.vertex.z);this.colors.push(1,1,1)}};
THREE.Tubex.prototype.generateIndicesAndUv=function(){for(var a=0;a<=this.tubularSegments;a++)for(var c=0;c<=this.radialSegments;c++){if(0<c&&0<a){var b=(this.radialSegments+1)*a+(c-1),f=(this.radialSegments+1)*a+c,e=(this.radialSegments+1)*(a-1)+c;this.indices.push((this.radialSegments+1)*(a-1)+(c-1),b,e);this.indices.push(b,f,e)}this.uv.x=a/this.tubularSegments;this.uv.y=c/this.radialSegments;this.uvs.push(this.uv.x,this.uv.y)}};
THREE.Tubex.prototype.updatePath=function(a){this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.normals=this.attributes.normal.array;this.vertices=this.attributes.position.array;this.colors=this.attributes.color.array;for(a=0;a<this.tubularSegments;a++)this.updateSegment(a);this.updateSegment(!1===this.closed?this.tubularSegments:0);this.attributes.color.needsUpdate=!0;this.attributes.position.needsUpdate=!0;this.attributes.normal.needsUpdate=!0;this.computeBoundingSphere()};
THREE.Tubex.prototype.updateUV=function(){this.uvs=this.attributes.uv.array;for(var a,c,b=0;b<=this.tubularSegments;b++){a=2*b*(this.radialSegments+1);for(var f=0;f<=this.radialSegments;f++)c=2*f,this.uv.x=b/this.tubularSegments,this.uv.y=f/this.radialSegments,this.uvs[a+c]=this.uv.x,this.uvs[a+c+1]=this.uv.y}this.attributes.uv.needsUpdate=!0};
THREE.Tubex.prototype.updateSegment=function(a){for(var c=3*a*(this.radialSegments+1),b=this.path.getPointAt(a/this.tubularSegments),f=this.frames.normals[a],e=this.frames.binormals[a],k=0;k<=this.radialSegments;k++){var h=k/this.radialSegments*Math.PI*2;a=3*k;var l=Math.sin(h),h=-Math.cos(h);this.normal.x=h*f.x+l*e.x;this.normal.y=h*f.y+l*e.y;this.normal.z=h*f.z+l*e.z;this.normal.normalize();this.normals[c+a]=this.normal.x;this.normals[c+a+1]=this.normal.y;this.normals[c+a+2]=this.normal.z;this.vertices[c+
a]=b.x+this.radius*this.normal.x;this.vertices[c+a+1]=b.y+this.radius*this.normal.y;this.vertices[c+a+2]=b.z+this.radius*this.normal.z;this.colors[c+a]=Math.abs(this.normal.x);this.colors[c+a+1]=Math.abs(this.normal.y);this.colors[c+a+2]=Math.abs(this.normal.z)}};THREE.ShaderShadow={uniforms:Object.assign({},THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(15658734)},specular:{value:new THREE.Color(1118481)},emissive:{value:new THREE.Color(0)},opacity:{value:0.4}}),fragmentShader:["uniform float opacity;\nvarying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.packing,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.shadowmask_pars_fragment,"void main() {\n   float mask = getShadowMask();\n   vec4 pp = vec4(1.0);\n   vec4 mapping = vec4( pp.rgb, pp.a * opacity );\n   vec4 shadowing = vec4( vec3(0.0), opacity * (1.0 - mask) );\n   gl_FragColor = mix( mapping, shadowing, 1.0 - mask );\n   gl_FragColor = shadowing;\n}"].join("\n"),
vertexShader:["varying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvUv = uv;\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),lights:!0,transparent:!0,depthWrite:!1};THREE.CarHelper=function(a,c,b){b=0.6*-b;this.py=a[1]-c[1];a=new Float32Array([-0.2,0,0,0.2,0,0,0,0,0,0,0.4,0,0,0,-0.2,0,0,0.2,a[0]-b,this.py,a[2],a[0]-b,this.py+1,a[2],-a[0]+b,this.py,a[2],-a[0]+b,this.py+1,a[2],-a[0]+b,this.py,-a[2],-a[0]+b,this.py+1,-a[2],a[0]-b,this.py,-a[2],a[0]-b,this.py+1,-a[2],a[0]-b,this.py,a[2],-a[0]+b,this.py,a[2],a[0]-b,this.py,-a[2],-a[0]+b,this.py,-a[2]]);c=new Float32Array([1,1,0,1,1,0,1,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,
1,0,1,1,0,1,1,0]);this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(a,3));this.geometry.addAttribute("color",new THREE.BufferAttribute(c,3));this.positions=this.geometry.attributes.position.array;this.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,name:"helper"});THREE.LineSegments.call(this,this.geometry,this.material)};THREE.CarHelper.prototype=Object.create(THREE.LineSegments.prototype);
THREE.CarHelper.prototype.constructor=THREE.CarHelper;THREE.CarHelper.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.CarHelper.prototype.updateSuspension=function(a,c,b,f){this.positions[22]=this.py-a;this.positions[28]=this.py-c;this.positions[34]=this.py-b;this.positions[40]=this.py-f;this.geometry.attributes.position.needsUpdate=!0};THREE.Terrain=function(a,c){a=void 0==a?{}:a;this.div=void 0==a.div?[64,64]:a.div;this.size=void 0==a.size?[100,10,100]:a.size;this.colorBase={r:1,g:0.7,b:0};this.complexity=void 0==a.complexity?30:a.complexity;this.complexity2=void 0==a.complexity2?60:a.complexity2;this.local=new THREE.Vector3;a.local&&this.local.fromArray(a.local);this.lng=this.div[0]*this.div[1];this.hdata=new Float32Array(this.lng);this.perlin=void 0==c?new Perlin:c;this.colors=new Float32Array(3*this.lng);this.geometry=new THREE.PlaneBufferGeometry(this.size[0],
this.size[2],this.div[0]-1,this.div[1]-1);this.geometry.rotateX(0.5*-Math.PI);this.geometry.computeBoundingSphere();this.geometry.addAttribute("color",new THREE.BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.material=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,name:"terrain",metalness:1,roughness:0.3,wireframe:!1});this.update();THREE.Mesh.call(this,this.geometry,this.material);this.castShadow=!1;this.receiveShadow=!0};
THREE.Terrain.prototype=Object.create(THREE.Mesh.prototype);THREE.Terrain.prototype.constructor=THREE.Terrain;THREE.Terrain.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.Terrain.prototype.setEnvMap=function(a){this.material.envMap=a};THREE.Terrain.prototype.move=function(){this.update()};THREE.Terrain.prototype.clamp=function(a,c,b){a=a<c?c:a;return a>b?b:a};THREE.Terrain.prototype.norm=function(a,c,b){return(a-c)/(b-c)};
THREE.Terrain.prototype.linear=function(a,c,b){return(1-a)*c+a*b};THREE.Terrain.prototype.cubicSCurve=function(a){return a*a*(3-2*a)};THREE.Terrain.prototype.quinticSCurve=function(a){var c=a*a*a,b=c*a;return 6*b*a-15*b+10*c};
THREE.Terrain.prototype.update=function(){for(var a=1/this.complexity,c=1/this.complexity2,b=1/this.div[0],f=(this.div[0]-1)/this.size[0],e=(this.div[1]-1)/this.size[2],k=this.lng,h,l,n,p;k--;)h=3*k,l=k%this.div[0],n=~~(k*b),p=0.5+0.5*this.perlin.noise((l+this.local.x*f)*a,(n+this.local.z*e)*a),l=0.5+0.5*this.perlin.noise((l+100+this.local.x*f)*c,(n+100+this.local.z*e)*c),p=Math.min(p,l),p=this.linear(p,0,0.7),p=this.quinticSCurve(p),this.hdata[k]=p*this.size[1],this.vertices[h+1]=this.hdata[k],this.colors[h]=
p*this.colorBase.r,this.colors[h+1]=p*this.colorBase.g,this.colors[h+2]=p*this.colorBase.b;this.geometry.attributes.position.needsUpdate=!0;this.geometry.attributes.color.needsUpdate=!0;this.geometry.computeVertexNormals()};THREE.ViewUtils={mergeGeometryArray:function(a){for(var c=[],b=a.length;b--;)c[b]=(new THREE.Geometry).fromBufferGeometry(a[b]);for(a=new THREE.Geometry;0<c.length;)b=c.pop(),a.merge(b),b.dispose();a.mergeVertices();c=(new THREE.BufferGeometry).fromGeometry(a);a.dispose();return c},prepaGeometry:function(a,c){var b=!1,f=!1;"mesh"==c&&(f=!0);"convex"==c&&(b=!0);var e,k,h,l=(new THREE.Geometry).fromBufferGeometry(a);l.mergeVertices();var n=a.attributes.position.array.length/3,p=l.vertices.length,x=
l.faces.length;a.realVertices=new Float32Array(3*p);a.realIndices=new (65535<3*x?Uint32Array:Uint16Array)(3*x);for(e=p;e--;)h=l.vertices[e],k=3*e,a.realVertices[k]=h.x,a.realVertices[k+1]=h.y,a.realVertices[k+2]=h.z;if(b)return l.dispose(),a.realVertices;for(e=x;e--;)h=l.faces[e],k=3*e,a.realIndices[k]=h.a,a.realIndices[k+1]=h.b,a.realIndices[k+2]=h.c;l.dispose();if(f){n=[];for(e=a.realIndices.length;e--;)k=3*e,h=3*a.realIndices[e],n[k]=a.realVertices[h],n[k+1]=a.realVertices[h+1],n[k+2]=a.realVertices[h+
2];return n}f=[];l=a.attributes.position.array;for(e=p;e--;)for(k=3*e,f[e]=[],b=n;b--;)h=3*b,l[h]==a.realVertices[k]&&l[h+1]==a.realVertices[k+1]&&l[h+2]==a.realVertices[k+2]&&f[e].push(b);var l=new (65535<p?Uint32Array:Uint16Array)(p),s=new (65535<n?Uint32Array:Uint16Array)(n);for(e=h=0;e<p;e++){k=f[e].length;l[e]=h;for(b=k;b--;)s[h+b]=f[e][b];h+=k}a.numFaces=x;a.numVertices=p;a.maxi=n;a.pPoint=l;a.lPoint=s}};var user=function(){var a=new Float32Array(20),c;user={init:function(b){c=new user.Gamepad(a);document.addEventListener("keydown",user.keyDown,!1);document.addEventListener("keyup",user.keyUp,!1)},update:function(a){c.update();c.ready&&c.getValue(0)},keyDown:function(b){if(!editor.getFocus()){b=b||window.event;switch(b.which){case 65:case 81:a[0]=-1;break;case 68:a[0]=1;break;case 87:case 90:a[1]=-1;break;case 83:a[1]=1;break;case 37:a[2]=-1;break;case 39:a[2]=1;break;case 38:a[3]=-1;break;case 40:a[3]=
1;break;case 17:case 67:a[5]=1;break;case 69:a[5]=1;break;case 32:a[4]=1;break;case 16:a[7]=1;break;case 71:view.hideGrid()}c.reset()}},keyUp:function(b){if(!editor.getFocus())switch(b=b||window.event,b.which){case 65:case 81:a[0]=0>a[0]?0:a[0];break;case 68:a[0]=0<a[0]?0:a[0];break;case 87:case 90:a[1]=0>a[1]?0:a[1];break;case 83:a[1]=0<a[1]?0:a[1];break;case 37:a[2]=0>a[2]?0:a[2];break;case 39:a[2]=0<a[2]?0:a[2];break;case 38:a[3]=0>a[3]?0:a[3];break;case 40:a[3]=0<a[3]?0:a[3];break;case 17:case 67:a[5]=
0;break;case 69:a[5]=0;break;case 32:a[4]=0;break;case 16:a[7]=0}},getKey:function(){return a},Gamepad:function(a){this.values=[];this.key=a;this.ready=0}};user.Gamepad.prototype={update:function(){var a,c,e,k,h,l,n=this.fix,p=navigator.getGamepads();for(a=0;a<p.length;a++)if(l=p[a])if(e=l.axes.length,k=l.buttons.length){this.values[a]||(this.values[a]=[]);for(c=0;c<e;c++)h=n(l.axes[c],0.08),0==this.ready&&0!==h&&(this.ready=1),this.values[a][c]=h;for(c=0;c<k;c++)h=n(l.buttons[c].value),0==this.ready&&
0!==h&&(this.ready=1),this.values[a][e+c]=h}else this.values[a]&&(this.values[a]=null)},getValue:function(a){for(var c=19,e;c--;)e=this.values[a][c],0==this.ready&&0!==e&&(this.ready=1),this.key[c]=e},reset:function(){this.ready=0},fix:function(a,c){var e=Number(a.toString().substring(0,5));c&&e<c&&e>-c&&(e=0);return e}};return user}();var gui=function(){var a;return gui={init:function(){a=document.createElement("div");document.body.appendChild(a)},initJoysticks:function(){UIL.add("joystick",{target:a,pos:{left:"auto",right:"100px",top:"auto",bottom:"10px"},name:"JOY",width:100,multiplicator:1,precision:2,fontColor:"#D4B87B"})}}}();var now;(function(a){var c,b=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var f=0;f<b.length;++f){var e=b[f];if(a.performance[e]){c=function(){return a.performance[e]()};break}}c||(c=Date.now);now=c})(window);var editor=function(){var a,c,b,f,e,k,h,l=function(){},n=function(){},p=!1,x=!1,s=[],B=[],D=null,d=0,A=0,C="",q,m=[],r,G=!1,u=!0,v=!1,w,y;return editor={init:function(F,m,r){F&&(l=F);m&&(n=m);u=r||!1;q=document.createElement("div");q.className="bigmenu";document.body.appendChild(q);this.makeBigMenu();F=document.createElement("div");F.style.cssText="position:absolute; right:0; top:0; width:1px; height:1px; pointer-events:none;";F.innerHTML="<svg width='80' height='80' viewBox='0 0 250 250' style='fill:rgba(255,255,255,0.2); color:#2B2A2D; position: absolute; top: 0; border: 0; right: 0;'>\n<path d='M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z' id='octo' onmouseover='editor.Gover();' onmouseout='editor.Gout();' onmousedown='editor.Gdown();'></path>\n<path d='M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2' fill='currentColor' style='transform-origin: 130px 106px;' id='octo-arm'></path>\n<path d='M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z' fill='currentColor' id='octo-body'></path></svg>";
document.body.appendChild(F);w=document.getElementById("octo");y=document.getElementById("octo-arm");k=document.createElement("div");k.className="debug";document.body.appendChild(k);h=document.createElement("div");h.className="title";document.body.appendChild(h);a=document.createElement("div");a.className="editor";document.body.appendChild(a);c=document.createElement("div");c.className="codeContent";a.appendChild(c);b=CodeMirror(c,{lineNumbers:!0,matchBrackets:!0,indentWithTabs:!1,styleActiveLine:!0,
theme:"monokai",mode:"text/javascript",tabSize:4,indentUnit:4,highlightSelectionMatches:{showToken:/\w/}});f=document.createElement("div");f.className="separator";document.body.appendChild(f);e=document.createElement("div");e.className="menuCode";a.appendChild(e);a.style.display="none";f.style.display="none";b.on("change",function(){editor.onChange()});b.on("focus",function(){x=!0;view.needFocus()});b.on("blur",function(){x=!1});b.on("drop",function(){p?p=!1:b.setValue("")});b.on("dragstart",function(){p=
!0});u&&(d=~~(0.4*window.innerWidth),a.style.display="block",f.style.display="block",this.addSeparatorEvent(),this.resize());q.style.width=window.innerWidth-d+"px"},addSeparatorEvent:function(){f.addEventListener("mouseover",editor.mid_over,!1);f.addEventListener("mouseout",editor.mid_out,!1);f.addEventListener("mousedown",editor.mid_down,!1)},removeSeparatorEvent:function(){f.removeEventListener("mouseover",editor.mid_over,!1);f.removeEventListener("mouseout",editor.mid_out,!1);f.removeEventListener("mousedown",
editor.mid_down,!1)},selectCode:function(){u?editor.hide():editor.show()},hide:function(){u=!1;a.style.display="none";f.style.display="none";A=d;d=0;this.removeSeparatorEvent();editor.Bdefault(m[1]);editor.resize()},show:function(){u=!0;a.style.display="block";f.style.display="block";d=A?A:~~(0.4*window.innerWidth);this.addSeparatorEvent();editor.resize()},resizeMenu:function(a){q&&(q.style.width=a+"px")},resize:function(c){c&&(d=c.clientX+10);view&&(view.setLeft(d),view.resize());q.style.left=d+
"px";h.style.left=d+"px";k.style.left=d+"px";f.style.left=d-10+"px";a.style.width=d-10+"px";b.refresh()},tell:function(a){k.textContent=a},makeBigMenu:function(){q.style.width=window.innerWidth-d+"px";m[0]=document.createElement("div");m[0].className="bigButton";q.appendChild(m[0]);m[0].innerHTML="DEMO";m[0].addEventListener("mousedown",editor.selectBigMenu,!1);m[0].name="demo";m[1]=document.createElement("div");m[1].className="bigButton";q.appendChild(m[1]);m[1].innerHTML="CODE";m[1].addEventListener("mousedown",
editor.selectCode,!1);m[1].name="code";r=document.createElement("div");r.className="bigContent";q.appendChild(r);for(var a=m.length;a--;)m[a].addEventListener("mouseover",editor.Bover,!1),m[a].addEventListener("mouseout",editor.Bout,!1)},selectBigMenu:function(a){G?editor.hideBigMenu():editor.showBigMenu()},showBigMenu:function(a){q.style.background="#252525";q.style.borderBottom="1px solid #3f3f3f";G=!0;a=demos.length;for(var b,c=0;c<a;c++)b=demos[c],b!==C&&editor.addButtonBig(demos[c])},hideBigMenu:function(a){q.style.background=
"rgba(0,0,0,0)";q.style.borderBottom="1px solid rgba(255, 255, 255, 0)";G=!1;a=r.childNodes.length;for(var b;a--;)b=r.childNodes[a],b.removeEventListener("mousedown",editor.bigDown),r.removeChild(b);editor.Bdefault(m[0])},addButtonBig:function(a){var b=document.createElement("div");b.className="menuButtonBig";r.appendChild(b);b.innerHTML="&bull; "+a.charAt(0).toUpperCase()+a.substring(1).toLowerCase();b.name=a;b.addEventListener("mousedown",editor.bigDown,!1)},bigDown:function(a){editor.hideBigMenu();
editor.load("demos/"+a.target.name+".js")},Bover:function(a){a.target.style.border="1px solid #3998d6";a.target.style.background="#3998d6";a.target.style.color="#FFFFFF"},Bout:function(a){var b=0;"code"==a.target.name&&u&&(b=1);"demo"==a.target.name&&G&&(b=1);b?(a.target.style.border="1px solid #3f3f3f",a.target.style.background="#3f3f3f",a.target.style.color="#999999"):editor.Bdefault(a.target)},Bdefault:function(a){a.style.border="1px solid #3f3f3f";a.style.background="#252525";a.style.color="#3998d6"},
Gover:function(){w.setAttribute("fill","#3998d6");y.style.webkitAnimationName="octocat-wave";y.style.webkitAnimationDuration="560ms"},Gout:function(){w.setAttribute("fill","rgba(255,255,255,0.2)");y.style.webkitAnimationName="none"},Gdown:function(){window.location.assign("https://github.com/lo-th/Ammo.lab")},mid_over:function(){f.style.background="#5f5f5f"},mid_out:function(){v||(f.style.background="none")},mid_down:function(){v=!0;document.addEventListener("mouseup",editor.mid_up,!1);document.addEventListener("mousemove",
editor.resize,!1)},mid_up:function(){v=!1;document.removeEventListener("mouseup",editor.mid_up,!1);document.removeEventListener("mousemove",editor.resize,!1)},load:function(a){C=a.substring(a.indexOf("/")+1,a.indexOf("."));var c=new XMLHttpRequest;c.overrideMimeType("text/plain; charset=x-user-defined");c.open("GET",a,!0);c.onload=function(){b.setValue(c.responseText)};c.send()},unFocus:function(){b.getInputField().blur();view.haveFocus()},refresh:function(){b.refresh()},getFocus:function(){return x},
validate:function(a){return b.operation(function(){for(;0<s.length;)b.removeLineClass(s.shift(),"background","errorLine");for(var c=B.length;c--;)b.removeLineWidget(B[c]);B.length=0;try{for(var d=esprima.parse(a,{tolerant:!0}).errors,c=d.length;c--;){var e=d[c],f=document.createElement("div");f.className="esprima-error";f.textContent=e.message.replace(/Line [0-9]+: /,"");var k=e.lineNumber-1;s.push(k);b.addLineClass(k,"background","errorLine");var h=b.addLineWidget(k,f);B.push(h)}}catch(l){f=document.createElement("div"),
f.className="esprima-error",f.textContent=l.message.replace(/Line [0-9]+: /,""),k=l.lineNumber-1,s.push(k),b.addLineClass(k,"background","errorLine"),h=b.addLineWidget(k,f),B.push(h)}return 0===s.length})},onChange:function(){var a=!0;location.hash.substr(1)===C&&(a=!1);n(a);clearTimeout(D);var c=b.getValue();this.validate(c)&&(D=setTimeout(function(){editor.inject(c)},0))},inject:function(a){location.hash=C;var c=document.createElement("script");c.language="javascript";c.type="text/javascript";c.text=
a;document.getElementsByTagName("BODY").item(0).appendChild(c);e.innerHTML="&bull; "+C;h.innerHTML=C.charAt(0).toUpperCase()+C.substring(1).toLowerCase();l(C)}}}();Math.torad=0.017453292519943295;Math.todeg=57.29577951308232;Math.degtorad=0.017453292519943295;Math.radtodeg=57.29577951308232;Math.Pi=3.141592653589793;Math.TwoPI=6.283185307179586;Math.PI90=1.570796326794896;Math.PI270=4.712388980384689;Math.lerp=function(a,c,b){return a+(c-a)*b};Math.rand=function(a,c){return Math.lerp(a,c,Math.random())};Math.randInt=function(a,c,b){return 1*Math.lerp(a,c,Math.random()).toFixed(b||0)};Math.int=function(a){return~~a};
var view=function(){var a,c=0,b=0,f=0,e=0,k,h,l,n,p,x,s,B,D,d,A,C=!1,q=1,m=1,r=0,G,u={heros:1,cars:2,bodys:3,solids:4,terrains:5,softs:6,joints:7},v=[],w=[],y=[],F=[],H=[],z=[],R=[],E=[],K={},L=!1,O=!1,J=null,N,U=0,V=0,P=0,ba=0,M,t,T=[],ca=null,da={},ea,Y=!1,I,S,fa,$=-0.01,Z=null,ga,Q=1,W=!0,aa="wireframe ceramic plastic smooth metal chrome brush black glow red sky".split(" "),X;return view={render:function(){requestAnimationFrame(a.render);TWEEN.update();THREE.SEA3D.AnimationHandler.update(0.017);
update();L&&(a.heroStep(Ar,ArPos[0]),a.carsStep(Ar,ArPos[1]),a.bodyStep(Ar,ArPos[2]),a.softStep(Ar,ArPos[3]),a.controlUpdate(),L=!1);postUpdate();h.render(l,n);c=now();c-1E3>b&&(b=c,e=f,f=0);f++},needUpdate:function(a){L=a},needCrowdUpdate:function(){},reset:function(){L=!1;postUpdate=function(){};update=function(){};this.removeRay();this.resetCamera();this.setShadowPosY(-0.01);G.visible=!0;for(var a,c;0<y.length;)l.remove(y.pop());for(;0<F.length;)l.remove(F.pop());for(;0<H.length;)l.remove(H.pop());
for(;0<z.length;)l.remove(z.pop());for(;0<v.length;)l.remove(v.pop());for(;0<E.length;)E.pop().dispose();for(;0<w.length;){a=w.pop();a.userData.helper&&(a.remove(a.userData.helper),a.userData.helper.dispose());for(c=a.userData.w.length;c--;)l.remove(a.userData.w[c]);l.remove(a)}Z=null;K={}},init:function(g){k=document.createElement("canvas");k.className="canvas3d";k.oncontextmenu=function(a){a.preventDefault()};k.ondrop=function(a){a.preventDefault()};document.body.appendChild(k);a=this;try{h=new THREE.WebGLRenderer({canvas:k,
antialias:!0,alpha:!1})}catch(c){null!==intro&&intro.message("<p>Sorry, your browser does not support WebGL.</p><p>This application uses WebGL to quickly draw AMMO Physics.</p><p>AMMO Physics can be used without WebGL, but unfortunately this application cannot.</p><p>Have a great day!</p>");return}null!==intro&&intro.clear();h.setClearColor(2434341,1);h.setPixelRatio(window.devicePixelRatio);h.gammaInput=!0;h.gammaOutput=!0;h.toneMapping=THREE.Uncharted2ToneMapping;h.toneMappingExposure=3;h.toneMappingWhitePoint=
5;l=new THREE.Scene;B=new THREE.Group;l.add(B);n=new THREE.PerspectiveCamera(60,1,1,1E3);n.position.set(0,0,30);p=new THREE.OrbitControls(n,k);p.target.set(0,0,0);p.enableKeys=!1;p.update();N=new THREE.Group;l.add(N);N.add(n);this.addLights();ea=new THREE.TextureLoader;x=new THREE.Raycaster;s=new THREE.Vector2;M={box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,0.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,
16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};M.wheel.rotateZ(-Math.PI90);t={terrain:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"terrain",wireframe:!0}),cloth:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"cloth",wireframe:!0,transparent:!0,opacity:0.9,side:THREE.DoubleSide}),ball:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"ball",wireframe:!0}),statique:new THREE.MeshBasicMaterial({color:3355545,
name:"statique",wireframe:!0,transparent:!0,opacity:0.6}),move:new THREE.MeshBasicMaterial({color:10066329,name:"move",wireframe:!0}),movehigh:new THREE.MeshBasicMaterial({color:16751001,name:"movehigh",wireframe:!0}),sleep:new THREE.MeshBasicMaterial({color:10066431,name:"sleep",wireframe:!0}),debug:new THREE.MeshBasicMaterial({color:1179409,name:"debug",wireframe:!0,opacity:0.1,transparent:!0}),hero:new THREE.MeshBasicMaterial({color:10040217,name:"hero",wireframe:!0}),cars:new THREE.MeshBasicMaterial({color:16777215,
name:"cars",wireframe:!0,transparent:!0,side:THREE.DoubleSide}),tmp1:new THREE.MeshBasicMaterial({color:16777215,name:"tmp1",wireframe:!0,transparent:!0}),tmp2:new THREE.MeshBasicMaterial({color:16777215,name:"tmp2",wireframe:!0,transparent:!0}),meca1:new THREE.MeshBasicMaterial({color:16777215,name:"meca1",wireframe:!0}),meca2:new THREE.MeshBasicMaterial({color:16777215,name:"meca2",wireframe:!0}),meca3:new THREE.MeshBasicMaterial({color:16777215,name:"meca3",wireframe:!0}),drone:new THREE.MeshBasicMaterial({color:16777215,
name:"drone",wireframe:!0}),pig:new THREE.MeshBasicMaterial({color:13870992,name:"pig",wireframe:!0,transparent:!1}),avatar:new THREE.MeshBasicMaterial({color:13870992,name:"avatar",wireframe:!0,transparent:!1}),both:new THREE.MeshBasicMaterial({color:16777215,name:"both",wireframe:!0,side:THREE.DoubleSide}),back:new THREE.MeshBasicMaterial({color:16777215,name:"back",wireframe:!0,side:THREE.BackSide})};G=new THREE.GridHelper(50,20,16777215,3355443);G.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,
transparent:!0,opacity:0.1});l.add(G);this.resize();this.initEnv();window.addEventListener("resize",a.resize,!1);this.render();this.load("basic",g)},addLights:function(){S=new THREE.DirectionalLight(16777215,1);S.position.set(-3,50,5);S.lookAt(new THREE.Vector3);l.add(S);fa=new THREE.AmbientLight(4473924);l.add(fa)},resize:function(){m=window.innerHeight;q=window.innerWidth-r;k.style.left=r+"px";n.aspect=q/m;n.updateProjectionMatrix();h.setSize(q,m);editor&&editor.resizeMenu(q)},setLeft:function(a){r=
a},getFps:function(){return e},getInfo:function(){return h.info.programs.length},addMap:function(a,c){var b=ea.load("./assets/textures/"+a);b.flipY=!1;t[c].map=b},getGeo:function(){return M},getMat:function(){return t},getScene:function(){return l},removeRay:function(){C&&(C=!1,k.removeEventListener("mousemove",a.rayTest,!1),d=null,B.remove(A),l.remove(D))},activeRay:function(g){C=!0;var c=new THREE.PlaneBufferGeometry(100,100);c.rotateX(-Math.PI90);A=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:16777215,
transparent:!0,opacity:0}));B.add(A);D=new THREE.Mesh(M.box,new THREE.MeshBasicMaterial({color:16711680}));l.add(D);k.addEventListener("mousemove",a.rayTest,!1);d=g},rayTest:function(a){s.x=(a.clientX-r)/q*2-1;s.y=2*-(a.clientY/m)+1;x.setFromCamera(s,n);a=x.intersectObjects(B.children,!0);a.length&&(D.position.copy(a[0].point),d(D))},changeMaterial:function(a){var c,b,d;0===a?(W=!0,b="MeshBasicMaterial",this.removeShadow()):(W=!1,b="MeshStandardMaterial",this.addShadow());for(d in t)c=t[d],a=c.name,
"debug"!==a&&(t[a]=new THREE[b]({name:a,envMap:null,map:c.map||null,vertexColors:c.vertexColors||!1,color:void 0===c.color?16777215:c.color.getHex(),wireframe:W,transparent:c.transparent||!1,opacity:c.opacity||1,side:c.side||THREE.FrontSide}),W||(t[a].envMap=X,t[a].metalness=0.8,t[a].roughness=0.2),c.dispose());for(d=y.length;d--;)a=y[d].material.name,y[d].material=t[a];for(d=F.length;d--;)a=F[d].material.name,F[d].material=t[a];for(d=w.length;d--;){if(void 0==w[d].material)for(c=w[d].children.length;c--;)a=
w[d].children[c].material.name,"helper"!==a&&(w[d].children[c].material=t[a]);else a=w[d].material.name,w[d].material=t[a];for(c=w[d].userData.w.length;c--;)a=w[d].userData.w[c].material.name,w[d].userData.w[c].material=t[a]}for(d=H.length;d--;)a=H[d].material.name,H[d].material=t[a];for(d=z.length;d--;)2!==z.softType&&(a=z[d].material.name,z[d].material=t[a])},needFocus:function(){k.addEventListener("mouseover",editor.unFocus,!1)},haveFocus:function(){k.removeEventListener("mouseover",editor.unFocus,
!1)},initEnv:function(){var a=document.createElement("div");a.className="env";var c=document.createElement("canvas");c.width=c.height=64;a.appendChild(c);document.body.appendChild(a);ga=c.getContext("2d");a.onclick=this.loadEnv;a.oncontextmenu=this.loadEnv;this.loadEnv()},loadEnv:function(g){var c=0;g&&(g.preventDefault(),c=g.button,0===c?Q++:Q--,Q==aa.length&&(Q=0),0>Q&&(Q=aa.length-1));var b=new Image;b.onload=function(){ga.drawImage(b,0,0,64,64);X=new THREE.Texture(b);X.mapping=THREE.SphericalReflectionMapping;
X.format=THREE.RGBFormat;X.needsUpdate=!0;0!==Q||W||a.changeMaterial(0);if(0!==Q)if(W)a.changeMaterial(1);else for(var g in t)t[g].envMap=X};b.src="./assets/textures/spherical/"+aa[Q]+".jpg"},hideGrid:function(){G.visible=G.visible?!1:!0},load:function(g,c){"string"==typeof g||g instanceof String?T.push(g):T=T.concat(g);ca=c||function(){};a.load_sea(T[0])},load_next:function(){T.shift();0===T.length?ca():a.load_sea(T[0])},load_sea:function(g){var c=new THREE.SEA3D;c.onComplete=function(b){da[g]=c.meshes;
b=c.geometries.length;for(var d;b--;)d=c.geometries[b],M[d.name]=d;a.load_next()};c.load("./assets/models/"+g+".sea")},getResult:function(){return da},mergeMesh:function(a){return THREE.ViewUtils.mergeGeometryArray(a)},prepaGeometry:function(a,c){return THREE.ViewUtils.prepaGeometry(a,c)},controlUpdate:function(){if(O&&null!==J){var a,c,b=J;a=b.userData.type;var d=b.userData.speed;c=-70*Math.torad;if("car"===a){if(10>d&&-10<d){this.setControle(!0);return}this.setControle(!1)}"hero"===a&&(this.setControle(!0),
U=p.getAzimuthalAngle()+Math.Pi,V=-p.getPolarAngle(),V!==ba&&(c=ba=V),U!==P&&(P=U,ammo.send("heroRotation",{id:b.userData.id,angle:U})));d=new THREE.Matrix4;d.extractRotation(b.matrix);a=new THREE.Vector3(0,0,1);a.applyMatrix4(d);b=b.position;a=Math.atan2(a.x,a.z);this.autoCamera(a,c,10,0.3,b)}},setFollow:function(a){J=this.getByName(a);null!==J&&(O=!0)},setTarget:function(a){p.target.copy(a);p.update()},autoCamera:function(a,c,b,d,e){d=d||1;n.position.lerp(this.orbit(a,c,b),d);e&&this.setTarget(e)},
moveCamera:function(a,c,b,d){a=this.orbit((a+180)*Math.torad,(c-90)*Math.torad,b);(new TWEEN.Tween(n.position)).to({x:a.x,y:a.y,z:a.z},400).easing(TWEEN.Easing.Quadratic.Out).start();(new TWEEN.Tween(p.target)).to({x:d[0],y:d[1],z:d[2]},400).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){p.update()}).start()},orbit:function(a,c,b){var d=new THREE.Vector3;d.x=b*Math.sin(c)*Math.sin(a);d.y=b*Math.cos(c);d.z=b*Math.sin(c)*Math.cos(a);a=new THREE.Vector3;a.copy(p.target).add(d);return a},setControle:function(a){p.enableRotate!==
a&&(p.enableRotate=a,p.enableZoom=a,p.enablePan=a)},resetCamera:function(){a.setControle(!0);J=null},setDriveCar:function(a){ammo.send("setDriveCar",{n:this.getByName(a).userData.id})},toRad:function(a){for(var c=a.length;c--;)a[c]*=Math.torad;return a},add:function(g){var c=!1;g.mass=void 0==g.mass?0:g.mass;g.type=void 0==g.type?"box":g.type;g.pos=void 0==g.pos?[0,0,0]:g.pos;g.size=void 0==g.size?[1,1,1]:g.size;1==g.size.length&&(g.size[1]=g.size[0]);2==g.size.length&&(g.size[2]=g.size[0]);g.geoSize&&
(1==g.geoSize.length&&(g.geoSize[1]=g.geoSize[0]),2==g.geoSize.length&&(g.geoSize[2]=g.geoSize[0]));g.rot=void 0==g.rot?[0,0,0]:this.toRad(g.rot);g.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(g.rot)).toArray();g.rotA&&(g.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(g.rotA))).toArray());g.rotB&&(g.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(g.rotB))).toArray());g.angUpper&&(g.angUpper=this.toRad(g.angUpper));
g.angLower&&(g.angLower=this.toRad(g.angLower));var b=null;if("joint"===g.type.substring(0,5))ammo.send("add",g);else if("plane"===g.type)G.position.set(g.pos[0],g.pos[1],g.pos[2]),ammo.send("add",g);else if("softTriMesh"===g.type)this.softTriMesh(g);else if("softConvex"===g.type)this.softConvex(g);else if("cloth"===g.type)this.cloth(g);else if("rope"===g.type)this.rope(g);else if("ellipsoid"===g.type)this.ellipsoid(g);else if("terrain"===g.type)this.terrain(g);else{b=void 0!==g.material?t[g.material]:
g.mass?t.move:t.statique;if("capsule"===g.type)c=new THREE.CapsuleBufferGeometry(g.size[0],0.5*g.size[1]),b=new THREE.Mesh(c,b),E.push(b.geometry),c=!0;else if("mesh"===g.type||"convex"===g.type)g.shape&&(g.v=a.prepaGeometry(g.shape,g.type),E.push(g.shape)),g.geometry?(b=new THREE.Mesh(g.geometry,b),E.push(g.geometry)):b=new THREE.Mesh(g.shape,b);else{if(g.geometry){if(g.geoRot||g.geoScale)g.geometry=g.geometry.clone();g.geoRot&&g.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(this.toRad(g.geoRot))));
g.geoScale&&g.geometry.applyMatrix((new THREE.Matrix4).makeScale(g.geoScale[0],g.geoScale[1],g.geoScale[2]))}b=0===g.mass&&"box"===g.type?new THREE.Mesh(g.geometry||M.hardbox,b):new THREE.Mesh(g.geometry||M[g.type],b);g.geometry&&(E.push(g.geometry),g.geoSize&&b.scale.fromArray(g.geoSize),!g.geoSize&&g.size&&b.scale.fromArray(g.size),c=!0)}b&&(c||b.scale.fromArray(g.size),b.position.fromArray(g.pos),b.quaternion.fromArray(g.quat),b.receiveShadow=!0,b.castShadow=!0,void 0!==g.parent?g.parent.add(b):
l.add(b));g.shape&&delete g.shape;g.geometry&&delete g.geometry;g.material&&delete g.material;void 0===g.noPhy&&(b&&(g.mass?(b.idx=view.setIdx(y.length,"bodys"),view.setName(g,b),y.push(b)):(b.idx=view.setIdx(F.length,"solids"),view.setName(g,b),F.push(b))),ammo.send("add",g));if(b)return b}},getGeoByName:function(a,c){for(var b,d=M.length;d--;)a==M[d].name&&(b=M[d]);c&&(b=(new THREE.BufferGeometry).fromGeometry(b));return b},character:function(a){a.size=void 0==a.size?[0.25,2,2]:a.size;1==a.size.length&&
(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:this.toRad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var c=new THREE.CapsuleBufferGeometry(a.size[0],0.5*a.size[1],6),b=new THREE.Group;if(a.debug){var d=new THREE.Mesh(c,t.debug);E.push(c);b.add(d)}a.mesh?(t.hero.skinning=!0,a.mesh.material=t.hero,a.mesh.scale.multiplyScalar(a.scale||1),a.mesh.position.set(0,0,0),a.mesh.play(0),
b.add(a.mesh),b.skin=a.mesh,E.push(b.skin.geometry)):(d=new THREE.Mesh(c,t.hero),E.push(c),b.add(d));b.userData.speed=0;b.userData.type="hero";b.userData.id=v.length;b.position.fromArray(a.pos);b.quaternion.fromArray(a.quat);b.castShadow=!0;b.receiveShadow=!0;b.idx=view.setIdx(v.length,"heros");view.setName(a,b);l.add(b);v.push(b);a.mesh&&delete a.mesh;ammo.send("character",a)},vehicle:function(g){var b=g.size||[2,0.5,4],c=g.pos||[0,0,0],d=g.rot||[0,0,0],e=g.wPos||[1,0,1.6];g.masscenter=void 0==g.masscenter?
[0,0,0]:g.masscenter;this.toRad(d);if(g.mesh)for(b=g.mesh,e=b.children.length;e--;)b.children[e].position.fromArray(g.masscenter).negate(),b.children[e].castShadow=!0,b.children[e].receiveShadow=!0;else e=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(b[0],b[1],b[2])),e.translate(-g.masscenter[0],-g.masscenter[1],-g.masscenter[2]),E.push(e),b=new THREE.Mesh(e,t.move);b.position.set(c[0],c[1],c[2]);b.rotation.set(d[0],d[1],d[2]);g.quat=b.quaternion.toArray();b.castShadow=!0;b.receiveShadow=
!0;l.add(b);b.idx=view.setIdx(w.length,"cars");view.setName(g,b);b.userData.speed=0;b.userData.steering=0;b.userData.NumWheels=g.nw||4;b.userData.type="car";var c=g.radius||0.4,d=g.deep||0.3,e=g.wPos||[1,-0.25,1.6],f=[],k=void 0==g.wheel?!0:!1,h=g.wheel||M.wheel,n=h.clone();n.rotateY(Math.Pi);E.push(n);for(var m=g.nw||4;m--;)f[m]=1==m||2==m?new THREE.Mesh(h,t.move):new THREE.Mesh(n,t.move),k?f[m].scale.set(d,c,c):f[m].material=t.cars,f[m].castShadow=!0,f[m].receiveShadow=!0,l.add(f[m]);b.userData.w=
f;g.helper&&(b.userData.helper=new THREE.CarHelper(e,g.masscenter,d),b.add(b.userData.helper));w.push(b);b.userData.id=w.length-1;g.mesh&&(g.mesh=null);g.wheel&&(g.wheel=null);if("mesh"==g.type||"convex"==g.type)g.v=a.prepaGeometry(g.shape,g.type);g.shape&&delete g.shape;g.mesh&&delete g.mesh;ammo.send("vehicle",g)},softTriMesh:function(b){var c=b.shape.clone(),d=b.pos||[0,0,0],e=b.size||[1,1,1],f=b.rot||[0,0,0];c.translate(d[0],d[1],d[2]);c.scale(e[0],e[1],e[2]);c.applyMatrix((new THREE.Matrix4).makeRotationY(f[1]*=
Math.torad));a.prepaGeometry(c);E.push(c);b.v=c.realVertices;b.i=c.realIndices;b.ntri=c.numFaces;c=new THREE.Mesh(c,void 0===b.material?t.cloth:t[b.material]);c.castShadow=!0;c.receiveShadow=!0;c.softType=5;c.points=b.v.length/3;c.idx=view.setIdx(z.length,"softs");view.setName(b,c);l.add(c);z.push(c);b.shape&&delete b.shape;b.material&&delete b.material;ammo.send("add",b)},softConvex:function(b){var c=b.shape,d=b.pos||[0,0,0];c.translate(d[0],d[1],d[2]);a.prepaGeometry(c);b.v=c.realVertices;c=new THREE.Mesh(c,
t.cloth);c.castShadow=!0;c.receiveShadow=!0;c.softType=4;c.points=b.v.length/3;c.idx=view.setIdx(z.length,"softs");view.setName(b,c);l.add(c);z.push(c);ammo.send("add",b)},cloth:function(a){var b=a.div||[16,16],c=a.size||[100,0,100],d=a.pos||[0,0,0],e=b[0]*b[1],f=new THREE.PlaneBufferGeometry(c[0],c[2],b[0]-1,b[1]-1);f.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*e),3));f.rotateX(-Math.PI90);e=new THREE.Mesh(f,t.cloth);e.idx=view.setIdx(z.length,"softs");view.setName(a,e);e.position.set(d[0],
d[1],d[2]);e.castShadow=!0;e.receiveShadow=!0;e.softType=1;e.points=f.attributes.position.array.length/3;l.add(e);z.push(e);a.size=c;a.div=b;a.pos=d;ammo.send("add",a)},rope:function(a){void 0===a.numSeg&&(a.numSeg=a.numSegment);var b=new THREE.Tubex(a,a.numSeg||10,a.radius||0.2,a.numRad||6,!1),c=new THREE.Mesh(b,t.ball);c.idx=view.setIdx(z.length,"softs");this.setName(a,c);c.castShadow=!0;c.receiveShadow=!0;c.softType=2;c.points=b.positions.length;l.add(c);z.push(c);ammo.send("add",a)},ellipsoid:function(a){ammo.send("add",
a)},ellipsoidMesh:function(a){var b=a.lng,c=[],d=a.a,e,f,k,h;for(e=0;e<b;e++)h=3*e,c.push(new THREE.Vector3(d[h],d[h+1],d[h+2]));var c=new THREE.ConvexGeometry(c),n=new Uint32Array(3*c.faces.length),m=new Float32Array(3*b),p=new Float32Array(b);k=c.vertices;for(e=b;e--;)for(f=b;f--;)h=3*f,d[h]==k[e].x&&d[h+1]==k[e].y&&d[h+2]==k[e].z&&(p[f]=e);for(e=b;e--;)h=3*e,f=3*p[e],m[f]=d[h],m[f+1]=d[h+1],m[f+2]=d[h+2];for(e=c.faces.length;e--;)h=3*e,d=c.faces[e],n[h]=d.a,n[h+1]=d.b,n[h+2]=d.c;e=new THREE.BufferGeometry;
e.setIndex(new THREE.BufferAttribute(n,1));e.addAttribute("position",new THREE.BufferAttribute(m,3));e.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*b),3));e.addAttribute("order",new THREE.BufferAttribute(p,1));e.computeVertexNormals();E.push(e);c.dispose();b=new THREE.Mesh(e,t.ball);b.idx=view.setIdx(z.length,"softs");this.setName(a,b);b.softType=3;b.points=e.attributes.position.array.length/3;b.castShadow=!0;b.receiveShadow=!0;l.add(b);z.push(b)},terrain:function(a){var b,c,
d,e;a.div=void 0==a.div?[64,64]:a.div;a.size=void 0==a.size?[100,10,100]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.dpos=void 0==a.dpos?[0,0,0]:a.dpos;a.complexity=void 0==a.complexity?30:a.complexity;a.lng=a.div[0]*a.div[1];a.hdata=new Float32Array(a.lng);Z||(Z=new Perlin);var f=1/a.complexity,h=1/a.div[0],k=(a.div[0]-1)/a.size[0],n=(a.div[1]-1)/a.size[2],m=new Float32Array(3*a.lng),p=new THREE.PlaneBufferGeometry(a.size[0],a.size[2],a.div[0]-1,a.div[1]-1);p.rotateX(-Math.PI90);var q=p.attributes.position.array;
for(b=a.lng;b--;)e=3*b,c=b%a.div[0],d=~~(b*h),c=0.5+0.5*Z.noise((c+a.dpos[0]*k)*f,(d+a.dpos[2]*n)*f),a.hdata[b]=c*a.size[1],q[e+1]=a.hdata[b],m[e]=c,m[e+1]=c,m[e+2]=c;p.addAttribute("color",new THREE.BufferAttribute(m,3));p.computeBoundingSphere();p.computeVertexNormals();E.push(p);b=new THREE.Mesh(p,t.terrain);b.position.fromArray(a.pos);b.castShadow=!1;b.receiveShadow=!0;b.idx=view.setIdx(H.length,"terrains");this.setName(a,b);l.add(b);H.push(b);ammo.send("add",a);I&&l.remove(I)},moveTerrain:function(a){},
setIdx:function(a,b){return a+0.1*u[b]},getByIdx:function(a){a=a.toFixed(1);var b=parseInt(a);switch(Number(a.substring(a.lastIndexOf(".")+1))){case 1:return v[b];case 2:return w[b];case 3:return y[b];case 4:return F[b];case 5:return H[b];case 6:return z[b];case 7:return R[b]}},setName:function(a,b){void 0!==a.name&&(K[a.name]=b.idx,b.name=a.name)},getByName:function(a){return view.getByIdx(K[a])},getNameIdx:function(a){return K[a]},getBody:function(){return y},bodyStep:function(a,b){y.length&&y.forEach(function(c,
d){var e=b+8*d,f=a[e];if(0<f)"sleep"==c.material.name&&(c.material=t.move),50<f&&"move"==c.material.name?c.material=t.movehigh:50>f&&"movehigh"==c.material.name&&(c.material=t.move),c.position.fromArray(a,e+1),c.quaternion.fromArray(a,e+4);else if("move"==c.material.name||"movehigh"==c.material.name)c.material=t.sleep})},heroStep:function(a,b){v.length&&v.forEach(function(c,d){var e=b+8*d,f=3.33*a[e];c.userData.speed=100*f;c.position.fromArray(a,e+1);c.quaternion.fromArray(a,e+4);c.skin&&(0===f?c.skin.play(0,
0.3):(c.skin.play(1,0.3),c.skin.setTimeScale(f)))})},carsStep:function(a,b){w.length&&w.forEach(function(c,d){var e=b+56*d;c.userData.speed=a[e];c.position.fromArray(a,e+1);c.quaternion.fromArray(a,e+4);var f=c.userData.NumWheels,h;c.userData.helper&&4==f&&(h=40,c.userData.helper.updateSuspension(a[e+h+0],a[e+h+1],a[e+h+2],a[e+h+3]));for(;f--;)h=8*(f+1),c.userData.w[f].position.fromArray(a,e+h+1),c.userData.w[f].quaternion.fromArray(a,e+h+4)})},getSofts:function(){return z},softStep:function(a,b){if(z.length){var c=
b;z.forEach(function(b,d){var e,f,h,k,l,n,m=b.geometry,p=b.softType,q=null,r=m.attributes.color?!0:!1,t=m.attributes.normal?!0:!1;if(2===p){for(l=m.positions.length;l--;)e=c+3*l,m.positions[l].set(a[e],a[e+1],a[e+2]);m.updatePath()}else{if(!m.attributes.position)return;k=m.attributes.position.array;r&&(f=m.attributes.color.array);if(5===p||4===p){var u=m.numVertices,v=m.maxi,s=m.pPoint,w=m.lPoint;for(l=u;l--;)for(e=3*l+c,n=l==u-1?v-s[l]:s[l+1]-s[l],h=s[l];n--;)f=3*w[h+n],k[f]=a[e],k[f+1]=a[e+1],k[f+
2]=a[e+2]}else if(m.attributes.order&&(q=m.attributes.order.array),l=k.length,e=2,null!==q)for(l=q.length;l--;)n=3*q[l],e=3*l+c,k[n]=a[e],k[n+1]=a[e+1],k[n+2]=a[e+2],h=Math.abs(a[e+1]/10),f[n]=h,f[n+1]=h,f[n+2]=h;else for(;l--;)k[l]=a[l+c],1==e&&(h=Math.abs(k[l]/10),f[l-1]=h,f[l]=h,f[l+1]=h),e--,e=0>e?2:e;2!==p&&m.computeVertexNormals();if(t){e=m.attributes.normal.array;for(l=u;l--;)for(n=l==u-1?v-s[l]:s[l+1]-s[l],h=s[l],k=3*w[h];n--;)f=3*w[h+n],e[f]=e[k],e[f+1]=e[k+1],e[f+2]=e[k+2];m.attributes.normal.needsUpdate=
!0}r&&(m.attributes.color.needsUpdate=!0);m.attributes.position.needsUpdate=!0;m.computeBoundingSphere()}c+=3*b.points})}},removeShadow:function(){Y&&(Y=!1,h.shadowMap.enabled=!1,I&&l.remove(I))},hideGroundShadow:function(){I.visible=!1},setShadowPosY:function(a){$=a;I&&(I.position.y=$,I.visible=!0)},addShadow:function(){if(!Y){Y=!0;h.shadowMap.enabled=!0;h.shadowMap.soft=!0;h.shadowMap.type=THREE.PCFSoftShadowMap;h.shadowMap.renderReverseSided=!1;if(!H.length){var a=new THREE.ShaderMaterial(THREE.ShaderShadow);
I=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200,1,1),a);I.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(0.5*-Math.PI));I.position.y=$;I.castShadow=!1;I.receiveShadow=!0;l.add(I)}S.castShadow=!0;a=new THREE.OrthographicCamera(70,-70,70,-70,25,170);S.shadow=new THREE.LightShadow(a);S.shadow.mapSize.width=1024;S.shadow.mapSize.height=1024}}}}();
