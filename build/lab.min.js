'use strict';var THREE,list,extensions,numDiv,data,TextDecoder,ammo,intro,UIL,esprima,CodeMirror,update,postUpdate,Ar,ArLng,ArPos,ArMax,demos,module,exports,process,define;var ARRAY8;ARRAY8||(ARRAY8="undefined"!==typeof Uint8Array?Uint8Array:Array);function Perlin(a){this.F2=0.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;a||(a=Math.random);this.p=new ARRAY8(256);this.perm=new ARRAY8(512);this.permMod12=new ARRAY8(512);for(var b=0;256>b;b++)this.p[b]=256*a();for(b=0;512>b;b++)this.perm[b]=this.p[b&255],this.permMod12[b]=this.perm[b]%12}
Perlin.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),noise:function(a,b){var c=this.permMod12,f=this.perm,d=this.grad3,g=0,h=0,l=0,n=(a+b)*this.F2,p=Math.floor(a+n),v=Math.floor(b+n),n=(p+v)*this.G2,s=a-(p-n),C=b-(v-n),w,e;s>C?(w=1,e=0):(w=0,e=1);var A=s-w+this.G2,y=C-e+this.G2,n=s-1+2*this.G2,q=C-1+2*this.G2,p=p&255,v=v&255,m=0.5-s*s-C*C;0<=m&&(g=3*c[p+f[v]],m*=m,g=m*m*(d[g]*s+d[g+1]*C));s=0.5-A*A-y*y;0<=s&&(h=3*c[p+w+f[v+
e]],s*=s,h=s*s*(d[h]*A+d[h+1]*y));A=0.5-n*n-q*q;0<=A&&(c=3*c[p+1+f[v+1]],A*=A,l=A*A*(d[c]*n+d[c+1]*q));return 70*(g+h+l)}};var TWEEN=TWEEN||function(){var a=[];return{getAll:function(){return a},removeAll:function(){a=[]},add:function(b){a.push(b)},remove:function(b){b=a.indexOf(b);-1!==b&&a.splice(b,1)},update:function(b,c){if(0===a.length)return!1;var f=0;for(b=void 0!==b?b:TWEEN.now();f<a.length;)a[f].update(b)||c?f++:a.splice(f,1);return!0}}}();
TWEEN.now="undefined"===typeof window&&"undefined"!==typeof process?function(){var a=process.hrtime();return 1E3*a[0]+a[1]/1E6}:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now.bind(window.performance):void 0!==Date.now?Date.now:function(){return(new Date).getTime()};
TWEEN.Tween=function(a){var b={},c={},f={},d=1E3,g=0,h,l=!1,n=!1,p=0,v=null,s=TWEEN.Easing.Linear.None,C=TWEEN.Interpolation.Linear,w=[],e=null,A=!1,y=null,q=null,m=null;this.to=function(a,b){c=a;void 0!==b&&(d=b);return this};this.start=function(e){TWEEN.add(this);n=!0;A=!1;v=void 0!==e?e:TWEEN.now();v+=p;for(var d in c){if(c[d]instanceof Array){if(0===c[d].length)continue;c[d]=[a[d]].concat(c[d])}void 0!==a[d]&&(b[d]=a[d],!1===b[d]instanceof Array&&(b[d]*=1),f[d]=b[d]||0)}return this};this.stop=
function(){if(!n)return this;TWEEN.remove(this);n=!1;null!==m&&m.call(a,a);this.stopChainedTweens();return this};this.end=function(){this.update(v+d);return this};this.stopChainedTweens=function(){for(var a=0,c=w.length;a<c;a++)w[a].stop()};this.delay=function(a){p=a;return this};this.repeat=function(a){g=a;return this};this.repeatDelay=function(a){h=a;return this};this.yoyo=function(a){l=a;return this};this.easing=function(a){s=a;return this};this.interpolation=function(a){C=a;return this};this.chain=
function(){w=arguments;return this};this.onStart=function(a){e=a;return this};this.onUpdate=function(a){y=a;return this};this.onComplete=function(a){q=a;return this};this.onStop=function(a){m=a;return this};this.update=function(n){var m,r,x;if(n<v)return!0;!1===A&&(null!==e&&e.call(a,a),A=!0);r=(n-v)/d;r=1<r?1:r;x=s(r);for(m in c)if(void 0!==b[m]){var B=b[m]||0,z=c[m];z instanceof Array?a[m]=C(z,x):("string"===typeof z&&(z="+"===z.charAt(0)||"-"===z.charAt(0)?B+parseFloat(z):parseFloat(z)),"number"===
typeof z&&(a[m]=B+(z-B)*x))}null!==y&&y.call(a,x);if(1===r)if(0<g){isFinite(g)&&g--;for(m in f)"string"===typeof c[m]&&(f[m]+=parseFloat(c[m])),l&&(r=f[m],f[m]=c[m],c[m]=r),b[m]=f[m];v=void 0!==h?n+h:n+p}else{null!==q&&q.call(a,a);n=0;for(m=w.length;n<m;n++)w[n].start(v+d);return!1}return!0}};
TWEEN.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?0.5*a*a:-0.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a:-0.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*
a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return 0.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?0.5*Math.pow(1024,a-1):0.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-
Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){return 0===a?0:1===a?1:-Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI)},Out:function(a){return 0===a?0:1===a?1:Math.pow(2,-10*a)*Math.sin(5*(a-0.1)*Math.PI)+1},InOut:function(a){if(0===a)return 0;if(1===a)return 1;a*=2;return 1>a?-0.5*Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI):0.5*Math.pow(2,-10*(a-1))*Math.sin(5*
(a-1.1)*Math.PI)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*(3.5949095*a-2.5949095):0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-TWEEN.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},InOut:function(a){return 0.5>a?0.5*TWEEN.Easing.Bounce.In(2*
a):0.5*TWEEN.Easing.Bounce.Out(2*a-1)+0.5}}};
TWEEN.Interpolation={Linear:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),g=TWEEN.Interpolation.Utils.Linear;return 0>b?g(a[0],a[1],f):1<b?g(a[c],a[c-1],c-f):g(a[d],a[d+1>c?c:d+1],f-d)},Bezier:function(a,b){for(var c=0,f=a.length-1,d=Math.pow,g=TWEEN.Interpolation.Utils.Bernstein,h=0;h<=f;h++)c+=d(1-b,f-h)*d(b,h)*a[h]*g(f,h);return c},CatmullRom:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),g=TWEEN.Interpolation.Utils.CatmullRom;return a[0]===a[c]?(0>b&&(d=Math.floor(f=c*(1+b))),g(a[(d-
1+c)%c],a[d],a[(d+1)%c],a[(d+2)%c],f-d)):0>b?a[0]-(g(a[0],a[0],a[1],a[1],-f)-a[0]):1<b?a[c]-(g(a[c],a[c],a[c-1],a[c-1],f-c)-a[c]):g(a[d?d-1:0],a[d],a[c<d+1?c:d+1],a[c<d+2?c:d+2],f-d)},Utils:{Linear:function(a,b,c){return(b-a)*c+a},Bernstein:function(a,b){var c=TWEEN.Interpolation.Utils.Factorial;return c(a)/c(b)/c(a-b)},Factorial:function(){var a=[1];return function(b){var c=1;if(a[b])return a[b];for(var f=b;1<f;f--)c*=f;return a[b]=c}}(),CatmullRom:function(a,b,c,f,d){a=0.5*(c-a);f=0.5*(f-b);var g=
d*d;return(2*b-2*c+a+f)*d*g+(-3*b+3*c-2*a-f)*g+a*d+b}}};(function(a){"function"===typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!==typeof module&&"object"===typeof exports?module.exports=TWEEN:void 0!==a&&(a.TWEEN=TWEEN)})(this);THREE.OrbitControls=function(a,b){function c(){return Math.pow(0.95,e.zoomSpeed)}function f(a){e.object instanceof THREE.PerspectiveCamera?B/=a:e.object instanceof THREE.OrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*a)),e.object.updateProjectionMatrix(),D=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function d(a){e.object instanceof THREE.PerspectiveCamera?B*=a:e.object instanceof THREE.OrthographicCamera?
(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/a)),e.object.updateProjectionMatrix(),D=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function g(a){if(!1!==e.enabled){a.preventDefault();if(a.button===e.mouseButtons.ORBIT){if(!1===e.enableRotate)return;I.set(a.clientX,a.clientY);t=m.ROTATE}else if(a.button===e.mouseButtons.ZOOM){if(!1===e.enableZoom)return;M.set(a.clientX,a.clientY);t=m.DOLLY}else if(a.button===
e.mouseButtons.PAN){if(!1===e.enablePan)return;K.set(a.clientX,a.clientY);t=m.PAN}t!==m.NONE&&(document.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",l,!1),e.dispatchEvent(y))}}function h(a){!1!==e.enabled&&(a.preventDefault(),t===m.ROTATE?!1!==e.enableRotate&&(E.set(a.clientX,a.clientY),N.subVectors(E,I),a=e.domElement===document?e.domElement.body:e.domElement,x.theta-=2*Math.PI*N.x/a.clientWidth*e.rotateSpeed,x.phi-=2*Math.PI*N.y/a.clientHeight*e.rotateSpeed,I.copy(E),e.update()):
t===m.DOLLY?!1!==e.enableZoom&&(L.set(a.clientX,a.clientY),O.subVectors(L,M),0<O.y?f(c()):0>O.y&&d(c()),M.copy(L),e.update()):t===m.PAN&&!1!==e.enablePan&&(P.set(a.clientX,a.clientY),J.subVectors(P,K),G(J.x,J.y),K.copy(P),e.update()))}function l(a){!1!==e.enabled&&(document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",l,!1),e.dispatchEvent(q),t=m.NONE)}function n(a){!1===e.enabled||!1===e.enableZoom||t!==m.NONE&&t!==m.ROTATE||(a.preventDefault(),a.stopPropagation(),
0>a.deltaY?d(c()):0<a.deltaY&&f(c()),e.update(),e.dispatchEvent(y),e.dispatchEvent(q))}function p(a){if(!1!==e.enabled&&!1!==e.enableKeys&&!1!==e.enablePan)switch(a.keyCode){case e.keys.UP:G(0,e.keyPanSpeed);e.update();break;case e.keys.BOTTOM:G(0,-e.keyPanSpeed);e.update();break;case e.keys.LEFT:G(e.keyPanSpeed,0);e.update();break;case e.keys.RIGHT:G(-e.keyPanSpeed,0),e.update()}}function v(a){if(!1!==e.enabled){switch(a.touches.length){case 1:if(!1===e.enableRotate)return;I.set(a.touches[0].pageX,
a.touches[0].pageY);t=m.TOUCH_ROTATE;break;case 2:if(!1===e.enableZoom)return;var c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;c=Math.sqrt(c*c+a*a);M.set(0,c);t=m.TOUCH_DOLLY;break;case 3:if(!1===e.enablePan)return;K.set(a.touches[0].pageX,a.touches[0].pageY);t=m.TOUCH_PAN;break;default:t=m.NONE}t!==m.NONE&&e.dispatchEvent(y)}}function s(a){if(!1!==e.enabled)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:if(!1===e.enableRotate)break;if(t!==
m.TOUCH_ROTATE)break;E.set(a.touches[0].pageX,a.touches[0].pageY);N.subVectors(E,I);var b=e.domElement===document?e.domElement.body:e.domElement;x.theta-=2*Math.PI*N.x/b.clientWidth*e.rotateSpeed;x.phi-=2*Math.PI*N.y/b.clientHeight*e.rotateSpeed;I.copy(E);e.update();break;case 2:if(!1===e.enableZoom)break;if(t!==m.TOUCH_DOLLY)break;b=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;b=Math.sqrt(b*b+a*a);L.set(0,b);O.subVectors(L,M);0<O.y?d(c()):0>O.y&&f(c());M.copy(L);
e.update();break;case 3:if(!1===e.enablePan)break;if(t!==m.TOUCH_PAN)break;P.set(a.touches[0].pageX,a.touches[0].pageY);J.subVectors(P,K);G(J.x,J.y);K.copy(P);e.update();break;default:t=m.NONE}}function C(a){!1!==e.enabled&&(e.dispatchEvent(q),t=m.NONE)}function w(a){a.preventDefault()}this.object=a;this.domElement=void 0!==b?b:document;this.enabled=!0;this.target=new THREE.Vector3;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.minPolarAngle=0;this.maxPolarAngle=
Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=!1;this.dampingFactor=0.25;this.enableZoom=!0;this.zoomSpeed=1;this.enableRotate=!0;this.rotateSpeed=1;this.enablePan=!0;this.keyPanSpeed=7;this.autoRotate=!1;this.autoRotateSpeed=2;this.enableKeys=!0;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=
this.object.zoom;this.getPolarAngle=function(){return r.phi};this.getAzimuthalAngle=function(){return r.theta};this.reset=function(){e.target.copy(e.target0);e.object.position.copy(e.position0);e.object.zoom=e.zoom0;e.object.updateProjectionMatrix();e.dispatchEvent(A);e.update();t=m.NONE};this.update=function(){var c=new THREE.Vector3,b=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),d=b.clone().inverse(),f=new THREE.Vector3,g=new THREE.Quaternion;return function(){var a=
e.object.position;c.copy(a).sub(e.target);c.applyQuaternion(b);r.setFromVector3(c);e.autoRotate&&t===m.NONE&&(x.theta-=2*Math.PI/60/60*e.autoRotateSpeed);r.theta+=x.theta;r.phi+=x.phi;r.theta=Math.max(e.minAzimuthAngle,Math.min(e.maxAzimuthAngle,r.theta));r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi));r.makeSafe();r.radius*=B;r.radius=Math.max(e.minDistance,Math.min(e.maxDistance,r.radius));e.target.add(z);c.setFromSpherical(r);c.applyQuaternion(d);a.copy(e.target).add(c);e.object.lookAt(e.target);
!0===e.enableDamping?(x.theta*=1-e.dampingFactor,x.phi*=1-e.dampingFactor):x.set(0,0,0);B=1;z.set(0,0,0);return D||f.distanceToSquared(e.object.position)>F||8*(1-g.dot(e.object.quaternion))>F?(e.dispatchEvent(A),f.copy(e.object.position),g.copy(e.object.quaternion),D=!1,!0):!1}}();this.dispose=function(){e.domElement.removeEventListener("contextmenu",w,!1);e.domElement.removeEventListener("mousedown",g,!1);e.domElement.removeEventListener("wheel",n,!1);e.domElement.removeEventListener("touchstart",
v,!1);e.domElement.removeEventListener("touchend",C,!1);e.domElement.removeEventListener("touchmove",s,!1);document.removeEventListener("mousemove",h,!1);document.removeEventListener("mouseup",l,!1);window.removeEventListener("keydown",p,!1)};var e=this,A={type:"change"},y={type:"start"},q={type:"end"},m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},t=m.NONE,F=1E-6,r=new THREE.Spherical,x=new THREE.Spherical,B=1,z=new THREE.Vector3,D=!1,I=new THREE.Vector2,E=new THREE.Vector2,
N=new THREE.Vector2,K=new THREE.Vector2,P=new THREE.Vector2,J=new THREE.Vector2,M=new THREE.Vector2,L=new THREE.Vector2,O=new THREE.Vector2,V=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,0);a.multiplyScalar(-c);z.add(a)}}(),W=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,1);a.multiplyScalar(c);z.add(a)}}(),G=function(){var a=new THREE.Vector3;return function(c,b){var d=e.domElement===document?e.domElement.body:e.domElement;if(e.object instanceof
THREE.PerspectiveCamera){a.copy(e.object.position).sub(e.target);var f=a.length(),f=f*Math.tan(e.object.fov/2*Math.PI/180);V(2*c*f/d.clientHeight,e.object.matrix);W(2*b*f/d.clientHeight,e.object.matrix)}else e.object instanceof THREE.OrthographicCamera?(V(c*(e.object.right-e.object.left)/e.object.zoom/d.clientWidth,e.object.matrix),W(b*(e.object.top-e.object.bottom)/e.object.zoom/d.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),
e.enablePan=!1)}}();e.domElement.addEventListener("contextmenu",w,!1);e.domElement.addEventListener("mousedown",g,!1);e.domElement.addEventListener("wheel",n,!1);e.domElement.addEventListener("touchstart",v,!1);e.domElement.addEventListener("touchend",C,!1);e.domElement.addEventListener("touchmove",s,!1);window.addEventListener("keydown",p,!1);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;
Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){console.warn("THREE.OrbitControls: .center has been renamed to .target");return this.target}},noZoom:{get:function(){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");return!this.enableZoom},set:function(a){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");this.enableZoom=!a}},noRotate:{get:function(){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");
return!this.enableRotate},set:function(a){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");this.enableRotate=!a}},noPan:{get:function(){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");return!this.enablePan},set:function(a){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");this.enablePan=!a}},noKeys:{get:function(){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");
return!this.enableKeys},set:function(a){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");this.enableKeys=!a}},staticMoving:{get:function(){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");return!this.enableDamping},set:function(a){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");this.enableDamping=!a}},dynamicDampingFactor:{get:function(){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");
return this.dampingFactor},set:function(a){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");this.dampingFactor=a}}});THREE.CapsuleBufferGeometry=function(a,b,c,f){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var d=a||1;b=b||1;var g=c||12,h=0.5*~~g;a=f||1;var l=2*Math.PI,n=0.5*Math.PI;f=new THREE.Geometry;a=new THREE.CylinderGeometry(d,d,b,g,a,!0);var p=new THREE.SphereGeometry(d,g,h,0,l,0,n),d=new THREE.SphereGeometry(d,g,h,0,l,n,n),g=(new THREE.Matrix4).makeTranslation(0,0,0);6===c&&g.makeRotationY(0.5235987755982988);c=(new THREE.Matrix4).makeTranslation(0,0.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,
0.5*-b,0);f.merge(a,g);f.merge(p,c);f.merge(d,b);f.mergeVertices();this.fromGeometry(f)};THREE.CapsuleBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CapsuleBufferGeometry.prototype.constructor=THREE.CapsuleBufferGeometry;THREE.ConvexGeometry=function(a){function b(c){var b=a[c].clone(),d=b.length();b.x+=2E-6*d*(Math.random()-0.5);b.y+=2E-6*d*(Math.random()-0.5);b.z+=2E-6*d*(Math.random()-0.5);for(var d=[],g=0;g<f.length;){var h=f[g],e=b,l=a[h[0]],n;n=l;var q=a[h[1]],m=a[h[2]],t=new THREE.Vector3,F=new THREE.Vector3;t.subVectors(m,q);F.subVectors(n,q);t.cross(F);t.normalize();n=t;l=n.dot(l);if(n.dot(e)>=l){for(e=0;3>e;e++){l=[h[e],h[(e+1)%3]];n=!0;for(q=0;q<d.length;q++)if(m=d[q],m[0]===l[1]&&m[1]===l[0]){d[q]=d[d.length-
1];d.pop();n=!1;break}n&&d.push(l)}f[g]=f[f.length-1];f.pop()}else g++}for(q=0;q<d.length;q++)f.push([d[q][0],d[q][1],c])}function c(a){var c=a.length();return new THREE.Vector2(a.x/c,a.y/c)}THREE.Geometry.call(this);for(var f=[[0,1,2],[0,2,1]],d=3;d<a.length;d++)b(d);for(var g=0,h=Array(a.length),d=0;d<f.length;d++)for(var l=f[d],n=0;3>n;n++)void 0===h[l[n]]&&(h[l[n]]=g++,this.vertices.push(a[l[n]])),l[n]=h[l[n]];for(d=0;d<f.length;d++)this.faces.push(new THREE.Face3(f[d][0],f[d][1],f[d][2]));for(d=
0;d<this.faces.length;d++)l=this.faces[d],this.faceVertexUvs[0].push([c(this.vertices[l.a]),c(this.vertices[l.b]),c(this.vertices[l.c])]);this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry.prototype.constructor=THREE.ConvexGeometry;THREE.Tubex=function(a,b,c,f,d,g){THREE.BufferGeometry.call(this);this.type="Tubex";this.tubularSegments=b||64;this.radius=c||1;this.radialSegments=f||8;this.closed=d||!1;if(a instanceof Array)this.positions=a;else{this.positions=[];b=(new THREE.Vector3).fromArray(a.start);c=(new THREE.Vector3).fromArray(a.end);f=c.clone().sub(b);a=a.numSegment-1;this.positions.push(b);for(d=1;d<a;d++)this.positions.push((new THREE.Vector3(f.x/a*d,f.y/a*d,f.z/a*d)).add(b));this.positions.push(c)}this.path=new THREE.CatmullRomCurve3(this.positions);
this.path.type=g||"catmullrom";this.path.closed=this.closed;this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.vertex=new THREE.Vector3;this.normal=new THREE.Vector3;this.uv=new THREE.Vector2;this.vertices=[];this.colors=[];this.normals=[];this.uvs=[];this.indices=[];this.generateBufferData();this.setIndex(new (65535<this.indices.length?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(this.indices,1));this.addAttribute("position",new THREE.Float32BufferAttribute(this.vertices,
3));this.addAttribute("color",new THREE.Float32BufferAttribute(this.colors,3));this.addAttribute("normal",new THREE.Float32BufferAttribute(this.normals,3));this.addAttribute("uv",new THREE.Float32BufferAttribute(this.uvs,2))};THREE.Tubex.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.Tubex.prototype.constructor=THREE.Tubex;
THREE.Tubex.prototype.generateBufferData=function(){for(var a=0;a<this.tubularSegments;a++)this.generateSegment(a);this.generateSegment(!1===this.closed?this.tubularSegments:0);this.generateIndicesAndUv()};
THREE.Tubex.prototype.generateSegment=function(a){var b=this.path.getPointAt(a/this.tubularSegments),c=this.frames.normals[a];a=this.frames.binormals[a];for(var f=0;f<=this.radialSegments;f++){var d=f/this.radialSegments*Math.PI*2,g=Math.sin(d),d=-Math.cos(d);this.normal.x=d*c.x+g*a.x;this.normal.y=d*c.y+g*a.y;this.normal.z=d*c.z+g*a.z;this.normal.normalize();this.normals.push(this.normal.x,this.normal.y,this.normal.z);this.vertex.x=b.x+this.radius*this.normal.x;this.vertex.y=b.y+this.radius*this.normal.y;
this.vertex.z=b.z+this.radius*this.normal.z;this.vertices.push(this.vertex.x,this.vertex.y,this.vertex.z);this.colors.push(1,1,1)}};
THREE.Tubex.prototype.generateIndicesAndUv=function(){for(var a=0;a<=this.tubularSegments;a++)for(var b=0;b<=this.radialSegments;b++){if(0<b&&0<a){var c=(this.radialSegments+1)*a+(b-1),f=(this.radialSegments+1)*a+b,d=(this.radialSegments+1)*(a-1)+b;this.indices.push((this.radialSegments+1)*(a-1)+(b-1),c,d);this.indices.push(c,f,d)}this.uv.x=a/this.tubularSegments;this.uv.y=b/this.radialSegments;this.uvs.push(this.uv.x,this.uv.y)}};
THREE.Tubex.prototype.updatePath=function(a){this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.normals=this.attributes.normal.array;this.vertices=this.attributes.position.array;this.colors=this.attributes.color.array;for(a=0;a<this.tubularSegments;a++)this.updateSegment(a);this.updateSegment(!1===this.closed?this.tubularSegments:0);this.attributes.color.needsUpdate=!0;this.attributes.position.needsUpdate=!0;this.attributes.normal.needsUpdate=!0;this.computeBoundingSphere()};
THREE.Tubex.prototype.updateUV=function(){this.uvs=this.attributes.uv.array;for(var a,b,c=0;c<=this.tubularSegments;c++){a=2*c*(this.radialSegments+1);for(var f=0;f<=this.radialSegments;f++)b=2*f,this.uv.x=c/this.tubularSegments,this.uv.y=f/this.radialSegments,this.uvs[a+b]=this.uv.x,this.uvs[a+b+1]=this.uv.y}this.attributes.uv.needsUpdate=!0};
THREE.Tubex.prototype.updateSegment=function(a){for(var b=3*a*(this.radialSegments+1),c=this.path.getPointAt(a/this.tubularSegments),f=this.frames.normals[a],d=this.frames.binormals[a],g=0;g<=this.radialSegments;g++){var h=g/this.radialSegments*Math.PI*2;a=3*g;var l=Math.sin(h),h=-Math.cos(h);this.normal.x=h*f.x+l*d.x;this.normal.y=h*f.y+l*d.y;this.normal.z=h*f.z+l*d.z;this.normal.normalize();this.normals[b+a]=this.normal.x;this.normals[b+a+1]=this.normal.y;this.normals[b+a+2]=this.normal.z;this.vertices[b+
a]=c.x+this.radius*this.normal.x;this.vertices[b+a+1]=c.y+this.radius*this.normal.y;this.vertices[b+a+2]=c.z+this.radius*this.normal.z;this.colors[b+a]=Math.abs(this.normal.x);this.colors[b+a+1]=Math.abs(this.normal.y);this.colors[b+a+2]=Math.abs(this.normal.z)}};THREE.ShaderShadow={uniforms:Object.assign({},THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(15658734)},specular:{value:new THREE.Color(1118481)},emissive:{value:new THREE.Color(0)},opacity:{value:0.4}}),fragmentShader:["uniform float opacity;\nvarying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.packing,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.shadowmask_pars_fragment,"void main() {\n   float mask = getShadowMask();\n   vec4 pp = vec4(1.0);\n   vec4 mapping = vec4( pp.rgb, pp.a * opacity );\n   vec4 shadowing = vec4( vec3(0.0), opacity * (1.0 - mask) );\n   gl_FragColor = mix( mapping, shadowing, 1.0 - mask );\n   gl_FragColor = shadowing;\n}"].join("\n"),
vertexShader:["varying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvUv = uv;\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),lights:!0,transparent:!0,depthWrite:!1};THREE.CarHelper=function(a,b,c){c=0.6*-c;this.py=a[1]-b[1];a=new Float32Array([-0.2,0,0,0.2,0,0,0,0,0,0,0.4,0,0,0,-0.2,0,0,0.2,a[0]-c,this.py,a[2],a[0]-c,this.py+1,a[2],-a[0]+c,this.py,a[2],-a[0]+c,this.py+1,a[2],-a[0]+c,this.py,-a[2],-a[0]+c,this.py+1,-a[2],a[0]-c,this.py,-a[2],a[0]-c,this.py+1,-a[2],a[0]-c,this.py,a[2],-a[0]+c,this.py,a[2],a[0]-c,this.py,-a[2],-a[0]+c,this.py,-a[2]]);b=new Float32Array([1,1,0,1,1,0,1,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,
1,0,1,1,0,1,1,0]);this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(a,3));this.geometry.addAttribute("color",new THREE.BufferAttribute(b,3));this.positions=this.geometry.attributes.position.array;this.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,name:"helper"});THREE.LineSegments.call(this,this.geometry,this.material)};THREE.CarHelper.prototype=Object.create(THREE.LineSegments.prototype);
THREE.CarHelper.prototype.constructor=THREE.CarHelper;THREE.CarHelper.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.CarHelper.prototype.updateSuspension=function(a,b,c,f){this.positions[22]=this.py-a;this.positions[28]=this.py-b;this.positions[34]=this.py-c;this.positions[40]=this.py-f;this.geometry.attributes.position.needsUpdate=!0};THREE.Terrain=function(a,b){a=void 0==a?{}:a;this.div=void 0==a.div?[64,64]:a.div;this.size=void 0==a.size?[100,10,100]:a.size;this.colorBase={r:1,g:0.7,b:0};this.complexity=void 0==a.complexity?30:a.complexity;this.complexity2=void 0==a.complexity2?60:a.complexity2;this.local=new THREE.Vector3;a.local&&this.local.fromArray(a.local);this.lng=this.div[0]*this.div[1];this.hdata=new Float32Array(this.lng);this.perlin=void 0==b?new Perlin:b;this.colors=new Float32Array(3*this.lng);this.geometry=new THREE.PlaneBufferGeometry(this.size[0],
this.size[2],this.div[0]-1,this.div[1]-1);this.geometry.rotateX(0.5*-Math.PI);this.geometry.computeBoundingSphere();this.geometry.addAttribute("color",new THREE.BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.material=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,name:"terrain",metalness:1,roughness:0.3,wireframe:!1});this.update();THREE.Mesh.call(this,this.geometry,this.material);this.castShadow=!1;this.receiveShadow=!0};
THREE.Terrain.prototype=Object.create(THREE.Mesh.prototype);THREE.Terrain.prototype.constructor=THREE.Terrain;THREE.Terrain.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.Terrain.prototype.setEnvMap=function(a){this.material.envMap=a};THREE.Terrain.prototype.move=function(){this.update()};THREE.Terrain.prototype.clamp=function(a,b,c){a=a<b?b:a;return a>c?c:a};THREE.Terrain.prototype.norm=function(a,b,c){return(a-b)/(c-b)};
THREE.Terrain.prototype.linear=function(a,b,c){return(1-a)*b+a*c};THREE.Terrain.prototype.cubicSCurve=function(a){return a*a*(3-2*a)};THREE.Terrain.prototype.quinticSCurve=function(a){var b=a*a*a,c=b*a;return 6*c*a-15*c+10*b};
THREE.Terrain.prototype.update=function(){for(var a=1/this.complexity,b=1/this.complexity2,c=1/this.div[0],f=(this.div[0]-1)/this.size[0],d=(this.div[1]-1)/this.size[2],g=this.lng,h,l,n,p;g--;)h=3*g,l=g%this.div[0],n=~~(g*c),p=0.5+0.5*this.perlin.noise((l+this.local.x*f)*a,(n+this.local.z*d)*a),l=0.5+0.5*this.perlin.noise((l+100+this.local.x*f)*b,(n+100+this.local.z*d)*b),p=Math.min(p,l),p=this.linear(p,0,0.7),p=this.quinticSCurve(p),this.hdata[g]=p*this.size[1],this.vertices[h+1]=this.hdata[g],this.colors[h]=
p*this.colorBase.r,this.colors[h+1]=p*this.colorBase.g,this.colors[h+2]=p*this.colorBase.b;this.geometry.attributes.position.needsUpdate=!0;this.geometry.attributes.color.needsUpdate=!0;this.geometry.computeVertexNormals()};THREE.ViewUtils={mergeGeometryArray:function(a){for(var b=[],c=a.length;c--;)b[c]=(new THREE.Geometry).fromBufferGeometry(a[c]);for(a=new THREE.Geometry;0<b.length;)c=b.pop(),a.merge(c),c.dispose();a.mergeVertices();b=(new THREE.BufferGeometry).fromGeometry(a);a.dispose();return b},prepaGeometry:function(a,b){var c=!1,f=!1;"mesh"==b&&(f=!0);"convex"==b&&(c=!0);var d,g,h,l=(new THREE.Geometry).fromBufferGeometry(a);l.mergeVertices();var n=a.attributes.position.array.length/3,p=l.vertices.length,v=
l.faces.length;a.realVertices=new Float32Array(3*p);a.realIndices=new (65535<3*v?Uint32Array:Uint16Array)(3*v);for(d=p;d--;)h=l.vertices[d],g=3*d,a.realVertices[g]=h.x,a.realVertices[g+1]=h.y,a.realVertices[g+2]=h.z;if(c)return l.dispose(),a.realVertices;for(d=v;d--;)h=l.faces[d],g=3*d,a.realIndices[g]=h.a,a.realIndices[g+1]=h.b,a.realIndices[g+2]=h.c;l.dispose();if(f){n=[];for(d=a.realIndices.length;d--;)g=3*d,h=3*a.realIndices[d],n[g]=a.realVertices[h],n[g+1]=a.realVertices[h+1],n[g+2]=a.realVertices[h+
2];return n}f=[];l=a.attributes.position.array;for(d=p;d--;)for(g=3*d,f[d]=[],c=n;c--;)h=3*c,l[h]==a.realVertices[g]&&l[h+1]==a.realVertices[g+1]&&l[h+2]==a.realVertices[g+2]&&f[d].push(c);var l=new (65535<p?Uint32Array:Uint16Array)(p),s=new (65535<n?Uint32Array:Uint16Array)(n);for(d=h=0;d<p;d++){g=f[d].length;l[d]=h;for(c=g;c--;)s[h+c]=f[d][c];h+=g}a.numFaces=v;a.numVertices=p;a.maxi=n;a.pPoint=l;a.lPoint=s}};var user=function(){var a=new Float32Array(20),b;user={init:function(c){b=new user.Gamepad(a);document.addEventListener("keydown",user.keyDown,!1);document.addEventListener("keyup",user.keyUp,!1)},update:function(a){b.update();b.ready&&b.getValue(0)},keyDown:function(c){if(!editor.getFocus()){c=c||window.event;switch(c.which){case 65:case 81:a[0]=-1;break;case 68:a[0]=1;break;case 87:case 90:a[1]=-1;break;case 83:a[1]=1;break;case 37:a[2]=-1;break;case 39:a[2]=1;break;case 38:a[3]=-1;break;case 40:a[3]=
1;break;case 17:case 67:a[5]=1;break;case 69:a[5]=1;break;case 32:a[4]=1;break;case 16:a[7]=1;break;case 71:view.hideGrid()}b.reset()}},keyUp:function(c){if(!editor.getFocus())switch(c=c||window.event,c.which){case 65:case 81:a[0]=0>a[0]?0:a[0];break;case 68:a[0]=0<a[0]?0:a[0];break;case 87:case 90:a[1]=0>a[1]?0:a[1];break;case 83:a[1]=0<a[1]?0:a[1];break;case 37:a[2]=0>a[2]?0:a[2];break;case 39:a[2]=0<a[2]?0:a[2];break;case 38:a[3]=0>a[3]?0:a[3];break;case 40:a[3]=0<a[3]?0:a[3];break;case 17:case 67:a[5]=
0;break;case 69:a[5]=0;break;case 32:a[4]=0;break;case 16:a[7]=0}},getKey:function(){return a},Gamepad:function(a){this.values=[];this.key=a;this.ready=0}};user.Gamepad.prototype={update:function(){var a,b,d,g,h,l,n=this.fix,p=navigator.getGamepads();for(a=0;a<p.length;a++)if(l=p[a])if(d=l.axes.length,g=l.buttons.length){this.values[a]||(this.values[a]=[]);for(b=0;b<d;b++)h=n(l.axes[b],0.08),0==this.ready&&0!==h&&(this.ready=1),this.values[a][b]=h;for(b=0;b<g;b++)h=n(l.buttons[b].value),0==this.ready&&
0!==h&&(this.ready=1),this.values[a][d+b]=h}else this.values[a]&&(this.values[a]=null)},getValue:function(a){for(var b=19,d;b--;)d=this.values[a][b],0==this.ready&&0!==d&&(this.ready=1),this.key[b]=d},reset:function(){this.ready=0},fix:function(a,b){var d=Number(a.toString().substring(0,5));b&&d<b&&d>-b&&(d=0);return d}};return user}();var gui=function(){var a;return gui={init:function(){a=document.createElement("div");document.body.appendChild(a)},initJoysticks:function(){UIL.add("joystick",{target:a,pos:{left:"auto",right:"100px",top:"auto",bottom:"10px"},name:"JOY",width:100,multiplicator:1,precision:2,fontColor:"#D4B87B"})}}}();var now;(function(a){var b,c=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var f=0;f<c.length;++f){var d=c[f];if(a.performance[d]){b=function(){return a.performance[d]()};break}}b||(b=Date.now);now=b})(window);var editor=function(){var a,b,c,f,d,g,h,l=function(){},n=!1,p=!1,v=[],s=[],C=null,w=0,e=0,A="",y,q=[],m,t=!1,F=!0,r=!1,x,B;return editor={init:function(e,m){e&&(l=e);F=m||!1;y=document.createElement("div");y.className="bigmenu";document.body.appendChild(y);this.makeBigMenu();var q=document.createElement("div");q.style.cssText="position:absolute; right:0; top:0; width:1px; height:1px; pointer-events:none;";q.innerHTML="<svg width='80' height='80' viewBox='0 0 250 250' style='fill:rgba(255,255,255,0.2); color:#2B2A2D; position: absolute; top: 0; border: 0; right: 0;'>\n<path d='M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z' id='octo' onmouseover='editor.Gover();' onmouseout='editor.Gout();' onmousedown='editor.Gdown();'></path>\n<path d='M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2' fill='currentColor' style='transform-origin: 130px 106px;' id='octo-arm'></path>\n<path d='M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z' fill='currentColor' id='octo-body'></path></svg>";
document.body.appendChild(q);x=document.getElementById("octo");B=document.getElementById("octo-arm");g=document.createElement("div");g.className="debug";document.body.appendChild(g);h=document.createElement("div");h.className="title";document.body.appendChild(h);a=document.createElement("div");a.className="editor";document.body.appendChild(a);b=document.createElement("div");b.className="codeContent";a.appendChild(b);c=CodeMirror(b,{lineNumbers:!0,matchBrackets:!0,indentWithTabs:!1,styleActiveLine:!0,
theme:"monokai",mode:"text/javascript",tabSize:4,indentUnit:4,highlightSelectionMatches:{showToken:/\w/}});f=document.createElement("div");f.className="separator";document.body.appendChild(f);d=document.createElement("div");d.className="menuCode";a.appendChild(d);a.style.display="none";f.style.display="none";c.on("change",function(){editor.onChange()});c.on("focus",function(){p=!0;view.needFocus()});c.on("blur",function(){p=!1});c.on("drop",function(){n?n=!1:c.setValue("")});c.on("dragstart",function(){n=
!0});F&&(w=~~(0.4*window.innerWidth),a.style.display="block",f.style.display="block",this.addSeparatorEvent(),this.resize());y.style.width=window.innerWidth-w+"px"},addSeparatorEvent:function(){f.addEventListener("mouseover",editor.mid_over,!1);f.addEventListener("mouseout",editor.mid_out,!1);f.addEventListener("mousedown",editor.mid_down,!1)},removeSeparatorEvent:function(){f.removeEventListener("mouseover",editor.mid_over,!1);f.removeEventListener("mouseout",editor.mid_out,!1);f.removeEventListener("mousedown",
editor.mid_down,!1)},selectCode:function(){F?editor.hide():editor.show()},hide:function(){F=!1;a.style.display="none";f.style.display="none";e=w;w=0;this.removeSeparatorEvent();editor.Bdefault(q[1]);editor.resize()},show:function(){F=!0;a.style.display="block";f.style.display="block";w=e?e:~~(0.4*window.innerWidth);this.addSeparatorEvent();editor.resize()},resizeMenu:function(a){y&&(y.style.width=a+"px")},resize:function(b){b&&(w=b.clientX+10);view&&(view.setLeft(w),view.resize());y.style.left=w+
"px";h.style.left=w+"px";g.style.left=w+"px";f.style.left=w-10+"px";a.style.width=w-10+"px";c.refresh()},tell:function(a){g.textContent=a},makeBigMenu:function(){y.style.width=window.innerWidth-w+"px";q[0]=document.createElement("div");q[0].className="bigButton";y.appendChild(q[0]);q[0].innerHTML="DEMO";q[0].addEventListener("mousedown",editor.selectBigMenu,!1);q[0].name="demo";q[1]=document.createElement("div");q[1].className="bigButton";y.appendChild(q[1]);q[1].innerHTML="CODE";q[1].addEventListener("mousedown",
editor.selectCode,!1);q[1].name="code";m=document.createElement("div");m.className="bigContent";y.appendChild(m);for(var a=q.length;a--;)q[a].addEventListener("mouseover",editor.Bover,!1),q[a].addEventListener("mouseout",editor.Bout,!1)},selectBigMenu:function(a){t?editor.hideBigMenu():editor.showBigMenu()},showBigMenu:function(a){y.style.background="#252525";y.style.borderBottom="1px solid #3f3f3f";t=!0;a=demos.length;for(var b,c=0;c<a;c++)b=demos[c],b!==A&&editor.addButtonBig(demos[c])},hideBigMenu:function(a){y.style.background=
"rgba(0,0,0,0)";y.style.borderBottom="1px solid rgba(255, 255, 255, 0)";t=!1;a=m.childNodes.length;for(var b;a--;)b=m.childNodes[a],b.removeEventListener("mousedown",editor.bigDown),m.removeChild(b);editor.Bdefault(q[0])},addButtonBig:function(a){var b=document.createElement("div");b.className="menuButtonBig";m.appendChild(b);b.innerHTML="&bull; "+a.charAt(0).toUpperCase()+a.substring(1).toLowerCase();b.name=a;b.addEventListener("mousedown",editor.bigDown,!1)},bigDown:function(a){editor.hideBigMenu();
editor.load("demos/"+a.target.name+".js")},Bover:function(a){a.target.style.border="1px solid #3998d6";a.target.style.background="#3998d6";a.target.style.color="#FFFFFF"},Bout:function(a){var b=0;"code"==a.target.name&&F&&(b=1);"demo"==a.target.name&&t&&(b=1);b?(a.target.style.border="1px solid #3f3f3f",a.target.style.background="#3f3f3f",a.target.style.color="#999999"):editor.Bdefault(a.target)},Bdefault:function(a){a.style.border="1px solid #3f3f3f";a.style.background="#252525";a.style.color="#3998d6"},
Gover:function(){x.setAttribute("fill","#3998d6");B.style.webkitAnimationName="octocat-wave";B.style.webkitAnimationDuration="560ms"},Gout:function(){x.setAttribute("fill","rgba(255,255,255,0.2)");B.style.webkitAnimationName="none"},Gdown:function(){window.location.assign("https://github.com/lo-th/Ammo.lab")},mid_over:function(){f.style.background="#5f5f5f"},mid_out:function(){r||(f.style.background="none")},mid_down:function(){r=!0;document.addEventListener("mouseup",editor.mid_up,!1);document.addEventListener("mousemove",
editor.resize,!1)},mid_up:function(){r=!1;document.removeEventListener("mouseup",editor.mid_up,!1);document.removeEventListener("mousemove",editor.resize,!1)},load:function(a){A=a.substring(a.indexOf("/")+1,a.indexOf("."));var b=new XMLHttpRequest;b.overrideMimeType("text/plain; charset=x-user-defined");b.open("GET",a,!0);b.onload=function(){c.setValue(b.responseText)};b.send()},unFocus:function(){c.getInputField().blur();view.haveFocus()},refresh:function(){c.refresh()},getFocus:function(){return p},
validate:function(a){return c.operation(function(){for(;0<v.length;)c.removeLineClass(v.shift(),"background","errorLine");for(var b=s.length;b--;)c.removeLineWidget(s[b]);s.length=0;try{for(var d=esprima.parse(a,{tolerant:!0}).errors,b=d.length;b--;){var e=d[b],f=document.createElement("div");f.className="esprima-error";f.textContent=e.message.replace(/Line [0-9]+: /,"");var g=e.lineNumber-1;v.push(g);c.addLineClass(g,"background","errorLine");var h=c.addLineWidget(g,f);s.push(h)}}catch(l){f=document.createElement("div"),
f.className="esprima-error",f.textContent=l.message.replace(/Line [0-9]+: /,""),g=l.lineNumber-1,v.push(g),c.addLineClass(g,"background","errorLine"),h=c.addLineWidget(g,f),s.push(h)}return 0===v.length})},onChange:function(){clearTimeout(C);var a=c.getValue();this.validate(a)&&(C=setTimeout(function(){editor.inject(a)},500))},inject:function(a){var b=document.createElement("script");b.language="javascript";b.type="text/javascript";b.text=a;document.getElementsByTagName("BODY").item(0).appendChild(b);
d.innerHTML="&bull; "+A;h.innerHTML=A.charAt(0).toUpperCase()+A.substring(1).toLowerCase();l(A)}}}();Math.torad=0.017453292519943295;Math.todeg=57.29577951308232;Math.degtorad=0.017453292519943295;Math.radtodeg=57.29577951308232;Math.Pi=3.141592653589793;Math.TwoPI=6.283185307179586;Math.PI90=1.570796326794896;Math.PI270=4.712388980384689;Math.lerp=function(a,b,c){return a+(b-a)*c};Math.rand=function(a,b){return Math.lerp(a,b,Math.random())};Math.randInt=function(a,b,c){return 1*Math.lerp(a,b,Math.random()).toFixed(c||0)};Math.int=function(a){return~~a};
var view=function(){var a,b=0,c=0,f=0,d=0,g,h,l,n,p,v,s,C,w,e,A,y=!1,q=1,m=1,t=0,F,r=[],x=[],B=[],z=[],D=[],I=[],E=[],N={},K=!1,P=!1,J=null,M,L=0,O=0,V=0,W=0,G,u,S=[],aa=null,ba={},ca,X=!1,H,R,da,Z=-0.01,Y=null,ea,Q=1,T=!0,$="wireframe ceramic plastic smooth metal chrome brush black glow red sky".split(" "),U;return view={render:function(){requestAnimationFrame(a.render);TWEEN.update();THREE.SEA3D.AnimationHandler.update(0.017);update();K&&(a.heroStep(Ar,ArPos[0]),a.carsStep(Ar,ArPos[1]),a.bodyStep(Ar,
ArPos[2]),a.softStep(Ar,ArPos[3]),a.controlUpdate(),K=!1);postUpdate();h.render(l,n);b=now();b-1E3>c&&(c=b,d=f,f=0);f++},needUpdate:function(a){K=a},needCrowdUpdate:function(){},reset:function(){K=!1;postUpdate=function(){};update=function(){};this.removeRay();this.resetCamera();this.setShadowPosY(-0.01);F.visible=!0;for(var a,b;0<r.length;)l.remove(r.pop());for(;0<x.length;)l.remove(x.pop());for(;0<B.length;)l.remove(B.pop());for(;0<z.length;)l.remove(z.pop());for(;0<I.length;)l.remove(I.pop());
for(;0<E.length;)E.pop().dispose();for(;0<D.length;){a=D.pop();a.userData.helper&&(a.remove(a.userData.helper),a.userData.helper.dispose());for(b=a.userData.w.length;b--;)l.remove(a.userData.w[b]);l.remove(a)}Y=null;N={}},init:function(k){g=document.createElement("canvas");g.className="canvas3d";g.oncontextmenu=function(a){a.preventDefault()};g.ondrop=function(a){a.preventDefault()};document.body.appendChild(g);a=this;try{h=new THREE.WebGLRenderer({canvas:g,antialias:!0,alpha:!1})}catch(b){null!==
intro&&intro.message("<p>Sorry, your browser does not support WebGL.</p><p>This application uses WebGL to quickly draw AMMO Physics.</p><p>AMMO Physics can be used without WebGL, but unfortunately this application cannot.</p><p>Have a great day!</p>");return}null!==intro&&intro.clear();h.setClearColor(2434341,1);h.setPixelRatio(window.devicePixelRatio);h.gammaInput=!0;h.gammaOutput=!0;h.toneMapping=THREE.Uncharted2ToneMapping;h.toneMappingExposure=3;h.toneMappingWhitePoint=5;l=new THREE.Scene;C=new THREE.Group;
l.add(C);n=new THREE.PerspectiveCamera(60,1,1,1E3);n.position.set(0,0,30);p=new THREE.OrbitControls(n,g);p.target.set(0,0,0);p.enableKeys=!1;p.update();M=new THREE.Group;l.add(M);M.add(n);this.addLights();ca=new THREE.TextureLoader;v=new THREE.Raycaster;s=new THREE.Vector2;G={box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,0.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),
highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};G.wheel.rotateZ(-Math.PI90);u={terrain:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"terrain",wireframe:!0}),cloth:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"cloth",wireframe:!0,transparent:!0,opacity:0.9,side:THREE.DoubleSide}),ball:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"ball",wireframe:!0}),statique:new THREE.MeshBasicMaterial({color:3355545,
name:"statique",wireframe:!0,transparent:!0,opacity:0.6}),move:new THREE.MeshBasicMaterial({color:10066329,name:"move",wireframe:!0}),movehigh:new THREE.MeshBasicMaterial({color:16751001,name:"movehigh",wireframe:!0}),sleep:new THREE.MeshBasicMaterial({color:10066431,name:"sleep",wireframe:!0}),debug:new THREE.MeshBasicMaterial({color:1179409,name:"debug",wireframe:!0,opacity:0.1,transparent:!0}),hero:new THREE.MeshBasicMaterial({color:10040217,name:"hero",wireframe:!0}),cars:new THREE.MeshBasicMaterial({color:16777215,
name:"cars",wireframe:!0,transparent:!0,side:THREE.DoubleSide}),tmp1:new THREE.MeshBasicMaterial({color:16777215,name:"tmp1",wireframe:!0,transparent:!0}),tmp2:new THREE.MeshBasicMaterial({color:16777215,name:"tmp2",wireframe:!0,transparent:!0}),meca1:new THREE.MeshBasicMaterial({color:16777215,name:"meca1",wireframe:!0}),meca2:new THREE.MeshBasicMaterial({color:16777215,name:"meca2",wireframe:!0}),meca3:new THREE.MeshBasicMaterial({color:16777215,name:"meca3",wireframe:!0}),drone:new THREE.MeshBasicMaterial({color:16777215,
name:"drone",wireframe:!0}),pig:new THREE.MeshBasicMaterial({color:13870992,name:"pig",wireframe:!0,transparent:!1}),avatar:new THREE.MeshBasicMaterial({color:13870992,name:"avatar",wireframe:!0,transparent:!1}),both:new THREE.MeshBasicMaterial({color:16777215,name:"both",wireframe:!0,side:THREE.DoubleSide}),back:new THREE.MeshBasicMaterial({color:16777215,name:"back",wireframe:!0,side:THREE.BackSide})};F=new THREE.GridHelper(50,20,16777215,3355443);F.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,
transparent:!0,opacity:0.1});l.add(F);this.resize();this.initEnv();window.addEventListener("resize",a.resize,!1);this.render();this.load("basic",k)},addLights:function(){R=new THREE.DirectionalLight(16777215,1);R.position.set(-3,50,5);R.lookAt(new THREE.Vector3);l.add(R);da=new THREE.AmbientLight(4473924);l.add(da)},resize:function(){m=window.innerHeight;q=window.innerWidth-t;g.style.left=t+"px";n.aspect=q/m;n.updateProjectionMatrix();h.setSize(q,m);editor&&editor.resizeMenu(q)},setLeft:function(a){t=
a},getFps:function(){return d},getInfo:function(){return h.info.programs.length},addMap:function(a,b){var c=ca.load("./assets/textures/"+a);c.flipY=!1;u[b].map=c},getGeo:function(){return G},getMat:function(){return u},getScene:function(){return l},removeRay:function(){y&&(y=!1,g.removeEventListener("mousemove",a.rayTest,!1),e=null,C.remove(A),l.remove(w))},activeRay:function(k){y=!0;var b=new THREE.PlaneBufferGeometry(100,100);b.rotateX(-Math.PI90);A=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:16777215,
transparent:!0,opacity:0}));C.add(A);w=new THREE.Mesh(G.box,new THREE.MeshBasicMaterial({color:16711680}));l.add(w);g.addEventListener("mousemove",a.rayTest,!1);e=k},rayTest:function(a){s.x=(a.clientX-t)/q*2-1;s.y=2*-(a.clientY/m)+1;v.setFromCamera(s,n);a=v.intersectObjects(C.children,!0);a.length&&(w.position.copy(a[0].point),e(w))},changeMaterial:function(a){var b,c,d;0===a?(T=!0,c="MeshBasicMaterial",this.removeShadow()):(T=!1,c="MeshStandardMaterial",this.addShadow());for(d in u)b=u[d],a=b.name,
"debug"!==a&&(u[a]=new THREE[c]({name:a,envMap:null,map:b.map||null,vertexColors:b.vertexColors||!1,color:void 0===b.color?16777215:b.color.getHex(),wireframe:T,transparent:b.transparent||!1,opacity:b.opacity||1,side:b.side||THREE.FrontSide}),T||(u[a].envMap=U,u[a].metalness=0.8,u[a].roughness=0.2),b.dispose());for(d=r.length;d--;)a=r[d].material.name,r[d].material=u[a];for(d=x.length;d--;)a=x[d].material.name,x[d].material=u[a];for(d=D.length;d--;){if(void 0==D[d].material)for(b=D[d].children.length;b--;)a=
D[d].children[b].material.name,"helper"!==a&&(D[d].children[b].material=u[a]);else a=D[d].material.name,D[d].material=u[a];for(b=D[d].userData.w.length;b--;)a=D[d].userData.w[b].material.name,D[d].userData.w[b].material=u[a]}for(d=B.length;d--;)a=B[d].material.name,B[d].material=u[a];for(d=z.length;d--;)2!==z.softType&&(a=z[d].material.name,z[d].material=u[a])},needFocus:function(){g.addEventListener("mouseover",editor.unFocus,!1)},haveFocus:function(){g.removeEventListener("mouseover",editor.unFocus,
!1)},initEnv:function(){var a=document.createElement("div");a.className="env";var b=document.createElement("canvas");b.width=b.height=64;a.appendChild(b);document.body.appendChild(a);ea=b.getContext("2d");a.onclick=this.loadEnv;a.oncontextmenu=this.loadEnv;this.loadEnv()},loadEnv:function(k){var b=0;k&&(k.preventDefault(),b=k.button,0===b?Q++:Q--,Q==$.length&&(Q=0),0>Q&&(Q=$.length-1));var c=new Image;c.onload=function(){ea.drawImage(c,0,0,64,64);U=new THREE.Texture(c);U.mapping=THREE.SphericalReflectionMapping;
U.format=THREE.RGBFormat;U.needsUpdate=!0;0!==Q||T||a.changeMaterial(0);if(0!==Q)if(T)a.changeMaterial(1);else for(var k in u)u[k].envMap=U};c.src="./assets/textures/spherical/"+$[Q]+".jpg"},hideGrid:function(){F.visible=F.visible?!1:!0},load:function(k,b){"string"==typeof k||k instanceof String?S.push(k):S=S.concat(k);aa=b||function(){};a.load_sea(S[0])},load_next:function(){S.shift();0===S.length?aa():a.load_sea(S[0])},load_sea:function(k){var b=new THREE.SEA3D;b.onComplete=function(c){ba[k]=b.meshes;
c=b.geometries.length;for(var d;c--;)d=b.geometries[c],G[d.name]=d;a.load_next()};b.load("./assets/models/"+k+".sea")},getResult:function(){return ba},mergeMesh:function(a){return THREE.ViewUtils.mergeGeometryArray(a)},prepaGeometry:function(a,b){return THREE.ViewUtils.prepaGeometry(a,b)},controlUpdate:function(){if(P&&null!==J){var a,b,c=J;a=c.userData.type;var d=c.userData.speed;b=-70*Math.torad;if("car"===a){if(10>d&&-10<d){this.setControle(!0);return}this.setControle(!1)}"hero"===a&&(this.setControle(!0),
L=p.getAzimuthalAngle()+Math.Pi,O=-p.getPolarAngle(),O!==W&&(b=W=O),L!==V&&(V=L,ammo.send("heroRotation",{id:c.userData.id,angle:L})));d=new THREE.Matrix4;d.extractRotation(c.matrix);a=new THREE.Vector3(0,0,1);a.applyMatrix4(d);c=c.position;a=Math.atan2(a.x,a.z);this.autoCamera(a,b,10,0.3,c)}},setFollow:function(a){J=this.getByName(a);null!==J&&(P=!0)},setTarget:function(a){p.target.copy(a);p.update()},autoCamera:function(a,b,c,d,e){d=d||1;n.position.lerp(this.orbit(a,b,c),d);e&&this.setTarget(e)},
moveCamera:function(a,b,c,d){a=this.orbit((a+180)*Math.torad,(b-90)*Math.torad,c);(new TWEEN.Tween(n.position)).to({x:a.x,y:a.y,z:a.z},400).easing(TWEEN.Easing.Quadratic.Out).start();(new TWEEN.Tween(p.target)).to({x:d[0],y:d[1],z:d[2]},400).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){p.update()}).start()},orbit:function(a,b,c){var d=new THREE.Vector3;d.x=c*Math.sin(b)*Math.sin(a);d.y=c*Math.cos(b);d.z=c*Math.sin(b)*Math.cos(a);a=new THREE.Vector3;a.copy(p.target).add(d);return a},setControle:function(a){p.enableRotate!==
a&&(p.enableRotate=a,p.enableZoom=a,p.enablePan=a)},resetCamera:function(){a.setControle(!0);J=null},setDriveCar:function(a){ammo.send("setDriveCar",{n:this.getByName(a).userData.id})},toRad:function(a){for(var b=a.length;b--;)a[b]*=Math.torad;return a},add:function(k){var b=!1;k.mass=void 0==k.mass?0:k.mass;k.type=void 0==k.type?"box":k.type;k.pos=void 0==k.pos?[0,0,0]:k.pos;k.size=void 0==k.size?[1,1,1]:k.size;1==k.size.length&&(k.size[1]=k.size[0]);2==k.size.length&&(k.size[2]=k.size[0]);k.geoSize&&
(1==k.geoSize.length&&(k.geoSize[1]=k.geoSize[0]),2==k.geoSize.length&&(k.geoSize[2]=k.geoSize[0]));k.rot=void 0==k.rot?[0,0,0]:this.toRad(k.rot);k.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(k.rot)).toArray();k.rotA&&(k.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(k.rotA))).toArray());k.rotB&&(k.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(k.rotB))).toArray());k.angUpper&&(k.angUpper=this.toRad(k.angUpper));
k.angLower&&(k.angLower=this.toRad(k.angLower));var c=null;if("joint"===k.type.substring(0,5))ammo.send("add",k);else if("plane"===k.type)F.position.set(k.pos[0],k.pos[1],k.pos[2]),ammo.send("add",k);else if("softTriMesh"===k.type)this.softTriMesh(k);else if("softConvex"===k.type)this.softConvex(k);else if("cloth"===k.type)this.cloth(k);else if("rope"===k.type)this.rope(k);else if("ellipsoid"===k.type)this.ellipsoid(k);else if("terrain"===k.type)this.terrain(k);else{c=void 0!==k.material?u[k.material]:
k.mass?u.move:u.statique;if("capsule"===k.type)b=new THREE.CapsuleBufferGeometry(k.size[0],0.5*k.size[1]),c=new THREE.Mesh(b,c),E.push(c.geometry),b=!0;else if("mesh"===k.type||"convex"===k.type)k.shape&&(k.v=a.prepaGeometry(k.shape,k.type),E.push(k.shape)),k.geometry?(c=new THREE.Mesh(k.geometry,c),E.push(k.geometry)):c=new THREE.Mesh(k.shape,c);else{if(k.geometry){if(k.geoRot||k.geoScale)k.geometry=k.geometry.clone();k.geoRot&&k.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(this.toRad(k.geoRot))));
k.geoScale&&k.geometry.applyMatrix((new THREE.Matrix4).makeScale(k.geoScale[0],k.geoScale[1],k.geoScale[2]))}c=0===k.mass&&"box"===k.type?new THREE.Mesh(k.geometry||G.hardbox,c):new THREE.Mesh(k.geometry||G[k.type],c);k.geometry&&(E.push(k.geometry),k.geoSize&&c.scale.fromArray(k.geoSize),!k.geoSize&&k.size&&c.scale.fromArray(k.size),b=!0)}c&&(b||c.scale.fromArray(k.size),c.position.fromArray(k.pos),c.quaternion.fromArray(k.quat),c.receiveShadow=!0,c.castShadow=!0,view.setName(k,c),void 0!==k.parent?
k.parent.add(c):l.add(c));k.shape&&delete k.shape;k.geometry&&delete k.geometry;k.material&&delete k.material;void 0===k.noPhy&&(c&&(k.mass?r.push(c):x.push(c)),ammo.send("add",k));if(c)return c}},getGeoByName:function(a,b){for(var c,d=G.length;d--;)a==G[d].name&&(c=G[d]);b&&(c=(new THREE.BufferGeometry).fromGeometry(c));return c},character:function(a){a.size=void 0==a.size?[0.25,2,2]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,
0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:this.toRad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var b=new THREE.CapsuleBufferGeometry(a.size[0],0.5*a.size[1],6),c=new THREE.Group;if(a.debug){var d=new THREE.Mesh(b,u.debug);E.push(b);c.add(d)}a.mesh?(u.hero.skinning=!0,a.mesh.material=u.hero,a.mesh.scale.multiplyScalar(a.scale||1),a.mesh.position.set(0,0,0),a.mesh.play(0),c.add(a.mesh),c.skin=a.mesh,E.push(c.skin.geometry)):(d=new THREE.Mesh(b,u.hero),
E.push(b),c.add(d));c.userData.speed=0;c.userData.type="hero";c.userData.id=I.length;c.position.fromArray(a.pos);c.quaternion.fromArray(a.quat);c.castShadow=!0;c.receiveShadow=!0;l.add(c);I.push(c);this.setName(a,c);a.mesh&&delete a.mesh;ammo.send("character",a)},vehicle:function(b){var c=b.size||[2,0.5,4],d=b.pos||[0,0,0],e=b.rot||[0,0,0],f=b.wPos||[1,0,1.6];b.masscenter=void 0==b.masscenter?[0,0,0]:b.masscenter;this.toRad(e);if(b.mesh)for(c=b.mesh,f=c.children.length;f--;)c.children[f].position.fromArray(b.masscenter).negate(),
c.children[f].castShadow=!0,c.children[f].receiveShadow=!0;else f=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(c[0],c[1],c[2])),f.translate(-b.masscenter[0],-b.masscenter[1],-b.masscenter[2]),E.push(f),c=new THREE.Mesh(f,u.move);c.position.set(d[0],d[1],d[2]);c.rotation.set(e[0],e[1],e[2]);b.quat=c.quaternion.toArray();c.castShadow=!0;c.receiveShadow=!0;l.add(c);this.setName(b,c);c.userData.speed=0;c.userData.steering=0;c.userData.NumWheels=b.nw||4;c.userData.type="car";var d=b.radius||
0.4,e=b.deep||0.3,f=b.wPos||[1,-0.25,1.6],g=[],h=void 0==b.wheel?!0:!1,n=b.wheel||G.wheel,m=n.clone();m.rotateY(Math.Pi);E.push(m);for(var p=b.nw||4;p--;)g[p]=1==p||2==p?new THREE.Mesh(n,u.move):new THREE.Mesh(m,u.move),h?g[p].scale.set(e,d,d):g[p].material=u.cars,g[p].castShadow=!0,g[p].receiveShadow=!0,l.add(g[p]);c.userData.w=g;b.helper&&(c.userData.helper=new THREE.CarHelper(f,b.masscenter,e),c.add(c.userData.helper));D.push(c);c.userData.id=D.length-1;b.mesh&&(b.mesh=null);b.wheel&&(b.wheel=
null);if("mesh"==b.type||"convex"==b.type)b.v=a.prepaGeometry(b.shape,b.type);b.shape&&delete b.shape;b.mesh&&delete b.mesh;ammo.send("vehicle",b)},softTriMesh:function(b){var c=b.shape.clone(),d=b.pos||[0,0,0],e=b.size||[1,1,1],f=b.rot||[0,0,0];c.translate(d[0],d[1],d[2]);c.scale(e[0],e[1],e[2]);c.applyMatrix((new THREE.Matrix4).makeRotationY(f[1]*=Math.torad));a.prepaGeometry(c);E.push(c);b.v=c.realVertices;b.i=c.realIndices;b.ntri=c.numFaces;c=new THREE.Mesh(c,void 0===b.material?u.cloth:u[b.material]);
c.castShadow=!0;c.receiveShadow=!0;c.softType=5;c.points=b.v.length/3;l.add(c);z.push(c);b.shape&&delete b.shape;b.material&&delete b.material;ammo.send("add",b)},softConvex:function(b){var c=b.shape,d=b.pos||[0,0,0];c.translate(d[0],d[1],d[2]);a.prepaGeometry(c);b.v=c.realVertices;c=new THREE.Mesh(c,u.cloth);c.castShadow=!0;c.receiveShadow=!0;c.softType=4;c.points=b.v.length/3;l.add(c);z.push(c);ammo.send("add",b)},cloth:function(a){var b=a.div||[16,16],c=a.size||[100,0,100],d=a.pos||[0,0,0],e=b[0]*
b[1],f=new THREE.PlaneBufferGeometry(c[0],c[2],b[0]-1,b[1]-1);f.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*e),3));f.rotateX(-Math.PI90);e=new THREE.Mesh(f,u.cloth);this.setName(a,e);e.position.set(d[0],d[1],d[2]);e.castShadow=!0;e.receiveShadow=!0;e.softType=1;e.points=f.attributes.position.array.length/3;l.add(e);z.push(e);a.size=c;a.div=b;a.pos=d;ammo.send("add",a)},rope:function(a){void 0===a.numSeg&&(a.numSeg=a.numSegment);var b=new THREE.Tubex(a,a.numSeg||10,a.radius||
0.2,a.numRad||6,!1),c=new THREE.Mesh(b,u.ball);this.setName(a,c);c.castShadow=!0;c.receiveShadow=!0;c.softType=2;c.points=b.positions.length;l.add(c);z.push(c);ammo.send("add",a)},ellipsoid:function(a){ammo.send("add",a)},ellipsoidMesh:function(a){var b=a.lng,c=[],d=a.a,e,f,g,h;for(e=0;e<b;e++)h=3*e,c.push(new THREE.Vector3(d[h],d[h+1],d[h+2]));var c=new THREE.ConvexGeometry(c),n=new Uint32Array(3*c.faces.length),m=new Float32Array(3*b),p=new Float32Array(b);g=c.vertices;for(e=b;e--;)for(f=b;f--;)h=
3*f,d[h]==g[e].x&&d[h+1]==g[e].y&&d[h+2]==g[e].z&&(p[f]=e);for(e=b;e--;)h=3*e,f=3*p[e],m[f]=d[h],m[f+1]=d[h+1],m[f+2]=d[h+2];for(e=c.faces.length;e--;)h=3*e,d=c.faces[e],n[h]=d.a,n[h+1]=d.b,n[h+2]=d.c;e=new THREE.BufferGeometry;e.setIndex(new THREE.BufferAttribute(n,1));e.addAttribute("position",new THREE.BufferAttribute(m,3));e.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*b),3));e.addAttribute("order",new THREE.BufferAttribute(p,1));e.computeVertexNormals();E.push(e);c.dispose();
b=new THREE.Mesh(e,u.ball);this.setName(a,b);b.softType=3;b.points=e.attributes.position.array.length/3;b.castShadow=!0;b.receiveShadow=!0;l.add(b);z.push(b)},terrain:function(a){var b,c,d,e;a.div=void 0==a.div?[64,64]:a.div;a.size=void 0==a.size?[100,10,100]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.dpos=void 0==a.dpos?[0,0,0]:a.dpos;a.complexity=void 0==a.complexity?30:a.complexity;a.lng=a.div[0]*a.div[1];a.hdata=new Float32Array(a.lng);Y||(Y=new Perlin);var f=1/a.complexity,g=1/a.div[0],h=(a.div[0]-
1)/a.size[0],n=(a.div[1]-1)/a.size[2],m=new Float32Array(3*a.lng),p=new THREE.PlaneBufferGeometry(a.size[0],a.size[2],a.div[0]-1,a.div[1]-1);p.rotateX(-Math.PI90);var q=p.attributes.position.array;for(b=a.lng;b--;)e=3*b,c=b%a.div[0],d=~~(b*g),c=0.5+0.5*Y.noise((c+a.dpos[0]*h)*f,(d+a.dpos[2]*n)*f),a.hdata[b]=c*a.size[1],q[e+1]=a.hdata[b],m[e]=c,m[e+1]=c,m[e+2]=c;p.addAttribute("color",new THREE.BufferAttribute(m,3));p.computeBoundingSphere();p.computeVertexNormals();E.push(p);b=new THREE.Mesh(p,u.terrain);
b.position.fromArray(a.pos);b.castShadow=!1;b.receiveShadow=!0;this.setName(a,b);l.add(b);B.push(b);ammo.send("add",a);H&&l.remove(H)},moveTerrain:function(a){},setName:function(a,b){void 0!==a.name&&(N[a.name]=b,b.name=a.name)},getByName:function(a){return N[a]||null},getBody:function(){return r},bodyStep:function(a,b){r.length&&r.forEach(function(c,d){var e=b+8*d,f=a[e];if(0<f)"sleep"==c.material.name&&(c.material=u.move),50<f&&"move"==c.material.name?c.material=u.movehigh:50>f&&"movehigh"==c.material.name&&
(c.material=u.move),c.position.fromArray(a,e+1),c.quaternion.fromArray(a,e+4);else if("move"==c.material.name||"movehigh"==c.material.name)c.material=u.sleep})},heroStep:function(a,b){I.length&&I.forEach(function(c,d){var e=b+8*d,f=3.33*a[e];c.userData.speed=100*f;c.position.fromArray(a,e+1);c.quaternion.fromArray(a,e+4);c.skin&&(0===f?c.skin.play(0,0.3):(c.skin.play(1,0.3),c.skin.setTimeScale(f)))})},carsStep:function(a,b){D.length&&D.forEach(function(c,d){var e=b+56*d;c.userData.speed=a[e];c.position.fromArray(a,
e+1);c.quaternion.fromArray(a,e+4);var f=c.userData.NumWheels,g;c.userData.helper&&4==f&&(g=40,c.userData.helper.updateSuspension(a[e+g+0],a[e+g+1],a[e+g+2],a[e+g+3]));for(;f--;)g=8*(f+1),c.userData.w[f].position.fromArray(a,e+g+1),c.userData.w[f].quaternion.fromArray(a,e+g+4)})},getSofts:function(){return z},softStep:function(a,b){if(z.length){var c=b;z.forEach(function(b,d){var e,f,g,h,l,n,m=b.geometry,p=b.softType,q=null,r=m.attributes.color?!0:!1,u=m.attributes.normal?!0:!1;if(2===p){for(l=m.positions.length;l--;)e=
c+3*l,m.positions[l].set(a[e],a[e+1],a[e+2]);m.updatePath()}else{if(!m.attributes.position)return;h=m.attributes.position.array;r&&(f=m.attributes.color.array);if(5===p||4===p){var t=m.numVertices,v=m.maxi,s=m.pPoint,w=m.lPoint;for(l=t;l--;)for(e=3*l+c,n=l==t-1?v-s[l]:s[l+1]-s[l],g=s[l];n--;)f=3*w[g+n],h[f]=a[e],h[f+1]=a[e+1],h[f+2]=a[e+2]}else if(m.attributes.order&&(q=m.attributes.order.array),l=h.length,e=2,null!==q)for(l=q.length;l--;)n=3*q[l],e=3*l+c,h[n]=a[e],h[n+1]=a[e+1],h[n+2]=a[e+2],g=Math.abs(a[e+
1]/10),f[n]=g,f[n+1]=g,f[n+2]=g;else for(;l--;)h[l]=a[l+c],1==e&&(g=Math.abs(h[l]/10),f[l-1]=g,f[l]=g,f[l+1]=g),e--,e=0>e?2:e;2!==p&&m.computeVertexNormals();if(u){e=m.attributes.normal.array;for(l=t;l--;)for(n=l==t-1?v-s[l]:s[l+1]-s[l],g=s[l],h=3*w[g];n--;)f=3*w[g+n],e[f]=e[h],e[f+1]=e[h+1],e[f+2]=e[h+2];m.attributes.normal.needsUpdate=!0}r&&(m.attributes.color.needsUpdate=!0);m.attributes.position.needsUpdate=!0;m.computeBoundingSphere()}c+=3*b.points})}},removeShadow:function(){X&&(X=!1,h.shadowMap.enabled=
!1,H&&l.remove(H))},hideGroundShadow:function(){H.visible=!1},setShadowPosY:function(a){Z=a;H&&(H.position.y=Z,H.visible=!0)},addShadow:function(){if(!X){X=!0;h.shadowMap.enabled=!0;h.shadowMap.soft=!0;h.shadowMap.type=THREE.PCFSoftShadowMap;h.shadowMap.renderReverseSided=!1;if(!B.length){var a=new THREE.ShaderMaterial(THREE.ShaderShadow);H=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200,1,1),a);H.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(0.5*-Math.PI));H.position.y=Z;H.castShadow=
!1;H.receiveShadow=!0;l.add(H)}R.castShadow=!0;a=new THREE.OrthographicCamera(70,-70,70,-70,25,170);R.shadow=new THREE.LightShadow(a);R.shadow.mapSize.width=1024;R.shadow.mapSize.height=1024}}}}();
