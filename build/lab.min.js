'use strict';var THREE,list,extensions,numDiv,data,TextDecoder,ammo,intro,UIL,esprima,CodeMirror,update,Br,Cr,Jr,Hr,Sr,demos,module,exports,process,define;var ARRAY8;ARRAY8||(ARRAY8="undefined"!==typeof Uint8Array?Uint8Array:Array);function Perlin(a){this.F2=0.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;a||(a=Math.random);this.p=new ARRAY8(256);this.perm=new ARRAY8(512);this.permMod12=new ARRAY8(512);for(var b=0;256>b;b++)this.p[b]=256*a();for(b=0;512>b;b++)this.perm[b]=this.p[b&255],this.permMod12[b]=this.perm[b]%12}
Perlin.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),noise:function(a,b){var c=this.permMod12,f=this.perm,d=this.grad3,h=0,g=0,k=0,l=(a+b)*this.F2,n=Math.floor(a+l),t=Math.floor(b+l),l=(n+t)*this.G2,u=a-(n-l),C=b-(t-l),v,e;u>C?(v=1,e=0):(v=0,e=1);var z=u-v+this.G2,x=C-e+this.G2,l=u-1+2*this.G2,p=C-1+2*this.G2,n=n&255,t=t&255,m=0.5-u*u-C*C;0<=m&&(h=3*c[n+f[t]],m*=m,h=m*m*(d[h]*u+d[h+1]*C));u=0.5-z*z-x*x;0<=u&&(g=3*c[n+v+f[t+
e]],u*=u,g=u*u*(d[g]*z+d[g+1]*x));z=0.5-l*l-p*p;0<=z&&(c=3*c[n+1+f[t+1]],z*=z,k=z*z*(d[c]*l+d[c+1]*p));return 70*(h+g+k)}};var TWEEN=TWEEN||function(){var a=[];return{getAll:function(){return a},removeAll:function(){a=[]},add:function(b){a.push(b)},remove:function(b){b=a.indexOf(b);-1!==b&&a.splice(b,1)},update:function(b,c){if(0===a.length)return!1;var f=0;for(b=void 0!==b?b:TWEEN.now();f<a.length;)a[f].update(b)||c?f++:a.splice(f,1);return!0}}}();
TWEEN.now="undefined"===typeof window&&"undefined"!==typeof process?function(){var a=process.hrtime();return 1E3*a[0]+a[1]/1E6}:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now.bind(window.performance):void 0!==Date.now?Date.now:function(){return(new Date).getTime()};
TWEEN.Tween=function(a){var b={},c={},f={},d=1E3,h=0,g,k=!1,l=!1,n=0,t=null,u=TWEEN.Easing.Linear.None,C=TWEEN.Interpolation.Linear,v=[],e=null,z=!1,x=null,p=null,m=null;this.to=function(a,e){c=a;void 0!==e&&(d=e);return this};this.start=function(e){TWEEN.add(this);l=!0;z=!1;t=void 0!==e?e:TWEEN.now();t+=n;for(var d in c){if(c[d]instanceof Array){if(0===c[d].length)continue;c[d]=[a[d]].concat(c[d])}void 0!==a[d]&&(b[d]=a[d],!1===b[d]instanceof Array&&(b[d]*=1),f[d]=b[d]||0)}return this};this.stop=
function(){if(!l)return this;TWEEN.remove(this);l=!1;null!==m&&m.call(a,a);this.stopChainedTweens();return this};this.end=function(){this.update(t+d);return this};this.stopChainedTweens=function(){for(var a=0,c=v.length;a<c;a++)v[a].stop()};this.delay=function(a){n=a;return this};this.repeat=function(a){h=a;return this};this.repeatDelay=function(a){g=a;return this};this.yoyo=function(a){k=a;return this};this.easing=function(a){u=a;return this};this.interpolation=function(a){C=a;return this};this.chain=
function(){v=arguments;return this};this.onStart=function(a){e=a;return this};this.onUpdate=function(a){x=a;return this};this.onComplete=function(a){p=a;return this};this.onStop=function(a){m=a;return this};this.update=function(l){var m,s,w;if(l<t)return!0;!1===z&&(null!==e&&e.call(a,a),z=!0);s=(l-t)/d;s=1<s?1:s;w=u(s);for(m in c)if(void 0!==b[m]){var A=b[m]||0,y=c[m];y instanceof Array?a[m]=C(y,w):("string"===typeof y&&(y="+"===y.charAt(0)||"-"===y.charAt(0)?A+parseFloat(y):parseFloat(y)),"number"===
typeof y&&(a[m]=A+(y-A)*w))}null!==x&&x.call(a,w);if(1===s)if(0<h){isFinite(h)&&h--;for(m in f)"string"===typeof c[m]&&(f[m]+=parseFloat(c[m])),k&&(s=f[m],f[m]=c[m],c[m]=s),b[m]=f[m];t=void 0!==g?l+g:l+n}else{null!==p&&p.call(a,a);l=0;for(m=v.length;l<m;l++)v[l].start(t+d);return!1}return!0}};
TWEEN.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?0.5*a*a:-0.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a:-0.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*
a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return 0.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?0.5*Math.pow(1024,a-1):0.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-
Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){return 0===a?0:1===a?1:-Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI)},Out:function(a){return 0===a?0:1===a?1:Math.pow(2,-10*a)*Math.sin(5*(a-0.1)*Math.PI)+1},InOut:function(a){if(0===a)return 0;if(1===a)return 1;a*=2;return 1>a?-0.5*Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI):0.5*Math.pow(2,-10*(a-1))*Math.sin(5*
(a-1.1)*Math.PI)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*(3.5949095*a-2.5949095):0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-TWEEN.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},InOut:function(a){return 0.5>a?0.5*TWEEN.Easing.Bounce.In(2*
a):0.5*TWEEN.Easing.Bounce.Out(2*a-1)+0.5}}};
TWEEN.Interpolation={Linear:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),h=TWEEN.Interpolation.Utils.Linear;return 0>b?h(a[0],a[1],f):1<b?h(a[c],a[c-1],c-f):h(a[d],a[d+1>c?c:d+1],f-d)},Bezier:function(a,b){for(var c=0,f=a.length-1,d=Math.pow,h=TWEEN.Interpolation.Utils.Bernstein,g=0;g<=f;g++)c+=d(1-b,f-g)*d(b,g)*a[g]*h(f,g);return c},CatmullRom:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),h=TWEEN.Interpolation.Utils.CatmullRom;return a[0]===a[c]?(0>b&&(d=Math.floor(f=c*(1+b))),h(a[(d-
1+c)%c],a[d],a[(d+1)%c],a[(d+2)%c],f-d)):0>b?a[0]-(h(a[0],a[0],a[1],a[1],-f)-a[0]):1<b?a[c]-(h(a[c],a[c],a[c-1],a[c-1],f-c)-a[c]):h(a[d?d-1:0],a[d],a[c<d+1?c:d+1],a[c<d+2?c:d+2],f-d)},Utils:{Linear:function(a,b,c){return(b-a)*c+a},Bernstein:function(a,b){var c=TWEEN.Interpolation.Utils.Factorial;return c(a)/c(b)/c(a-b)},Factorial:function(){var a=[1];return function(b){var c=1;if(a[b])return a[b];for(var f=b;1<f;f--)c*=f;return a[b]=c}}(),CatmullRom:function(a,b,c,f,d){a=0.5*(c-a);f=0.5*(f-b);var h=
d*d;return(2*b-2*c+a+f)*d*h+(-3*b+3*c-2*a-f)*h+a*d+b}}};(function(a){"function"===typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!==typeof module&&"object"===typeof exports?module.exports=TWEEN:void 0!==a&&(a.TWEEN=TWEEN)})(this);THREE.OrbitControls=function(a,b){function c(){return Math.pow(0.95,e.zoomSpeed)}function f(a){e.object instanceof THREE.PerspectiveCamera?A/=a:e.object instanceof THREE.OrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*a)),e.object.updateProjectionMatrix(),D=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function d(a){e.object instanceof THREE.PerspectiveCamera?A*=a:e.object instanceof THREE.OrthographicCamera?
(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/a)),e.object.updateProjectionMatrix(),D=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function h(a){if(!1!==e.enabled){a.preventDefault();if(a.button===e.mouseButtons.ORBIT){if(!1===e.enableRotate)return;F.set(a.clientX,a.clientY);r=m.ROTATE}else if(a.button===e.mouseButtons.ZOOM){if(!1===e.enableZoom)return;J.set(a.clientX,a.clientY);r=m.DOLLY}else if(a.button===
e.mouseButtons.PAN){if(!1===e.enablePan)return;N.set(a.clientX,a.clientY);r=m.PAN}r!==m.NONE&&(document.addEventListener("mousemove",g,!1),document.addEventListener("mouseup",k,!1),e.dispatchEvent(x))}}function g(a){!1!==e.enabled&&(a.preventDefault(),r===m.ROTATE?!1!==e.enableRotate&&(B.set(a.clientX,a.clientY),K.subVectors(B,F),a=e.domElement===document?e.domElement.body:e.domElement,w.theta-=2*Math.PI*K.x/a.clientWidth*e.rotateSpeed,w.phi-=2*Math.PI*K.y/a.clientHeight*e.rotateSpeed,F.copy(B),e.update()):
r===m.DOLLY?!1!==e.enableZoom&&(L.set(a.clientX,a.clientY),O.subVectors(L,J),0<O.y?f(c()):0>O.y&&d(c()),J.copy(L),e.update()):r===m.PAN&&!1!==e.enablePan&&(H.set(a.clientX,a.clientY),M.subVectors(H,N),q(M.x,M.y),N.copy(H),e.update()))}function k(a){!1!==e.enabled&&(document.removeEventListener("mousemove",g,!1),document.removeEventListener("mouseup",k,!1),e.dispatchEvent(p),r=m.NONE)}function l(a){!1===e.enabled||!1===e.enableZoom||r!==m.NONE&&r!==m.ROTATE||(a.preventDefault(),a.stopPropagation(),
0>a.deltaY?d(c()):0<a.deltaY&&f(c()),e.update(),e.dispatchEvent(x),e.dispatchEvent(p))}function n(a){if(!1!==e.enabled&&!1!==e.enableKeys&&!1!==e.enablePan)switch(a.keyCode){case e.keys.UP:q(0,e.keyPanSpeed);e.update();break;case e.keys.BOTTOM:q(0,-e.keyPanSpeed);e.update();break;case e.keys.LEFT:q(e.keyPanSpeed,0);e.update();break;case e.keys.RIGHT:q(-e.keyPanSpeed,0),e.update()}}function t(a){if(!1!==e.enabled){switch(a.touches.length){case 1:if(!1===e.enableRotate)return;F.set(a.touches[0].pageX,
a.touches[0].pageY);r=m.TOUCH_ROTATE;break;case 2:if(!1===e.enableZoom)return;var c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;c=Math.sqrt(c*c+a*a);J.set(0,c);r=m.TOUCH_DOLLY;break;case 3:if(!1===e.enablePan)return;N.set(a.touches[0].pageX,a.touches[0].pageY);r=m.TOUCH_PAN;break;default:r=m.NONE}r!==m.NONE&&e.dispatchEvent(x)}}function u(a){if(!1!==e.enabled)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:if(!1===e.enableRotate)break;if(r!==
m.TOUCH_ROTATE)break;B.set(a.touches[0].pageX,a.touches[0].pageY);K.subVectors(B,F);var b=e.domElement===document?e.domElement.body:e.domElement;w.theta-=2*Math.PI*K.x/b.clientWidth*e.rotateSpeed;w.phi-=2*Math.PI*K.y/b.clientHeight*e.rotateSpeed;F.copy(B);e.update();break;case 2:if(!1===e.enableZoom)break;if(r!==m.TOUCH_DOLLY)break;b=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;b=Math.sqrt(b*b+a*a);L.set(0,b);O.subVectors(L,J);0<O.y?d(c()):0>O.y&&f(c());J.copy(L);
e.update();break;case 3:if(!1===e.enablePan)break;if(r!==m.TOUCH_PAN)break;H.set(a.touches[0].pageX,a.touches[0].pageY);M.subVectors(H,N);q(M.x,M.y);N.copy(H);e.update();break;default:r=m.NONE}}function C(a){!1!==e.enabled&&(e.dispatchEvent(p),r=m.NONE)}function v(a){a.preventDefault()}this.object=a;this.domElement=void 0!==b?b:document;this.enabled=!0;this.target=new THREE.Vector3;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.minPolarAngle=0;this.maxPolarAngle=
Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=!1;this.dampingFactor=0.25;this.enableZoom=!0;this.zoomSpeed=1;this.enableRotate=!0;this.rotateSpeed=1;this.enablePan=!0;this.keyPanSpeed=7;this.autoRotate=!1;this.autoRotateSpeed=2;this.enableKeys=!0;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=
this.object.zoom;this.getPolarAngle=function(){return s.phi};this.getAzimuthalAngle=function(){return s.theta};this.reset=function(){e.target.copy(e.target0);e.object.position.copy(e.position0);e.object.zoom=e.zoom0;e.object.updateProjectionMatrix();e.dispatchEvent(z);e.update();r=m.NONE};this.update=function(){var c=new THREE.Vector3,b=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),d=b.clone().inverse(),f=new THREE.Vector3,h=new THREE.Quaternion;return function(){var a=
e.object.position;c.copy(a).sub(e.target);c.applyQuaternion(b);s.setFromVector3(c);e.autoRotate&&r===m.NONE&&(w.theta-=2*Math.PI/60/60*e.autoRotateSpeed);s.theta+=w.theta;s.phi+=w.phi;s.theta=Math.max(e.minAzimuthAngle,Math.min(e.maxAzimuthAngle,s.theta));s.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,s.phi));s.makeSafe();s.radius*=A;s.radius=Math.max(e.minDistance,Math.min(e.maxDistance,s.radius));e.target.add(y);c.setFromSpherical(s);c.applyQuaternion(d);a.copy(e.target).add(c);e.object.lookAt(e.target);
!0===e.enableDamping?(w.theta*=1-e.dampingFactor,w.phi*=1-e.dampingFactor):w.set(0,0,0);A=1;y.set(0,0,0);return D||f.distanceToSquared(e.object.position)>E||8*(1-h.dot(e.object.quaternion))>E?(e.dispatchEvent(z),f.copy(e.object.position),h.copy(e.object.quaternion),D=!1,!0):!1}}();this.dispose=function(){e.domElement.removeEventListener("contextmenu",v,!1);e.domElement.removeEventListener("mousedown",h,!1);e.domElement.removeEventListener("wheel",l,!1);e.domElement.removeEventListener("touchstart",
t,!1);e.domElement.removeEventListener("touchend",C,!1);e.domElement.removeEventListener("touchmove",u,!1);document.removeEventListener("mousemove",g,!1);document.removeEventListener("mouseup",k,!1);window.removeEventListener("keydown",n,!1)};var e=this,z={type:"change"},x={type:"start"},p={type:"end"},m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},r=m.NONE,E=1E-6,s=new THREE.Spherical,w=new THREE.Spherical,A=1,y=new THREE.Vector3,D=!1,F=new THREE.Vector2,B=new THREE.Vector2,
K=new THREE.Vector2,N=new THREE.Vector2,H=new THREE.Vector2,M=new THREE.Vector2,J=new THREE.Vector2,L=new THREE.Vector2,O=new THREE.Vector2,U=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,0);a.multiplyScalar(-c);y.add(a)}}(),G=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,1);a.multiplyScalar(c);y.add(a)}}(),q=function(){var a=new THREE.Vector3;return function(c,b){var d=e.domElement===document?e.domElement.body:e.domElement;if(e.object instanceof
THREE.PerspectiveCamera){a.copy(e.object.position).sub(e.target);var f=a.length(),f=f*Math.tan(e.object.fov/2*Math.PI/180);U(2*c*f/d.clientHeight,e.object.matrix);G(2*b*f/d.clientHeight,e.object.matrix)}else e.object instanceof THREE.OrthographicCamera?(U(c*(e.object.right-e.object.left)/e.object.zoom/d.clientWidth,e.object.matrix),G(b*(e.object.top-e.object.bottom)/e.object.zoom/d.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),
e.enablePan=!1)}}();e.domElement.addEventListener("contextmenu",v,!1);e.domElement.addEventListener("mousedown",h,!1);e.domElement.addEventListener("wheel",l,!1);e.domElement.addEventListener("touchstart",t,!1);e.domElement.addEventListener("touchend",C,!1);e.domElement.addEventListener("touchmove",u,!1);window.addEventListener("keydown",n,!1);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;
Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){console.warn("THREE.OrbitControls: .center has been renamed to .target");return this.target}},noZoom:{get:function(){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");return!this.enableZoom},set:function(a){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");this.enableZoom=!a}},noRotate:{get:function(){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");
return!this.enableRotate},set:function(a){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");this.enableRotate=!a}},noPan:{get:function(){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");return!this.enablePan},set:function(a){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");this.enablePan=!a}},noKeys:{get:function(){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");
return!this.enableKeys},set:function(a){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");this.enableKeys=!a}},staticMoving:{get:function(){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");return!this.enableDamping},set:function(a){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");this.enableDamping=!a}},dynamicDampingFactor:{get:function(){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");
return this.dampingFactor},set:function(a){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");this.dampingFactor=a}}});THREE.CapsuleBufferGeometry=function(a,b,c,f){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var d=a||1;b=b||1;var h=c||12,g=0.5*~~h;a=f||1;var k=2*Math.PI,l=0.5*Math.PI;f=new THREE.Geometry;a=new THREE.CylinderGeometry(d,d,b,h,a,!0);var n=new THREE.SphereGeometry(d,h,g,0,k,0,l),d=new THREE.SphereGeometry(d,h,g,0,k,l,l),h=(new THREE.Matrix4).makeTranslation(0,0,0);6===c&&h.makeRotationY(0.5235987755982988);c=(new THREE.Matrix4).makeTranslation(0,0.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,
0.5*-b,0);f.merge(a,h);f.merge(n,c);f.merge(d,b);f.mergeVertices();this.fromGeometry(f)};THREE.CapsuleBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CapsuleBufferGeometry.prototype.constructor=THREE.CapsuleBufferGeometry;THREE.ConvexGeometry=function(a){function b(c){var b=a[c].clone(),d=b.length();b.x+=2E-6*d*(Math.random()-0.5);b.y+=2E-6*d*(Math.random()-0.5);b.z+=2E-6*d*(Math.random()-0.5);for(var d=[],h=0;h<f.length;){var g=f[h],e=b,k=a[g[0]],l;l=k;var p=a[g[1]],m=a[g[2]],r=new THREE.Vector3,E=new THREE.Vector3;r.subVectors(m,p);E.subVectors(l,p);r.cross(E);r.normalize();l=r;k=l.dot(k);if(l.dot(e)>=k){for(e=0;3>e;e++){k=[g[e],g[(e+1)%3]];l=!0;for(p=0;p<d.length;p++)if(m=d[p],m[0]===k[1]&&m[1]===k[0]){d[p]=d[d.length-
1];d.pop();l=!1;break}l&&d.push(k)}f[h]=f[f.length-1];f.pop()}else h++}for(p=0;p<d.length;p++)f.push([d[p][0],d[p][1],c])}function c(a){var c=a.length();return new THREE.Vector2(a.x/c,a.y/c)}THREE.Geometry.call(this);for(var f=[[0,1,2],[0,2,1]],d=3;d<a.length;d++)b(d);for(var h=0,g=Array(a.length),d=0;d<f.length;d++)for(var k=f[d],l=0;3>l;l++)void 0===g[k[l]]&&(g[k[l]]=h++,this.vertices.push(a[k[l]])),k[l]=g[k[l]];for(d=0;d<f.length;d++)this.faces.push(new THREE.Face3(f[d][0],f[d][1],f[d][2]));for(d=
0;d<this.faces.length;d++)k=this.faces[d],this.faceVertexUvs[0].push([c(this.vertices[k.a]),c(this.vertices[k.b]),c(this.vertices[k.c])]);this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry.prototype.constructor=THREE.ConvexGeometry;THREE.Tubex=function(a,b,c,f,d,h){THREE.BufferGeometry.call(this);this.type="Tubex";this.tubularSegments=b||64;this.radius=c||1;this.radialSegments=f||8;this.closed=d||!1;if(a instanceof Array)this.positions=a;else{this.positions=[];b=(new THREE.Vector3).fromArray(a.start);c=(new THREE.Vector3).fromArray(a.end);f=c.clone().sub(b);a=a.numSegment-1;this.positions.push(b);for(d=1;d<a;d++)this.positions.push((new THREE.Vector3(f.x/a*d,f.y/a*d,f.z/a*d)).add(b));this.positions.push(c)}this.path=new THREE.CatmullRomCurve3(this.positions);
this.path.type=h||"catmullrom";this.path.closed=this.closed;this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.vertex=new THREE.Vector3;this.normal=new THREE.Vector3;this.uv=new THREE.Vector2;this.vertices=[];this.normals=[];this.uvs=[];this.indices=[];this.generateBufferData();this.setIndex(new (65535<this.indices.length?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(this.indices,1));this.addAttribute("position",new THREE.Float32BufferAttribute(this.vertices,
3));this.addAttribute("normal",new THREE.Float32BufferAttribute(this.normals,3));this.addAttribute("uv",new THREE.Float32BufferAttribute(this.uvs,2))};THREE.Tubex.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.Tubex.prototype.constructor=THREE.Tubex;THREE.Tubex.prototype.generateBufferData=function(){for(var a=0;a<this.tubularSegments;a++)this.generateSegment(a);this.generateSegment(!1===this.closed?this.tubularSegments:0);this.generateIndicesAndUv()};
THREE.Tubex.prototype.generateSegment=function(a){var b=this.path.getPointAt(a/this.tubularSegments),c=this.frames.normals[a];a=this.frames.binormals[a];for(var f=0;f<=this.radialSegments;f++){var d=f/this.radialSegments*Math.PI*2,h=Math.sin(d),d=-Math.cos(d);this.normal.x=d*c.x+h*a.x;this.normal.y=d*c.y+h*a.y;this.normal.z=d*c.z+h*a.z;this.normal.normalize();this.normals.push(this.normal.x,this.normal.y,this.normal.z);this.vertex.x=b.x+this.radius*this.normal.x;this.vertex.y=b.y+this.radius*this.normal.y;
this.vertex.z=b.z+this.radius*this.normal.z;this.vertices.push(this.vertex.x,this.vertex.y,this.vertex.z)}};
THREE.Tubex.prototype.generateIndicesAndUv=function(){for(var a=0;a<=this.tubularSegments;a++)for(var b=0;b<=this.radialSegments;b++){if(0<b&&0<a){var c=(this.radialSegments+1)*a+(b-1),f=(this.radialSegments+1)*a+b,d=(this.radialSegments+1)*(a-1)+b;this.indices.push((this.radialSegments+1)*(a-1)+(b-1),c,d);this.indices.push(c,f,d)}this.uv.x=a/this.tubularSegments;this.uv.y=b/this.radialSegments;this.uvs.push(this.uv.x,this.uv.y)}};
THREE.Tubex.prototype.updatePath=function(a){this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.normals=this.attributes.normal.array;this.vertices=this.attributes.position.array;for(a=0;a<this.tubularSegments;a++)this.updateSegment(a);this.updateSegment(!1===this.closed?this.tubularSegments:0);this.attributes.position.needsUpdate=!0;this.attributes.normal.needsUpdate=!0};
THREE.Tubex.prototype.updateUV=function(){this.uvs=this.attributes.uv.array;for(var a,b,c=0;c<=this.tubularSegments;c++){a=2*c*(this.radialSegments+1);for(var f=0;f<=this.radialSegments;f++)b=2*f,this.uv.x=c/this.tubularSegments,this.uv.y=f/this.radialSegments,this.uvs[a+b]=this.uv.x,this.uvs[a+b+1]=this.uv.y}this.attributes.uv.needsUpdate=!0};
THREE.Tubex.prototype.updateSegment=function(a){for(var b=3*a*(this.radialSegments+1),c=this.path.getPointAt(a/this.tubularSegments),f=this.frames.normals[a],d=this.frames.binormals[a],h=0;h<=this.radialSegments;h++){var g=h/this.radialSegments*Math.PI*2;a=3*h;var k=Math.sin(g),g=-Math.cos(g);this.normal.x=g*f.x+k*d.x;this.normal.y=g*f.y+k*d.y;this.normal.z=g*f.z+k*d.z;this.normal.normalize();this.normals[b+a]=this.normal.x;this.normals[b+a+1]=this.normal.y;this.normals[b+a+2]=this.normal.z;this.vertices[b+
a]=c.x+this.radius*this.normal.x;this.vertices[b+a+1]=c.y+this.radius*this.normal.y;this.vertices[b+a+2]=c.z+this.radius*this.normal.z}};THREE.ShaderShadow={uniforms:Object.assign({},THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(15658734)},specular:{value:new THREE.Color(1118481)},emissive:{value:new THREE.Color(0)},opacity:{value:0.4}}),fragmentShader:["uniform float opacity;\nvarying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.packing,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.shadowmask_pars_fragment,"void main() {\n   float mask = getShadowMask();\n   vec4 pp = vec4(1.0);\n   vec4 mapping = vec4( pp.rgb, pp.a * opacity );\n   vec4 shadowing = vec4( vec3(0.0), opacity * (1.0 - mask) );\n   gl_FragColor = mix( mapping, shadowing, 1.0 - mask );\n   gl_FragColor = shadowing;\n}"].join("\n"),
vertexShader:["varying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvUv = uv;\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),lights:!0,transparent:!0};THREE.CarHelper=function(a){this.py=a[1];a=new Float32Array([-0.2,0,0,0.2,0,0,0,0,0,0,0.4,0,0,0,-0.2,0,0,0.2,0.5*a[0],a[1],a[2],0.5*a[0],a[1]+1,a[2],0.5*-a[0],a[1],a[2],0.5*-a[0],a[1]+1,a[2],0.5*-a[0],a[1],-a[2],0.5*-a[0],a[1]+1,-a[2],0.5*a[0],a[1],-a[2],0.5*a[0],a[1]+1,-a[2]]);var b=new Float32Array([1,1,0,1,1,0,1,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0]);this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(a,3));this.geometry.addAttribute("color",
new THREE.BufferAttribute(b,3));this.positions=this.geometry.attributes.position.array;this.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,name:"helper"});THREE.LineSegments.call(this,this.geometry,this.material)};THREE.CarHelper.prototype=Object.create(THREE.LineSegments.prototype);THREE.CarHelper.prototype.constructor=THREE.CarHelper;THREE.CarHelper.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};
THREE.CarHelper.prototype.updateSuspension=function(a,b,c,f){this.positions[22]=this.py-a;this.positions[28]=this.py-b;this.positions[34]=this.py-c;this.positions[40]=this.py-f;this.geometry.attributes.position.needsUpdate=!0};THREE.Terrain=function(a,b){a=void 0==a?{}:a;this.div=void 0==a.div?[64,64]:a.div;this.size=void 0==a.size?[100,10,100]:a.size;this.colorBase={r:1,g:0.7,b:0};this.complexity=void 0==a.complexity?30:a.complexity;this.complexity2=void 0==a.complexity2?60:a.complexity2;this.local=new THREE.Vector3;a.local&&this.local.fromArray(a.local);this.lng=this.div[0]*this.div[1];this.hdata=new Float32Array(this.lng);this.perlin=void 0==b?new Perlin:b;this.colors=new Float32Array(3*this.lng);this.geometry=new THREE.PlaneBufferGeometry(this.size[0],
this.size[2],this.div[0]-1,this.div[1]-1);this.geometry.rotateX(0.5*-Math.PI);this.geometry.computeBoundingSphere();this.geometry.addAttribute("color",new THREE.BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.material=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,name:"terrain",metalness:1,roughness:0.3,wireframe:!1});this.update();THREE.Mesh.call(this,this.geometry,this.material);this.castShadow=!1;this.receiveShadow=!0};
THREE.Terrain.prototype=Object.create(THREE.Mesh.prototype);THREE.Terrain.prototype.constructor=THREE.Terrain;THREE.Terrain.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.Terrain.prototype.setEnvMap=function(a){this.material.envMap=a};THREE.Terrain.prototype.move=function(){this.update()};THREE.Terrain.prototype.clamp=function(a,b,c){a=a<b?b:a;return a>c?c:a};THREE.Terrain.prototype.norm=function(a,b,c){return(a-b)/(c-b)};
THREE.Terrain.prototype.linear=function(a,b,c){return(1-a)*b+a*c};THREE.Terrain.prototype.cubicSCurve=function(a){return a*a*(3-2*a)};THREE.Terrain.prototype.quinticSCurve=function(a){var b=a*a*a,c=b*a;return 6*c*a-15*c+10*b};
THREE.Terrain.prototype.update=function(){for(var a=1/this.complexity,b=1/this.complexity2,c=1/this.div[0],f=(this.div[0]-1)/this.size[0],d=(this.div[1]-1)/this.size[2],h=this.lng,g,k,l,n;h--;)g=3*h,k=h%this.div[0],l=~~(h*c),n=0.5+0.5*this.perlin.noise((k+this.local.x*f)*a,(l+this.local.z*d)*a),k=0.5+0.5*this.perlin.noise((k+100+this.local.x*f)*b,(l+100+this.local.z*d)*b),n=Math.min(n,k),n=this.linear(n,0,0.7),n=this.quinticSCurve(n),this.hdata[h]=n*this.size[1],this.vertices[g+1]=this.hdata[h],this.colors[g]=
n*this.colorBase.r,this.colors[g+1]=n*this.colorBase.g,this.colors[g+2]=n*this.colorBase.b;this.geometry.attributes.position.needsUpdate=!0;this.geometry.attributes.color.needsUpdate=!0;this.geometry.computeVertexNormals()};THREE.ViewUtils={mergeGeometryArray:function(a){for(var b=[],c=a.length;c--;)b[c]=(new THREE.Geometry).fromBufferGeometry(a[c]);for(a=new THREE.Geometry;0<b.length;)c=b.pop(),a.merge(c),c.dispose();a.mergeVertices();b=(new THREE.BufferGeometry).fromGeometry(a);a.dispose();return b},prepaGeometry:function(a,b){var c=!1,f=!1;"mesh"==b&&(f=!0);"convex"==b&&(c=!0);var d,h,g,k=(new THREE.Geometry).fromBufferGeometry(a);k.mergeVertices();var l=a.attributes.position.array.length/3,n=k.vertices.length,t=
k.faces.length;a.realVertices=new Float32Array(3*n);a.realIndices=new (65535<3*t?Uint32Array:Uint16Array)(3*t);for(d=n;d--;)g=k.vertices[d],h=3*d,a.realVertices[h]=g.x,a.realVertices[h+1]=g.y,a.realVertices[h+2]=g.z;if(c)return k.dispose(),a.realVertices;for(d=t;d--;)g=k.faces[d],h=3*d,a.realIndices[h]=g.a,a.realIndices[h+1]=g.b,a.realIndices[h+2]=g.c;k.dispose();if(f){l=[];for(d=a.realIndices.length;d--;)h=3*d,g=3*a.realIndices[d],l[h]=a.realVertices[g],l[h+1]=a.realVertices[g+1],l[h+2]=a.realVertices[g+
2];return l}f=[];k=a.attributes.position.array;for(d=n;d--;)for(h=3*d,f[d]=[],c=l;c--;)g=3*c,k[g]==a.realVertices[h]&&k[g+1]==a.realVertices[h+1]&&k[g+2]==a.realVertices[h+2]&&f[d].push(c);var k=new (65535<n?Uint32Array:Uint16Array)(n),u=new (65535<l?Uint32Array:Uint16Array)(l);for(d=g=0;d<n;d++){h=f[d].length;k[d]=g;for(c=h;c--;)u[g+c]=f[d][c];g+=h}a.numFaces=t;a.numVertices=n;a.maxi=l;a.pPoint=k;a.lPoint=u}};var user=function(){var a=new Float32Array(20),b;user={init:function(c){b=new user.Gamepad(a);document.addEventListener("keydown",user.keyDown,!1);document.addEventListener("keyup",user.keyUp,!1)},update:function(a){b.update();b.ready&&b.getValue(0)},keyDown:function(c){if(!editor.getFocus()){c=c||window.event;switch(c.which){case 65:case 81:a[0]=-1;break;case 68:a[0]=1;break;case 87:case 90:a[1]=-1;break;case 83:a[1]=1;break;case 37:a[2]=-1;break;case 39:a[2]=1;break;case 38:a[3]=-1;break;case 40:a[3]=
1;break;case 17:case 67:a[5]=1;break;case 69:a[5]=1;break;case 32:a[4]=1;break;case 16:a[7]=1;break;case 71:view.hideGrid()}b.reset()}},keyUp:function(c){if(!editor.getFocus())switch(c=c||window.event,c.which){case 65:case 81:a[0]=0>a[0]?0:a[0];break;case 68:a[0]=0<a[0]?0:a[0];break;case 87:case 90:a[1]=0>a[1]?0:a[1];break;case 83:a[1]=0<a[1]?0:a[1];break;case 37:a[2]=0>a[2]?0:a[2];break;case 39:a[2]=0<a[2]?0:a[2];break;case 38:a[3]=0>a[3]?0:a[3];break;case 40:a[3]=0<a[3]?0:a[3];break;case 17:case 67:a[5]=
0;break;case 69:a[5]=0;break;case 32:a[4]=0;break;case 16:a[7]=0}},getKey:function(){return a},Gamepad:function(a){this.values=[];this.key=a;this.ready=0}};user.Gamepad.prototype={update:function(){var a,b,d,h,g,k,l=this.fix,n=navigator.getGamepads();for(a=0;a<n.length;a++)if(k=n[a])if(d=k.axes.length,h=k.buttons.length){this.values[a]||(this.values[a]=[]);for(b=0;b<d;b++)g=l(k.axes[b],0.08),0==this.ready&&0!==g&&(this.ready=1),this.values[a][b]=g;for(b=0;b<h;b++)g=l(k.buttons[b].value),0==this.ready&&
0!==g&&(this.ready=1),this.values[a][d+b]=g}else this.values[a]&&(this.values[a]=null)},getValue:function(a){for(var b=19,d;b--;)d=this.values[a][b],0==this.ready&&0!==d&&(this.ready=1),this.key[b]=d},reset:function(){this.ready=0},fix:function(a,b){var d=Number(a.toString().substring(0,5));b&&d<b&&d>-b&&(d=0);return d}};return user}();var gui=function(){var a;return gui={init:function(){a=document.createElement("div");document.body.appendChild(a)},initJoysticks:function(){UIL.add("joystick",{target:a,pos:{left:"auto",right:"100px",top:"auto",bottom:"10px"},name:"JOY",width:100,multiplicator:1,precision:2,fontColor:"#D4B87B"})}}}();var now;(function(a){var b,c=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var f=0;f<c.length;++f){var d=c[f];if(a.performance[d]){b=function(){return a.performance[d]()};break}}b||(b=Date.now);now=b})(window);var editor=function(){var a,b,c,f,d,h,g,k=function(){},l=!1,n=!1,t=[],u=[],C=null,v=0,e=0,z="",x,p=[],m,r=!1,E=!0,s=!1,w,A;editor=function(){};editor.init=function(e,m){e&&(k=e);E=m||!1;x=document.createElement("div");x.className="bigmenu";document.body.appendChild(x);this.makeBigMenu();var p=document.createElement("div");p.style.cssText="position:absolute; right:0; top:0; width:1px; height:1px; pointer-events:none;";p.innerHTML="<svg width='80' height='80' viewBox='0 0 250 250' style='fill:rgba(255,255,255,0.2); color:#2B2A2D; position: absolute; top: 0; border: 0; right: 0;'>\n<path d='M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z' id='octo' onmouseover='editor.Gover();' onmouseout='editor.Gout();' onmousedown='editor.Gdown();'></path>\n<path d='M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2' fill='currentColor' style='transform-origin: 130px 106px;' id='octo-arm'></path>\n<path d='M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z' fill='currentColor' id='octo-body'></path></svg>";
document.body.appendChild(p);w=document.getElementById("octo");A=document.getElementById("octo-arm");h=document.createElement("div");h.className="debug";document.body.appendChild(h);g=document.createElement("div");g.className="title";document.body.appendChild(g);a=document.createElement("div");a.className="editor";document.body.appendChild(a);b=document.createElement("div");b.className="codeContent";a.appendChild(b);c=CodeMirror(b,{lineNumbers:!0,matchBrackets:!0,indentWithTabs:!1,styleActiveLine:!0,
theme:"monokai",mode:"text/javascript",tabSize:4,indentUnit:4,highlightSelectionMatches:{showToken:/\w/}});f=document.createElement("div");f.className="separator";document.body.appendChild(f);d=document.createElement("div");d.className="menuCode";a.appendChild(d);a.style.display="none";f.style.display="none";c.on("change",function(){editor.onChange()});c.on("focus",function(){n=!0;view.needFocus()});c.on("blur",function(){n=!1});c.on("drop",function(){l?l=!1:c.setValue("")});c.on("dragstart",function(){l=
!0});E&&(v=~~(0.4*window.innerWidth),a.style.display="block",f.style.display="block",this.addSeparatorEvent(),this.resize());x.style.width=window.innerWidth-v+"px"};editor.addSeparatorEvent=function(){f.addEventListener("mouseover",editor.mid_over,!1);f.addEventListener("mouseout",editor.mid_out,!1);f.addEventListener("mousedown",editor.mid_down,!1)};editor.removeSeparatorEvent=function(){f.removeEventListener("mouseover",editor.mid_over,!1);f.removeEventListener("mouseout",editor.mid_out,!1);f.removeEventListener("mousedown",
editor.mid_down,!1)};editor.selectCode=function(){E?editor.hide():editor.show()};editor.hide=function(){E=!1;a.style.display="none";f.style.display="none";e=v;v=0;this.removeSeparatorEvent();editor.Bdefault(p[1]);editor.resize()};editor.show=function(){E=!0;a.style.display="block";f.style.display="block";v=e?e:~~(0.4*window.innerWidth);this.addSeparatorEvent();editor.resize()};editor.resizeMenu=function(a){x&&(x.style.width=a+"px")};editor.resize=function(b){b&&(v=b.clientX+10);view&&(view.setLeft(v),
view.resize());x.style.left=v+"px";g.style.left=v+"px";h.style.left=v+"px";f.style.left=v-10+"px";a.style.width=v-10+"px";c.refresh()};editor.tell=function(a){h.innerHTML=a};editor.makeBigMenu=function(){x.style.width=window.innerWidth-v+"px";p[0]=document.createElement("div");p[0].className="bigButton";x.appendChild(p[0]);p[0].innerHTML="DEMO";p[0].addEventListener("mousedown",editor.selectBigMenu,!1);p[0].name="demo";p[1]=document.createElement("div");p[1].className="bigButton";x.appendChild(p[1]);
p[1].innerHTML="CODE";p[1].addEventListener("mousedown",editor.selectCode,!1);p[1].name="code";m=document.createElement("div");m.className="bigContent";x.appendChild(m);for(var a=p.length;a--;)p[a].addEventListener("mouseover",editor.Bover,!1),p[a].addEventListener("mouseout",editor.Bout,!1)};editor.selectBigMenu=function(a){r?editor.hideBigMenu():editor.showBigMenu()};editor.showBigMenu=function(a){x.style.background="#242424";x.style.borderBottom="1px solid #5c5c5c";r=!0;a=demos.length;for(var b,
c=0;c<a;c++)b=demos[c],b!==z&&editor.addButtonBig(demos[c])};editor.hideBigMenu=function(a){x.style.background="rgba(0,0,0,0)";x.style.borderBottom="1px solid rgba(255, 255, 255, 0)";r=!1;a=m.childNodes.length;for(var b;a--;)b=m.childNodes[a],b.removeEventListener("mousedown",editor.bigDown),m.removeChild(b);editor.Bdefault(p[0])};editor.addButtonBig=function(a){var b=document.createElement("div");b.className="menuButtonBig";m.appendChild(b);b.innerHTML="&bull; "+a.charAt(0).toUpperCase()+a.substring(1).toLowerCase();
b.name=a;b.addEventListener("mousedown",editor.bigDown,!1)};editor.bigDown=function(a){editor.hideBigMenu();editor.load("demos/"+a.target.name+".js")};editor.Bover=function(a){a.target.style.border="1px solid #308AFF";a.target.style.background="#308AFF";a.target.style.color="#c2d0ff"};editor.Bout=function(a){var b=0;"code"==a.target.name&&E&&(b=1);"demo"==a.target.name&&r&&(b=1);b?(a.target.style.border="1px solid #5c5c5c",a.target.style.background="#5c5c5c",a.target.style.color="#999999"):editor.Bdefault(a.target)};
editor.Bdefault=function(a){a.style.border="1px solid #5c5c5c";a.style.background="#242424";a.style.color="#dedede"};editor.Gover=function(){w.setAttribute("fill","#105AE2");A.style.webkitAnimationName="octocat-wave";A.style.webkitAnimationDuration="560ms"};editor.Gout=function(){w.setAttribute("fill","rgba(255,255,255,0.2)");A.style.webkitAnimationName="none"};editor.Gdown=function(){window.location.assign("https://github.com/lo-th/Ammo.lab")};editor.mid_over=function(){f.style.background="#5c5c5c"};
editor.mid_out=function(){s||(f.style.background="none")};editor.mid_down=function(){s=!0;document.addEventListener("mouseup",editor.mid_up,!1);document.addEventListener("mousemove",editor.resize,!1)};editor.mid_up=function(){s=!1;document.removeEventListener("mouseup",editor.mid_up,!1);document.removeEventListener("mousemove",editor.resize,!1)};editor.load=function(a){z=a.substring(a.indexOf("/")+1,a.indexOf("."));var b=new XMLHttpRequest;b.overrideMimeType("text/plain; charset=x-user-defined");
b.open("GET",a,!0);b.onload=function(){c.setValue(b.responseText)};b.send()};editor.unFocus=function(){c.getInputField().blur();view.haveFocus()};editor.refresh=function(){c.refresh()};editor.getFocus=function(){return n};editor.validate=function(a){return c.operation(function(){for(;0<t.length;)c.removeLineClass(t.shift(),"background","errorLine");for(var b=u.length;b--;)c.removeLineWidget(u[b]);u.length=0;try{for(var d=esprima.parse(a,{tolerant:!0}).errors,b=d.length;b--;){var e=d[b],f=document.createElement("div");
f.className="esprima-error";f.textContent=e.message.replace(/Line [0-9]+: /,"");var h=e.lineNumber-1;t.push(h);c.addLineClass(h,"background","errorLine");var g=c.addLineWidget(h,f);u.push(g)}}catch(k){f=document.createElement("div"),f.className="esprima-error",f.textContent=k.message.replace(/Line [0-9]+: /,""),h=k.lineNumber-1,t.push(h),c.addLineClass(h,"background","errorLine"),g=c.addLineWidget(h,f),u.push(g)}return 0===t.length})};editor.onChange=function(){clearTimeout(C);var a=c.getValue();
this.validate(a)&&(C=setTimeout(function(){editor.inject(a)},500))};editor.inject=function(a){var b=document.createElement("script");b.language="javascript";b.type="text/javascript";b.text=a;document.getElementsByTagName("BODY").item(0).appendChild(b);d.innerHTML="&bull; "+z;g.innerHTML=z.charAt(0).toUpperCase()+z.substring(1).toLowerCase();k(z)};return editor}();Math.torad=0.017453292519943295;Math.todeg=57.29577951308232;Math.degtorad=0.017453292519943295;Math.radtodeg=57.29577951308232;Math.Pi=3.141592653589793;Math.TwoPI=6.283185307179586;Math.PI90=1.570796326794896;Math.PI270=4.712388980384689;Math.lerp=function(a,b,c){return a+(b-a)*c};Math.rand=function(a,b){return Math.lerp(a,b,Math.random())};Math.randInt=function(a,b,c){return 1*Math.lerp(a,b,Math.random()).toFixed(c||0)};Math.int=function(a){return~~a};
var view=function(){var a=0,b=0,c=0,f=0,d=!0,h,g,k,l,n,t,u,C,v,e,z,x=!1,p=1,m=1,r=0,E,s=[],w=[],A=[],y=[],D=[],F=[],B=[],K={},N=!1,H=null,M,J=0,L=0,O=0,U=0,G,q,R=[],Z=null,$={},aa,V=!1,I,Q,ba,X=-0.01,W=null,ca,P=1,S=!0,Y="wireframe ceramic plastic smooth metal chrome brush black glow red sky".split(" "),T;return view={init:function(a){h=document.createElement("canvas");h.className="canvas3d";h.oncontextmenu=function(a){a.preventDefault()};h.ondrop=function(a){a.preventDefault()};document.body.appendChild(h);
try{g=new THREE.WebGLRenderer({canvas:h,antialias:!0,alpha:!1})}catch(b){null!==intro&&intro.message("<p>Sorry, your browser does not support WebGL.</p><p>This application uses WebGL to quickly draw AMMO Physics.</p><p>AMMO Physics can be used without WebGL, but unfortunately this application cannot.</p><p>Have a great day!</p>");return}null!==intro&&intro.clear();g.setClearColor(2368548,1);g.setPixelRatio(window.devicePixelRatio);g.gammaInput=!0;g.gammaOutput=!0;g.toneMapping=THREE.Uncharted2ToneMapping;
g.toneMappingExposure=3;g.toneMappingWhitePoint=5;k=new THREE.Scene;C=new THREE.Group;k.add(C);l=new THREE.PerspectiveCamera(60,1,1,1E3);l.position.set(0,0,30);n=new THREE.OrbitControls(l,h);n.target.set(0,0,0);n.enableKeys=!1;n.update();M=new THREE.Group;k.add(M);M.add(l);this.addLights();aa=new THREE.TextureLoader;t=new THREE.Raycaster;u=new THREE.Vector2;G={box:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,0.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,
16,12),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};G.wheel.rotateZ(-Math.PI90);q={terrain:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"terrain",wireframe:!0}),cloth:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"cloth",wireframe:!0,transparent:!0,opacity:0.9,side:THREE.DoubleSide}),ball:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"ball",wireframe:!0}),statique:new THREE.MeshBasicMaterial({color:3355545,name:"statique",wireframe:!0,
transparent:!0,opacity:0.6}),move:new THREE.MeshBasicMaterial({color:10066329,name:"move",wireframe:!0}),movehigh:new THREE.MeshBasicMaterial({color:16751001,name:"movehigh",wireframe:!0}),sleep:new THREE.MeshBasicMaterial({color:10066431,name:"sleep",wireframe:!0}),debug:new THREE.MeshBasicMaterial({color:1179409,name:"debug",wireframe:!0,opacity:0.1,transparent:!0}),hero:new THREE.MeshBasicMaterial({color:10040217,name:"hero",wireframe:!0}),cars:new THREE.MeshBasicMaterial({color:16777215,name:"cars",
wireframe:!0,transparent:!0,side:THREE.DoubleSide}),tmp1:new THREE.MeshBasicMaterial({color:16777215,name:"tmp1",wireframe:!0,transparent:!0}),tmp2:new THREE.MeshBasicMaterial({color:16777215,name:"tmp2",wireframe:!0,transparent:!0}),meca1:new THREE.MeshBasicMaterial({color:16777215,name:"meca1",wireframe:!0}),meca2:new THREE.MeshBasicMaterial({color:16777215,name:"meca2",wireframe:!0}),meca3:new THREE.MeshBasicMaterial({color:16777215,name:"meca3",wireframe:!0}),pig:new THREE.MeshBasicMaterial({color:13870992,
name:"pig",wireframe:!0,transparent:!1}),avatar:new THREE.MeshBasicMaterial({color:13870992,name:"avatar",wireframe:!0,transparent:!1}),both:new THREE.MeshBasicMaterial({color:16777215,name:"both",wireframe:!0,side:THREE.DoubleSide}),back:new THREE.MeshBasicMaterial({color:16777215,name:"back",wireframe:!0,side:THREE.BackSide})};E=new THREE.GridHelper(50,20,16777215,3355443);E.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0,opacity:0.1});k.add(E);window.addEventListener("resize",
view.resize,!1);this.resize();this.initEnv();a&&a();this.render()},addLights:function(){Q=new THREE.DirectionalLight(16777215,1);Q.position.set(-3,50,5);Q.lookAt(new THREE.Vector3);k.add(Q);ba=new THREE.AmbientLight(4473924);k.add(ba)},resize:function(){m=window.innerHeight;p=window.innerWidth-r;h.style.left=r+"px";l.aspect=p/m;l.updateProjectionMatrix();g.setSize(p,m);editor&&editor.resizeMenu(p)},setLeft:function(a){r=a},getFps:function(){return f},getInfo:function(){return g.info.programs.length},
render:function(){requestAnimationFrame(view.render);a=now();a-1E3>b&&(b=a,f=c,c=0);c++;TWEEN.update();THREE.SEA3D.AnimationHandler.update(0.017);update();g.render(k,l)},addMap:function(a,b){var c=aa.load("./assets/textures/"+a);c.flipY=!1;q[b].map=c},getGeo:function(){return G},getMat:function(){return q},getScene:function(){return k},removeRay:function(){x&&(x=!1,h.removeEventListener("mousemove",view.rayTest,!1),e=null,C.remove(z),k.remove(v))},activeRay:function(a){x=!0;var b=new THREE.PlaneBufferGeometry(100,
100);b.rotateX(-Math.PI90);z=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}));C.add(z);v=new THREE.Mesh(G.box,new THREE.MeshBasicMaterial({color:16711680}));k.add(v);h.addEventListener("mousemove",view.rayTest,!1);e=a},rayTest:function(a){u.x=(a.clientX-r)/p*2-1;u.y=2*-(a.clientY/m)+1;t.setFromCamera(u,l);a=t.intersectObjects(C.children,!0);a.length&&(v.position.copy(a[0].point),e(v))},changeMaterial:function(a){var b,c,d;0===a?(S=!0,c="MeshBasicMaterial",this.removeShadow()):
(S=!1,c="MeshStandardMaterial",this.addShadow());for(d in q)b=q[d],a=b.name,"debug"!==a&&(q[a]=new THREE[c]({name:a,envMap:null,map:b.map||null,vertexColors:b.vertexColors||!1,color:void 0===b.color?16777215:b.color.getHex(),wireframe:S,transparent:b.transparent||!1,opacity:b.opacity||1,side:b.side||THREE.FrontSide}),S||(q[a].envMap=T,q[a].metalness=0.6,q[a].roughness=0.4),b.dispose());for(d=s.length;d--;)a=s[d].material.name,s[d].material=q[a];for(d=w.length;d--;)a=w[d].material.name,w[d].material=
q[a];for(d=D.length;d--;){if(void 0==D[d].material)for(b=D[d].children.length;b--;)a=D[d].children[b].material.name,"helper"!==a&&(D[d].children[b].material=q[a]);else a=D[d].material.name,D[d].material=q[a];for(b=D[d].userData.w.length;b--;)a=D[d].userData.w[b].material.name,D[d].userData.w[b].material=q[a]}for(d=A.length;d--;)a=A[d].material.name,A[d].material=q[a];for(d=y.length;d--;)2!==y.softType&&(a=y[d].material.name,y[d].material=q[a])},needFocus:function(){h.addEventListener("mouseover",
editor.unFocus,!1)},haveFocus:function(){h.removeEventListener("mouseover",editor.unFocus,!1)},initEnv:function(){var a=document.createElement("div");a.className="env";var b=document.createElement("canvas");b.width=b.height=64;a.appendChild(b);document.body.appendChild(a);ca=b.getContext("2d");a.onclick=this.loadEnv;a.oncontextmenu=this.loadEnv;this.loadEnv()},loadEnv:function(a){var b=0;a&&(a.preventDefault(),b=a.button,0===b?P++:P--,P==Y.length&&(P=0),0>P&&(P=Y.length-1));var c=new Image;c.onload=
function(){ca.drawImage(c,0,0,64,64);T=new THREE.Texture(c);T.mapping=THREE.SphericalReflectionMapping;T.format=THREE.RGBFormat;T.needsUpdate=!0;0!==P||S||view.changeMaterial(0);if(0!==P)if(S)view.changeMaterial(1);else for(var a in q)q[a].envMap=T};c.src="./assets/textures/spherical/"+Y[P]+".jpg"},hideGrid:function(){E.visible=E.visible?!1:!0},load:function(a,b){"string"==typeof a||a instanceof String?R.push(a):R=R.concat(a);Z=b||function(){};view.load_sea(R[0])},load_next:function(){R.shift();0===
R.length?Z():view.load_sea(R[0])},load_sea:function(a){var b=new THREE.SEA3D;b.onComplete=function(c){$[a]=b.meshes;c=b.geometries.length;for(var d;c--;)d=b.geometries[c],G[d.name]=d;view.load_next()};b.load("./assets/models/"+a+".sea")},getResult:function(){return $},mergeMesh:function(a){return THREE.ViewUtils.mergeGeometryArray(a)},prepaGeometry:function(a,b){return THREE.ViewUtils.prepaGeometry(a,b)},controlUpdate:function(){if(N&&null!==H){var a,b,c=H;a=c.userData.type;var d=c.userData.speed;
b=-70*Math.torad;if("car"===a){if(10>d&&-10<d){view.setControle(!0);return}view.setControle(!1)}"hero"===a&&(view.setControle(!0),J=n.getAzimuthalAngle()+Math.Pi,L=-n.getPolarAngle(),L!==U&&(b=U=L),J!==O&&(O=J,ammo.send("heroRotation",{id:c.userData.id,angle:J})));d=new THREE.Matrix4;d.extractRotation(c.matrix);a=new THREE.Vector3(0,0,1);a.applyMatrix4(d);c=c.position;a=Math.atan2(a.x,a.z);view.autoCamera(a,b,10,0.3,c)}},setFollow:function(a){H=this.getByName(a);null!==H&&(N=!0)},setTarget:function(a){n.target.copy(a);
n.update()},autoCamera:function(a,b,c,d,e){d=d||1;l.position.lerp(this.orbit(a,b,c),d);e&&view.setTarget(e)},moveCamera:function(a,b,c,d,e){d=d||1;l.position.lerp(this.orbit((a+180)*Math.torad,(b-90)*Math.torad,c),d);e&&view.setTarget(e)},orbit:function(a,b,c){var d=new THREE.Vector3;d.x=c*Math.sin(b)*Math.sin(a);d.y=c*Math.cos(b);d.z=c*Math.sin(b)*Math.cos(a);a=new THREE.Vector3;a.copy(n.target).add(d);return a},setControle:function(a){n.enableRotate!==a&&(n.enableRotate=a,n.enableZoom=a,n.enablePan=
a)},resetCamera:function(){view.setControle(!0);H=null},setDriveCar:function(a){ammo.send("setDriveCar",{n:this.getByName(a).userData.id})},toRad:function(a){for(var b=a.length;b--;)a[b]*=Math.torad;return a},reset:function(){view.removeRay();view.setShadowPosY(-0.01);E.visible=!0;for(var a,b;0<s.length;)k.remove(s.pop());for(;0<w.length;)k.remove(w.pop());for(;0<A.length;)k.remove(A.pop());for(;0<y.length;)k.remove(y.pop());for(;0<F.length;)k.remove(F.pop());for(;0<B.length;)B.pop().dispose();for(;0<
D.length;){a=D.pop();a.userData.helper&&(a.remove(a.userData.helper),a.userData.helper.dispose());for(b=a.userData.w.length;b--;)k.remove(a.userData.w[b]);k.remove(a)}s.length=0;W=null;K={};view.resetCamera();d=!0},add:function(a){var b=!1;a.mass=void 0==a.mass?0:a.mass;a.type=void 0==a.type?"box":a.type;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.size=void 0==a.size?[1,1,1]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.geoSize&&(1==a.geoSize.length&&(a.geoSize[1]=
a.geoSize[0]),2==a.geoSize.length&&(a.geoSize[2]=a.geoSize[0]));a.rot=void 0==a.rot?[0,0,0]:this.toRad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();a.rotA&&(a.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(a.rotA))).toArray());a.rotB&&(a.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(a.rotB))).toArray());a.angUpper&&(a.angUpper=this.toRad(a.angUpper));a.angLower&&(a.angLower=this.toRad(a.angLower));
var c=null;if("joint"===a.type.substring(0,5))ammo.send("add",a);else if("plane"===a.type)E.position.set(a.pos[0],a.pos[1],a.pos[2]),ammo.send("add",a);else if("softTriMesh"===a.type)this.softTriMesh(a);else if("softConvex"===a.type)this.softConvex(a);else if("cloth"===a.type)this.cloth(a);else if("rope"===a.type)this.rope(a);else if("ellipsoid"===a.type)this.ellipsoid(a);else if("terrain"===a.type)this.terrain(a);else{c=void 0!==a.material?q[a.material]:a.mass?q.move:q.statique;if("capsule"===a.type)b=
new THREE.CapsuleBufferGeometry(a.size[0],0.5*a.size[1]),c=new THREE.Mesh(b,c),B.push(c.geometry),b=!0;else if("mesh"===a.type||"convex"===a.type)a.v=view.prepaGeometry(a.shape,a.type),a.geometry?(c=new THREE.Mesh(a.geometry,c),B.push(a.geometry),B.push(a.shape)):(c=new THREE.Mesh(a.shape,c),B.push(c.geometry));else{if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(this.toRad(a.geoRot))));
a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[1],a.geoScale[2]))}c=new THREE.Mesh(a.geometry||G[a.type],c);a.geometry&&(B.push(a.geometry),a.geoSize&&c.scale.fromArray(a.geoSize),!a.geoSize&&a.size&&c.scale.fromArray(a.size),b=!0)}c&&(b||c.scale.fromArray(a.size),c.position.fromArray(a.pos),c.quaternion.fromArray(a.quat),c.receiveShadow=!0,c.castShadow=!0,this.setName(a,c),k.add(c),a.mass?s.push(c):w.push(c));a.shape&&delete a.shape;a.geometry&&delete a.geometry;
a.material&&delete a.material;ammo.send("add",a)}},getGeoByName:function(a,b){for(var c,d=G.length;d--;)a==G[d].name&&(c=G[d]);b&&(c=(new THREE.BufferGeometry).fromGeometry(c));return c},character:function(a){a.size=void 0==a.size?[0.25,2,2]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:this.toRad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var b=
new THREE.CapsuleBufferGeometry(a.size[0],0.5*a.size[1],6),c=new THREE.Group;if(a.debug){var d=new THREE.Mesh(b,q.debug);B.push(b);c.add(d)}a.mesh?(q.hero.skinning=!0,a.mesh.material=q.hero,a.mesh.scale.multiplyScalar(a.scale||1),a.mesh.position.set(0,0,0),a.mesh.play(0),c.add(a.mesh),c.skin=a.mesh,B.push(c.skin.geometry)):(d=new THREE.Mesh(b,q.hero),B.push(b),c.add(d));c.userData.speed=0;c.userData.type="hero";c.userData.id=F.length;c.position.fromArray(a.pos);c.quaternion.fromArray(a.quat);c.castShadow=
!0;c.receiveShadow=!0;k.add(c);F.push(c);this.setName(a,c);a.mesh&&delete a.mesh;ammo.send("character",a)},vehicle:function(a){var b=a.size||[2,0.5,4],c=a.pos||[0,0,0],d=a.rot||[0,0,0],e=a.wPos||[1,0,1.6],f=a.massCenter||[0,0.25,0];this.toRad(d);if(a.mesh)for(var b=a.mesh,h=b.children.length;h--;)b.children[h].position.set(f[0],f[1],f[2]),b.children[h].castShadow=!0,b.children[h].receiveShadow=!0;else b=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(b[0],b[1],b[2])),b.translate(f[0],
f[1],f[2]),B.push(b),b=new THREE.Mesh(b,q.move);b.position.set(c[0],c[1],c[2]);b.rotation.set(d[0],d[1],d[2]);a.quat=b.quaternion.toArray();b.castShadow=!0;b.receiveShadow=!0;k.add(b);this.setName(a,b);b.userData.speed=0;b.userData.steering=0;b.userData.NumWheels=a.nw||4;b.userData.type="car";a.helper&&(b.userData.helper=new THREE.CarHelper(e),b.add(b.userData.helper));var c=a.radius||0.4,d=a.deep||0.3,e=[],f=void 0==a.wheel?!0:!1,h=a.wheel||G.wheel,g=h.clone();g.rotateY(Math.Pi);B.push(g);for(var l=
a.nw||4;l--;)e[l]=1==l||2==l?new THREE.Mesh(h,q.move):new THREE.Mesh(g,q.move),f?e[l].scale.set(d,c,c):e[l].material=q.cars,e[l].castShadow=!0,e[l].receiveShadow=!0,k.add(e[l]);b.userData.w=e;D.push(b);b.userData.id=D.length-1;a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.type||"convex"==a.type)a.v=view.prepaGeometry(a.shape,a.type);a.shape&&delete a.shape;a.mesh&&delete a.mesh;ammo.send("vehicle",a)},softTriMesh:function(a){var b=a.shape.clone(),c=a.pos||[0,0,0],d=a.size||[1,1,1],e=
a.rot||[0,0,0];b.translate(c[0],c[1],c[2]);b.scale(d[0],d[1],d[2]);b.applyMatrix((new THREE.Matrix4).makeRotationY(e[1]*=Math.torad));view.prepaGeometry(b);B.push(b);a.v=b.realVertices;a.i=b.realIndices;a.ntri=b.numFaces;b=new THREE.Mesh(b,void 0===a.material?q.cloth:q[a.material]);b.castShadow=!0;b.receiveShadow=!0;b.softType=5;k.add(b);y.push(b);a.shape&&delete a.shape;a.material&&delete a.material;ammo.send("add",a)},softConvex:function(a){var b=a.shape,c=a.pos||[0,0,0];b.translate(c[0],c[1],c[2]);
view.prepaGeometry(b);a.v=b.realVertices;b=new THREE.Mesh(b,q.cloth);b.castShadow=!0;b.receiveShadow=!0;b.softType=4;k.add(b);y.push(b);ammo.send("add",a)},cloth:function(a){var b=a.div||[16,16],c=a.size||[100,0,100],d=a.pos||[0,0,0],e=b[0]*b[1],f=new THREE.PlaneBufferGeometry(c[0],c[2],b[0]-1,b[1]-1);f.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*e),3));f.rotateX(-Math.PI90);e=new THREE.Mesh(f,q.cloth);this.setName(a,e);e.position.set(d[0],d[1],d[2]);e.castShadow=!0;e.receiveShadow=
!0;e.softType=1;k.add(e);y.push(e);a.size=c;a.div=b;a.pos=d;ammo.send("add",a)},rope:function(a){void 0===a.numSeg&&(a.numSeg=a.numSegment);var b=new THREE.Tubex(a,a.numSeg||10,a.radius||0.2,a.numRad||6,!1),b=new THREE.Mesh(b,q.ball);this.setName(a,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=2;k.add(b);y.push(b);ammo.send("add",a)},ellipsoid:function(a){ammo.send("add",a)},ellipsoidMesh:function(a){var b=a.lng,c=[],d=a.a,e,f,h,g;for(e=0;e<b;e++)g=3*e,c.push(new THREE.Vector3(d[g],d[g+1],d[g+
2]));var c=new THREE.ConvexGeometry(c),l=new Uint32Array(3*c.faces.length),m=new Float32Array(3*b),n=new Float32Array(b);h=c.vertices;for(e=b;e--;)for(f=b;f--;)g=3*f,d[g]==h[e].x&&d[g+1]==h[e].y&&d[g+2]==h[e].z&&(n[f]=e);for(e=b;e--;)g=3*e,f=3*n[e],m[f]=d[g],m[f+1]=d[g+1],m[f+2]=d[g+2];for(e=c.faces.length;e--;)g=3*e,d=c.faces[e],l[g]=d.a,l[g+1]=d.b,l[g+2]=d.c;e=new THREE.BufferGeometry;e.setIndex(new THREE.BufferAttribute(l,1));e.addAttribute("position",new THREE.BufferAttribute(m,3));e.addAttribute("color",
new THREE.BufferAttribute(new Float32Array(3*b),3));e.addAttribute("order",new THREE.BufferAttribute(n,1));e.computeVertexNormals();B.push(e);c.dispose();b=new THREE.Mesh(e,q.ball);this.setName(a,b);b.softType=3;b.castShadow=!0;b.receiveShadow=!0;k.add(b);y.push(b)},terrain:function(a){var b,c,d,e;a.div=void 0==a.div?[64,64]:a.div;a.size=void 0==a.size?[100,10,100]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.dpos=void 0==a.dpos?[0,0,0]:a.dpos;a.complexity=void 0==a.complexity?30:a.complexity;a.lng=
a.div[0]*a.div[1];a.hdata=new Float32Array(a.lng);W||(W=new Perlin);var f=1/a.complexity,h=1/a.div[0],g=(a.div[0]-1)/a.size[0],l=(a.div[1]-1)/a.size[2],m=new Float32Array(3*a.lng),n=new THREE.PlaneBufferGeometry(a.size[0],a.size[2],a.div[0]-1,a.div[1]-1);n.rotateX(-Math.PI90);var p=n.attributes.position.array;for(b=a.lng;b--;)e=3*b,c=b%a.div[0],d=~~(b*h),c=0.5+0.5*W.noise((c+a.dpos[0]*g)*f,(d+a.dpos[2]*l)*f),a.hdata[b]=c*a.size[1],p[e+1]=a.hdata[b],m[e]=c,m[e+1]=c,m[e+2]=c;n.addAttribute("color",
new THREE.BufferAttribute(m,3));n.computeBoundingSphere();n.computeVertexNormals();B.push(n);b=new THREE.Mesh(n,q.terrain);b.position.fromArray(a.pos);b.castShadow=!1;b.receiveShadow=!0;this.setName(a,b);k.add(b);A.push(b);ammo.send("add",a);I&&k.remove(I)},moveTerrain:function(a){},setName:function(a,b){void 0!==a.name&&(K[a.name]=b,b.name=a.name)},getByName:function(a){return K[a]||null},update:function(){this.bodyStep();this.heroStep();this.carsStep();this.softStep();this.controlUpdate();d&&(d=
!1)},bodyStep:function(){s.length&&s.forEach(function(a,b){var c=8*b,d=Br[c];if(0<d)"sleep"==a.material.name&&(a.material=q.move),50<d&&"move"==a.material.name?a.material=q.movehigh:50>d&&"movehigh"==a.material.name&&(a.material=q.move),a.position.fromArray(Br,c+1),a.quaternion.fromArray(Br,c+4);else if("move"==a.material.name||"movehigh"==a.material.name)a.material=q.sleep})},heroStep:function(){F.length&&F.forEach(function(a,b){var c=8*b,d=3.33*Hr[c];a.userData.speed=100*d;a.position.fromArray(Hr,
c+1);a.quaternion.fromArray(Hr,c+4);a.skin&&(0===d?a.skin.play(0,0.3):(a.skin.play(1,0.3),a.skin.setTimeScale(d)))})},carsStep:function(){D.length&&D.forEach(function(a,b){var c=56*b;a.userData.speed=Cr[c];a.position.fromArray(Cr,c+1);a.quaternion.fromArray(Cr,c+4);var d=a.userData.NumWheels,e;a.userData.helper&&4==d&&(e=40,a.userData.helper.updateSuspension(Cr[c+e+0],Cr[c+e+1],Cr[c+e+2],Cr[c+e+3]));for(;d--;)e=8*(d+1),a.userData.w[d].position.fromArray(Cr,c+e+1),a.userData.w[d].quaternion.fromArray(Cr,
c+e+4)})},getSofts:function(){return y},softStep:function(){if(y.length){var a=0;y.forEach(function(b,c){var d,e,f,h,g,k,l=b.softType,m=null,n=b.geometry.attributes.color?!0:!1,p=b.geometry.attributes.normal?!0:!1;if(2===l){for(g=b.geometry.positions.length;g--;)d=a+3*g,b.geometry.positions[g].set(Sr[d],Sr[d+1],Sr[d+2]);b.geometry.updatePath();a+=3*b.geometry.positions.length}else{h=b.geometry.attributes.position.array;n&&(e=b.geometry.attributes.color.array);if(5===l||4===l){var q=b.geometry.numVertices,
s=b.geometry.maxi,r=b.geometry.pPoint,t=b.geometry.lPoint;for(g=q;g--;)for(d=3*g+a,k=g==q-1?s-r[g]:r[g+1]-r[g],f=r[g];k--;)e=3*t[f+k],h[e]=Sr[d],h[e+1]=Sr[d+1],h[e+2]=Sr[d+2]}else if(b.geometry.attributes.order&&(m=b.geometry.attributes.order.array),g=h.length,d=2,null!==m)for(g=m.length;g--;)k=3*m[g],d=3*g+a,h[k]=Sr[d],h[k+1]=Sr[d+1],h[k+2]=Sr[d+2],f=Math.abs(Sr[d+1]/10),e[k]=f,e[k+1]=f,e[k+2]=f;else for(;g--;)h[g]=Sr[g+a],1==d&&(f=Math.abs(h[g]/10),e[g-1]=f,e[g]=f,e[g+1]=f),d--,d=0>d?2:d;2!==l&&
b.geometry.computeVertexNormals();b.geometry.attributes.position.needsUpdate=!0;if(p){d=b.geometry.attributes.normal.array;for(g=q;g--;)for(k=g==q-1?s-r[g]:r[g+1]-r[g],f=r[g],p=3*t[f];k--;)e=3*t[f+k],d[e]=d[p],d[e+1]=d[p+1],d[e+2]=d[p+2];b.geometry.attributes.normal.needsUpdate=!0}n&&(b.geometry.attributes.color.needsUpdate=!0);b.geometry.computeBoundingSphere();a=5===l?a+3*b.geometry.numVertices:a+h.length}})}},removeShadow:function(){V&&(V=!1,g.shadowMap.enabled=!1,I&&k.remove(I))},setShadowPosY:function(a){X=
a;I&&(I.position.y=X)},addShadow:function(){if(!V){V=!0;g.shadowMap.enabled=!0;g.shadowMap.soft=!0;g.shadowMap.type=THREE.PCFSoftShadowMap;g.shadowMap.renderReverseSided=!1;if(!A.length){var a=new THREE.ShaderMaterial(THREE.ShaderShadow);I=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200,1,1),a);I.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(0.5*-Math.PI));I.position.y=X;I.castShadow=!1;I.receiveShadow=!0;k.add(I)}Q.castShadow=!0;a=new THREE.OrthographicCamera(70,-70,70,-70,25,170);
Q.shadow=new THREE.LightShadow(a);Q.shadow.mapSize.width=1024;Q.shadow.mapSize.height=1024}}}}();
