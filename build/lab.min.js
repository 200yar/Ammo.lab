'use strict';var THREE,list,extensions,numDiv,data,TextDecoder,ammo,intro,UIL,esprima,CodeMirror,update,postUpdate,Br,Cr,Jr,Hr,Sr,demos,module,exports,process,define;var ARRAY8;ARRAY8||(ARRAY8="undefined"!==typeof Uint8Array?Uint8Array:Array);function Perlin(a){this.F2=0.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;a||(a=Math.random);this.p=new ARRAY8(256);this.perm=new ARRAY8(512);this.permMod12=new ARRAY8(512);for(var b=0;256>b;b++)this.p[b]=256*a();for(b=0;512>b;b++)this.perm[b]=this.p[b&255],this.permMod12[b]=this.perm[b]%12}
Perlin.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),noise:function(a,b){var c=this.permMod12,f=this.perm,d=this.grad3,h=0,g=0,l=0,m=(a+b)*this.F2,p=Math.floor(a+m),u=Math.floor(b+m),m=(p+u)*this.G2,v=a-(p-m),D=b-(u-m),w,e;v>D?(w=1,e=0):(w=0,e=1);var A=v-w+this.G2,y=D-e+this.G2,m=v-1+2*this.G2,q=D-1+2*this.G2,p=p&255,u=u&255,n=0.5-v*v-D*D;0<=n&&(h=3*c[p+f[u]],n*=n,h=n*n*(d[h]*v+d[h+1]*D));v=0.5-A*A-y*y;0<=v&&(g=3*c[p+w+f[u+
e]],v*=v,g=v*v*(d[g]*A+d[g+1]*y));A=0.5-m*m-q*q;0<=A&&(c=3*c[p+1+f[u+1]],A*=A,l=A*A*(d[c]*m+d[c+1]*q));return 70*(h+g+l)}};var TWEEN=TWEEN||function(){var a=[];return{getAll:function(){return a},removeAll:function(){a=[]},add:function(b){a.push(b)},remove:function(b){b=a.indexOf(b);-1!==b&&a.splice(b,1)},update:function(b,c){if(0===a.length)return!1;var f=0;for(b=void 0!==b?b:TWEEN.now();f<a.length;)a[f].update(b)||c?f++:a.splice(f,1);return!0}}}();
TWEEN.now="undefined"===typeof window&&"undefined"!==typeof process?function(){var a=process.hrtime();return 1E3*a[0]+a[1]/1E6}:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now.bind(window.performance):void 0!==Date.now?Date.now:function(){return(new Date).getTime()};
TWEEN.Tween=function(a){var b={},c={},f={},d=1E3,h=0,g,l=!1,m=!1,p=0,u=null,v=TWEEN.Easing.Linear.None,D=TWEEN.Interpolation.Linear,w=[],e=null,A=!1,y=null,q=null,n=null;this.to=function(a,b){c=a;void 0!==b&&(d=b);return this};this.start=function(e){TWEEN.add(this);m=!0;A=!1;u=void 0!==e?e:TWEEN.now();u+=p;for(var d in c){if(c[d]instanceof Array){if(0===c[d].length)continue;c[d]=[a[d]].concat(c[d])}void 0!==a[d]&&(b[d]=a[d],!1===b[d]instanceof Array&&(b[d]*=1),f[d]=b[d]||0)}return this};this.stop=
function(){if(!m)return this;TWEEN.remove(this);m=!1;null!==n&&n.call(a,a);this.stopChainedTweens();return this};this.end=function(){this.update(u+d);return this};this.stopChainedTweens=function(){for(var a=0,c=w.length;a<c;a++)w[a].stop()};this.delay=function(a){p=a;return this};this.repeat=function(a){h=a;return this};this.repeatDelay=function(a){g=a;return this};this.yoyo=function(a){l=a;return this};this.easing=function(a){v=a;return this};this.interpolation=function(a){D=a;return this};this.chain=
function(){w=arguments;return this};this.onStart=function(a){e=a;return this};this.onUpdate=function(a){y=a;return this};this.onComplete=function(a){q=a;return this};this.onStop=function(a){n=a;return this};this.update=function(m){var n,s,x;if(m<u)return!0;!1===A&&(null!==e&&e.call(a,a),A=!0);s=(m-u)/d;s=1<s?1:s;x=v(s);for(n in c)if(void 0!==b[n]){var B=b[n]||0,z=c[n];z instanceof Array?a[n]=D(z,x):("string"===typeof z&&(z="+"===z.charAt(0)||"-"===z.charAt(0)?B+parseFloat(z):parseFloat(z)),"number"===
typeof z&&(a[n]=B+(z-B)*x))}null!==y&&y.call(a,x);if(1===s)if(0<h){isFinite(h)&&h--;for(n in f)"string"===typeof c[n]&&(f[n]+=parseFloat(c[n])),l&&(s=f[n],f[n]=c[n],c[n]=s),b[n]=f[n];u=void 0!==g?m+g:m+p}else{null!==q&&q.call(a,a);m=0;for(n=w.length;m<n;m++)w[m].start(u+d);return!1}return!0}};
TWEEN.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?0.5*a*a:-0.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a:-0.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*
a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return 0.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?0.5*Math.pow(1024,a-1):0.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-
Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){return 0===a?0:1===a?1:-Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI)},Out:function(a){return 0===a?0:1===a?1:Math.pow(2,-10*a)*Math.sin(5*(a-0.1)*Math.PI)+1},InOut:function(a){if(0===a)return 0;if(1===a)return 1;a*=2;return 1>a?-0.5*Math.pow(2,10*(a-1))*Math.sin(5*(a-1.1)*Math.PI):0.5*Math.pow(2,-10*(a-1))*Math.sin(5*
(a-1.1)*Math.PI)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*(3.5949095*a-2.5949095):0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-TWEEN.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},InOut:function(a){return 0.5>a?0.5*TWEEN.Easing.Bounce.In(2*
a):0.5*TWEEN.Easing.Bounce.Out(2*a-1)+0.5}}};
TWEEN.Interpolation={Linear:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),h=TWEEN.Interpolation.Utils.Linear;return 0>b?h(a[0],a[1],f):1<b?h(a[c],a[c-1],c-f):h(a[d],a[d+1>c?c:d+1],f-d)},Bezier:function(a,b){for(var c=0,f=a.length-1,d=Math.pow,h=TWEEN.Interpolation.Utils.Bernstein,g=0;g<=f;g++)c+=d(1-b,f-g)*d(b,g)*a[g]*h(f,g);return c},CatmullRom:function(a,b){var c=a.length-1,f=c*b,d=Math.floor(f),h=TWEEN.Interpolation.Utils.CatmullRom;return a[0]===a[c]?(0>b&&(d=Math.floor(f=c*(1+b))),h(a[(d-
1+c)%c],a[d],a[(d+1)%c],a[(d+2)%c],f-d)):0>b?a[0]-(h(a[0],a[0],a[1],a[1],-f)-a[0]):1<b?a[c]-(h(a[c],a[c],a[c-1],a[c-1],f-c)-a[c]):h(a[d?d-1:0],a[d],a[c<d+1?c:d+1],a[c<d+2?c:d+2],f-d)},Utils:{Linear:function(a,b,c){return(b-a)*c+a},Bernstein:function(a,b){var c=TWEEN.Interpolation.Utils.Factorial;return c(a)/c(b)/c(a-b)},Factorial:function(){var a=[1];return function(b){var c=1;if(a[b])return a[b];for(var f=b;1<f;f--)c*=f;return a[b]=c}}(),CatmullRom:function(a,b,c,f,d){a=0.5*(c-a);f=0.5*(f-b);var h=
d*d;return(2*b-2*c+a+f)*d*h+(-3*b+3*c-2*a-f)*h+a*d+b}}};(function(a){"function"===typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!==typeof module&&"object"===typeof exports?module.exports=TWEEN:void 0!==a&&(a.TWEEN=TWEEN)})(this);THREE.OrbitControls=function(a,b){function c(){return Math.pow(0.95,e.zoomSpeed)}function f(a){e.object instanceof THREE.PerspectiveCamera?B/=a:e.object instanceof THREE.OrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*a)),e.object.updateProjectionMatrix(),E=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function d(a){e.object instanceof THREE.PerspectiveCamera?B*=a:e.object instanceof THREE.OrthographicCamera?
(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/a)),e.object.updateProjectionMatrix(),E=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function h(a){if(!1!==e.enabled){a.preventDefault();if(a.button===e.mouseButtons.ORBIT){if(!1===e.enableRotate)return;I.set(a.clientX,a.clientY);r=n.ROTATE}else if(a.button===e.mouseButtons.ZOOM){if(!1===e.enableZoom)return;L.set(a.clientX,a.clientY);r=n.DOLLY}else if(a.button===
e.mouseButtons.PAN){if(!1===e.enablePan)return;M.set(a.clientX,a.clientY);r=n.PAN}r!==n.NONE&&(document.addEventListener("mousemove",g,!1),document.addEventListener("mouseup",l,!1),e.dispatchEvent(y))}}function g(a){!1!==e.enabled&&(a.preventDefault(),r===n.ROTATE?!1!==e.enableRotate&&(C.set(a.clientX,a.clientY),N.subVectors(C,I),a=e.domElement===document?e.domElement.body:e.domElement,x.theta-=2*Math.PI*N.x/a.clientWidth*e.rotateSpeed,x.phi-=2*Math.PI*N.y/a.clientHeight*e.rotateSpeed,I.copy(C),e.update()):
r===n.DOLLY?!1!==e.enableZoom&&(K.set(a.clientX,a.clientY),O.subVectors(K,L),0<O.y?f(c()):0>O.y&&d(c()),L.copy(K),e.update()):r===n.PAN&&!1!==e.enablePan&&(P.set(a.clientX,a.clientY),J.subVectors(P,M),G(J.x,J.y),M.copy(P),e.update()))}function l(a){!1!==e.enabled&&(document.removeEventListener("mousemove",g,!1),document.removeEventListener("mouseup",l,!1),e.dispatchEvent(q),r=n.NONE)}function m(a){!1===e.enabled||!1===e.enableZoom||r!==n.NONE&&r!==n.ROTATE||(a.preventDefault(),a.stopPropagation(),
0>a.deltaY?d(c()):0<a.deltaY&&f(c()),e.update(),e.dispatchEvent(y),e.dispatchEvent(q))}function p(a){if(!1!==e.enabled&&!1!==e.enableKeys&&!1!==e.enablePan)switch(a.keyCode){case e.keys.UP:G(0,e.keyPanSpeed);e.update();break;case e.keys.BOTTOM:G(0,-e.keyPanSpeed);e.update();break;case e.keys.LEFT:G(e.keyPanSpeed,0);e.update();break;case e.keys.RIGHT:G(-e.keyPanSpeed,0),e.update()}}function u(a){if(!1!==e.enabled){switch(a.touches.length){case 1:if(!1===e.enableRotate)return;I.set(a.touches[0].pageX,
a.touches[0].pageY);r=n.TOUCH_ROTATE;break;case 2:if(!1===e.enableZoom)return;var c=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;c=Math.sqrt(c*c+a*a);L.set(0,c);r=n.TOUCH_DOLLY;break;case 3:if(!1===e.enablePan)return;M.set(a.touches[0].pageX,a.touches[0].pageY);r=n.TOUCH_PAN;break;default:r=n.NONE}r!==n.NONE&&e.dispatchEvent(y)}}function v(a){if(!1!==e.enabled)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:if(!1===e.enableRotate)break;if(r!==
n.TOUCH_ROTATE)break;C.set(a.touches[0].pageX,a.touches[0].pageY);N.subVectors(C,I);var b=e.domElement===document?e.domElement.body:e.domElement;x.theta-=2*Math.PI*N.x/b.clientWidth*e.rotateSpeed;x.phi-=2*Math.PI*N.y/b.clientHeight*e.rotateSpeed;I.copy(C);e.update();break;case 2:if(!1===e.enableZoom)break;if(r!==n.TOUCH_DOLLY)break;b=a.touches[0].pageX-a.touches[1].pageX;a=a.touches[0].pageY-a.touches[1].pageY;b=Math.sqrt(b*b+a*a);K.set(0,b);O.subVectors(K,L);0<O.y?d(c()):0>O.y&&f(c());L.copy(K);
e.update();break;case 3:if(!1===e.enablePan)break;if(r!==n.TOUCH_PAN)break;P.set(a.touches[0].pageX,a.touches[0].pageY);J.subVectors(P,M);G(J.x,J.y);M.copy(P);e.update();break;default:r=n.NONE}}function D(a){!1!==e.enabled&&(e.dispatchEvent(q),r=n.NONE)}function w(a){a.preventDefault()}this.object=a;this.domElement=void 0!==b?b:document;this.enabled=!0;this.target=new THREE.Vector3;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.minPolarAngle=0;this.maxPolarAngle=
Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=!1;this.dampingFactor=0.25;this.enableZoom=!0;this.zoomSpeed=1;this.enableRotate=!0;this.rotateSpeed=1;this.enablePan=!0;this.keyPanSpeed=7;this.autoRotate=!1;this.autoRotateSpeed=2;this.enableKeys=!0;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=
this.object.zoom;this.getPolarAngle=function(){return s.phi};this.getAzimuthalAngle=function(){return s.theta};this.reset=function(){e.target.copy(e.target0);e.object.position.copy(e.position0);e.object.zoom=e.zoom0;e.object.updateProjectionMatrix();e.dispatchEvent(A);e.update();r=n.NONE};this.update=function(){var c=new THREE.Vector3,b=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),d=b.clone().inverse(),f=new THREE.Vector3,h=new THREE.Quaternion;return function(){var a=
e.object.position;c.copy(a).sub(e.target);c.applyQuaternion(b);s.setFromVector3(c);e.autoRotate&&r===n.NONE&&(x.theta-=2*Math.PI/60/60*e.autoRotateSpeed);s.theta+=x.theta;s.phi+=x.phi;s.theta=Math.max(e.minAzimuthAngle,Math.min(e.maxAzimuthAngle,s.theta));s.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,s.phi));s.makeSafe();s.radius*=B;s.radius=Math.max(e.minDistance,Math.min(e.maxDistance,s.radius));e.target.add(z);c.setFromSpherical(s);c.applyQuaternion(d);a.copy(e.target).add(c);e.object.lookAt(e.target);
!0===e.enableDamping?(x.theta*=1-e.dampingFactor,x.phi*=1-e.dampingFactor):x.set(0,0,0);B=1;z.set(0,0,0);return E||f.distanceToSquared(e.object.position)>F||8*(1-h.dot(e.object.quaternion))>F?(e.dispatchEvent(A),f.copy(e.object.position),h.copy(e.object.quaternion),E=!1,!0):!1}}();this.dispose=function(){e.domElement.removeEventListener("contextmenu",w,!1);e.domElement.removeEventListener("mousedown",h,!1);e.domElement.removeEventListener("wheel",m,!1);e.domElement.removeEventListener("touchstart",
u,!1);e.domElement.removeEventListener("touchend",D,!1);e.domElement.removeEventListener("touchmove",v,!1);document.removeEventListener("mousemove",g,!1);document.removeEventListener("mouseup",l,!1);window.removeEventListener("keydown",p,!1)};var e=this,A={type:"change"},y={type:"start"},q={type:"end"},n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},r=n.NONE,F=1E-6,s=new THREE.Spherical,x=new THREE.Spherical,B=1,z=new THREE.Vector3,E=!1,I=new THREE.Vector2,C=new THREE.Vector2,
N=new THREE.Vector2,M=new THREE.Vector2,P=new THREE.Vector2,J=new THREE.Vector2,L=new THREE.Vector2,K=new THREE.Vector2,O=new THREE.Vector2,V=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,0);a.multiplyScalar(-c);z.add(a)}}(),W=function(){var a=new THREE.Vector3;return function(c,b){a.setFromMatrixColumn(b,1);a.multiplyScalar(c);z.add(a)}}(),G=function(){var a=new THREE.Vector3;return function(c,b){var d=e.domElement===document?e.domElement.body:e.domElement;if(e.object instanceof
THREE.PerspectiveCamera){a.copy(e.object.position).sub(e.target);var f=a.length(),f=f*Math.tan(e.object.fov/2*Math.PI/180);V(2*c*f/d.clientHeight,e.object.matrix);W(2*b*f/d.clientHeight,e.object.matrix)}else e.object instanceof THREE.OrthographicCamera?(V(c*(e.object.right-e.object.left)/e.object.zoom/d.clientWidth,e.object.matrix),W(b*(e.object.top-e.object.bottom)/e.object.zoom/d.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),
e.enablePan=!1)}}();e.domElement.addEventListener("contextmenu",w,!1);e.domElement.addEventListener("mousedown",h,!1);e.domElement.addEventListener("wheel",m,!1);e.domElement.addEventListener("touchstart",u,!1);e.domElement.addEventListener("touchend",D,!1);e.domElement.addEventListener("touchmove",v,!1);window.addEventListener("keydown",p,!1);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;
Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){console.warn("THREE.OrbitControls: .center has been renamed to .target");return this.target}},noZoom:{get:function(){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");return!this.enableZoom},set:function(a){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");this.enableZoom=!a}},noRotate:{get:function(){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");
return!this.enableRotate},set:function(a){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");this.enableRotate=!a}},noPan:{get:function(){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");return!this.enablePan},set:function(a){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead.");this.enablePan=!a}},noKeys:{get:function(){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");
return!this.enableKeys},set:function(a){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");this.enableKeys=!a}},staticMoving:{get:function(){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");return!this.enableDamping},set:function(a){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");this.enableDamping=!a}},dynamicDampingFactor:{get:function(){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");
return this.dampingFactor},set:function(a){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");this.dampingFactor=a}}});THREE.CapsuleBufferGeometry=function(a,b,c,f){THREE.BufferGeometry.call(this);this.type="CapsuleBufferGeometry";var d=a||1;b=b||1;var h=c||12,g=0.5*~~h;a=f||1;var l=2*Math.PI,m=0.5*Math.PI;f=new THREE.Geometry;a=new THREE.CylinderGeometry(d,d,b,h,a,!0);var p=new THREE.SphereGeometry(d,h,g,0,l,0,m),d=new THREE.SphereGeometry(d,h,g,0,l,m,m),h=(new THREE.Matrix4).makeTranslation(0,0,0);6===c&&h.makeRotationY(0.5235987755982988);c=(new THREE.Matrix4).makeTranslation(0,0.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,
0.5*-b,0);f.merge(a,h);f.merge(p,c);f.merge(d,b);f.mergeVertices();this.fromGeometry(f)};THREE.CapsuleBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CapsuleBufferGeometry.prototype.constructor=THREE.CapsuleBufferGeometry;THREE.ConvexGeometry=function(a){function b(c){var b=a[c].clone(),d=b.length();b.x+=2E-6*d*(Math.random()-0.5);b.y+=2E-6*d*(Math.random()-0.5);b.z+=2E-6*d*(Math.random()-0.5);for(var d=[],h=0;h<f.length;){var g=f[h],e=b,l=a[g[0]],m;m=l;var q=a[g[1]],n=a[g[2]],r=new THREE.Vector3,F=new THREE.Vector3;r.subVectors(n,q);F.subVectors(m,q);r.cross(F);r.normalize();m=r;l=m.dot(l);if(m.dot(e)>=l){for(e=0;3>e;e++){l=[g[e],g[(e+1)%3]];m=!0;for(q=0;q<d.length;q++)if(n=d[q],n[0]===l[1]&&n[1]===l[0]){d[q]=d[d.length-
1];d.pop();m=!1;break}m&&d.push(l)}f[h]=f[f.length-1];f.pop()}else h++}for(q=0;q<d.length;q++)f.push([d[q][0],d[q][1],c])}function c(a){var c=a.length();return new THREE.Vector2(a.x/c,a.y/c)}THREE.Geometry.call(this);for(var f=[[0,1,2],[0,2,1]],d=3;d<a.length;d++)b(d);for(var h=0,g=Array(a.length),d=0;d<f.length;d++)for(var l=f[d],m=0;3>m;m++)void 0===g[l[m]]&&(g[l[m]]=h++,this.vertices.push(a[l[m]])),l[m]=g[l[m]];for(d=0;d<f.length;d++)this.faces.push(new THREE.Face3(f[d][0],f[d][1],f[d][2]));for(d=
0;d<this.faces.length;d++)l=this.faces[d],this.faceVertexUvs[0].push([c(this.vertices[l.a]),c(this.vertices[l.b]),c(this.vertices[l.c])]);this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry.prototype.constructor=THREE.ConvexGeometry;THREE.Tubex=function(a,b,c,f,d,h){THREE.BufferGeometry.call(this);this.type="Tubex";this.tubularSegments=b||64;this.radius=c||1;this.radialSegments=f||8;this.closed=d||!1;if(a instanceof Array)this.positions=a;else{this.positions=[];b=(new THREE.Vector3).fromArray(a.start);c=(new THREE.Vector3).fromArray(a.end);f=c.clone().sub(b);a=a.numSegment-1;this.positions.push(b);for(d=1;d<a;d++)this.positions.push((new THREE.Vector3(f.x/a*d,f.y/a*d,f.z/a*d)).add(b));this.positions.push(c)}this.path=new THREE.CatmullRomCurve3(this.positions);
this.path.type=h||"catmullrom";this.path.closed=this.closed;this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.vertex=new THREE.Vector3;this.normal=new THREE.Vector3;this.uv=new THREE.Vector2;this.vertices=[];this.colors=[];this.normals=[];this.uvs=[];this.indices=[];this.generateBufferData();this.setIndex(new (65535<this.indices.length?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(this.indices,1));this.addAttribute("position",new THREE.Float32BufferAttribute(this.vertices,
3));this.addAttribute("color",new THREE.Float32BufferAttribute(this.colors,3));this.addAttribute("normal",new THREE.Float32BufferAttribute(this.normals,3));this.addAttribute("uv",new THREE.Float32BufferAttribute(this.uvs,2))};THREE.Tubex.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.Tubex.prototype.constructor=THREE.Tubex;
THREE.Tubex.prototype.generateBufferData=function(){for(var a=0;a<this.tubularSegments;a++)this.generateSegment(a);this.generateSegment(!1===this.closed?this.tubularSegments:0);this.generateIndicesAndUv()};
THREE.Tubex.prototype.generateSegment=function(a){var b=this.path.getPointAt(a/this.tubularSegments),c=this.frames.normals[a];a=this.frames.binormals[a];for(var f=0;f<=this.radialSegments;f++){var d=f/this.radialSegments*Math.PI*2,h=Math.sin(d),d=-Math.cos(d);this.normal.x=d*c.x+h*a.x;this.normal.y=d*c.y+h*a.y;this.normal.z=d*c.z+h*a.z;this.normal.normalize();this.normals.push(this.normal.x,this.normal.y,this.normal.z);this.vertex.x=b.x+this.radius*this.normal.x;this.vertex.y=b.y+this.radius*this.normal.y;
this.vertex.z=b.z+this.radius*this.normal.z;this.vertices.push(this.vertex.x,this.vertex.y,this.vertex.z);this.colors.push(1,1,1)}};
THREE.Tubex.prototype.generateIndicesAndUv=function(){for(var a=0;a<=this.tubularSegments;a++)for(var b=0;b<=this.radialSegments;b++){if(0<b&&0<a){var c=(this.radialSegments+1)*a+(b-1),f=(this.radialSegments+1)*a+b,d=(this.radialSegments+1)*(a-1)+b;this.indices.push((this.radialSegments+1)*(a-1)+(b-1),c,d);this.indices.push(c,f,d)}this.uv.x=a/this.tubularSegments;this.uv.y=b/this.radialSegments;this.uvs.push(this.uv.x,this.uv.y)}};
THREE.Tubex.prototype.updatePath=function(a){this.frames=this.path.computeFrenetFrames(this.tubularSegments,this.closed);this.normals=this.attributes.normal.array;this.vertices=this.attributes.position.array;this.colors=this.attributes.color.array;for(a=0;a<this.tubularSegments;a++)this.updateSegment(a);this.updateSegment(!1===this.closed?this.tubularSegments:0);this.attributes.color.needsUpdate=!0;this.attributes.position.needsUpdate=!0;this.attributes.normal.needsUpdate=!0};
THREE.Tubex.prototype.updateUV=function(){this.uvs=this.attributes.uv.array;for(var a,b,c=0;c<=this.tubularSegments;c++){a=2*c*(this.radialSegments+1);for(var f=0;f<=this.radialSegments;f++)b=2*f,this.uv.x=c/this.tubularSegments,this.uv.y=f/this.radialSegments,this.uvs[a+b]=this.uv.x,this.uvs[a+b+1]=this.uv.y}this.attributes.uv.needsUpdate=!0};
THREE.Tubex.prototype.updateSegment=function(a){for(var b=3*a*(this.radialSegments+1),c=this.path.getPointAt(a/this.tubularSegments),f=this.frames.normals[a],d=this.frames.binormals[a],h=0;h<=this.radialSegments;h++){var g=h/this.radialSegments*Math.PI*2;a=3*h;var l=Math.sin(g),g=-Math.cos(g);this.normal.x=g*f.x+l*d.x;this.normal.y=g*f.y+l*d.y;this.normal.z=g*f.z+l*d.z;this.normal.normalize();this.normals[b+a]=this.normal.x;this.normals[b+a+1]=this.normal.y;this.normals[b+a+2]=this.normal.z;this.vertices[b+
a]=c.x+this.radius*this.normal.x;this.vertices[b+a+1]=c.y+this.radius*this.normal.y;this.vertices[b+a+2]=c.z+this.radius*this.normal.z;this.colors[b+a]=Math.abs(this.normal.x);this.colors[b+a+1]=Math.abs(this.normal.y);this.colors[b+a+2]=Math.abs(this.normal.z)}};THREE.ShaderShadow={uniforms:Object.assign({},THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(15658734)},specular:{value:new THREE.Color(1118481)},emissive:{value:new THREE.Color(0)},opacity:{value:0.4}}),fragmentShader:["uniform float opacity;\nvarying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.packing,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.shadowmask_pars_fragment,"void main() {\n   float mask = getShadowMask();\n   vec4 pp = vec4(1.0);\n   vec4 mapping = vec4( pp.rgb, pp.a * opacity );\n   vec4 shadowing = vec4( vec3(0.0), opacity * (1.0 - mask) );\n   gl_FragColor = mix( mapping, shadowing, 1.0 - mask );\n   gl_FragColor = shadowing;\n}"].join("\n"),
vertexShader:["varying vec2 vUv;",THREE.ShaderChunk.common,THREE.ShaderChunk.bsdfs,THREE.ShaderChunk.lights_pars,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvUv = uv;\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),lights:!0,transparent:!0,depthWrite:!1};THREE.CarHelper=function(a){this.py=a[1];a=new Float32Array([-0.2,0,0,0.2,0,0,0,0,0,0,0.4,0,0,0,-0.2,0,0,0.2,0.5*a[0],a[1],a[2],0.5*a[0],a[1]+1,a[2],0.5*-a[0],a[1],a[2],0.5*-a[0],a[1]+1,a[2],0.5*-a[0],a[1],-a[2],0.5*-a[0],a[1]+1,-a[2],0.5*a[0],a[1],-a[2],0.5*a[0],a[1]+1,-a[2]]);var b=new Float32Array([1,1,0,1,1,0,1,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0]);this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(a,3));this.geometry.addAttribute("color",
new THREE.BufferAttribute(b,3));this.positions=this.geometry.attributes.position.array;this.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,name:"helper"});THREE.LineSegments.call(this,this.geometry,this.material)};THREE.CarHelper.prototype=Object.create(THREE.LineSegments.prototype);THREE.CarHelper.prototype.constructor=THREE.CarHelper;THREE.CarHelper.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};
THREE.CarHelper.prototype.updateSuspension=function(a,b,c,f){this.positions[22]=this.py-a;this.positions[28]=this.py-b;this.positions[34]=this.py-c;this.positions[40]=this.py-f;this.geometry.attributes.position.needsUpdate=!0};THREE.Terrain=function(a,b){a=void 0==a?{}:a;this.div=void 0==a.div?[64,64]:a.div;this.size=void 0==a.size?[100,10,100]:a.size;this.colorBase={r:1,g:0.7,b:0};this.complexity=void 0==a.complexity?30:a.complexity;this.complexity2=void 0==a.complexity2?60:a.complexity2;this.local=new THREE.Vector3;a.local&&this.local.fromArray(a.local);this.lng=this.div[0]*this.div[1];this.hdata=new Float32Array(this.lng);this.perlin=void 0==b?new Perlin:b;this.colors=new Float32Array(3*this.lng);this.geometry=new THREE.PlaneBufferGeometry(this.size[0],
this.size[2],this.div[0]-1,this.div[1]-1);this.geometry.rotateX(0.5*-Math.PI);this.geometry.computeBoundingSphere();this.geometry.addAttribute("color",new THREE.BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.material=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,name:"terrain",metalness:1,roughness:0.3,wireframe:!1});this.update();THREE.Mesh.call(this,this.geometry,this.material);this.castShadow=!1;this.receiveShadow=!0};
THREE.Terrain.prototype=Object.create(THREE.Mesh.prototype);THREE.Terrain.prototype.constructor=THREE.Terrain;THREE.Terrain.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};THREE.Terrain.prototype.setEnvMap=function(a){this.material.envMap=a};THREE.Terrain.prototype.move=function(){this.update()};THREE.Terrain.prototype.clamp=function(a,b,c){a=a<b?b:a;return a>c?c:a};THREE.Terrain.prototype.norm=function(a,b,c){return(a-b)/(c-b)};
THREE.Terrain.prototype.linear=function(a,b,c){return(1-a)*b+a*c};THREE.Terrain.prototype.cubicSCurve=function(a){return a*a*(3-2*a)};THREE.Terrain.prototype.quinticSCurve=function(a){var b=a*a*a,c=b*a;return 6*c*a-15*c+10*b};
THREE.Terrain.prototype.update=function(){for(var a=1/this.complexity,b=1/this.complexity2,c=1/this.div[0],f=(this.div[0]-1)/this.size[0],d=(this.div[1]-1)/this.size[2],h=this.lng,g,l,m,p;h--;)g=3*h,l=h%this.div[0],m=~~(h*c),p=0.5+0.5*this.perlin.noise((l+this.local.x*f)*a,(m+this.local.z*d)*a),l=0.5+0.5*this.perlin.noise((l+100+this.local.x*f)*b,(m+100+this.local.z*d)*b),p=Math.min(p,l),p=this.linear(p,0,0.7),p=this.quinticSCurve(p),this.hdata[h]=p*this.size[1],this.vertices[g+1]=this.hdata[h],this.colors[g]=
p*this.colorBase.r,this.colors[g+1]=p*this.colorBase.g,this.colors[g+2]=p*this.colorBase.b;this.geometry.attributes.position.needsUpdate=!0;this.geometry.attributes.color.needsUpdate=!0;this.geometry.computeVertexNormals()};THREE.ViewUtils={mergeGeometryArray:function(a){for(var b=[],c=a.length;c--;)b[c]=(new THREE.Geometry).fromBufferGeometry(a[c]);for(a=new THREE.Geometry;0<b.length;)c=b.pop(),a.merge(c),c.dispose();a.mergeVertices();b=(new THREE.BufferGeometry).fromGeometry(a);a.dispose();return b},prepaGeometry:function(a,b){var c=!1,f=!1;"mesh"==b&&(f=!0);"convex"==b&&(c=!0);var d,h,g,l=(new THREE.Geometry).fromBufferGeometry(a);l.mergeVertices();var m=a.attributes.position.array.length/3,p=l.vertices.length,u=
l.faces.length;a.realVertices=new Float32Array(3*p);a.realIndices=new (65535<3*u?Uint32Array:Uint16Array)(3*u);for(d=p;d--;)g=l.vertices[d],h=3*d,a.realVertices[h]=g.x,a.realVertices[h+1]=g.y,a.realVertices[h+2]=g.z;if(c)return l.dispose(),a.realVertices;for(d=u;d--;)g=l.faces[d],h=3*d,a.realIndices[h]=g.a,a.realIndices[h+1]=g.b,a.realIndices[h+2]=g.c;l.dispose();if(f){m=[];for(d=a.realIndices.length;d--;)h=3*d,g=3*a.realIndices[d],m[h]=a.realVertices[g],m[h+1]=a.realVertices[g+1],m[h+2]=a.realVertices[g+
2];return m}f=[];l=a.attributes.position.array;for(d=p;d--;)for(h=3*d,f[d]=[],c=m;c--;)g=3*c,l[g]==a.realVertices[h]&&l[g+1]==a.realVertices[h+1]&&l[g+2]==a.realVertices[h+2]&&f[d].push(c);var l=new (65535<p?Uint32Array:Uint16Array)(p),v=new (65535<m?Uint32Array:Uint16Array)(m);for(d=g=0;d<p;d++){h=f[d].length;l[d]=g;for(c=h;c--;)v[g+c]=f[d][c];g+=h}a.numFaces=u;a.numVertices=p;a.maxi=m;a.pPoint=l;a.lPoint=v}};var user=function(){var a=new Float32Array(20),b;user={init:function(c){b=new user.Gamepad(a);document.addEventListener("keydown",user.keyDown,!1);document.addEventListener("keyup",user.keyUp,!1)},update:function(a){b.update();b.ready&&b.getValue(0)},keyDown:function(c){if(!editor.getFocus()){c=c||window.event;switch(c.which){case 65:case 81:a[0]=-1;break;case 68:a[0]=1;break;case 87:case 90:a[1]=-1;break;case 83:a[1]=1;break;case 37:a[2]=-1;break;case 39:a[2]=1;break;case 38:a[3]=-1;break;case 40:a[3]=
1;break;case 17:case 67:a[5]=1;break;case 69:a[5]=1;break;case 32:a[4]=1;break;case 16:a[7]=1;break;case 71:view.hideGrid()}b.reset()}},keyUp:function(c){if(!editor.getFocus())switch(c=c||window.event,c.which){case 65:case 81:a[0]=0>a[0]?0:a[0];break;case 68:a[0]=0<a[0]?0:a[0];break;case 87:case 90:a[1]=0>a[1]?0:a[1];break;case 83:a[1]=0<a[1]?0:a[1];break;case 37:a[2]=0>a[2]?0:a[2];break;case 39:a[2]=0<a[2]?0:a[2];break;case 38:a[3]=0>a[3]?0:a[3];break;case 40:a[3]=0<a[3]?0:a[3];break;case 17:case 67:a[5]=
0;break;case 69:a[5]=0;break;case 32:a[4]=0;break;case 16:a[7]=0}},getKey:function(){return a},Gamepad:function(a){this.values=[];this.key=a;this.ready=0}};user.Gamepad.prototype={update:function(){var a,b,d,h,g,l,m=this.fix,p=navigator.getGamepads();for(a=0;a<p.length;a++)if(l=p[a])if(d=l.axes.length,h=l.buttons.length){this.values[a]||(this.values[a]=[]);for(b=0;b<d;b++)g=m(l.axes[b],0.08),0==this.ready&&0!==g&&(this.ready=1),this.values[a][b]=g;for(b=0;b<h;b++)g=m(l.buttons[b].value),0==this.ready&&
0!==g&&(this.ready=1),this.values[a][d+b]=g}else this.values[a]&&(this.values[a]=null)},getValue:function(a){for(var b=19,d;b--;)d=this.values[a][b],0==this.ready&&0!==d&&(this.ready=1),this.key[b]=d},reset:function(){this.ready=0},fix:function(a,b){var d=Number(a.toString().substring(0,5));b&&d<b&&d>-b&&(d=0);return d}};return user}();var gui=function(){var a;return gui={init:function(){a=document.createElement("div");document.body.appendChild(a)},initJoysticks:function(){UIL.add("joystick",{target:a,pos:{left:"auto",right:"100px",top:"auto",bottom:"10px"},name:"JOY",width:100,multiplicator:1,precision:2,fontColor:"#D4B87B"})}}}();var now;(function(a){var b,c=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var f=0;f<c.length;++f){var d=c[f];if(a.performance[d]){b=function(){return a.performance[d]()};break}}b||(b=Date.now);now=b})(window);var editor=function(){var a,b,c,f,d,h,g,l=function(){},m=!1,p=!1,u=[],v=[],D=null,w=0,e=0,A="",y,q=[],n,r=!1,F=!0,s=!1,x,B;return editor={init:function(e,n){e&&(l=e);F=n||!1;y=document.createElement("div");y.className="bigmenu";document.body.appendChild(y);this.makeBigMenu();var q=document.createElement("div");q.style.cssText="position:absolute; right:0; top:0; width:1px; height:1px; pointer-events:none;";q.innerHTML="<svg width='80' height='80' viewBox='0 0 250 250' style='fill:rgba(255,255,255,0.2); color:#2B2A2D; position: absolute; top: 0; border: 0; right: 0;'>\n<path d='M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z' id='octo' onmouseover='editor.Gover();' onmouseout='editor.Gout();' onmousedown='editor.Gdown();'></path>\n<path d='M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2' fill='currentColor' style='transform-origin: 130px 106px;' id='octo-arm'></path>\n<path d='M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z' fill='currentColor' id='octo-body'></path></svg>";
document.body.appendChild(q);x=document.getElementById("octo");B=document.getElementById("octo-arm");h=document.createElement("div");h.className="debug";document.body.appendChild(h);g=document.createElement("div");g.className="title";document.body.appendChild(g);a=document.createElement("div");a.className="editor";document.body.appendChild(a);b=document.createElement("div");b.className="codeContent";a.appendChild(b);c=CodeMirror(b,{lineNumbers:!0,matchBrackets:!0,indentWithTabs:!1,styleActiveLine:!0,
theme:"monokai",mode:"text/javascript",tabSize:4,indentUnit:4,highlightSelectionMatches:{showToken:/\w/}});f=document.createElement("div");f.className="separator";document.body.appendChild(f);d=document.createElement("div");d.className="menuCode";a.appendChild(d);a.style.display="none";f.style.display="none";c.on("change",function(){editor.onChange()});c.on("focus",function(){p=!0;view.needFocus()});c.on("blur",function(){p=!1});c.on("drop",function(){m?m=!1:c.setValue("")});c.on("dragstart",function(){m=
!0});F&&(w=~~(0.4*window.innerWidth),a.style.display="block",f.style.display="block",this.addSeparatorEvent(),this.resize());y.style.width=window.innerWidth-w+"px"},addSeparatorEvent:function(){f.addEventListener("mouseover",editor.mid_over,!1);f.addEventListener("mouseout",editor.mid_out,!1);f.addEventListener("mousedown",editor.mid_down,!1)},removeSeparatorEvent:function(){f.removeEventListener("mouseover",editor.mid_over,!1);f.removeEventListener("mouseout",editor.mid_out,!1);f.removeEventListener("mousedown",
editor.mid_down,!1)},selectCode:function(){F?editor.hide():editor.show()},hide:function(){F=!1;a.style.display="none";f.style.display="none";e=w;w=0;this.removeSeparatorEvent();editor.Bdefault(q[1]);editor.resize()},show:function(){F=!0;a.style.display="block";f.style.display="block";w=e?e:~~(0.4*window.innerWidth);this.addSeparatorEvent();editor.resize()},resizeMenu:function(a){y&&(y.style.width=a+"px")},resize:function(b){b&&(w=b.clientX+10);view&&(view.setLeft(w),view.resize());y.style.left=w+
"px";g.style.left=w+"px";h.style.left=w+"px";f.style.left=w-10+"px";a.style.width=w-10+"px";c.refresh()},tell:function(a){h.innerHTML=a},makeBigMenu:function(){y.style.width=window.innerWidth-w+"px";q[0]=document.createElement("div");q[0].className="bigButton";y.appendChild(q[0]);q[0].innerHTML="DEMO";q[0].addEventListener("mousedown",editor.selectBigMenu,!1);q[0].name="demo";q[1]=document.createElement("div");q[1].className="bigButton";y.appendChild(q[1]);q[1].innerHTML="CODE";q[1].addEventListener("mousedown",
editor.selectCode,!1);q[1].name="code";n=document.createElement("div");n.className="bigContent";y.appendChild(n);for(var a=q.length;a--;)q[a].addEventListener("mouseover",editor.Bover,!1),q[a].addEventListener("mouseout",editor.Bout,!1)},selectBigMenu:function(a){r?editor.hideBigMenu():editor.showBigMenu()},showBigMenu:function(a){y.style.background="#252525";y.style.borderBottom="1px solid #3f3f3f";r=!0;a=demos.length;for(var b,c=0;c<a;c++)b=demos[c],b!==A&&editor.addButtonBig(demos[c])},hideBigMenu:function(a){y.style.background=
"rgba(0,0,0,0)";y.style.borderBottom="1px solid rgba(255, 255, 255, 0)";r=!1;a=n.childNodes.length;for(var b;a--;)b=n.childNodes[a],b.removeEventListener("mousedown",editor.bigDown),n.removeChild(b);editor.Bdefault(q[0])},addButtonBig:function(a){var b=document.createElement("div");b.className="menuButtonBig";n.appendChild(b);b.innerHTML="&bull; "+a.charAt(0).toUpperCase()+a.substring(1).toLowerCase();b.name=a;b.addEventListener("mousedown",editor.bigDown,!1)},bigDown:function(a){editor.hideBigMenu();
editor.load("demos/"+a.target.name+".js")},Bover:function(a){a.target.style.border="1px solid #3998d6";a.target.style.background="#3998d6";a.target.style.color="#FFFFFF"},Bout:function(a){var b=0;"code"==a.target.name&&F&&(b=1);"demo"==a.target.name&&r&&(b=1);b?(a.target.style.border="1px solid #3f3f3f",a.target.style.background="#3f3f3f",a.target.style.color="#999999"):editor.Bdefault(a.target)},Bdefault:function(a){a.style.border="1px solid #3f3f3f";a.style.background="#252525";a.style.color="#3998d6"},
Gover:function(){x.setAttribute("fill","#105AE2");B.style.webkitAnimationName="octocat-wave";B.style.webkitAnimationDuration="560ms"},Gout:function(){x.setAttribute("fill","rgba(255,255,255,0.2)");B.style.webkitAnimationName="none"},Gdown:function(){window.location.assign("https://github.com/lo-th/Ammo.lab")},mid_over:function(){f.style.background="#3f3f3f"},mid_out:function(){s||(f.style.background="none")},mid_down:function(){s=!0;document.addEventListener("mouseup",editor.mid_up,!1);document.addEventListener("mousemove",
editor.resize,!1)},mid_up:function(){s=!1;document.removeEventListener("mouseup",editor.mid_up,!1);document.removeEventListener("mousemove",editor.resize,!1)},load:function(a){A=a.substring(a.indexOf("/")+1,a.indexOf("."));var b=new XMLHttpRequest;b.overrideMimeType("text/plain; charset=x-user-defined");b.open("GET",a,!0);b.onload=function(){c.setValue(b.responseText)};b.send()},unFocus:function(){c.getInputField().blur();view.haveFocus()},refresh:function(){c.refresh()},getFocus:function(){return p},
validate:function(a){return c.operation(function(){for(;0<u.length;)c.removeLineClass(u.shift(),"background","errorLine");for(var b=v.length;b--;)c.removeLineWidget(v[b]);v.length=0;try{for(var d=esprima.parse(a,{tolerant:!0}).errors,b=d.length;b--;){var e=d[b],f=document.createElement("div");f.className="esprima-error";f.textContent=e.message.replace(/Line [0-9]+: /,"");var h=e.lineNumber-1;u.push(h);c.addLineClass(h,"background","errorLine");var g=c.addLineWidget(h,f);v.push(g)}}catch(l){f=document.createElement("div"),
f.className="esprima-error",f.textContent=l.message.replace(/Line [0-9]+: /,""),h=l.lineNumber-1,u.push(h),c.addLineClass(h,"background","errorLine"),g=c.addLineWidget(h,f),v.push(g)}return 0===u.length})},onChange:function(){clearTimeout(D);var a=c.getValue();this.validate(a)&&(D=setTimeout(function(){editor.inject(a)},500))},inject:function(a){var b=document.createElement("script");b.language="javascript";b.type="text/javascript";b.text=a;document.getElementsByTagName("BODY").item(0).appendChild(b);
d.innerHTML="&bull; "+A;g.innerHTML=A.charAt(0).toUpperCase()+A.substring(1).toLowerCase();l(A)}}}();Math.torad=0.017453292519943295;Math.todeg=57.29577951308232;Math.degtorad=0.017453292519943295;Math.radtodeg=57.29577951308232;Math.Pi=3.141592653589793;Math.TwoPI=6.283185307179586;Math.PI90=1.570796326794896;Math.PI270=4.712388980384689;Math.lerp=function(a,b,c){return a+(b-a)*c};Math.rand=function(a,b){return Math.lerp(a,b,Math.random())};Math.randInt=function(a,b,c){return 1*Math.lerp(a,b,Math.random()).toFixed(c||0)};Math.int=function(a){return~~a};
var view=function(){var a,b=0,c=0,f=0,d=0,h,g,l,m,p,u,v,D,w,e,A,y=!1,q=1,n=1,r=0,F,s=[],x=[],B=[],z=[],E=[],I=[],C=[],N={},M=!1,P=!1,J=null,L,K=0,O=0,V=0,W=0,G,t,S=[],aa=null,ba={},ca,X=!1,H,R,da,Z=-0.01,Y=null,ea,Q=1,T=!0,$="wireframe ceramic plastic smooth metal chrome brush black glow red sky".split(" "),U;return view={render:function(){requestAnimationFrame(a.render);TWEEN.update();THREE.SEA3D.AnimationHandler.update(0.017);update();M&&(a.bodyStep(),a.heroStep(),a.carsStep(),a.softStep(),a.controlUpdate(),
M=!1);postUpdate();g.render(l,m);b=now();b-1E3>c&&(c=b,d=f,f=0);f++},needUpdate:function(){M=!0},needCrowdUpdate:function(){},reset:function(){this.removeRay();this.resetCamera();this.setShadowPosY(-0.01);F.visible=!0;for(var a,b;0<s.length;)l.remove(s.pop());for(;0<x.length;)l.remove(x.pop());for(;0<B.length;)l.remove(B.pop());for(;0<z.length;)l.remove(z.pop());for(;0<I.length;)l.remove(I.pop());for(;0<C.length;)C.pop().dispose();for(;0<E.length;){a=E.pop();a.userData.helper&&(a.remove(a.userData.helper),
a.userData.helper.dispose());for(b=a.userData.w.length;b--;)l.remove(a.userData.w[b]);l.remove(a)}Y=null;N={};postUpdate=function(){};update=function(){}},init:function(k){h=document.createElement("canvas");h.className="canvas3d";h.oncontextmenu=function(a){a.preventDefault()};h.ondrop=function(a){a.preventDefault()};document.body.appendChild(h);a=this;try{g=new THREE.WebGLRenderer({canvas:h,antialias:!0,alpha:!1})}catch(b){null!==intro&&intro.message("<p>Sorry, your browser does not support WebGL.</p><p>This application uses WebGL to quickly draw AMMO Physics.</p><p>AMMO Physics can be used without WebGL, but unfortunately this application cannot.</p><p>Have a great day!</p>");
return}null!==intro&&intro.clear();g.setClearColor(2434341,1);g.setPixelRatio(window.devicePixelRatio);g.gammaInput=!0;g.gammaOutput=!0;g.toneMapping=THREE.Uncharted2ToneMapping;g.toneMappingExposure=3;g.toneMappingWhitePoint=5;l=new THREE.Scene;D=new THREE.Group;l.add(D);m=new THREE.PerspectiveCamera(60,1,1,1E3);m.position.set(0,0,30);p=new THREE.OrbitControls(m,h);p.target.set(0,0,0);p.enableKeys=!1;p.update();L=new THREE.Group;l.add(L);L.add(m);this.addLights();ca=new THREE.TextureLoader;u=new THREE.Raycaster;
v=new THREE.Vector2;G={box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,0.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1)};G.wheel.rotateZ(-Math.PI90);t={terrain:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"terrain",wireframe:!0}),cloth:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"cloth",
wireframe:!0,transparent:!0,opacity:0.9,side:THREE.DoubleSide}),ball:new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,name:"ball",wireframe:!0}),statique:new THREE.MeshBasicMaterial({color:3355545,name:"statique",wireframe:!0,transparent:!0,opacity:0.6}),move:new THREE.MeshBasicMaterial({color:10066329,name:"move",wireframe:!0}),movehigh:new THREE.MeshBasicMaterial({color:16751001,name:"movehigh",wireframe:!0}),sleep:new THREE.MeshBasicMaterial({color:10066431,name:"sleep",wireframe:!0}),
debug:new THREE.MeshBasicMaterial({color:1179409,name:"debug",wireframe:!0,opacity:0.1,transparent:!0}),hero:new THREE.MeshBasicMaterial({color:10040217,name:"hero",wireframe:!0}),cars:new THREE.MeshBasicMaterial({color:16777215,name:"cars",wireframe:!0,transparent:!0,side:THREE.DoubleSide}),tmp1:new THREE.MeshBasicMaterial({color:16777215,name:"tmp1",wireframe:!0,transparent:!0}),tmp2:new THREE.MeshBasicMaterial({color:16777215,name:"tmp2",wireframe:!0,transparent:!0}),meca1:new THREE.MeshBasicMaterial({color:16777215,
name:"meca1",wireframe:!0}),meca2:new THREE.MeshBasicMaterial({color:16777215,name:"meca2",wireframe:!0}),meca3:new THREE.MeshBasicMaterial({color:16777215,name:"meca3",wireframe:!0}),pig:new THREE.MeshBasicMaterial({color:13870992,name:"pig",wireframe:!0,transparent:!1}),avatar:new THREE.MeshBasicMaterial({color:13870992,name:"avatar",wireframe:!0,transparent:!1}),both:new THREE.MeshBasicMaterial({color:16777215,name:"both",wireframe:!0,side:THREE.DoubleSide}),back:new THREE.MeshBasicMaterial({color:16777215,
name:"back",wireframe:!0,side:THREE.BackSide})};F=new THREE.GridHelper(50,20,16777215,3355443);F.material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0,opacity:0.1});l.add(F);this.resize();this.initEnv();window.addEventListener("resize",a.resize,!1);this.render();this.load("basic",k)},addLights:function(){R=new THREE.DirectionalLight(16777215,1);R.position.set(-3,50,5);R.lookAt(new THREE.Vector3);l.add(R);da=new THREE.AmbientLight(4473924);l.add(da)},resize:function(){n=
window.innerHeight;q=window.innerWidth-r;h.style.left=r+"px";m.aspect=q/n;m.updateProjectionMatrix();g.setSize(q,n);editor&&editor.resizeMenu(q)},setLeft:function(a){r=a},getFps:function(){return d},getInfo:function(){return g.info.programs.length},addMap:function(a,b){var c=ca.load("./assets/textures/"+a);c.flipY=!1;t[b].map=c},getGeo:function(){return G},getMat:function(){return t},getScene:function(){return l},removeRay:function(){y&&(y=!1,h.removeEventListener("mousemove",a.rayTest,!1),e=null,
D.remove(A),l.remove(w))},activeRay:function(k){y=!0;var b=new THREE.PlaneBufferGeometry(100,100);b.rotateX(-Math.PI90);A=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}));D.add(A);w=new THREE.Mesh(G.box,new THREE.MeshBasicMaterial({color:16711680}));l.add(w);h.addEventListener("mousemove",a.rayTest,!1);e=k},rayTest:function(a){v.x=(a.clientX-r)/q*2-1;v.y=2*-(a.clientY/n)+1;u.setFromCamera(v,m);a=u.intersectObjects(D.children,!0);a.length&&(w.position.copy(a[0].point),
e(w))},changeMaterial:function(a){var b,c,d;0===a?(T=!0,c="MeshBasicMaterial",this.removeShadow()):(T=!1,c="MeshStandardMaterial",this.addShadow());for(d in t)b=t[d],a=b.name,"debug"!==a&&(t[a]=new THREE[c]({name:a,envMap:null,map:b.map||null,vertexColors:b.vertexColors||!1,color:void 0===b.color?16777215:b.color.getHex(),wireframe:T,transparent:b.transparent||!1,opacity:b.opacity||1,side:b.side||THREE.FrontSide}),T||(t[a].envMap=U,t[a].metalness=0.6,t[a].roughness=0.4),b.dispose());for(d=s.length;d--;)a=
s[d].material.name,s[d].material=t[a];for(d=x.length;d--;)a=x[d].material.name,x[d].material=t[a];for(d=E.length;d--;){if(void 0==E[d].material)for(b=E[d].children.length;b--;)a=E[d].children[b].material.name,"helper"!==a&&(E[d].children[b].material=t[a]);else a=E[d].material.name,E[d].material=t[a];for(b=E[d].userData.w.length;b--;)a=E[d].userData.w[b].material.name,E[d].userData.w[b].material=t[a]}for(d=B.length;d--;)a=B[d].material.name,B[d].material=t[a];for(d=z.length;d--;)2!==z.softType&&(a=
z[d].material.name,z[d].material=t[a])},needFocus:function(){h.addEventListener("mouseover",editor.unFocus,!1)},haveFocus:function(){h.removeEventListener("mouseover",editor.unFocus,!1)},initEnv:function(){var a=document.createElement("div");a.className="env";var b=document.createElement("canvas");b.width=b.height=64;a.appendChild(b);document.body.appendChild(a);ea=b.getContext("2d");a.onclick=this.loadEnv;a.oncontextmenu=this.loadEnv;this.loadEnv()},loadEnv:function(k){var b=0;k&&(k.preventDefault(),
b=k.button,0===b?Q++:Q--,Q==$.length&&(Q=0),0>Q&&(Q=$.length-1));var c=new Image;c.onload=function(){ea.drawImage(c,0,0,64,64);U=new THREE.Texture(c);U.mapping=THREE.SphericalReflectionMapping;U.format=THREE.RGBFormat;U.needsUpdate=!0;0!==Q||T||a.changeMaterial(0);if(0!==Q)if(T)a.changeMaterial(1);else for(var k in t)t[k].envMap=U};c.src="./assets/textures/spherical/"+$[Q]+".jpg"},hideGrid:function(){F.visible=F.visible?!1:!0},load:function(k,b){"string"==typeof k||k instanceof String?S.push(k):S=
S.concat(k);aa=b||function(){};a.load_sea(S[0])},load_next:function(){S.shift();0===S.length?aa():a.load_sea(S[0])},load_sea:function(k){var b=new THREE.SEA3D;b.onComplete=function(c){ba[k]=b.meshes;c=b.geometries.length;for(var d;c--;)d=b.geometries[c],G[d.name]=d;a.load_next()};b.load("./assets/models/"+k+".sea")},getResult:function(){return ba},mergeMesh:function(a){return THREE.ViewUtils.mergeGeometryArray(a)},prepaGeometry:function(a,b){return THREE.ViewUtils.prepaGeometry(a,b)},controlUpdate:function(){if(P&&
null!==J){var a,b,c=J;a=c.userData.type;var d=c.userData.speed;b=-70*Math.torad;if("car"===a){if(10>d&&-10<d){this.setControle(!0);return}this.setControle(!1)}"hero"===a&&(this.setControle(!0),K=p.getAzimuthalAngle()+Math.Pi,O=-p.getPolarAngle(),O!==W&&(b=W=O),K!==V&&(V=K,ammo.send("heroRotation",{id:c.userData.id,angle:K})));d=new THREE.Matrix4;d.extractRotation(c.matrix);a=new THREE.Vector3(0,0,1);a.applyMatrix4(d);c=c.position;a=Math.atan2(a.x,a.z);this.autoCamera(a,b,10,0.3,c)}},setFollow:function(a){J=
this.getByName(a);null!==J&&(P=!0)},setTarget:function(a){p.target.copy(a);p.update()},autoCamera:function(a,b,c,d,e){d=d||1;m.position.lerp(this.orbit(a,b,c),d);e&&this.setTarget(e)},moveCamera:function(a,b,c,d){a=this.orbit((a+180)*Math.torad,(b-90)*Math.torad,c);(new TWEEN.Tween(m.position)).to({x:a.x,y:a.y,z:a.z},400).easing(TWEEN.Easing.Quadratic.Out).start();(new TWEEN.Tween(p.target)).to({x:d[0],y:d[1],z:d[2]},400).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){p.update()}).start()},
orbit:function(a,b,c){var d=new THREE.Vector3;d.x=c*Math.sin(b)*Math.sin(a);d.y=c*Math.cos(b);d.z=c*Math.sin(b)*Math.cos(a);a=new THREE.Vector3;a.copy(p.target).add(d);return a},setControle:function(a){p.enableRotate!==a&&(p.enableRotate=a,p.enableZoom=a,p.enablePan=a)},resetCamera:function(){a.setControle(!0);J=null},setDriveCar:function(a){ammo.send("setDriveCar",{n:this.getByName(a).userData.id})},toRad:function(a){for(var b=a.length;b--;)a[b]*=Math.torad;return a},add:function(k){var b=!1;k.mass=
void 0==k.mass?0:k.mass;k.type=void 0==k.type?"box":k.type;k.pos=void 0==k.pos?[0,0,0]:k.pos;k.size=void 0==k.size?[1,1,1]:k.size;1==k.size.length&&(k.size[1]=k.size[0]);2==k.size.length&&(k.size[2]=k.size[0]);k.geoSize&&(1==k.geoSize.length&&(k.geoSize[1]=k.geoSize[0]),2==k.geoSize.length&&(k.geoSize[2]=k.geoSize[0]));k.rot=void 0==k.rot?[0,0,0]:this.toRad(k.rot);k.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(k.rot)).toArray();k.rotA&&(k.quatA=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(k.rotA))).toArray());
k.rotB&&(k.quatB=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(this.toRad(k.rotB))).toArray());k.angUpper&&(k.angUpper=this.toRad(k.angUpper));k.angLower&&(k.angLower=this.toRad(k.angLower));var c=null;if("joint"===k.type.substring(0,5))ammo.send("add",k);else if("plane"===k.type)F.position.set(k.pos[0],k.pos[1],k.pos[2]),ammo.send("add",k);else if("softTriMesh"===k.type)this.softTriMesh(k);else if("softConvex"===k.type)this.softConvex(k);else if("cloth"===k.type)this.cloth(k);else if("rope"===
k.type)this.rope(k);else if("ellipsoid"===k.type)this.ellipsoid(k);else if("terrain"===k.type)this.terrain(k);else{c=void 0!==k.material?t[k.material]:k.mass?t.move:t.statique;if("capsule"===k.type)b=new THREE.CapsuleBufferGeometry(k.size[0],0.5*k.size[1]),c=new THREE.Mesh(b,c),C.push(c.geometry),b=!0;else if("mesh"===k.type||"convex"===k.type)k.v=a.prepaGeometry(k.shape,k.type),k.geometry?(c=new THREE.Mesh(k.geometry,c),C.push(k.geometry),C.push(k.shape)):(c=new THREE.Mesh(k.shape,c),C.push(c.geometry));
else{if(k.geometry){if(k.geoRot||k.geoScale)k.geometry=k.geometry.clone();k.geoRot&&k.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(this.toRad(k.geoRot))));k.geoScale&&k.geometry.applyMatrix((new THREE.Matrix4).makeScale(k.geoScale[0],k.geoScale[1],k.geoScale[2]))}c=0===k.mass&&"box"===k.type?new THREE.Mesh(k.geometry||G.hardbox,c):new THREE.Mesh(k.geometry||G[k.type],c);k.geometry&&(C.push(k.geometry),k.geoSize&&c.scale.fromArray(k.geoSize),!k.geoSize&&
k.size&&c.scale.fromArray(k.size),b=!0)}c&&(b||c.scale.fromArray(k.size),c.position.fromArray(k.pos),c.quaternion.fromArray(k.quat),c.receiveShadow=!0,c.castShadow=!0,this.setName(k,c),l.add(c),k.mass?s.push(c):x.push(c));k.shape&&delete k.shape;k.geometry&&delete k.geometry;k.material&&delete k.material;ammo.send("add",k)}},getGeoByName:function(a,b){for(var c,d=G.length;d--;)a==G[d].name&&(c=G[d]);b&&(c=(new THREE.BufferGeometry).fromGeometry(c));return c},character:function(a){a.size=void 0==a.size?
[0.25,2,2]:a.size;1==a.size.length&&(a.size[1]=a.size[0]);2==a.size.length&&(a.size[2]=a.size[0]);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:this.toRad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();var b=new THREE.CapsuleBufferGeometry(a.size[0],0.5*a.size[1],6),c=new THREE.Group;if(a.debug){var d=new THREE.Mesh(b,t.debug);C.push(b);c.add(d)}a.mesh?(t.hero.skinning=!0,a.mesh.material=t.hero,a.mesh.scale.multiplyScalar(a.scale||
1),a.mesh.position.set(0,0,0),a.mesh.play(0),c.add(a.mesh),c.skin=a.mesh,C.push(c.skin.geometry)):(d=new THREE.Mesh(b,t.hero),C.push(b),c.add(d));c.userData.speed=0;c.userData.type="hero";c.userData.id=I.length;c.position.fromArray(a.pos);c.quaternion.fromArray(a.quat);c.castShadow=!0;c.receiveShadow=!0;l.add(c);I.push(c);this.setName(a,c);a.mesh&&delete a.mesh;ammo.send("character",a)},vehicle:function(b){var c=b.size||[2,0.5,4],d=b.pos||[0,0,0],e=b.rot||[0,0,0],f=b.wPos||[1,0,1.6],h=b.massCenter||
[0,0.25,0];this.toRad(e);if(b.mesh)for(var c=b.mesh,g=c.children.length;g--;)c.children[g].position.set(h[0],h[1],h[2]),c.children[g].castShadow=!0,c.children[g].receiveShadow=!0;else c=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(c[0],c[1],c[2])),c.translate(h[0],h[1],h[2]),C.push(c),c=new THREE.Mesh(c,t.move);c.position.set(d[0],d[1],d[2]);c.rotation.set(e[0],e[1],e[2]);b.quat=c.quaternion.toArray();c.castShadow=!0;c.receiveShadow=!0;l.add(c);this.setName(b,c);c.userData.speed=
0;c.userData.steering=0;c.userData.NumWheels=b.nw||4;c.userData.type="car";b.helper&&(c.userData.helper=new THREE.CarHelper(f),c.add(c.userData.helper));var d=b.radius||0.4,e=b.deep||0.3,f=[],h=void 0==b.wheel?!0:!1,g=b.wheel||G.wheel,m=g.clone();m.rotateY(Math.Pi);C.push(m);for(var n=b.nw||4;n--;)f[n]=1==n||2==n?new THREE.Mesh(g,t.move):new THREE.Mesh(m,t.move),h?f[n].scale.set(e,d,d):f[n].material=t.cars,f[n].castShadow=!0,f[n].receiveShadow=!0,l.add(f[n]);c.userData.w=f;E.push(c);c.userData.id=
E.length-1;b.mesh&&(b.mesh=null);b.wheel&&(b.wheel=null);if("mesh"==b.type||"convex"==b.type)b.v=a.prepaGeometry(b.shape,b.type);b.shape&&delete b.shape;b.mesh&&delete b.mesh;ammo.send("vehicle",b)},softTriMesh:function(b){var c=b.shape.clone(),d=b.pos||[0,0,0],e=b.size||[1,1,1],f=b.rot||[0,0,0];c.translate(d[0],d[1],d[2]);c.scale(e[0],e[1],e[2]);c.applyMatrix((new THREE.Matrix4).makeRotationY(f[1]*=Math.torad));a.prepaGeometry(c);C.push(c);b.v=c.realVertices;b.i=c.realIndices;b.ntri=c.numFaces;c=
new THREE.Mesh(c,void 0===b.material?t.cloth:t[b.material]);c.castShadow=!0;c.receiveShadow=!0;c.softType=5;l.add(c);z.push(c);b.shape&&delete b.shape;b.material&&delete b.material;ammo.send("add",b)},softConvex:function(b){var c=b.shape,d=b.pos||[0,0,0];c.translate(d[0],d[1],d[2]);a.prepaGeometry(c);b.v=c.realVertices;c=new THREE.Mesh(c,t.cloth);c.castShadow=!0;c.receiveShadow=!0;c.softType=4;l.add(c);z.push(c);ammo.send("add",b)},cloth:function(a){var b=a.div||[16,16],c=a.size||[100,0,100],d=a.pos||
[0,0,0],e=b[0]*b[1],f=new THREE.PlaneBufferGeometry(c[0],c[2],b[0]-1,b[1]-1);f.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*e),3));f.rotateX(-Math.PI90);e=new THREE.Mesh(f,t.cloth);this.setName(a,e);e.position.set(d[0],d[1],d[2]);e.castShadow=!0;e.receiveShadow=!0;e.softType=1;l.add(e);z.push(e);a.size=c;a.div=b;a.pos=d;ammo.send("add",a)},rope:function(a){void 0===a.numSeg&&(a.numSeg=a.numSegment);var b=new THREE.Tubex(a,a.numSeg||10,a.radius||0.2,a.numRad||6,!1),b=new THREE.Mesh(b,
t.ball);this.setName(a,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=2;l.add(b);z.push(b);ammo.send("add",a)},ellipsoid:function(a){ammo.send("add",a)},ellipsoidMesh:function(a){var b=a.lng,c=[],d=a.a,e,f,h,g;for(e=0;e<b;e++)g=3*e,c.push(new THREE.Vector3(d[g],d[g+1],d[g+2]));var c=new THREE.ConvexGeometry(c),n=new Uint32Array(3*c.faces.length),m=new Float32Array(3*b),p=new Float32Array(b);h=c.vertices;for(e=b;e--;)for(f=b;f--;)g=3*f,d[g]==h[e].x&&d[g+1]==h[e].y&&d[g+2]==h[e].z&&(p[f]=e);for(e=
b;e--;)g=3*e,f=3*p[e],m[f]=d[g],m[f+1]=d[g+1],m[f+2]=d[g+2];for(e=c.faces.length;e--;)g=3*e,d=c.faces[e],n[g]=d.a,n[g+1]=d.b,n[g+2]=d.c;e=new THREE.BufferGeometry;e.setIndex(new THREE.BufferAttribute(n,1));e.addAttribute("position",new THREE.BufferAttribute(m,3));e.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*b),3));e.addAttribute("order",new THREE.BufferAttribute(p,1));e.computeVertexNormals();C.push(e);c.dispose();b=new THREE.Mesh(e,t.ball);this.setName(a,b);b.softType=3;b.castShadow=
!0;b.receiveShadow=!0;l.add(b);z.push(b)},terrain:function(a){var b,c,d,e;a.div=void 0==a.div?[64,64]:a.div;a.size=void 0==a.size?[100,10,100]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.dpos=void 0==a.dpos?[0,0,0]:a.dpos;a.complexity=void 0==a.complexity?30:a.complexity;a.lng=a.div[0]*a.div[1];a.hdata=new Float32Array(a.lng);Y||(Y=new Perlin);var f=1/a.complexity,h=1/a.div[0],g=(a.div[0]-1)/a.size[0],n=(a.div[1]-1)/a.size[2],m=new Float32Array(3*a.lng),p=new THREE.PlaneBufferGeometry(a.size[0],a.size[2],
a.div[0]-1,a.div[1]-1);p.rotateX(-Math.PI90);var q=p.attributes.position.array;for(b=a.lng;b--;)e=3*b,c=b%a.div[0],d=~~(b*h),c=0.5+0.5*Y.noise((c+a.dpos[0]*g)*f,(d+a.dpos[2]*n)*f),a.hdata[b]=c*a.size[1],q[e+1]=a.hdata[b],m[e]=c,m[e+1]=c,m[e+2]=c;p.addAttribute("color",new THREE.BufferAttribute(m,3));p.computeBoundingSphere();p.computeVertexNormals();C.push(p);b=new THREE.Mesh(p,t.terrain);b.position.fromArray(a.pos);b.castShadow=!1;b.receiveShadow=!0;this.setName(a,b);l.add(b);B.push(b);ammo.send("add",
a);H&&l.remove(H)},moveTerrain:function(a){},setName:function(a,b){void 0!==a.name&&(N[a.name]=b,b.name=a.name)},getByName:function(a){return N[a]||null},getBody:function(){return s},bodyStep:function(){s.length&&s.forEach(function(a,b){var c=8*b,d=Br[c];if(0<d)"sleep"==a.material.name&&(a.material=t.move),50<d&&"move"==a.material.name?a.material=t.movehigh:50>d&&"movehigh"==a.material.name&&(a.material=t.move),a.position.fromArray(Br,c+1),a.quaternion.fromArray(Br,c+4);else if("move"==a.material.name||
"movehigh"==a.material.name)a.material=t.sleep})},heroStep:function(){I.length&&I.forEach(function(a,b){var c=8*b,d=3.33*Hr[c];a.userData.speed=100*d;a.position.fromArray(Hr,c+1);a.quaternion.fromArray(Hr,c+4);a.skin&&(0===d?a.skin.play(0,0.3):(a.skin.play(1,0.3),a.skin.setTimeScale(d)))})},carsStep:function(){E.length&&E.forEach(function(a,b){var c=56*b;a.userData.speed=Cr[c];a.position.fromArray(Cr,c+1);a.quaternion.fromArray(Cr,c+4);var d=a.userData.NumWheels,e;a.userData.helper&&4==d&&(e=40,a.userData.helper.updateSuspension(Cr[c+
e+0],Cr[c+e+1],Cr[c+e+2],Cr[c+e+3]));for(;d--;)e=8*(d+1),a.userData.w[d].position.fromArray(Cr,c+e+1),a.userData.w[d].quaternion.fromArray(Cr,c+e+4)})},getSofts:function(){return z},softStep:function(){if(z.length){var a=0;z.forEach(function(b,c){var d,e,f,h,g,l,m=b.softType,n=null,p=b.geometry.attributes.color?!0:!1,q=b.geometry.attributes.normal?!0:!1;if(2===m){for(g=b.geometry.positions.length;g--;)d=a+3*g,b.geometry.positions[g].set(Sr[d],Sr[d+1],Sr[d+2]);b.geometry.updatePath();a+=3*b.geometry.positions.length}else{h=
b.geometry.attributes.position.array;p&&(e=b.geometry.attributes.color.array);if(5===m||4===m){var s=b.geometry.numVertices,t=b.geometry.maxi,r=b.geometry.pPoint,u=b.geometry.lPoint;for(g=s;g--;)for(d=3*g+a,l=g==s-1?t-r[g]:r[g+1]-r[g],f=r[g];l--;)e=3*u[f+l],h[e]=Sr[d],h[e+1]=Sr[d+1],h[e+2]=Sr[d+2]}else if(b.geometry.attributes.order&&(n=b.geometry.attributes.order.array),g=h.length,d=2,null!==n)for(g=n.length;g--;)l=3*n[g],d=3*g+a,h[l]=Sr[d],h[l+1]=Sr[d+1],h[l+2]=Sr[d+2],f=Math.abs(Sr[d+1]/10),e[l]=
f,e[l+1]=f,e[l+2]=f;else for(;g--;)h[g]=Sr[g+a],1==d&&(f=Math.abs(h[g]/10),e[g-1]=f,e[g]=f,e[g+1]=f),d--,d=0>d?2:d;2!==m&&b.geometry.computeVertexNormals();b.geometry.attributes.position.needsUpdate=!0;if(q){d=b.geometry.attributes.normal.array;for(g=s;g--;)for(l=g==s-1?t-r[g]:r[g+1]-r[g],f=r[g],q=3*u[f];l--;)e=3*u[f+l],d[e]=d[q],d[e+1]=d[q+1],d[e+2]=d[q+2];b.geometry.attributes.normal.needsUpdate=!0}p&&(b.geometry.attributes.color.needsUpdate=!0);b.geometry.computeBoundingSphere();a=5===m?a+3*b.geometry.numVertices:
a+h.length}})}},removeShadow:function(){X&&(X=!1,g.shadowMap.enabled=!1,H&&l.remove(H))},hideGroundShadow:function(){H.visible=!1},setShadowPosY:function(a){Z=a;H&&(H.position.y=Z,H.visible=!0)},addShadow:function(){if(!X){X=!0;g.shadowMap.enabled=!0;g.shadowMap.soft=!0;g.shadowMap.type=THREE.PCFSoftShadowMap;g.shadowMap.renderReverseSided=!1;if(!B.length){var a=new THREE.ShaderMaterial(THREE.ShaderShadow);H=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200,1,1),a);H.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(0.5*
-Math.PI));H.position.y=Z;H.castShadow=!1;H.receiveShadow=!0;l.add(H)}R.castShadow=!0;a=new THREE.OrthographicCamera(70,-70,70,-70,25,170);R.shadow=new THREE.LightShadow(a);R.shadow.mapSize.width=1024;R.shadow.mapSize.height=1024}}}}();
